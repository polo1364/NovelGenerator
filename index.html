<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°èªªç”Ÿæˆå™¨ï¼ˆç›´è§€ä»‹é¢ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a33;
      --card2:#0f1930;
      --line:#223458;
      --text:#e8eefc;
      --muted:#a9b6d6;
      --bad:#ff5a7a;
      --ok:#37d67a;
      --warn:#ffcc66;
      --accent:#7aa7ff;
      --accent2:#9b7aff;
      --shadow: 0 16px 50px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(122,167,255,.25), transparent 55%),
        radial-gradient(1000px 700px at 85% 20%, rgba(155,122,255,.20), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(55,214,122,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:24px 16px 42px;
    }
    header{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(122,167,255,.95), rgba(155,122,255,.95));
      box-shadow: 0 12px 30px rgba(122,167,255,.25);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 60%);
      transform: rotate(18deg);
    }
    h1{
      font-size:18px;
      margin:0;
      letter-spacing:.4px;
    }
    .subtitle{
      margin:2px 0 0;
      font-size:13px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(16,26,51,.55);
      backdrop-filter: blur(8px);
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1.15fr;
      gap:16px;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: rgba(16,26,51,.78);
      border:1px solid rgba(34,52,88,.85);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(34,52,88,.85);
      background: rgba(15,25,48,.55);
    }
    .card .hd .title{
      font-weight:700;
      font-size:14px;
      letter-spacing:.3px;
      margin:0;
    }
    .card .hd .hint{
      font-size:12px;
      color:var(--muted);
    }
    .card .bd{padding:14px 16px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    @media (max-width: 520px){
      .row, .row3{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(34,52,88,.9);
      background: rgba(11,18,32,.55);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(122,167,255,.9);
      box-shadow: 0 0 0 3px rgba(122,167,255,.18);
    }
    .inline{
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      border:none;
      border-radius:16px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, filter .15s ease;
      display:inline-flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(122,167,255,.95), rgba(155,122,255,.95));
      color:#081026;
    }
    .btn.ghost{
      background: rgba(11,18,32,.35);
      border:1px solid rgba(34,52,88,.9);
      color:var(--text);
    }
    .btn.warn{
      background: rgba(255,204,102,.16);
      border:1px solid rgba(255,204,102,.38);
      color: var(--warn);
    }
    .btn:disabled{
      opacity:.55; cursor:not-allowed;
      filter: grayscale(.2);
    }
    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .monos{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .banner{
      border:1px solid rgba(255,204,102,.45);
      background: rgba(255,204,102,.12);
      color: var(--warn);
      padding:10px 12px;
      border-radius:16px;
      margin:12px 0 0;
      display:none;
    }
    .banner strong{color:#ffe7b0}
    .tabs{
      display:flex; gap:8px;
    }
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(34,52,88,.85);
      background: rgba(11,18,32,.35);
      color: var(--muted);
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .tab.active{
      background: rgba(122,167,255,.18);
      color: var(--text);
      border-color: rgba(122,167,255,.55);
    }
    .outbox{
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .status{
      display:flex;
      gap:10px;
      align-items:center;
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background: rgba(169,182,214,.55);
      box-shadow: 0 0 0 4px rgba(169,182,214,.10);
    }
    .dot.ok{background: var(--ok); box-shadow: 0 0 0 4px rgba(55,214,122,.12)}
    .dot.bad{background: var(--bad); box-shadow: 0 0 0 4px rgba(255,90,122,.14)}
    .pre{
      border:1px solid rgba(34,52,88,.85);
      background: rgba(11,18,32,.45);
      border-radius: 18px;
      padding:14px;
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.55;
      min-height: 360px;
      overflow:auto;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .chip{
      border:1px solid rgba(34,52,88,.85);
      background: rgba(11,18,32,.30);
      border-radius:999px;
      padding:7px 10px;
    }
    details{
      border:1px dashed rgba(34,52,88,.75);
      border-radius: 16px;
      background: rgba(11,18,32,.18);
      padding:10px 12px;
      margin-top: 10px;
    }
    summary{
      cursor:pointer;
      font-weight:700;
      color: var(--text);
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .twocol{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
      margin-top: 10px;
    }
    @media (max-width: 520px){ .twocol{grid-template-columns:1fr} }
    .footerNote{
      margin-top:12px;
      color: var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .toggle{
      display:flex; align-items:center; gap:10px;
      user-select:none;
      font-size:13px;
      color: var(--text);
    }
    .switch{
      width:44px; height:26px; border-radius:999px;
      border:1px solid rgba(34,52,88,.95);
      background: rgba(11,18,32,.45);
      position:relative;
      cursor:pointer;
      flex:none;
    }
    .knob{
      width:20px; height:20px; border-radius:99px;
      background: rgba(169,182,214,.9);
      position:absolute; top:2px; left:2px;
      transition: left .15s ease, background .15s ease;
    }
    .switch.on{
      border-color: rgba(55,214,122,.55);
      background: rgba(55,214,122,.10);
    }
    .switch.on .knob{
      left:22px;
      background: rgba(55,214,122,.95);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>å°èªªç”Ÿæˆå™¨ï¼ˆåƒç”Ÿè²¼åœ–ä¸€æ¨£ç›´è¦ºï¼Œä½†é€™æ¬¡ç”Ÿçš„æ˜¯æ–‡å­—ï¼‰</h1>
          <div class="subtitle">æ”¯æ´ Google AI Studioï¼ˆGeminiï¼‰ï¼›å¯æ‰‹å‹•è¼¸å…¥ Keyï¼›å³å´å³æ™‚è¼¸å‡ºèˆ‡éŒ¯èª¤è¨ºæ–·ã€‚</div>
        </div>
      </div>
      <div class="pill monos" id="envPill">protocol: â€¦</div>
    </header>

    <div class="banner" id="fileBanner">
      <strong>ä½ æ˜¯ç”¨ file:// ç›´æ¥é–‹æª”</strong>ï¼Œç€è¦½å™¨æœƒæŠŠä¾†æºç•¶æˆ <span class="monos">origin = null</span>ï¼Œå¾ˆå¤š fetch æœƒè¢« CORS æ“‹æ‰ã€‚<br/>
      å»ºè­°ç”¨ <span class="monos">http://localhost</span> è·‘èµ·ä¾†ï¼ˆä¾‹å¦‚ <span class="monos">python -m http.server 5500</span>ï¼‰ã€‚
    </div>

    <div class="grid">
      <!-- LEFT: Controls -->
      <section class="card">
        <div class="hd">
          <div>
            <p class="title">è¨­å®š</p>
            <div class="hint">å…ˆæŠŠé‘°åŒ™æ’å°æ´ï¼Œå†é–‹å§‹å¯«ä½œï¼ˆä¸ç„¶ 401 æœƒå¾ˆå…‡ï¼‰</div>
          </div>
          <button class="btn ghost" id="btnReset" title="æ¸…ç©º/é‡ç½®">é‡ç½®</button>
        </div>

        <div class="bd">
          <div class="row">
            <div>
              <label>ä¾›æ‡‰å•†</label>
              <!-- åªæä¾› Google AI Studio ï¼ˆGeminiï¼‰ï¼Œé¸æ“‡å™¨éš±è—ä¸¦é¡¯ç¤ºå›ºå®šæ–‡å­— -->
              <select id="provider" style="display:none">
                <option value="gemini">Google Geminiï¼ˆAI Studioï¼‰</option>
              </select>
              <div style="margin-top:6px;font-size:14px;color:var(--muted)">Google AI Studioï¼ˆGeminiï¼‰</div>
            </div>
            <!-- éš±è— OpenAI æ¨¡å¼é¸æ“‡ï¼Œå› ç‚ºåªä½¿ç”¨ Google AI Studio -->
            <div style="display:none">
              <label>æ¨¡å¼</label>
              <select id="openaiMode">
                <option value="responses">Responses API</option>
                <option value="chat">Chat</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <div>
            <label>API Keyï¼ˆä¸æœƒä¸Šå‚³åˆ°ä»»ä½•åœ°æ–¹ï¼›é™¤éä½ æŒ‰ç”Ÿæˆæ‰æœƒé€å‡ºï¼‰</label>
            <div class="inline">
              <input id="apiKey" type="password" placeholder="OpenAI: sk-... / Gemini: AIza...ï¼ˆçœ‹ä½ é¸å“ªä¸€å€‹ä¾›æ‡‰å•†ï¼‰" autocomplete="off" />
              <button class="btn ghost" id="btnToggleKey" title="é¡¯ç¤º/éš±è—">ğŸ‘ï¸</button>
            </div>
            <div style="height:8px"></div>
            <div class="row">
              <div class="toggle">
                <div class="switch" id="swRemember" role="switch" aria-checked="false" tabindex="0"><div class="knob"></div></div>
                è¨˜ä½ Keyï¼ˆå­˜åˆ°æœ¬æ©Ÿ localStorageï¼‰
              </div>
              <div class="toggle">
                <div class="switch on" id="swPolish" role="switch" aria-checked="true" tabindex="0"><div class="knob"></div></div>
                é™ä½é‡è¤‡ç”¨èªï¼ˆåŠ å¼·å»é‡æŒ‡ä»¤ï¼‰
              </div>
            </div>
            <div class="footerNote">
              è‹¥ä½ è¦éƒ¨ç½²åˆ° GitHub Pagesï¼š<b>ä¸è¦æŠŠ key å¯«æ­»åœ¨ç¨‹å¼è£¡</b>ã€‚é€™é æ˜¯è®“æ¯å€‹ä½¿ç”¨è€…è‡ªå·±è¼¸å…¥è‡ªå·±çš„ keyã€‚
            </div>
          </div>

          <details open>
            <summary>æ¨¡å‹èˆ‡ç«¯é»</summary>
            <div class="twocol">
              <div>
              <label>Modelï¼ˆå¯è‡ªè¡Œæ”¹ï¼‰</label>
              <input id="model" placeholder="ä¾‹å¦‚ï¼šgemini-1.5-pro / gemini-1.5-flash / gemini-1.0-pro" />
              </div>
              <div>
              <label>Base URL</label>
              <input id="baseUrl" placeholder="ä¾‹å¦‚ï¼šhttps://generativelanguage.googleapis.com/v1betaï¼ˆé è¨­æœƒè‡ªå‹•å¸¶å…¥ï¼‰" />
              </div>
            </div>
            <div class="twocol">
              <div>
                <label>Temperature</label>
                <input id="temp" type="number" min="0" max="2" step="0.1" value="0.8" />
              </div>
              <div>
                <label>è¼¸å‡ºé•·åº¦ï¼ˆå¤§æ¦‚å­—æ•¸ï¼‰</label>
                <input id="targetLen" type="number" min="300" max="5000" step="100" value="1200" />
              </div>
            </div>
            <div class="small">
              å°æé†’ï¼šOpenAI ç”¨éŒ¯ keyï¼ˆåƒ AIza...ï¼‰å°±æœƒ 401ï¼›Gemini ç”¨ sk-... ä¹Ÿä¸€æ¨£æœƒå°·å°¬åˆ°çˆ†ã€‚
            </div>
          </details>

          <div style="height:12px"></div>

          <div class="row">
            <div>
              <label>å°èªªé¡å‹ï¼ˆå¯é¸ or è‡ªè¨‚ï¼‰</label>
              <select id="genre">
                <option value="ç¾ä»£æ—¥å¸¸">ç¾ä»£æ—¥å¸¸</option>
                <option value="æˆ€æ„›å–œåŠ‡">æˆ€æ„›å–œåŠ‡</option>
                <option value="æ‡¸ç–‘æ¨ç†">æ‡¸ç–‘æ¨ç†</option>
                <option value="å¥‡å¹»å†’éšª">å¥‡å¹»å†’éšª</option>
                <option value="ç§‘å¹»/è³½åš">ç§‘å¹»/è³½åš</option>
                <option value="è·å ´çˆ†ç¬‘">è·å ´çˆ†ç¬‘</option>
                <option value="ææ€–é©šæ‚š">ææ€–é©šæ‚š</option>
                <option value="è‡ªè¨‚">è‡ªè¨‚â€¦</option>
              </select>
            </div>
            <div>
              <label>è‡ªè¨‚é¡å‹ï¼ˆç•¶ä¸Šé¢é¸ã€Œè‡ªè¨‚ã€æ‰æœƒç”¨ï¼‰</label>
              <input id="genreCustom" placeholder="ä¾‹å¦‚ï¼šå°å¼é»‘è‰²å¹½é»˜ã€ç¡¬æ´¾ç§‘å¹»ã€æ—¥ç³»è¼•å°èªª..." />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div>
              <label>è¦–è§’</label>
              <select id="pov">
                <option value="ç¬¬ä¸€äººç¨±">ç¬¬ä¸€äººç¨±</option>
                <option value="ç¬¬ä¸‰äººç¨±">ç¬¬ä¸‰äººç¨±</option>
                <option value="å¤šè¦–è§’">å¤šè¦–è§’</option>
              </select>
            </div>
            <div>
              <label>èªæ°£/æ–‡é¢¨</label>
              <select id="tone">
                <option value="è‡ªç„¶å£èªã€ç¯€å¥æ˜å¿«">è‡ªç„¶å£èªã€ç¯€å¥æ˜å¿«</option>
                <option value="ç´°è†©æå¯«ã€æœ‰ç•«é¢æ„Ÿ">ç´°è†©æå¯«ã€æœ‰ç•«é¢æ„Ÿ</option>
                <option value="å†·é¢åæ§½ã€é»‘è‰²å¹½é»˜">å†·é¢åæ§½ã€é»‘è‰²å¹½é»˜</option>
                <option value="ç†±è¡€ä¸­äºŒã€æµ®èª‡ç‡ƒ">ç†±è¡€ä¸­äºŒã€æµ®èª‡ç‡ƒ</option>
                <option value="ç°¡æ½”ä¿è½ã€å°‘å»¢è©±">ç°¡æ½”ä¿è½ã€å°‘å»¢è©±</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>

          <div>
            <label>ä¸»é¡Œï¼ˆä¸€å¥è©±ä¹Ÿå¯ä»¥ï¼‰</label>
            <div class="inline" style="gap:8px">
              <input id="theme" placeholder="ä¾‹å¦‚ï¼šåŠ ç­åˆ°å‡Œæ™¨çš„å·¥ç¨‹å¸«ï¼Œæ„å¤–æ”¶åˆ°ä¸€å°ä¾†è‡ªæœªä¾†çš„ä¿¡â€¦" />
              <button class="btn ghost" id="btnRandomTheme" title="éš¨æ©Ÿä¸»é¡Œ">ğŸ²</button>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div>
              <label>ä¸»è¦äººè¨­ï¼ˆè§’è‰²è¨­å®šï¼‰</label>
              <div class="inline" style="gap:8px">
                <textarea id="characters" placeholder="ä¾‹ï¼šä¸»è§’ï¼šâ€¦ å¹´é½¡/æ€§æ ¼/ç¼ºé»/ç›®æ¨™â€¦ï¼›é…è§’ï¼šâ€¦"></textarea>
                <button class="btn ghost" id="btnRandomCharacters" title="éš¨æ©Ÿäººè¨­">ğŸ²</button>
              </div>
            </div>
            <div>
              <label>ä¸–ç•Œè§€ / èƒŒæ™¯ï¼ˆå¯ç•™ç©ºï¼‰</label>
              <div class="inline" style="gap:8px">
                <textarea id="world" placeholder="ä¾‹ï¼šåŸå¸‚è¦å‰‡ã€ç§‘æŠ€ç­‰ç´šã€é­”æ³•ç³»çµ±ã€å…¬å¸æ–‡åŒ–ï¼ˆå’³ï¼‰..."></textarea>
                <button class="btn ghost" id="btnRandomWorld" title="éš¨æ©ŸèƒŒæ™¯">ğŸ²</button>
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row3">
            <div>
              <label>ç« ç¯€æ•¸</label>
              <input id="chapters" type="number" min="1" max="20" step="1" value="5" />
            </div>
            <div>
              <label>è¼¸å‡ºæ ¼å¼</label>
              <select id="format">
                <option value="text">ç´”æ–‡å­—ï¼ˆæ¨è–¦ï¼‰</option>
                <option value="json">JSONï¼ˆä¾¿æ–¼ä½ å¾ŒçºŒåš UI/åˆ†é ï¼‰</option>
              </select>
            </div>
            <div>
              <label>èªè¨€</label>
              <select id="lang">
                <option value="ç¹é«”ä¸­æ–‡">ç¹é«”ä¸­æ–‡</option>
                <option value="ç°¡é«”ä¸­æ–‡">ç°¡é«”ä¸­æ–‡</option>
                <option value="è‹±æ–‡">è‹±æ–‡</option>
                <option value="æ—¥æ–‡">æ—¥æ–‡</option>
              </select>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="inline" style="justify-content:space-between; flex-wrap:wrap">
            <button class="btn primary" id="btnGenerate">âœ¨ ç”Ÿæˆå°èªª</button>
            <button class="btn ghost" id="btnCopy">ğŸ“‹ è¤‡è£½è¼¸å‡º</button>
            <button class="btn warn" id="btnDryRun" title="ä¸å‘¼å« APIã€åªé¡¯ç¤ºä½ è¦é€å‡ºçš„ payload">ğŸ§ª é¡¯ç¤ºè«‹æ±‚å…§å®¹</button>
          </div>

          <div class="footerNote">
            è‹¥ä½ é‡åˆ° <span class="monos">429</span>ï¼šé€šå¸¸æ˜¯<b>è¶…å‡ºé€Ÿç‡/é…é¡</b>ï¼Œè·Ÿ CORS ä¸ä¸€æ¨£ï¼›è«‹é™ä½é »ç‡æˆ–æ› key/æ–¹æ¡ˆã€‚ 
          </div>
        </div>
      </section>

      <!-- RIGHT: Output -->
      <section class="card" aria-live="polite">
        <div class="hd">
          <div>
            <p class="title">è¼¸å‡º</p>
            <div class="hint">å³é‚Šå°±æ˜¯ä½ çš„å°èªªï¼›å·¦é‚Šæ˜¯ä½ ä¸‹çš„ã€Œå’’èªã€ï¼ˆä¹Ÿå°±æ˜¯æç¤ºè©ï¼‰</div>
          </div>
          <div class="tabs">
            <div class="tab active" data-tab="result">çµæœ</div>
            <div class="tab" data-tab="log">Log</div>
            <div class="tab" data-tab="raw">Raw JSON</div>
          </div>
        </div>

        <div class="outbox">
          <div class="toolbar">
            <div class="status">
              <span class="dot" id="statusDot"></span>
              <span id="statusText">å¾…å‘½ä¸­ã€‚è«‹å…ˆé¸ä¾›æ‡‰å•†ã€å¡« keyï¼Œç„¶å¾ŒæŒ‰ã€Œç”Ÿæˆã€ã€‚</span>
            </div>
            <div class="kpi">
              <span class="chip" id="chipProvider">provider: -</span>
              <span class="chip" id="chipEndpoint">endpoint: -</span>
              <span class="chip" id="chipModel">model: -</span>
            </div>
          </div>

          <div class="pre" id="outResult"></div>
          <div class="pre" id="outLog" style="display:none; min-height: 360px;"></div>
          <div class="pre monos" id="outRaw" style="display:none; min-height: 360px;"></div>
        </div>
      </section>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const state = {
    lastText: "",
    lastRaw: null,
    lastLog: "",
    showKey: false,
    rememberKey: false,
    polish: true,
  };

  // ----- éš¨æ©Ÿç”Ÿæˆè³‡æ–™ -----
  // ä¸»é¡Œå€™é¸æ¸…å–®
  const randomThemes = [
    "ä¸€å ´ç©¿è¶Šæ™‚ç©ºçš„æ—…ç¨‹æ”¹è®Šäº†ä¸»è§’çš„ä¸€ç”Ÿ",
    "åœ¨æœ«æ—¥å»¢å¢Ÿä¸­å°‹æ‰¾äººæ€§çš„å…‰èŠ’",
    "AIèˆ‡äººé¡å…±ç”Ÿçš„å¥‡å¹»éƒ½å¸‚",
    "å¤±æ¥­å·¥ç¨‹å¸«æ„å¤–ç¹¼æ‰¿ä¸€åº§å¤è€æ›¸åº—",
    "å¤ªç©ºç§»æ°‘è¨ˆç•«èƒŒå¾Œçš„é™°è¬€",
    "å¹³å‡¡é«˜ä¸­ç”Ÿçªç„¶ç²å¾—è®€å¿ƒèƒ½åŠ›",
    "è·å ´èœé³¥èˆ‡æœªä¾†è‡ªå·±å±•é–‹å°è©±",
    "ç¶²ç´…ä¸»æ’­æ²å…¥è¶…è‡ªç„¶äº‹ä»¶",
    "ç ”ç©¶å“¡åœ¨å¤¢ä¸­æ§åˆ¶ç¾å¯¦"
  ];

  // äººè¨­å€™é¸æ¸…å–®ï¼Œæ¯ç­†åŒ…å«å¤šè¡Œæ–‡å­—
  const randomCharacters = [
    `ä¸»è§’ï¼šæ—å®¥ç©ï¼Œ26 æ­²å¹³å‡¡å·¥ç¨‹å¸«ï¼Œå…§å‘ç´°å¿ƒï¼Œç¼ºé»æ˜¯å„ªæŸ”å¯¡æ–·ï¼Œå¤¢æƒ³å¯«å‡ºä¸€æœ¬å°èªªã€‚\né…è§’ï¼šé™³ç‘‹åº­ï¼Œ28 æ­²é«˜ä¸­æ•™å¸«ï¼Œç†±æƒ…é–‹æœ—ï¼Œå­æƒ¡æ¬ºé¨™ï¼Œç›®æ¨™æ˜¯å¸¶å­¸ç”ŸåƒåŠ ç§‘å±•ã€‚\nåæ´¾ï¼šç¥ç§˜ AIï¼Œå¤–è¡¨å†·é…·ï¼Œæ“æœ‰å¼·å¤§è¨ˆç®—èƒ½åŠ›ï¼Œç›®æ¨™æ§åˆ¶äººé¡ã€‚`,
    `ä¸»è§’ï¼šå¼µå°æ…ˆï¼Œ18 æ­²å‰›ç•¢æ¥­çš„é«˜ä¸­ç”Ÿï¼Œå¤éˆç²¾æ€ªï¼Œç¼ºé»æ˜¯è¡å‹•æ˜“æ€’ï¼Œç›®æ¨™æ˜¯æ‰¾åˆ°å¤±è¹¤çš„å“¥å“¥ã€‚\né…è§’ï¼šå³ä¼¯ï¼Œ60 æ­²é€€ä¼‘è€å…µï¼Œæ²‰é»˜å¯¡è¨€ï¼Œæ“æœ‰ç¥ç§˜éå»ï¼Œç›®æ¨™æ˜¯å®ˆè­·å®¶é„‰ã€‚\nåæ´¾ï¼šé»‘å¹«è€å¤§ï¼Œå–„æ–¼æ“ç¸±äººå¿ƒï¼Œç›®æ¨™çµ±ä¸€åœ°ä¸‹ä¸–ç•Œã€‚`,
    `ä¸»è§’ï¼šé™³éœé›¯ï¼Œ30 æ­²ç§‘å¹»å°èªªå®¶ï¼Œå¤©é¦¬è¡Œç©ºï¼Œç¼ºé»æ˜¯æ‹–å»¶ç—‡åš´é‡ï¼Œå¤¢æƒ³å¯«å‡ºæš¢éŠ·ä½œå“ã€‚\né…è§’ï¼šç¾…ä¿®ï¼Œ24 æ­²è‡ªåª’é«”å‰ªè¼¯å¸«ï¼Œæç¬‘æ¨‚è§€ï¼Œç›®æ¨™æ˜¯å¢ç²‰ç™¾è¬ã€‚\nåæ´¾ï¼šè³‡æ·±ç·¨è¼¯ï¼ŒæŒ‘å‰”è‹›åˆ»ï¼Œç›®æ¨™æ˜¯é€¼ä¸»è§’æŒ‰æ™‚äº¤ç¨¿ã€‚`,
    `ä¸»è§’ï¼šé«˜å­ç¶­ï¼Œ40 æ­²è­¦æ¢ï¼Œå†·éœç†æ€§ï¼Œç¼ºé»æ˜¯éåº¦åŸ·è‘—ï¼Œç›®æ¨™æ˜¯ç ´è§£æ‡¸æ¡ˆã€‚\né…è§’ï¼šè¶™èªæ™¨ï¼Œ35 æ­²å¿ƒç†é†«å¸«ï¼Œå–„è§£äººæ„ï¼Œç›®æ¨™æ˜¯æ²»ç™’è‡ªå·±çš„å‰µå‚·ã€‚\nåæ´¾ï¼šé€£ç’°æ®ºæ‰‹ï¼Œè°æ˜ç‹¡çŒ¾ï¼Œç›®æ¨™æ˜¯æŒ‘æˆ°è­¦æ–¹åº•ç·šã€‚`,
    `ä¸»è§’ï¼šå‘¨é›…çªï¼Œ22 æ­²å¤§å­¸ç”Ÿï¼Œç„¡ç¥è«–è€…ï¼Œç¼ºé»æ˜¯ç¼ºä¹è‡ªä¿¡ï¼Œå¤¢æƒ³æˆç‚ºåµæ¢å°èªªå®¶ã€‚\né…è§’ï¼šæä¿Šï¼Œ22 æ­²è³‡å„ªç”Ÿï¼Œæ“…é•·é§­å®¢æŠ€è¡“ï¼Œç›®æ¨™æ˜¯ç ´è§£å­¸æ ¡çš„é»‘æš—ç§˜å¯†ã€‚\nåæ´¾ï¼šå­¸é™¢é™¢é•·ï¼Œè¡¨é¢æ…ˆç¥¥ï¼Œå…¶å¯¦æš—ä¸­é€²è¡Œéæ³•ç ”ç©¶ã€‚`
  ];

  // ä¸–ç•Œè§€å€™é¸æ¸…å–®
  const randomWorlds = [
    "è¿‘æœªä¾†çš„å°åŒ—ï¼Œç§‘æŠ€é€²æ­¥ä½†è²§å¯Œå·®è·åŠ åŠ‡ï¼Œæ”¿åºœæ¨è¡ŒåŸºå› æ”¹é€ æ”¿ç­–ã€‚",
    "é«˜é›„æŸå€‹è¢«è²¡åœ˜æŒæ§çš„å·¥æ¥­å€ï¼Œåœ°ä¸‹é‚„éš±è—è‘—å¤–æ˜Ÿæ–‡æ˜éºè·¡ã€‚",
    "æ¶ç©ºçš„å¥‡å¹»ç‹åœ‹ï¼Œé­”æ³•èƒ½é‡ä»¥æµ·æ½®ç‚ºæºï¼Œæœˆåœ“æ™‚åŠ›é‡æœ€å¼·ã€‚",
    "ç¾ä»£éƒ½å¸‚èˆ‡å¹³è¡Œå®‡å®™äº¤éŒ¯ï¼Œé€éç‰¹å®šé–€èƒ½ç©¿æ¢­ã€‚",
    "è’è•ªçš„ç«æ˜Ÿæ®–æ°‘åœ°ï¼Œè³‡æºåŒ±ä¹ï¼Œå”¯ä¸€æ°´æºè¢«ä¼æ¥­æ§åˆ¶ã€‚",
    "äºŒåä¸€ä¸–ç´€æœ«å…¨çƒè¢«å·¨å‹å…¬å¸çµ±æ²»ï¼Œäººå·¥å³¶æˆç‚ºå”¯ä¸€é¿é›£æ‰€ã€‚",
    "å¤è€çš„æ±æ–¹ç‹æœèˆ‡æ©Ÿæ¢°æ–‡æ˜äº¤èï¼Œè’¸æ±½é£›èˆ¹ä¾†å›ç©¿æ¢­ã€‚"
  ];

  const ui = {
    provider: $("provider"),
    openaiMode: $("openaiMode"),
    apiKey: $("apiKey"),
    model: $("model"),
    baseUrl: $("baseUrl"),
    temp: $("temp"),
    targetLen: $("targetLen"),
    genre: $("genre"),
    genreCustom: $("genreCustom"),
    pov: $("pov"),
    tone: $("tone"),
    theme: $("theme"),
    characters: $("characters"),
    world: $("world"),
    chapters: $("chapters"),
    format: $("format"),
    lang: $("lang"),
    btnGenerate: $("btnGenerate"),
    btnCopy: $("btnCopy"),
    btnDryRun: $("btnDryRun"),
    btnReset: $("btnReset"),
    btnToggleKey: $("btnToggleKey"),
    swRemember: $("swRemember"),
    swPolish: $("swPolish"),
    statusDot: $("statusDot"),
    statusText: $("statusText"),
    outResult: $("outResult"),
    outLog: $("outLog"),
    outRaw: $("outRaw"),
    chipProvider: $("chipProvider"),
    chipEndpoint: $("chipEndpoint"),
    chipModel: $("chipModel"),
    envPill: $("envPill"),
    fileBanner: $("fileBanner"),
    btnRandomTheme: $("btnRandomTheme"),
    btnRandomCharacters: $("btnRandomCharacters"),
    btnRandomWorld: $("btnRandomWorld"),
  };

  function setStatus(kind, text){
    ui.statusText.textContent = text;
    ui.statusDot.classList.remove("ok","bad");
    if(kind==="ok") ui.statusDot.classList.add("ok");
    else if(kind==="bad") ui.statusDot.classList.add("bad");
  }
  function appendLog(line){
    const ts = new Date().toLocaleTimeString();
    state.lastLog += `[${ts}] ${line}\n`;
    ui.outLog.textContent = state.lastLog;
  }

  function getGenre(){
    const g = ui.genre.value;
    return (g === "è‡ªè¨‚") ? (ui.genreCustom.value || "è‡ªè¨‚é¡å‹") : g;
  }

  function isFileProtocol(){
    return location.protocol === "file:";
  }

  function setProviderDefaults(){
    const p = ui.provider.value;
    const mode = ui.openaiMode.value;
    if(p === "openai"){
      ui.openaiMode.disabled = false;
      ui.model.placeholder = "ä¾‹å¦‚ï¼šgpt-4.1-mini / gpt-4o-mini ...";
      if(!ui.model.value) ui.model.value = "gpt-4.1-mini";
      if(!ui.baseUrl.value || ui.baseUrl.dataset.auto === "1"){
        ui.baseUrl.value = (mode === "responses")
          ? "https://api.openai.com/v1/responses"
          : "https://api.openai.com/v1/chat/completions";
        ui.baseUrl.dataset.auto = "1";
      }
    }else if(p === "gemini"){
      ui.openaiMode.disabled = true;
      ui.model.placeholder = "ä¾‹å¦‚ï¼šgemini-1.5-flash / gemini-1.5-pro ...";
      if(!ui.model.value) ui.model.value = "gemini-1.5-flash";
      if(!ui.baseUrl.value || ui.baseUrl.dataset.auto === "1"){
        ui.baseUrl.value = "https://generativelanguage.googleapis.com/v1beta";
        ui.baseUrl.dataset.auto = "1";
      }
    }else{
      ui.openaiMode.disabled = true;
      ui.model.placeholder = "è‡ªè¨‚å¾Œç«¯å¯å¿½ç•¥æˆ–ç•¶ä½œåƒæ•¸";
      if(!ui.model.value) ui.model.value = "";
      if(!ui.baseUrl.value || ui.baseUrl.dataset.auto === "1"){
        ui.baseUrl.value = "http://localhost:3000/api/generate";
        ui.baseUrl.dataset.auto = "1";
      }
    }
    syncChips();
  }

  function syncChips(){
    const p = ui.provider.value;
    ui.chipProvider.textContent = `provider: ${p}`;
    ui.chipModel.textContent = `model: ${ui.model.value || "-"}`;

    let ep = ui.baseUrl.value || "-";
    if(p==="gemini" && ui.model.value){
      ep = `${ui.baseUrl.value}/models/${ui.model.value}:generateContent`;
    }
    ui.chipEndpoint.textContent = `endpoint: ${shorten(ep, 40)}`;
  }

  function shorten(s, n){
    if(!s) return s;
    return s.length > n ? s.slice(0, n-1) + "â€¦" : s;
  }

  function buildPrompt(){
    const genre = getGenre();
    const lang = ui.lang.value;
    const polish = state.polish;

    const sys = [
      `ä½ æ˜¯ä¸€ä½å°ˆæ¥­å°èªªå¯«ä½œåŠ©æ‰‹ã€‚è«‹ç”¨ã€Œ${lang}ã€è¼¸å‡ºã€‚`,
      `ç›®æ¨™ï¼šç”¢å‡ºå¯è®€æ€§é«˜ã€æƒ…ç¯€æ¨é€²æ¸…æ¥šã€æ®µè½åˆ†æ˜çš„å°èªªã€‚`,
      `é¢¨æ ¼ï¼š${ui.tone.value}ã€‚é¡å‹ï¼š${genre}ã€‚è¦–è§’ï¼š${ui.pov.value}ã€‚`,
      `è¦æ±‚ï¼šä¸è¦è‡ªæˆ‘æ­éœ²ã€ä¸æåŠä½ æ˜¯ AIã€ä¸æè¿°ã€Œæˆ‘æ­£åœ¨ç”Ÿæˆã€ç­‰éç¨‹ã€‚`,
      polish ? `å»é‡æŒ‡ä»¤ï¼šé¿å…å¥å‹èˆ‡æªè¾­é‡è¤‡ï¼›æ¯æ®µç›¡é‡æœ‰ä¸åŒçš„ç¯€å¥èˆ‡è½‰æŠ˜ï¼›ä¸è¦é€£çºŒä½¿ç”¨ç›¸åŒé–‹é ­ã€‚` : ``,
    ].filter(Boolean).join("\n");

    const target = Number(ui.targetLen.value || 1200);
    const ch = Math.max(1, Math.min(20, Number(ui.chapters.value || 5)));

    const user = [
      `ã€ä¸»é¡Œã€‘${ui.theme.value || "ï¼ˆæœªå¡«ï¼‰"}`,
      `ã€ä¸»è¦äººè¨­ã€‘\n${ui.characters.value || "ï¼ˆæœªå¡«ï¼‰"}`,
      `ã€ä¸–ç•Œè§€/èƒŒæ™¯ã€‘\n${ui.world.value || "ï¼ˆå¯è‡ªç”±è£œå…¨ï¼‰"}`,
      ``,
      `ã€è¼¸å‡ºçµæ§‹ã€‘`,
      `1) æ›¸åï¼ˆ1 å€‹ï¼‰ + ä¸€å¥è©±è³£é»ï¼ˆ1 å¥ï¼‰`,
      `2) æ•…äº‹å¤§ç¶±ï¼ˆ8~12 é»ï¼Œæ¢åˆ—ï¼‰`,
      `3) æ­£æ–‡ï¼šåˆ†æˆ ${ch} ç« ï¼Œæ¯ç« æœ‰ç« åï¼›ç¸½é•·åº¦ç´„ ${target} å­—ä¸Šä¸‹ï¼ˆå…è¨±åˆç†æµ®å‹•ï¼‰`,
      ``,
      ui.format.value === "json"
        ? `ã€æ ¼å¼ã€‘è«‹è¼¸å‡ºã€Œåš´æ ¼ JSONã€ï¼Œä¸è¦ä½¿ç”¨åå¼•è™Ÿï¼Œä¸è¦é™„åŠ è¨»è§£ã€‚å»ºè­°çµæ§‹ï¼š` +
          `{"title":"","hook":"","outline":[...], "chapters":[{"no":1,"title":"","content":""}, ...]}`
        : `ã€æ ¼å¼ã€‘ç´”æ–‡å­—å³å¯ï¼Œæ®µè½æ¸…æ¥šã€å°è©±ç”¨å…¨å½¢å¼•è™Ÿæ›´å¥½ã€‚`,
    ].join("\n");

    return { sys, user };
  }

  // ---- API Callers ----
  async function callOpenAI({ baseUrl, mode, key, model, temperature, prompt }){
    const headers = {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${key}`,
    };

    let body;
    if(mode === "chat"){
      body = {
        model,
        messages: [
          { role: "system", content: prompt.sys },
          { role: "user", content: prompt.user },
        ],
        temperature,
      };
    }else{
      // Responses API (best-effort compatible)
      body = {
        model,
        input: [
          { role: "system", content: prompt.sys },
          { role: "user", content: prompt.user },
        ],
        temperature,
      };
    }

    appendLog(`OpenAI request -> ${baseUrl}`);
    const res = await fetch(baseUrl, { method:"POST", headers, body: JSON.stringify(body) });
    const rawText = await res.text();
    let data;
    try{ data = JSON.parse(rawText); }catch{ data = { _raw: rawText }; }
    if(!res.ok) throw { status: res.status, data, rawText };

    const text = extractTextFromAny(data);
    return { data, text };
  }

  async function callGemini({ baseUrl, key, model, temperature, prompt }){
    // ä½¿ç”¨ x-goog-api-key header å‘¼å« Google AI Studio (Gemini) API
    const url = `${baseUrl}/models/${encodeURIComponent(model)}:generateContent`;
    const body = {
      contents: [
        { role: "user", parts: [{ text: `${prompt.sys}\n\n${prompt.user}` }] }
      ],
      generationConfig: {
        temperature,
      }
    };
    appendLog(`Gemini request -> ${url}`);
    const res = await fetch(url, {
      method:"POST",
      headers: {
        "Content-Type":"application/json",
        "x-goog-api-key": key
      },
      body: JSON.stringify(body)
    });
    const rawText = await res.text();
    let data;
    try{ data = JSON.parse(rawText); }catch{ data = { _raw: rawText }; }
    if(!res.ok) throw { status: res.status, data, rawText };

    const text = extractTextFromAny(data);
    return { data, text };
  }

  async function callCustom({ baseUrl, key, model, temperature, prompt }){
    // You control your backend. We'll send a friendly payload.
    const body = {
      apiKey: key || null,
      model: model || null,
      temperature,
      system: prompt.sys,
      input: prompt.user,
      meta: { format: ui.format.value, lang: ui.lang.value }
    };
    appendLog(`Custom request -> ${baseUrl}`);
    const res = await fetch(baseUrl, { method:"POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(body) });
    const rawText = await res.text();
    let data;
    try{ data = JSON.parse(rawText); }catch{ data = { _raw: rawText }; }
    if(!res.ok) throw { status: res.status, data, rawText };

    const text = (data && (data.text || data.output || data.content)) ? (data.text || data.output || data.content) : extractTextFromAny(data);
    return { data, text };
  }

  function extractTextFromAny(data){
    // OpenAI chat.completions
    if(data?.choices?.[0]?.message?.content) return data.choices[0].message.content;

    // OpenAI responses
    if(typeof data?.output_text === "string") return data.output_text;

    // Try typical responses shapes
    if(Array.isArray(data?.output)){
      for(const item of data.output){
        if(Array.isArray(item?.content)){
          for(const c of item.content){
            if(typeof c?.text === "string") return c.text;
            if(typeof c?.content === "string") return c.content;
          }
        }
      }
    }

    // Gemini
    if(data?.candidates?.[0]?.content?.parts?.[0]?.text) return data.candidates[0].content.parts[0].text;

    // Fallback: stringify
    try{ return JSON.stringify(data, null, 2); }catch{ return String(data); }
  }

  function classifyError(err){
    // err: {status, data, rawText}
    const status = err?.status;
    const msg = err?.data?.error?.message || err?.data?.message || err?.data?.error || err?.rawText || "æœªçŸ¥éŒ¯èª¤";
    return { status, msg: String(msg) };
  }

  // ---- UI actions ----
  function setTab(name){
    document.querySelectorAll(".tab").forEach(t=>{
      const active = t.dataset.tab === name;
      t.classList.toggle("active", active);
    });
    ui.outResult.style.display = (name==="result") ? "block" : "none";
    ui.outLog.style.display    = (name==="log") ? "block" : "none";
    ui.outRaw.style.display    = (name==="raw") ? "block" : "none";
  }

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=> setTab(t.dataset.tab));
  });

  function toggleSwitch(swEl, keyName){
    const on = !swEl.classList.contains("on");
    swEl.classList.toggle("on", on);
    swEl.setAttribute("aria-checked", on ? "true" : "false");
    if(keyName === "remember"){ state.rememberKey = on; persist(); }
    if(keyName === "polish"){ state.polish = on; }
  }

  ui.swRemember.addEventListener("click", ()=> toggleSwitch(ui.swRemember, "remember"));
  ui.swPolish.addEventListener("click", ()=> toggleSwitch(ui.swPolish, "polish"));
  ui.swRemember.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleSwitch(ui.swRemember,"remember"); }});
  ui.swPolish.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleSwitch(ui.swPolish,"polish"); }});

  ui.btnToggleKey.addEventListener("click", ()=>{
    state.showKey = !state.showKey;
    ui.apiKey.type = state.showKey ? "text" : "password";
    ui.btnToggleKey.textContent = state.showKey ? "ğŸ™ˆ" : "ğŸ‘ï¸";
  });

  ui.provider.addEventListener("change", ()=>{
    ui.baseUrl.dataset.auto = "1";
    setProviderDefaults();
  });
  ui.openaiMode.addEventListener("change", ()=>{
    ui.baseUrl.dataset.auto = "1";
    setProviderDefaults();
  });

  ["model","baseUrl","temp","targetLen","genre","genreCustom","pov","tone"].forEach(id=>{
    $(id).addEventListener("input", syncChips);
  });

  ui.btnCopy.addEventListener("click", async ()=>{
    const text = state.lastText || ui.outResult.textContent || "";
    try{
      await navigator.clipboard.writeText(text);
      setStatus("ok", "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚å»å§ï¼Œæ‹¿å»é¤µä½ çš„æ’ç‰ˆå™¨ã€‚");
      appendLog("Copied output to clipboard.");
    }catch{
      setStatus("bad", "è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨å¯èƒ½ä¸çµ¦å‰ªè²¼ç°¿æ¬Šé™ï¼‰ã€‚");
      appendLog("Clipboard copy failed.");
    }
  });

  ui.btnDryRun.addEventListener("click", ()=>{
    const p = ui.provider.value;
    const mode = ui.openaiMode.value;
    const prompt = buildPrompt();
    const temperature = Number(ui.temp.value || 0.8);
    const baseUrl = ui.baseUrl.value.trim();
    const model = ui.model.value.trim();
    const payload = (p==="openai")
      ? (mode==="chat"
          ? { baseUrl, headers: {Authorization:"Bearer â€¦"}, body: { model, messages:[{role:"system",content:prompt.sys},{role:"user",content:prompt.user}], temperature } }
          : { baseUrl, headers: {Authorization:"Bearer â€¦"}, body: { model, input:[{role:"system",content:prompt.sys},{role:"user",content:prompt.user}], temperature } })
      : (p==="gemini"
          ? { url: `${baseUrl}/models/${model}:generateContent?key=â€¦`, body: { contents:[{role:"user",parts:[{text:prompt.sys+"\\n\\n"+prompt.user}]}], generationConfig:{temperature} } }
          : { baseUrl, body: { apiKey:"â€¦(optional)", model, temperature, system: prompt.sys, input: prompt.user } });

    state.lastRaw = payload;
    ui.outRaw.textContent = JSON.stringify(payload, null, 2);
    setTab("raw");
    setStatus("ok","å·²é¡¯ç¤ºä½ å³å°‡é€å‡ºçš„è«‹æ±‚å…§å®¹ï¼ˆDry Runï¼‰ã€‚");
    appendLog("Dry run payload displayed.");
  });

  // éš¨æ©Ÿå¡«å…¥ä¸»é¡Œã€äººè¨­èˆ‡èƒŒæ™¯
  if(ui.btnRandomTheme){
    ui.btnRandomTheme.addEventListener("click", ()=>{
      const r = randomThemes[Math.floor(Math.random() * randomThemes.length)];
      ui.theme.value = r;
      persist();
    });
  }
  if(ui.btnRandomCharacters){
    ui.btnRandomCharacters.addEventListener("click", ()=>{
      const r = randomCharacters[Math.floor(Math.random() * randomCharacters.length)];
      ui.characters.value = r;
      persist();
    });
  }
  if(ui.btnRandomWorld){
    ui.btnRandomWorld.addEventListener("click", ()=>{
      const r = randomWorlds[Math.floor(Math.random() * randomWorlds.length)];
      ui.world.value = r;
      persist();
    });
  }

  ui.btnReset.addEventListener("click", ()=>{
    // keep provider
    ui.apiKey.value = "";
    ui.theme.value = "";
    ui.characters.value = "";
    ui.world.value = "";
    ui.genre.value = "ç¾ä»£æ—¥å¸¸";
    ui.genreCustom.value = "";
    ui.pov.value = "ç¬¬ä¸€äººç¨±";
    ui.tone.value = "è‡ªç„¶å£èªã€ç¯€å¥æ˜å¿«";
    ui.chapters.value = 5;
    ui.format.value = "text";
    ui.lang.value = "ç¹é«”ä¸­æ–‡";
    ui.temp.value = 0.8;
    ui.targetLen.value = 1200;
    ui.baseUrl.dataset.auto = "1";
    ui.model.value = "";
    state.lastText = "";
    state.lastRaw = null;
    state.lastLog = "";
    ui.outResult.textContent = "";
    ui.outRaw.textContent = "";
    ui.outLog.textContent = "";
    setStatus(null, "å·²é‡ç½®ï¼ˆä¾›æ‡‰å•†ä¿ç•™ï¼‰ã€‚");
    appendLog("Reset.");
    setProviderDefaults();
    persist();
  });

  function persist(){
    const save = {
      provider: ui.provider.value,
      openaiMode: ui.openaiMode.value,
      model: ui.model.value,
      baseUrl: ui.baseUrl.value,
      temp: ui.temp.value,
      targetLen: ui.targetLen.value,
      genre: ui.genre.value,
      genreCustom: ui.genreCustom.value,
      pov: ui.pov.value,
      tone: ui.tone.value,
      chapters: ui.chapters.value,
      format: ui.format.value,
      lang: ui.lang.value,
      rememberKey: state.rememberKey,
      polish: state.polish,
    };
    localStorage.setItem("novel_ui_cfg", JSON.stringify(save));
    if(state.rememberKey){
      localStorage.setItem("novel_ui_key", ui.apiKey.value || "");
    }else{
      localStorage.removeItem("novel_ui_key");
    }
  }

  function restore(){
    try{
      const cfg = JSON.parse(localStorage.getItem("novel_ui_cfg") || "{}");
      if(cfg.provider) ui.provider.value = cfg.provider;
      if(cfg.openaiMode) ui.openaiMode.value = cfg.openaiMode;

      state.rememberKey = !!cfg.rememberKey;
      state.polish = (cfg.polish !== undefined) ? !!cfg.polish : true;

      ui.swRemember.classList.toggle("on", state.rememberKey);
      ui.swRemember.setAttribute("aria-checked", state.rememberKey ? "true" : "false");

      ui.swPolish.classList.toggle("on", state.polish);
      ui.swPolish.setAttribute("aria-checked", state.polish ? "true" : "false");

      if(cfg.model) ui.model.value = cfg.model;
      if(cfg.baseUrl) { ui.baseUrl.value = cfg.baseUrl; ui.baseUrl.dataset.auto = "0"; }
      if(cfg.temp) ui.temp.value = cfg.temp;
      if(cfg.targetLen) ui.targetLen.value = cfg.targetLen;
      if(cfg.genre) ui.genre.value = cfg.genre;
      if(cfg.genreCustom) ui.genreCustom.value = cfg.genreCustom;
      if(cfg.pov) ui.pov.value = cfg.pov;
      if(cfg.tone) ui.tone.value = cfg.tone;
      if(cfg.chapters) ui.chapters.value = cfg.chapters;
      if(cfg.format) ui.format.value = cfg.format;
      if(cfg.lang) ui.lang.value = cfg.lang;

      if(state.rememberKey){
        ui.apiKey.value = localStorage.getItem("novel_ui_key") || "";
      }
    }catch(e){
      // ignore
    }
  }

  ["input","change"].forEach(ev=>{
    ["provider","openaiMode","model","baseUrl","temp","targetLen","genre","genreCustom","pov","tone","chapters","format","lang","apiKey"].forEach(id=>{
      $(id).addEventListener(ev, persist);
    });
  });

  ui.btnGenerate.addEventListener("click", async ()=>{
    const provider = ui.provider.value;
    const key = (ui.apiKey.value || "").trim();
    const model = (ui.model.value || "").trim();
    const baseUrl = (ui.baseUrl.value || "").trim();
    const mode = ui.openaiMode.value;
    const temperature = Number(ui.temp.value || 0.8);

    setProviderDefaults();
    syncChips();

    if(isFileProtocol()){
      setStatus("bad", "ä½ ç¾åœ¨æ˜¯ file:// é–‹å•Ÿï¼Œå»ºè­°ç”¨ http://localhost è·‘èµ·ä¾†ï¼Œä¸ç„¶ CORS æœƒä¸€ç›´æ—è›‹ã€‚");
      appendLog("Blocked: running on file:// (origin null).");
      return;
    }

    if(!baseUrl){
      setStatus("bad", "Base URL ä¸èƒ½ç©ºã€‚");
      return;
    }

    if(provider !== "custom" && !key){
      setStatus("bad","ä½ é‚„æ²’å¡« API Keyã€‚");
      return;
    }

    if(provider !== "custom" && !model){
      setStatus("bad","ä½ é‚„æ²’å¡« modelã€‚");
      return;
    }

    // quick sanity hint: åµæ¸¬éŒ¯èª¤çš„ API key æ ¼å¼
    if(key.startsWith("sk-")){
      setStatus("bad","ä½ è¼¸å…¥çš„æ˜¯ OpenAI çš„ sk- é–‹é ­ keyï¼Œè«‹ä½¿ç”¨ Google AI Studio çš„ keyï¼ˆé€šå¸¸ç‚º AIza æˆ–å…¶ä»–æ ¼å¼ï¼‰ã€‚");
      return;
    }

    ui.btnGenerate.disabled = true;
    setStatus(null, "ç”Ÿæˆä¸­â€¦ï¼ˆå¦‚æœå¡ä½ï¼Œé€šå¸¸ä¸æ˜¯ä½ çš„äººè¨­å¤ªè¤‡é›œï¼Œæ˜¯ä½ ç«¯é»æˆ– key å¤ªå€”å¼·ï¼‰");
    appendLog("Generate clicked.");

    const prompt = buildPrompt();

    try{
      let result;
      if(provider === "openai"){
        result = await callOpenAI({ baseUrl, mode, key, model, temperature, prompt });
      }else if(provider === "gemini"){
        result = await callGemini({ baseUrl, key, model, temperature, prompt });
      }else{
        result = await callCustom({ baseUrl, key, model, temperature, prompt });
      }

      state.lastRaw = result.data;
      state.lastText = result.text || "";
      ui.outResult.textContent = state.lastText || "(ç©ºç™½è¼¸å‡º)";

      ui.outRaw.textContent = JSON.stringify(result.data, null, 2);
      setTab("result");
      setStatus("ok", "å®Œæˆï¼å³é‚Šæ˜¯å°èªªï¼›å¦‚æœä½ è¦ºå¾—å¤ªå¥½çœ‹ï¼Œè«‹è¨˜å¾—æ˜¯ä½ æç¤ºè©ä¸‹å¾—å¥½ï¼ˆæˆ‘åªæ˜¯æ‰“å­—å“¡ï¼‰ã€‚");
      appendLog("Success.");
    }catch(err){
      const {status, msg} = classifyError(err);
      state.lastRaw = err?.data || err;
      ui.outRaw.textContent = JSON.stringify(state.lastRaw, null, 2);

      // Friendly diagnosis for common cases
      let hint = "";
      if(status === 401){
        hint = "ï¼ˆ401ï¼šæœªæˆæ¬Š/Key éŒ¯èª¤ã€‚æœ€å¸¸è¦‹æ˜¯ä¾›æ‡‰å•†é¸éŒ¯ã€key æ ¼å¼ä¸å°ï¼Œæˆ–æ‰“éŒ¯ endpointã€‚ï¼‰";
      }else if(status === 429){
        hint = "ï¼ˆ429ï¼šé€Ÿç‡/é…é¡è¶…é™ã€‚é™ä½è«‹æ±‚é »ç‡ã€æ› key æˆ–æª¢æŸ¥æ–¹æ¡ˆ/é¡åº¦ã€‚ï¼‰";
      }else if(status === 0 || !status){
        hint = "ï¼ˆå¯èƒ½æ˜¯ CORSã€ç¶²è·¯ã€æˆ– Base URL æ ¹æœ¬æ²’è·‘èµ·ä¾†ã€‚ï¼‰";
      }

      ui.outResult.textContent = `è«‹æ±‚å¤±æ•—ï¼š${status || "?"}\n${msg}\n${hint}`;
      setTab("result");
      setStatus("bad", `å¤±æ•—ï¼š${status || "?"} ${hint}`);
      appendLog(`Error: ${status || "?"} ${msg}`);
    }finally{
      ui.btnGenerate.disabled = false;
      syncChips();
    }
  });

  // boot
  ui.envPill.textContent = `protocol: ${location.protocol}`;
  if(isFileProtocol()){
    ui.fileBanner.style.display = "block";
  }

  restore();
  setProviderDefaults();
  syncChips();
  setStatus(null,"å¾…å‘½ä¸­ã€‚é¸ä¾›æ‡‰å•†ã€å¡« keyã€æŒ‰ç”Ÿæˆå°±é–‹å¯«ã€‚");
})();
</script>
</body>
</html>