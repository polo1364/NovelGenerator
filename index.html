<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°èªªç”Ÿæˆå™¨ | AI å‰µä½œå·¥åŠ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;600;700&family=LXGW+WenKai+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #1a1a2e;
        --primary-light: #16213e;
        --accent: #e94560;
        --accent-hover: #ff6b6b;
        --gold: #f4a261;
        --gold-light: #f8c291;
        --text: #2d3436;
        --text-light: #636e72;
        --bg: #fefefe;
        --card-bg: #ffffff;
        --section-bg: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        --input-bg: #fff;
        --border: #e0e0e0;
        --shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 15px 50px rgba(0, 0, 0, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'LXGW WenKai TC', 'Noto Serif TC', serif;
        background: var(--bg);
        background-image: 
          radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.03) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(244, 162, 97, 0.03) 0%, transparent 50%),
          linear-gradient(180deg, #fefefe 0%, #f8f9fa 100%);
        color: var(--text);
        min-height: 100vh;
        padding: 40px 20px 80px;
      }

      /* é ‚éƒ¨è£é£¾æ¢ */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--gold), var(--accent));
        z-index: 1000;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
      }

      /* é ­éƒ¨å€åŸŸ */
      header {
        text-align: center;
        margin-bottom: 50px;
        position: relative;
      }

      header::after {
        content: 'âœ¦';
        display: block;
        font-size: 1.5rem;
        color: var(--gold);
        margin-top: 20px;
        animation: twinkle 2s ease-in-out infinite;
      }

      @keyframes twinkle {
        0%, 100% { opacity: 0.5; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
      }

      h1 {
        font-family: 'Noto Serif TC', serif;
        font-size: 3rem;
        font-weight: 700;
        margin: 0;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: 0.1em;
      }

      .subtitle {
        margin-top: 16px;
        color: var(--text-light);
        font-size: 1.1rem;
        line-height: 1.8;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      /* ä¸»å¡ç‰‡ */
      .card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: var(--shadow);
        padding: 40px;
        margin-bottom: 30px;
        border: 1px solid rgba(0, 0, 0, 0.03);
        transition: box-shadow 0.3s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-hover);
      }

      /* å€å¡Šæ¨£å¼ */
      .section {
        background: var(--section-bg);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }

      .section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, var(--accent), var(--gold));
        border-radius: 4px 0 0 4px;
      }

      .section-title {
        font-family: 'Noto Serif TC', serif;
        font-weight: 600;
        font-size: 1.3rem;
        color: var(--primary);
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title::before {
        content: attr(data-icon);
        font-size: 1.2rem;
      }

      /* è¼¸å…¥çµ„ä»¶ */
      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--primary);
        font-size: 0.95rem;
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .label-row label {
        font-weight: 500;
        color: var(--primary);
        margin-bottom: 0;
      }

      input[type="text"],
      input[type="number"],
      input[type="password"],
      select,
      textarea {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid var(--border);
        border-radius: 12px;
        background: var(--input-bg);
        font-family: inherit;
        font-size: 1rem;
        color: var(--text);
        transition: all 0.3s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.1);
      }

      textarea {
        min-height: 100px;
        resize: vertical;
        line-height: 1.6;
      }

      select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23636e72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px;
        padding-right: 45px;
      }

      /* API é‡‘é‘°å®¹å™¨ */
      .api-key-container {
        display: flex;
        gap: 10px;
      }

      .api-key-container input {
        flex: 1;
      }

      /* æŒ‰éˆ•æ¨£å¼ */
      button {
        font-family: inherit;
        font-size: 0.95rem;
        font-weight: 500;
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.4s, height 0.4s;
      }

      button:active::after {
        width: 300px;
        height: 300px;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent) 0%, #ff6b6b 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
      }

      .btn-secondary {
        background: var(--primary);
        color: #fff;
      }

      .btn-secondary:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
      }

      .btn-outline {
        background: transparent;
        color: var(--text);
        border: 2px solid var(--border);
      }

      .btn-outline:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .btn-gold {
        background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
        color: var(--primary);
        box-shadow: 0 4px 15px rgba(244, 162, 97, 0.3);
      }

      .btn-gold:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 162, 97, 0.4);
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 0.85rem;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }

      /* ä¸»æŒ‰éˆ•å€ */
      .buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 10px;
      }

      /* äººç‰©è¨­å®šå€ */
      .character-row {
        display: grid;
        grid-template-columns: 70px 75px 75px repeat(6, 1fr) auto auto;
        gap: 10px;
        margin-bottom: 14px;
        align-items: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
      }

      .character-row:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 12px rgba(233, 69, 96, 0.08);
      }

      .char-index {
        font-weight: 600;
        color: var(--accent);
        font-size: 0.9rem;
      }

      .character-row input,
      .character-row select {
        padding: 10px 12px;
        font-size: 0.9rem;
      }

      .character-row .char-gender,
      .character-row .char-age {
        padding: 10px 8px;
      }

      .character-row button {
        padding: 10px 14px;
        white-space: nowrap;
      }
      
      .char-remove-btn {
        color: #999;
        border-color: #ddd;
      }
      
      .char-remove-btn:hover {
        color: #e94560;
        border-color: #e94560;
        background: rgba(233, 69, 96, 0.1);
      }

      @media (max-width: 1200px) {
        .character-row {
          grid-template-columns: 70px 75px 75px 1fr 1fr 1fr auto auto;
        }
        .character-row .char-weakness,
        .character-row .char-secret,
        .character-row .char-relation {
          grid-column: span 1;
        }
      }

      @media (max-width: 768px) {
        .character-row {
          grid-template-columns: 1fr 1fr;
        }
        .char-index {
          grid-column: 1 / -1;
        }
        .character-row .char-gender,
        .character-row .char-age {
          width: 100%;
        }
        .char-random-btn, .char-remove-btn {
          justify-self: end;
        }
      }

      @media (max-width: 500px) {
        .character-row {
          grid-template-columns: 1fr;
        }
        .character-row button {
          width: 100%;
        }
      }

      /* ç‹€æ…‹è¨Šæ¯ */
      .status {
        margin-top: 16px;
        padding: 14px 20px;
        border-radius: 10px;
        font-size: 0.95rem;
        display: none;
        align-items: center;
        gap: 10px;
      }

      .status.show {
        display: flex;
      }

      .status.loading {
        background: linear-gradient(90deg, #f8f9fa, #e9ecef, #f8f9fa);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        color: var(--text);
      }

      .status.success {
        background: #d4edda;
        color: #155724;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
      }

      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      .status-icon {
        font-size: 1.2rem;
      }

      /* è¼¸å‡ºå€ */
      .output {
        margin-top: 30px;
        padding: 40px;
        border: 2px solid var(--border);
        border-radius: 16px;
        background: linear-gradient(180deg, #fff 0%, #fafafa 100%);
        font-family: 'Noto Serif TC', serif;
        font-size: 1.15rem;
        line-height: 2;
        white-space: pre-wrap;
        color: var(--text);
        min-height: 200px;
        position: relative;
      }

      .output:empty::before {
        content: 'ç”Ÿæˆçš„æ•…äº‹å°‡æœƒåœ¨é€™è£¡é¡¯ç¤º...';
        color: #adb5bd;
        font-style: italic;
      }

      .output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .output-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--primary);
      }

      /* ======================= */
      /* æ›¸ç±¤åŠŸèƒ½ - å¤§å¹…å„ªåŒ– */
      /* ======================= */
      .bookmark-card {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: #fff;
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow);
      }

      .bookmark-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .bookmark-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .bookmark-title::before {
        content: 'ğŸ“š';
        font-size: 1.4rem;
      }

      .bookmark-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 400;
      }

      .bookmark-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .bookmark-actions button {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .bookmark-actions button:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      /* æ›¸ç±¤æœå°‹èˆ‡æ’åº */
      .bookmark-toolbar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .bookmark-search {
        flex: 1;
        min-width: 200px;
        position: relative;
      }

      .bookmark-search input {
        padding-left: 45px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
      }

      .bookmark-search input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .bookmark-search input:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: none;
      }

      .bookmark-search::before {
        content: 'ğŸ”';
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1rem;
        z-index: 1;
      }

      .bookmark-sort {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        min-width: 140px;
      }

      .bookmark-sort option {
        background: var(--primary);
        color: #fff;
      }

      /* æ›¸ç±¤åˆ—è¡¨ */
      .bookmark-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
      }

      .bookmark-list::-webkit-scrollbar {
        width: 6px;
      }

      .bookmark-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      .bookmark-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .bookmark-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      .bookmark-item:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateX(4px);
      }

      .bookmark-item-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
      }

      .bookmark-item-content {
        flex: 1;
        min-width: 0;
      }

      .bookmark-item-title {
        font-weight: 500;
        font-size: 1rem;
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .bookmark-item-meta {
        display: flex;
        gap: 16px;
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .bookmark-item-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .bookmark-item-actions button {
        padding: 8px 12px;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        border: none;
      }

      .bookmark-item-actions button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .bookmark-item-actions .btn-load {
        background: var(--gold);
        color: var(--primary);
      }

      .bookmark-item-actions .btn-load:hover {
        background: var(--gold-light);
      }

      .bookmark-empty {
        text-align: center;
        padding: 40px;
        opacity: 0.7;
      }

      .bookmark-empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
      }

      /* æ›¸ç±¤ç·¨è¼¯å½ˆçª— */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        padding: 20px;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: #fff;
        border-radius: 20px;
        padding: 32px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.3s ease;
        color: var(--text);
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
      }

      .modal-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 24px 0;
        color: var(--primary);
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      /* ç« ç¯€å°èˆª - æ™ºèƒ½æµ®å‹•å¼ */
      .chapter-nav-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 999;
        display: none;
      }

      .chapter-nav-container.show {
        display: block;
      }

      .chapter-nav-toggle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent) 0%, #ff6b6b 100%);
        color: #fff;
        border: none;
        box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .chapter-nav-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(233, 69, 96, 0.5);
      }

      .chapter-nav-toggle .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--primary);
        color: #fff;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
      }

      .chapter-nav-panel {
        position: absolute;
        top: 0;
        right: 60px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        padding: 16px;
        min-width: 250px;
        max-width: 350px;
        max-height: 70vh;
        overflow-y: auto;
        opacity: 0;
        visibility: hidden;
        transform: translateX(20px);
        transition: all 0.3s ease;
      }

      .chapter-nav-panel.open {
        opacity: 1;
        visibility: visible;
        transform: translateX(0);
      }

      .chapter-nav-panel::-webkit-scrollbar {
        width: 4px;
      }

      .chapter-nav-panel::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
      }

      .chapter-nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .chapter-nav-title {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
      }

      .chapter-nav-close {
        background: none;
        border: none;
        color: var(--text-light);
        cursor: pointer;
        padding: 4px;
        font-size: 1.2rem;
        line-height: 1;
      }

      .chapter-nav-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .chapter-nav-list button {
        padding: 10px 14px;
        font-size: 0.85rem;
        background: #f8f9fa;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 8px;
        text-align: left;
        transition: all 0.2s ease;
      }

      .chapter-nav-list button:hover {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
        transform: translateX(4px);
      }

      .chapter-nav-list button.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }

      .chapter-nav-list button .chapter-num {
        display: inline-block;
        background: rgba(0,0,0,0.1);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        margin-right: 8px;
      }

      .chapter-nav-list button.active .chapter-num {
        background: rgba(255,255,255,0.2);
      }

      /* é–±è®€é€²åº¦æŒ‡ç¤ºå™¨ */
      .reading-progress {
        position: fixed;
        top: 4px;
        left: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--gold));
        z-index: 1001;
        transition: width 0.1s ease;
      }

      @media (max-width: 768px) {
        .chapter-nav-container {
          top: auto;
          bottom: 20px;
          right: 16px;
        }

        .chapter-nav-panel {
          right: 0;
          top: auto;
          bottom: 60px;
          max-width: calc(100vw - 32px);
        }
      }

      /* å‹•ç•« */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card, .bookmark-card {
        animation: fadeInUp 0.6s ease-out;
      }

      .card:nth-child(2) { animation-delay: 0.1s; }
      .bookmark-card { animation-delay: 0.2s; }

      /* éŸ¿æ‡‰å¼ */
      @media (max-width: 768px) {
        body {
          padding: 20px 16px 60px;
        }

        h1 {
          font-size: 2rem;
        }

        .card {
          padding: 24px;
        }

        .section {
          padding: 20px;
        }

        .output {
          padding: 24px;
          font-size: 1.05rem;
        }

        .bookmark-card {
          padding: 20px;
        }

        .buttons {
          flex-direction: column;
        }

        .buttons button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>å°èªªç”Ÿæˆå™¨</h1>
        <p class="subtitle">
          çµåˆ AI çš„ç„¡é™å‰µæ„ï¼Œæ‰“é€ å°ˆå±¬æ–¼ä½ çš„é•·ç¯‡æ•…äº‹<br>
          è¨­å®šä¸»é¡Œã€äººç‰©ã€èƒŒæ™¯ï¼Œä¸€éµç”Ÿæˆç²¾å½©å°èªª
        </p>
      </header>

      <div class="card">
        <!-- åŸºæœ¬è¨­å®š -->
        <div class="section">
          <h2 class="section-title" data-icon="âš™ï¸">åŸºæœ¬è¨­å®š</h2>
          <div class="input-group">
            <label for="apiKey">Gemini API é‡‘é‘°</label>
            <div class="api-key-container">
              <input
                type="password"
                id="apiKey"
                placeholder="è«‹è¼¸å…¥æ‚¨çš„ API é‡‘é‘°"
                autocomplete="off"
              />
              <button type="button" id="toggleApiKeyVisibility" class="btn-outline btn-small">é¡¯ç¤º</button>
            </div>
          </div>
          <div class="input-group">
            <label for="model">é¸æ“‡æ¨¡å‹</label>
            <select id="model">
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-pro">Gemini Pro</option>
            </select>
          </div>
        </div>

        <!-- æ•…äº‹å…ƒç´  -->
        <div class="section">
          <h2 class="section-title" data-icon="ğŸ“–">æ•…äº‹å…ƒç´ </h2>
          <div class="input-group">
            <label for="theme">ä¸»é¡Œ</label>
            <select id="theme">
              <option value="">è«‹é¸æ“‡ä¸»é¡Œ</option>
            </select>
          </div>
          <div class="input-group">
            <label for="setting">èƒŒæ™¯è¨­å®š</label>
            <select id="setting">
              <option value="">è«‹é¸æ“‡èƒŒæ™¯</option>
            </select>
          </div>
          <div class="input-group">
            <div class="label-row">
              <label>ä¸»è¦äººç‰©è¨­å®š</label>
              <div style="display: flex; gap: 8px;">
                <button id="randomAllCharactersBtn" type="button" class="btn-outline btn-small">ğŸ² éš¨æ©Ÿäººç‰©</button>
                <button id="addCharacterBtn" type="button" class="btn-outline btn-small">+ æ–°å¢äººç‰©</button>
              </div>
            </div>
            <div id="charactersContainer"></div>
          </div>
          <div class="input-group">
            <label for="style">æ•…äº‹é¢¨æ ¼</label>
            <select id="style">
              <option value="">è«‹é¸æ“‡é¢¨æ ¼</option>
            </select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="input-group" style="margin-bottom: 0;">
              <label for="chapters">ç« ç¯€æ•¸</label>
              <input type="number" id="chapters" placeholder="å¦‚ï¼š10" min="1" max="50" step="1" />
            </div>
            <div class="input-group" style="margin-bottom: 0;">
              <label for="length">é è¨ˆç¸½å­—æ•¸</label>
              <input type="number" id="length" placeholder="å¦‚ï¼š50000" min="1000" max="200000" step="1000" />
            </div>
          </div>
        </div>

        <!-- å…¶ä»–èªªæ˜ -->
        <div class="section">
          <h2 class="section-title" data-icon="âœï¸">å…¶ä»–èªªæ˜</h2>
          <div class="input-group" style="margin-bottom: 0;">
            <label for="notes">è£œå……èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="notes" placeholder="å¦‚æœ‰é¡å¤–æƒ…ç¯€æˆ–é¢¨æ ¼è¦æ±‚ï¼Œå¯åœ¨æ­¤è£œå……ã€‚ä¾‹å¦‚ï¼šå¸Œæœ›ä¸»è§’æœ‰åè½‰çš„çµå±€ã€åŠ å…¥æ™‚é–“æ—…è¡Œå…ƒç´ ç­‰ã€‚"></textarea>
          </div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="buttons">
          <button id="randomBtn" type="button" class="btn-gold">ğŸ² éš¨æ©Ÿå¡«å……</button>
          <button id="generateBtn" type="button" class="btn-primary">âœ¨ é–‹å§‹ç”Ÿæˆ</button>
          <button id="continueBtn" type="button" class="btn-secondary" disabled>â¤ ç¹¼çºŒç”Ÿæˆ</button>
          <button id="downloadBtn" type="button" class="btn-outline" disabled>â¬‡ ä¸‹è¼‰å°èªª</button>
        </div>

        <!-- ç‹€æ…‹è¨Šæ¯ -->
        <div id="status" class="status">
          <span class="status-icon"></span>
          <span class="status-text"></span>
        </div>

        <!-- è¼¸å‡ºå€ -->
        <div class="output-header" style="margin-top: 30px;">
          <span class="output-title">ğŸ“œ ç”Ÿæˆçµæœ</span>
        </div>
        <div id="result" class="output"></div>
      </div>

      <!-- æµ®å‹•ç« ç¯€å°èˆª -->
      <div id="chapterNavContainer" class="chapter-nav-container">
        <button id="chapterNavToggle" class="chapter-nav-toggle" title="ç« ç¯€å°èˆª">
          ğŸ“‘
          <span id="chapterBadge" class="badge">0</span>
        </button>
        <div id="chapterNavPanel" class="chapter-nav-panel">
          <div class="chapter-nav-header">
            <span class="chapter-nav-title">ğŸ“– ç« ç¯€ç›®éŒ„</span>
            <button id="chapterNavClose" class="chapter-nav-close">âœ•</button>
          </div>
          <div id="chapterNavList" class="chapter-nav-list"></div>
        </div>
      </div>

      <!-- é–±è®€é€²åº¦æ¢ -->
      <div id="readingProgress" class="reading-progress" style="width: 0%;"></div>

      <!-- æ›¸ç±¤å€ - å…¨æ–°è¨­è¨ˆ -->
      <div class="bookmark-card">
        <div class="bookmark-header">
          <h2 class="bookmark-title">
            æˆ‘çš„æ›¸ç±¤
            <span id="bookmarkCount" class="bookmark-count">0 ç¯‡</span>
          </h2>
          <div class="bookmark-actions">
            <button id="addBookmarkBtn" type="button" class="btn-small">ğŸ’¾ å„²å­˜ç›®å‰æ•…äº‹</button>
            <button id="exportBookmarksBtn" type="button" class="btn-small">ğŸ“¤ åŒ¯å‡ºå…¨éƒ¨</button>
            <button id="importBookmarksBtn" type="button" class="btn-small">ğŸ“¥ åŒ¯å…¥</button>
          </div>
        </div>

        <div class="bookmark-toolbar">
          <div class="bookmark-search">
            <input type="text" id="bookmarkSearch" placeholder="æœå°‹æ›¸ç±¤..." />
          </div>
          <select id="bookmarkSort" class="bookmark-sort">
            <option value="newest">æœ€æ–°å„ªå…ˆ</option>
            <option value="oldest">æœ€èˆŠå„ªå…ˆ</option>
            <option value="name">åç¨±æ’åº</option>
            <option value="length">é•·åº¦æ’åº</option>
          </select>
        </div>

        <ul id="bookmarkList" class="bookmark-list"></ul>
      </div>
    </div>

    <!-- ç·¨è¼¯æ›¸ç±¤å½ˆçª— -->
    <div id="editModal" class="modal-overlay">
      <div class="modal">
        <h3 class="modal-title">ç·¨è¼¯æ›¸ç±¤</h3>
        <div class="input-group">
          <label for="editBookmarkTitle">æ›¸ç±¤æ¨™é¡Œ</label>
          <input type="text" id="editBookmarkTitle" placeholder="è¼¸å…¥æ›¸ç±¤æ¨™é¡Œ" />
        </div>
        <div class="input-group">
          <label for="editBookmarkTags">æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
          <input type="text" id="editBookmarkTags" placeholder="å¦‚ï¼šå¥‡å¹», å†’éšª, ä¸»è§’å…‰ç’°" />
        </div>
        <div class="input-group" style="margin-bottom: 0;">
          <label for="editBookmarkNotes">å‚™è¨»</label>
          <textarea id="editBookmarkNotes" placeholder="æ·»åŠ å‚™è¨»..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" id="cancelEditBtn" class="btn-outline">å–æ¶ˆ</button>
          <button type="button" id="saveEditBtn" class="btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;" />

    <script>
      // ==================== å…ƒç´ å–å¾— ====================
      const apiKeyInput = document.getElementById('apiKey');
      const modelSelect = document.getElementById('model');
      const themeSelect = document.getElementById('theme');
      const settingSelect = document.getElementById('setting');
      const styleSelect = document.getElementById('style');
      const chaptersInput = document.getElementById('chapters');
      const lengthInput = document.getElementById('length');
      const notesInput = document.getElementById('notes');
      const randomBtn = document.getElementById('randomBtn');
      const generateBtn = document.getElementById('generateBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const continueBtn = document.getElementById('continueBtn');
      const statusDiv = document.getElementById('status');
      const resultDiv = document.getElementById('result');
      const toggleApiKeyVisibility = document.getElementById('toggleApiKeyVisibility');
      const charactersContainer = document.getElementById('charactersContainer');
      const randomAllCharactersBtn = document.getElementById('randomAllCharactersBtn');
      const addCharacterBtn = document.getElementById('addCharacterBtn');

      // æµ®å‹•ç« ç¯€å°èˆªå…ƒç´ 
      const chapterNavContainer = document.getElementById('chapterNavContainer');
      const chapterNavToggle = document.getElementById('chapterNavToggle');
      const chapterNavPanel = document.getElementById('chapterNavPanel');
      const chapterNavClose = document.getElementById('chapterNavClose');
      const chapterNavList = document.getElementById('chapterNavList');
      const chapterBadge = document.getElementById('chapterBadge');
      const readingProgress = document.getElementById('readingProgress');

      // æ›¸ç±¤å…ƒç´ 
      const addBookmarkBtn = document.getElementById('addBookmarkBtn');
      const exportBookmarksBtn = document.getElementById('exportBookmarksBtn');
      const importBookmarksBtn = document.getElementById('importBookmarksBtn');
      const importFileInput = document.getElementById('importFileInput');
      const bookmarkSearch = document.getElementById('bookmarkSearch');
      const bookmarkSort = document.getElementById('bookmarkSort');
      const bookmarkList = document.getElementById('bookmarkList');
      const bookmarkCount = document.getElementById('bookmarkCount');

      // ç·¨è¼¯å½ˆçª—å…ƒç´ 
      const editModal = document.getElementById('editModal');
      const editBookmarkTitle = document.getElementById('editBookmarkTitle');
      const editBookmarkTags = document.getElementById('editBookmarkTags');
      const editBookmarkNotes = document.getElementById('editBookmarkNotes');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const saveEditBtn = document.getElementById('saveEditBtn');

      let latestStory = '';
      let editingBookmarkId = null;
      let chapterMatches = [];
      let isPanelOpen = false;

      // ==================== ç‹€æ…‹é¡¯ç¤º ====================
      function showStatus(type, message) {
        const icons = {
          loading: 'â³',
          success: 'âœ…',
          error: 'âŒ'
        };
        statusDiv.className = `status show ${type}`;
        statusDiv.querySelector('.status-icon').textContent = icons[type] || '';
        statusDiv.querySelector('.status-text').textContent = message;
      }

      function hideStatus() {
        statusDiv.className = 'status';
      }

      // ==================== API é‡‘é‘° ====================
      const storedKey = localStorage.getItem('geminiApiKey');
      if (storedKey) apiKeyInput.value = storedKey;

      apiKeyInput.addEventListener('change', () => {
        const val = apiKeyInput.value.trim();
        if (val) {
          try {
            localStorage.setItem('geminiApiKey', val);
          } catch (e) {
            showStatus('error', 'API é‡‘é‘°å„²å­˜å¤±æ•—');
          }
        }
      });

      toggleApiKeyVisibility.addEventListener('click', () => {
        const isPassword = apiKeyInput.type === 'password';
        apiKeyInput.type = isPassword ? 'text' : 'password';
        toggleApiKeyVisibility.textContent = isPassword ? 'éš±è—' : 'é¡¯ç¤º';
      });

      // ==================== è¼‰å…¥å·²å„²å­˜çš„æ•…äº‹ ====================
      const savedStory = localStorage.getItem('savedStory');
      if (savedStory) {
        latestStory = savedStory;
        resultDiv.textContent = savedStory;
        downloadBtn.disabled = false;
        continueBtn.disabled = false;
        parseAndShowChapters(savedStory);
      }

      // ==================== éš¨æ©Ÿè³‡æ–™åº« ====================
      const themes = [
        // å¥‡å¹»é¡
        'å¥‡å¹»å†’éšª','å²è©©å¥‡å¹»','é»‘æš—å¥‡å¹»','éƒ½å¸‚å¥‡å¹»','ç«¥è©±æ”¹ç·¨','ç¥è©±å‚³èªª','ç²¾éˆèˆ‡çŸ®äºº','é¾èˆ‡é­”æ³•','ç•°ä¸–ç•Œè½‰ç”Ÿ','å‹‡è€…èˆ‡é­”ç‹',
        // ç§‘å¹»é¡
        'æœªä¾†ç§‘å¹»','å¤ªç©ºæ­ŒåŠ‡','è³½åšé¾å…‹','å¾Œå•Ÿç¤ºéŒ„','äººå·¥æ™ºæ…§','æ™‚é–“æ—…è¡Œ','å¤–æ˜Ÿæ–‡æ˜','åŸºå› æ”¹é€ ','è™›æ“¬å¯¦å¢ƒ','æ©Ÿç”²æˆ°çˆ­',
        // æ„›æƒ…é¡
        'æµªæ¼«æ„›æƒ…','ç¦å¿Œä¹‹æˆ€','é’æ¢…ç«¹é¦¬','è¾¦å…¬å®¤æˆ€æƒ…','è±ªé–€æ©æ€¨','è·¨è¶Šæ™‚ç©ºçš„æ„›','ç•°æ—ä¹‹æˆ€','è™æˆ€æƒ…æ·±','ç”œèœœæ—¥å¸¸','å©šå¾Œç”Ÿæ´»',
        // æ‡¸ç–‘æ¨ç†é¡
        'æ‡¸ç–‘æ¨ç†','å¯†å®¤æ®ºäºº','é€£ç’°æ®ºæ‰‹','æ³•åº­æ”»é˜²','è­¦åŒªå°æ±º','é–“è«œè«œæˆ°','çŠ¯ç½ªå¿ƒç†','å†·æ¡ˆé‡å•Ÿ','å¾©ä»‡è¨ˆç•«','å®Œç¾çŠ¯ç½ª',
        // æ­·å²é¡
        'æ­·å²å‚³å¥‡','å®®å»·é¬¥çˆ­','æˆ°åœ‹é¢¨é›²','ä¸‰åœ‹æ¼”ç¾©','æ°‘åœ‹é¢¨è¯','å¤ä»£å•†æˆ°','æ±Ÿæ¹–æ©æ€¨','å¸ç‹å°‡ç›¸','äº‚ä¸–è‹±é›„','æ­·å²ç©¿è¶Š',
        // ææ€–é©šæ‚šé¡
        'ææ€–é©šæ‚š','å¿ƒç†ææ€–','éˆç•°é¬¼æ€ª','å…‹è˜‡é­¯ç¥è©±','éƒ½å¸‚æ€ªè«‡','è©›å’’å‚³èªª','é¬¼å±‹æ¢éšª','æœ«æ—¥ç”Ÿå­˜','å–ªå±å±æ©Ÿ','é‚ªæ•™å„€å¼',
        // æ­¦ä¿ ä»™ä¿ é¡
        'å¤è£æ­¦ä¿ ','ä»™ä¿ ä¿®çœŸ','ç„å¹»ä¿®çœŸ','æ±Ÿæ¹–ä¿ å®¢','é–€æ´¾çˆ­é¬¥','åŠèˆ‡æƒ…ä»‡','é£›å‡æˆä»™','å¦–é­”é¬¼æ€ª','é“æ³•è‡ªç„¶','æ­¦æ—è‡³å°Š',
        // ç¾ä»£é¡
        'ç¾ä»£éƒ½å¸‚','è·å ´é¢¨é›²','å¨›æ¨‚åœˆ','é«”è‚²ç«¶æŠ€','é›»ç«¶ç†±è¡€','å‰µæ¥­å¥®é¬¥','æ ¡åœ’é’æ˜¥','å®¶åº­å€«ç†','ç¤¾æœƒå¯«å¯¦','ç¶²ç´…ç”Ÿæ´»',
        // å…¶ä»–é¡å‹
        'è»äº‹æˆ°çˆ­','æµ·æ´‹å†’éšª','è¥¿éƒ¨æ‹“è’','åŒ—æ­ç¶­äº¬','æ¢éšªå°‹å¯¶','å‹•ç‰©è¦–è§’','ç¾é£Ÿæ–™ç†','é†«ç™‚è·äºº','æ³•å¾‹æ­£ç¾©','éŸ³æ¨‚å¤¢æƒ³',
        // ç‰¹æ®Šé¡Œæ
        'æœ«ä¸–å»¢åœŸ','ç•°èƒ½è¦ºé†’','ç³»çµ±æµ','ç„¡é™æµ','å‰¯æœ¬éŠæˆ²','ç›´æ’­æ±‚ç”Ÿ','è¦å‰‡æ€ªè«‡','è©­ç•°éŠæˆ²','éˆæ°£å¾©ç”¦','è«¸å¤©è¬ç•Œ'
      ];
      
      const settingsData = [
        // å¥‡å¹»ä¸–ç•Œ
        'è™›æ§‹çš„ä¸­ä¸–ç´€ç‹åœ‹','ç²¾éˆæ—çš„æ£®æ—åœ‹åº¦','çŸ®äººçš„åœ°åº•åŸå¸‚','é¾æ—ç›¤æ“šçš„ç«å±±å³¶','é­”æ³•å¸«çš„æµ®ç©ºå¡”','è¢«è©›å’’çš„é»‘æš—æ£®æ—','ç¥è–çš„å…‰æ˜ç¥æ®¿','äº¡éˆæ©«è¡Œçš„è’åŸ','æµ·å¦–å‡ºæ²’çš„ç¥ç§˜æµ·åŸŸ','éš±è—åœ¨è¿·éœ§ä¸­çš„ä»™å¢ƒ',
        // ç§‘å¹»ä¸–ç•Œ
        '21ä¸–ç´€çš„è‡ºç£éƒ½å¸‚','é™é çš„å¤ªç©ºæ®–æ°‘åœ°','è™›æ“¬å¯¦å¢ƒä¸–ç•Œ','è¿‘æœªä¾†çš„é«˜ç§‘æŠ€åŸå¸‚','ç¹è¯çš„éŠ€æ²³å•†å ´','å®‡å®™æˆ°è‰¦ä¸Š','ç«æ˜Ÿæ®–æ°‘åŸºåœ°','æµ·åº•éƒ½å¸‚äºç‰¹è˜­ææ–¯','è³½åšé¾å…‹çš„éœ“è™¹éƒ½å¸‚','äººå·¥æ™ºæ…§çµ±æ²»çš„åŸå¸‚',
        // æ­·å²å ´æ™¯
        'å¤ä»£çš‡å®®','æ˜æœå®®å»·','å”æœé•·å®‰åŸ','å®‹ä»£ç¹è¯æ±´äº¬','æˆ°åœ‹æ™‚ä»£çš„åŸå ¡','ä¸‰åœ‹æ™‚æœŸçš„æˆ°å ´','æ¸…æœç´«ç¦åŸ','æ°‘åœ‹æ™‚æœŸçš„ä¸Šæµ·ç˜','å¤ç¾…é¦¬ç«¶æŠ€å ´','åŸƒåŠæ³•è€ç‹å®®',
        // ç¾ä»£å ´æ™¯
        'ç¹è¯çš„ç¾ä»£å¤§éƒ½æœƒ','å¯§éœçš„é„‰æ‘å°é®','ç¥ç§˜çš„ç§ç«‹å­¸æ ¡','é ‚ç´šçš„è·¨åœ‹ä¼æ¥­','ç†±é¬§çš„å¤œå¸‚è¡—é“','é«˜ç´šçš„ç™¾è²¨å•†å ´','é™°æš—çš„åœ°ä¸‹é»‘å¸‚','è±ªè¯çš„åº¦å‡å‹åœ°','å¿™ç¢Œçš„é†«é™¢','åš´è‚…çš„æ³•é™¢',
        // ç‰¹æ®Šå ´æ™¯
        'æœ«æ—¥å¾Œçš„è’åœŸ','é­”æ³•å­¸é™¢','è’¸æ±½é¾å…‹åŸå¸‚','æ·±æµ·ç‹åœ‹','éš±è—æ–¼é›²ç«¯çš„åŸå ¡','å¤è€çš„å±±æ—æ‘è½','é›ªå±±ä¸Šçš„ä¿®é“é™¢','ç†±å¸¶é›¨æ—æ·±è™•','å·¨å‹è¿·å®®éƒ½å¸‚','æ®–æ°‘æµ·ç›œèˆ¹',
        // ç•°ä¸–ç•Œ
        'å¹³è¡Œå®‡å®™','ç•°æ¬¡å…ƒç©ºé–“','å¤¢å¢ƒä¸–ç•Œ','éˆç•Œèˆ‡å†¥åºœ','å¤©ç•Œèˆ‡ä»™å¢ƒ','åœ°ç„æ·±æ·µ','æ™‚é–“è£‚ç¸«ä¹‹ä¸­','é‡å­ç–ŠåŠ çš„ä¸–ç•Œ','éŠæˆ²å‰¯æœ¬ç©ºé–“','è«¸ç¥çš„é ˜åŸŸ',
        // æ—¥å¸¸å ´æ™¯
        'æº«é¦¨çš„å’–å•¡å»³','è€èˆŠçš„æ›¸åº—','ç¥ç§˜çš„å¤è‘£åº—','ç†±é¬§çš„éŠæ¨‚åœ’','å®‰éœçš„åœ–æ›¸é¤¨','æ··äº‚çš„æ¼”å”±æœƒç¾å ´','ç·Šå¼µçš„è€ƒè©¦ç¾å ´','æµªæ¼«çš„æµ·é‚Š','å£¯éº—çš„å±±é ‚','å¯§éœçš„å¯ºå»Ÿ',
        // ç‰¹æ®Šç’°å¢ƒ
        'èˆ‡ä¸–éš”çµ•çš„å­¤å³¶','æ°¸å¤œçš„æ¥µåœ°','æ²™æ¼ ä¸­çš„ç¶ æ´²','æ¼‚æµ®åœ¨ç©ºä¸­çš„å³¶å¶¼','åœ°ä¸‹æ·±è™•çš„æ´ç©´','æ´»ç«å±±å£','å†°å°çš„å¤åŸ','è¢«éºå¿˜çš„å¤æ–‡æ˜éºè·¡','ç•°å½¢èŸ²å·¢','æ©Ÿæ¢°æ˜Ÿçƒ'
      ];
      
      const stylesArr = [
        // æƒ…æ„ŸåŸºèª¿
        'è©©æ„','å¹½é»˜','é»‘æš—','å‹µå¿—','æµªæ¼«','æº«é¦¨','æ‚²å‚·','ç†±è¡€','å†·é…·','æº«æŸ”',
        // æ•˜äº‹é¢¨æ ¼
        'æ‡¸ç–‘','åˆºæ¿€','è¼•é¬†','ç·Šå¼µ','å²è©©','ç´°è†©','ç²—ç·','è¯éº—','ç°¡ç´„','å¯«å¯¦',
        // æ–‡å­¸é¢¨æ ¼
        'å¤å…¸è¯éº—','è’èª•','ç¾å¯¦ä¸»ç¾©','é­”å¹»ç¾å¯¦','æ„è­˜æµ','é»‘è‰²å¹½é»˜','è«·åˆº','æ‰¹åˆ¤','å“²ç†','æŠ’æƒ…',
        // æ°›åœé¢¨æ ¼
        'å¿ƒç†é©šæ‚š','é™°é¬±å£“æŠ‘','æ˜äº®æ­¡å¿«','ç¥ç§˜è©­ç•°','èŠåš´è‚…ç©†','ä¿çš®å¯æ„›','æˆç†Ÿç©©é‡','é’æ˜¥æ´»åŠ›','è’¼æ¶¼æ‚²å£¯','å¤¢å¹»è¿·é›¢',
        // ç¯€å¥é¢¨æ ¼
        'å¿«ç¯€å¥','æ…¢ç†±','è·Œå®•èµ·ä¼','å¹³é‹ªç›´æ•˜','å€’æ•˜æ’æ•˜','å¤šç·šä¸¦é€²','å–®ç·šæ·±å…¥','ç¾¤åƒæå¯«','ç¬¬ä¸€äººç¨±','å…¨çŸ¥è¦–è§’',
        // ç‰¹è‰²é¢¨æ ¼
        'è¼•å°èªªé¢¨','ç¶²æ–‡çˆ½æ–‡','æ–‡è—æ¸…æ–°','ç¡¬æ ¸å¯«å¯¦','è»Ÿç§‘å¹»','ç¡¬ç§‘å¹»','æ–°æ­¦ä¿ ','å¤è¨€','ç¾è¨€','ç”œå¯µ'
      ];
      const chapterOpts = [5, 8, 10, 12, 15];
      const lengthOpts = [30000, 50000, 70000, 90000];

      const nameOptions = ['è‰¾ç³','æ´›æ©','å‡±äº','ç±³çˆ¾','å¸­æ©','è–‡æ‹‰','ç¥ˆå®‰','æœæ—','å¸Œçˆ¾ç¶­','èŠé›…','ä¼Šå‡¡','æ³•è˜­','æ ¼è˜­','æ¢…èŠ™','å®‰å¨œ','é›·æ ¼','ç´¢è²','è‰¾ç•¥ç‰¹','äºæ­·å…‹','è«å¦®å¡','è·¯è¥¿','ä¼ŠèŠ™','åŠ ç™¾åˆ—','äºç•¶','ç‘ªé›…','è‰¾å¾·','è–©æ‹‰','æ°ç™»','çªæ‹‰','å¾·ç‘å…‹','å‡±ç‘Ÿç³','é¦¬ä¸','ç¾…çµ²','å¥§åˆ©ç¶­','æ˜†æ±€','å“ˆè‰','ä¼¯ç´å¾·','æµ·å€«','ä¸¹å°¼çˆ¾','é›·åˆ‡çˆ¾','å±±å§†','è‰¾è–‡','è«¾äº','è‰¾ç±³è‰','å¸ƒèŠæ©','è‰¾èœœè‰äº','é”ç±³å®‰','éœ²è¥¿äº','ç±³è˜­é”','äºæ­·å±±å¤§','æ³¢ç³å¨œ','äº¨åˆ©','è˜‡è²äº','è²»å—å¤š','å…‹èŠå…’','åŸƒå¾·åŠ ','æ­æ–‡','è‰äº','æŸ¥çˆ¾æ–¯','å“ˆå¨œ','æ°å…‹','ç‘ªè’‚çˆ¾é”','æ‰˜å°¼','å¨œå¡”è‰','é”ç‘æ–¯','å…‹é‡Œæ–¯','è‰¾ç‘ª','ç¾…ä¼¯ç‰¹','å‡±ç‰¹','æ ¼è•¾çµ²','è«é‡Œæ–¯','æ™®æ‹‰å¤š','å‹æ‹‰','ç¶­å…‹å¤š','å‡±è‰','è²åˆ©æ™®','ç‘ç§‹','å²è’‚å¤«','ç¾…ä¼Š','å“ˆå¾·æ£®','å¦®å¯','å…‹éº—çµ²æ±€','èŠæ˜‚','æ¢…æ ¹','æœè˜­','é¦¬é›…','è˜­æ–¯æ´›ç‰¹','å¡ç¾…çˆ¾','ä¼Šéº—èç™½','ä¼Šè–©è²æ‹‰','è€ƒç‰¹å°¼','è”£ç´','å”å¨œ','å¡å¾·é‡Œå…‹','å¸ƒè˜­å¦®','é›·è’™','å‡±è–©ç³','é˜¿èŠå…‹æ–¯','åŠ å¸ƒé‡ŒåŸƒæ‹‰','è¥¿è’™'];
      
      // ç”·æ€§åå­—
      const maleNames = ['æ´›æ©','ç±³çˆ¾','å¸­æ©','ç¥ˆå®‰','æœæ—','ä¼Šå‡¡','æ³•è˜­','æ ¼è˜­','é›·æ ¼','è‰¾ç•¥ç‰¹','äºæ­·å…‹','åŠ ç™¾åˆ—','äºç•¶','è‰¾å¾·','æ°ç™»','å¾·ç‘å…‹','é¦¬ä¸','å¥§åˆ©ç¶­','æ˜†æ±€','ä¼¯ç´å¾·','ä¸¹å°¼çˆ¾','å±±å§†','è«¾äº','å¸ƒèŠæ©','é”ç±³å®‰','äºæ­·å±±å¤§','äº¨åˆ©','è²»å—å¤š','åŸƒå¾·åŠ ','æ­æ–‡','æŸ¥çˆ¾æ–¯','æ°å…‹','æ‰˜å°¼','é”ç‘æ–¯','å…‹é‡Œæ–¯','ç¾…ä¼¯ç‰¹','è«é‡Œæ–¯','æ™®æ‹‰å¤š','ç¶­å…‹å¤š','è²åˆ©æ™®','å²è’‚å¤«','ç¾…ä¼Š','å“ˆå¾·æ£®','èŠæ˜‚','æœè˜­','è˜­æ–¯æ´›ç‰¹','å¡å¾·é‡Œå…‹','é›·è’™','é˜¿èŠå…‹æ–¯','è¥¿è’™','å¨å»‰','è©¹å§†æ–¯','éº¥å…‹','å¤§è¡›','ç´„ç‘Ÿå¤«','ç†æŸ¥','æ¹¯ç‘ªæ–¯','å®‰å¾·é­¯','ä¹”æ²»','è‰¾å€«','å‡±æ–‡','ä¹”ç´æ£®','ä¹”èˆ’äº','èŠæ©','å°¼å¤æ‹‰æ–¯','è´¾æ–¯æ±€','å¸ƒå…°ç™»','æ³°å‹’','äºšä¼¦','æ°ç‘ç±³','è‚–æ©','å¾·é‡Œå…‹','é©¬ä¿®','ä¿ç½—','å¡å°”','æ–‡æ£®ç‰¹'];
      
      // å¥³æ€§åå­—
      const femaleNames = ['è‰¾ç³','å‡±äº','è–‡æ‹‰','å¸Œçˆ¾ç¶­','èŠé›…','æ¢…èŠ™','å®‰å¨œ','ç´¢è²','è«å¦®å¡','è·¯è¥¿','ä¼ŠèŠ™','ç‘ªé›…','è–©æ‹‰','çªæ‹‰','å‡±ç‘Ÿç³','ç¾…çµ²','å“ˆè‰','æµ·å€«','é›·åˆ‡çˆ¾','è‰¾è–‡','è‰¾ç±³è‰','è‰¾èœœè‰äº','éœ²è¥¿äº','ç±³è˜­é”','æ³¢ç³å¨œ','è˜‡è²äº','å…‹èŠå…’','è‰äº','å“ˆå¨œ','ç‘ªè’‚çˆ¾é”','å¨œå¡”è‰','è‰¾ç‘ª','å‡±ç‰¹','æ ¼è•¾çµ²','å‹æ‹‰','å‡±è‰','ç‘ç§‹','å¦®å¯','å…‹éº—çµ²æ±€','æ¢…æ ¹','é¦¬é›…','å¡ç¾…çˆ¾','ä¼Šéº—èç™½','ä¼Šè–©è²æ‹‰','è€ƒç‰¹å°¼','è”£ç´','å”å¨œ','å¸ƒè˜­å¦®','å‡±è–©ç³','åŠ å¸ƒé‡ŒåŸƒæ‹‰','è‰¾è‰çµ²','ç¶­å¤šåˆ©äº','å¥§è‰ç¶­äº','å¤æ´›ç‰¹','é˜¿æ›¼é”','æ½”è¥¿å¡','çå¦®ä½›','èœœé›ªå…’','å¦®å¨œ','å…‹è˜¿ä¼Š','èæ›¼çŠ','é»›å®‰å¨œ','å‡±è’‚','è‰¾è‰æ£®','å¸ƒéº—å§¬ç‰¹','è«å¦®å…‹','å®‰çªæ‹‰','å²é»›è¥¿','å¦é›…','è˜¿æ‹‰','æ½˜ä¹ƒæ‹‰'];
      const personalityOptions = ['å¤–å†·å…§ç†±','è‡ªå‘ä½†å˜´ç¡¬','æ¨‚è§€åˆè¡å‹•','å†·éœä½†ååŸ·','æº«æŸ”å»ä¸è¼•ä¿¡ä»»ä½•äºº','å …éŸŒè€Œæ²‰é»˜','å¹½é»˜é–‹æœ—','å–„è‰¯åˆå–®ç´”','å¤šç–‘ä¸”è¬¹æ…','è‡ªä¿¡è€Œå‚²æ…¢','æ‡¶æ•£å»è¶…å‡¡è°æ˜','ç¾©æ°£è€Œå›ºåŸ·','æ€¥èºä½†å¿ƒåœ°å–„è‰¯','è¬™è™›è€Œæ©Ÿæ™º','å¤©çœŸåˆå¥½å¥‡','å†·é…·ç„¡æƒ…','å–„æ–¼äº¤éš›','å­¤åƒ»æ²‰é»˜','å‹‡æ•¢è¡å‹•','ç†æ€§å…‹åˆ¶','æ„›å¹»æƒ³','å­¤å–®','å«‰å¦’å¿ƒå¼·','å‹‡æ–¼æŒ‘æˆ°','æ¨‚æ–¼åŠ©äºº','å¤šæ„å–„æ„Ÿ','æ‡¶æ•£','å¥½å‹•','æ©Ÿæ™ºéˆæ´»','å¿ƒç›´å£å¿«','å„ªæŸ”å¯¡æ–·','å–„æ–¼éš±å¿','é ‘å¼·','æ‡·ç–‘ä¸€åˆ‡','æ€ç¶­åš´è¬¹','é»‘æš—å…§å¿ƒ','è¡å‹•ç«çˆ†','é™°æ™´ä¸å®š','å®¢è§€ç†æ€§','è‡ªå¾‹è‡ªçœ','è²ªå¿ƒ','ç²—æå¤§è‘‰','å­¤é«˜è‡ªå‚²','æ‚²å¤©æ†«äºº','æ±‚çŸ¥æ¬²å¼·','ä¿å®ˆå‚³çµ±','å†’éšªç²¾ç¥','æµªæ¼«æƒ…æ‡·','éµé¢ç„¡ç§','æƒ…æ„Ÿè±æ²›','ä¸æ‹˜å°ç¯€','å¬‰çš®ç¬‘è‡‰','æ·±è¬€é æ…®','å‹‡æ•¢ç„¡ç•','å‹å–„ç†±æƒ…','ç´”çœŸå­©æ°£','å†·æ¼ ç–é›¢','å¿ƒæ€çº–ç´°','è¬™éœä½èª¿','å‰›æ„è‡ªç”¨','é¢¨è¶£å¹½é»˜','å……æ»¿æ­£ç¾©æ„Ÿ','å–„æ–¼æ“æ§','å¸¸å¸¸æ‡·ç–‘è‡ªå·±','æ¨‚è§€é–‹æœ—','æ„Ÿæ€§ç´°è†©','ç©ä¸–ä¸æ­','å¥®ç™¼å‘ä¸Š','ç„¡å˜é ­','å›ºåŸ·å·±è¦‹','åè¦†ç„¡å¸¸','å¿è€åŠ›å¼·','æ†¨åšè€å¯¦','å­¤åƒ»æ€ªç•°','å¤æ€ªå¤šè®Š','å«‰æƒ¡å¦‚ä»‡','å¤©çœŸæµªæ¼«','è±ªæ”¾ä¸ç¾ˆ','å¯Œæœ‰å‰µæ„','éš¨é‡è€Œå®‰','å¿ƒç‹ æ‰‹è¾£','é‡è¦–ç¦®ç¯€','ç†±æ„›è‡ªç”±','è²ªç©','ç¯€å„‰','å¿ƒåœ°å–„è‰¯','å–œæ­¡å†’éšª','å°ˆæ³¨åŸ·è‘—','çœŸèª å¦ç‡','å°å¿ƒç¿¼ç¿¼','å€”å¼·å›ºåŸ·','å¤©é¦¬è¡Œç©º','å–„è§£äººæ„','æ˜“ç‡ƒæ˜“çˆ†ç‚¸','éåº¦æ¨‚è§€','è«åè‡ªä¿¡','å”¯æˆ‘ç¨å°Š','æ‚²è§€å­ä¸–','å‡¡äº‹æ±‚çœŸ'];
      const goalOptions = ['æ‰¾å›å¤±è½çš„å®¶æ—å¾½ç« ','ç ´è§£ç¦æ›¸çš„å°å°','æ•‘å›è¢«è©›å’’çš„æœ‹å‹','æŸ¥å‡ºå­¸é™¢è£¡çš„å…§é¬¼','è­‰æ˜è‡ªå·±ä¸æ˜¯æ€ªç‰©','å°‹æ‰¾å¤±è¹¤çš„å¸«çˆ¶','å¾©ä»‡é›ªæ¥','æ‹¯æ•‘ä¸–ç•Œå…æ–¼æ¯€æ»…','é€ƒé›¢è‡ªèº«çš„å‘½é‹','å°‹æ±‚å…§å¿ƒçš„è‡ªç”±','æ­é–‹å¤è€éºè·¡çš„ç§˜å¯†','å®Œæˆçˆ¶æ¯æœªç«Ÿçš„å¤¢æƒ³','æ‰“å€’æš´æ”¿çš„å›ç‹','å°‹æ‰¾å‚³èªªä¸­çš„å¯¶è—','å®ˆè­·æ•…é„‰å…æ–¼ä¾µç•¥','ç ´è§£è¡€çµ±ä¹‹è¬','æ²»ç™’è‡ªå·±çš„ç—…ç—›','æˆç‚ºæœ€å¼·è€…','é˜»æ­¢æœ«æ—¥é™è‡¨','æ”¹è®Šæœªä¾†çš„é è¨€','çµ±æ²»æ•´å€‹åœ‹åº¦','æ‰¾åˆ°é€šå¾€å¹³è¡Œä¸–ç•Œçš„é–€','ç ´è§£å¤è€é­”æ³•çš„è¬èª','é˜»æ­¢é‚ªæƒ¡æ•™åœ˜å¾©æ´»','æ‹¯æ•‘æ—äººå…æ–¼æ»…çµ•','èˆ‡å¿ƒæ„›ä¹‹äººé‡é€¢','æ‰¾å‡ºçœŸæ­£çš„èº«ä¸–','è®“ä¸–ç•Œå’Œå¹³','æ¶ˆæ»…æ‰€æœ‰é»‘æš—åŠ›é‡','å®Œæˆæœ€å¾Œä¸€ä»»å‹™','æ­éœ²å·¨å¤§é™°è¬€','ä¿®å¾©ç ´ç¢çš„ç‹åœ‹','æ‰¾åˆ°å¤±è¹¤çš„å¯¶è—','æ²»ç™’ä¸–ç•Œçš„ç–¾ç—…','æ‘§æ¯€é‚ªæƒ¡çµ„ç¹”','å ±å¾©å‰ä¸–çš„ä»‡æ•µ','æ¢ç´¢æœªçŸ¥æ˜Ÿç³»','ä¿è­·è‡ªç„¶ç’°å¢ƒ','ç™¼ç¾æ°¸æ†ä¹‹æ³‰','çµ±ä¸€å„æ—å‹¢åŠ›','å°‹æ‰¾å¤±å‚³çš„é­”æ³•å·è»¸','è§£æ”¾å¥´å½¹çš„äººæ°‘','é˜»æ­¢é»‘æš—å„€å¼','å®Œæˆç¥–å…ˆçš„éºé¡˜','å»ºç«‹å’Œå¹³çš„ä¸–ç•Œ','æ­é–‹èº«ä¸–ä¹‹è¬','æˆ°å‹å¿ƒé­”','æ“ºè„«å®¶æ—è©›å’’','å¯¦ç¾å†’éšªå¤¢æƒ³','å¥ªå›å¤±å»çš„ç‹ä½','æ‰¾åˆ°å‚³èªªä¸­çš„æ­¦å™¨','å¾©æ´»å·²é€çš„æ„›äºº','ç ´é™¤å‘½é‹æŸç¸›','å¾å¥´å½¹ä¸­è§£æ”¾æ—äºº','å°‹æ±‚çœŸæ­£çš„å‹èª¼','å»ºç«‹å¼·å¤§çš„åœ˜éšŠ','é–‹å‰µæ–°ç§©åº','æ­é–‹å¤å¢“çš„ç§˜å¯†','ç©¿è¶Šæ™‚ç©ºæ‹¯æ•‘ä¸–ç•Œ','è¿½æ±‚è—è¡“æ¥µè‡´','å®Œæˆä¸€å ´å²è©©ä¹‹æ—…','é˜»æ­¢æ™‚ç©ºå´©å£','æ¨ç¿»è…æ•—æ”¿æ¬Š','å°‹æ‰¾æ°¸æ†çš„æ„›æƒ…','ä¿è­·å¼±å°','æ‹¯æ•‘è¢«éºå¿˜çš„ç¨®æ—','é˜»æ­¢ç˜Ÿç–«è”“å»¶','å°‹æ‰¾æ–°çš„å®¶åœ’','å¯¦ç¾ç§‘å­¸çªç ´','æ•‘è´–è‡ªå·±','æ²»ç™‚è¦ªäººçš„ç–¾ç—…','æ‰“ç ´å‘½é‹è¼ªè¿´','çµ„ç¹”åæŠ—è»','å®ˆè­·ç¥ç§˜å¯¶çŸ³','é˜»æ­¢ä¸–ç•Œèåˆ','æ‰¾å›å¤±å»çš„èƒ½åŠ›','å°‹æ±‚åŠ›é‡çš„ä¾†æº','è­‰æ˜è‡ªå·±çš„åƒ¹å€¼','æˆç‚ºå‚³èªªä¸­çš„è‹±é›„','é˜»æ­¢æœ«æ—¥æ©Ÿå™¨','é‡å»ºå®¶åœ’','æ‰¾åˆ°è¨˜æ†¶ç¢ç‰‡','å®ˆè­·ç”Ÿå‘½ä¹‹æ¨¹','ç¶­æŒä¸–ç•Œå¹³è¡¡','æ‹¯æ•‘è¢«å›šç¦çš„éˆé­‚','æ¢ç´¢æµ·åº•ä¸–ç•Œ','é˜»æ­¢æ´ªæ°´','è¿½å°‹çœŸç†','æˆç‚ºæœ€å‰å¤§çš„å·«å¸«','é–‹å‰µæ–°ä¸–ç•Œ','ç¹¼æ‰¿ç¥çš„åŠ›é‡','é˜»æ­¢ç˜‹ç‹‚ç§‘å­¸å®¶','å®Œæˆæœ€å¾Œçš„å†’éšª','æ‰¾åˆ°å®‡å®™çš„èµ·æº','æ•‘åŠ©å­¤å…’é™¢','è§£é–‹æ­·å²è¬åœ˜','å¹³æ¯æˆ°çˆ­','å¬å–šç¥é¾','å°‹æ‰¾å¤±æ•£å¤šå¹´çš„è¦ªäºº','çªç ´è‡ªæˆ‘æ¥µé™','çµ±ä¸€å››æµ·å…«è’','å¯¦ç¾å’Œå¹³å…±è™•','è¿½æ±‚ç¥ç§˜åŠ›é‡'];
      const weaknessOptions = ['å®³æ€•é»‘æš—','é‡åˆ°å£“åŠ›å°±èªªè¬Š','å¤ªå®¹æ˜“ç›¸ä¿¡åˆ¥äºº','å¼·è¿«ç—‡åš´é‡','ä¸€æ—¦æ‰¿è«¾å°±ä¸è‚¯å›é ­','ç•æ‡¼æ·±æµ·','æé«˜ç—‡','å®¹æ˜“ç™¼æ€’','éæ–¼å›ºåŸ·','æ‚£æœ‰å¤±çœ ','å°é­”æ³•éæ•','ä¸æ“…é•·è¬Šè¨€','å¿ƒè»Ÿ','å®¹æ˜“ç„¦æ…®','æ‡¼æ€•å­¤ç¨','æ€•è¡€','è¨˜æ†¶è¡°é€€','å¸¸è‡ªæˆ‘æ‡·ç–‘','é«”åŠ›å·®','æƒ…ç·’èµ·ä¼å¤§','ææ°´','ä¸‰åˆ†é˜ç†±åº¦','è²ªåƒ','æ„›ç¡è¦º','æ²’è‡ªä¿¡','å®¹æ˜“å«‰å¦’','æ€•è›‡','ç„¡æ³•æ‹’çµ•ä»–äºº','å—åˆ°é‡‘éŒ¢èª˜æƒ‘','æ‡¦å¼±','æ€•å¯‚å¯','æ€•å¤±æ•—','çœ¼ç¥ä¸å¥½','è¿·å¤±è‡ªæˆ‘','å®¹æ˜“æšˆè¡€','éåº¦åŒæƒ…å¿ƒ','æƒ…ç·’ä¸ç©©','é£²é£Ÿå¤±èª¿','ç¼ºä¹è€å¿ƒ','æ€•è¢«æ‹’çµ•','æ˜“æ„Ÿå¯‚å¯','æ™‚é–“ç®¡ç†å·®','å®¹æ˜“åˆ†å¿ƒ','å„ªæŸ”å¯¡æ–·','æ€•å¯µç‰©','å°è²éŸ³éæ•','æœƒæšˆè»Š','ä¸æœƒæ¸¸æ³³','æ€•èœ˜è››','å°é‡‘éŒ¢è‘—è¿·','éæ–¼èª å¯¦','ä¸èƒ½ä¿å®ˆç§˜å¯†','å¥å¿˜','åå°„ç¥ç¶“å·®','å®³æ€•è›™','æ„›å‡ºé¢¨é ­','æƒ…ç·’åŒ–','å‚²æ…¢è‡ªå¤§','æ‡·ç–‘ä¸€åˆ‡','å—ä¸èµ·æ‰¹è©•','è¿½æ±‚å®Œç¾','éåº¦é–‹æœ—','å¾—å¤±å¿ƒé‡','éæ–¼å–„è‰¯','å¸¸å¸¸é²åˆ°','è‡ªæ§åŠ›å·®','å®¹æ˜“ç…©æƒ±','æ‡·èˆŠ','éæ–¼ç¾å¯¦','æ€•ç—›','ä¸æ“…äº¤éš›','æ„›æ‹–å»¶','ä¸å–„ç†è²¡','æ€•æ›ç’°å¢ƒ','ä½è¡€ç³–','æ€•é›·','æ„›å“­','æ€•é†«é™¢','ç„¡å®‰å…¨æ„Ÿ','å¤ªåœ¨æ„ä»–äººçœ¼å…‰','æ€•ç«','æ€•èŸ‘è‚','æ€•é›¨','æ€•è¢«å­¤ç«‹','æ€•æœªçŸ¥','æ€•é»‘å¤œ','ææ‡¼é«˜å£“','æ€•å¤±å»æœ‹å‹','éæ–¼è¡å‹•','æ˜“æ€’','æœ‰å¼·è¿«ç—‡','æ½”ç™–','éæ–¼æŒ‘å‰”','ç¼ºä¹ä¿¡å¿ƒ','å®³æ€•èªªè¬Š','é‡‘éŒ¢è¿·æƒ‘','éåº¦è‡ªè²¬','æ€•é»‘æ€•é¬¼','ç„¡æ³•é•·æ™‚é–“å°ˆæ³¨','éæ–¼æ•æ„Ÿ','å–œæ­¡æ”€æ¯”'];
      const secretOptions = ['å…¶å¯¦èƒ½è½è¦‹é­”æ–çš„è²éŸ³','æ›¾ç¶“æ–½æ”¾éç¦å’’','è¡€çµ±æœ‰çˆ­è­°','èˆ‡åæ´¾æœ‰è¡€ç·£é—œä¿‚','è¨˜æ†¶è¢«äººå‹•éæ‰‹è…³','èº«ä¸Šè—æœ‰å¤è€ç¬¦æ–‡','æ˜¯é è¨€ä¸­çš„å­©å­','éš±è—è‘—ç¬¬äºŒäººæ ¼','çœŸæ­£çš„èº«ä»½æ˜¯ç‹æ—','æ‰‹æ¡æœªä¾†çš„é è¨€','æ“æœ‰æ¯€æ»…ä¸–ç•Œçš„åŠ›é‡','æ®ºéç„¡è¾œçš„äºº','éˆé­‚è¢«åˆ†è£‚','èˆ‡ç¥éˆç°½ä¸‹å¥‘ç´„','é«”å…§å¯„å®¿é¾æ—è¡€è„ˆ','è¢«äººæ§åˆ¶æ€æƒ³','æŒæœ‰ç¦æ›¸','æ›¾æ˜¯æ•µè»é–“è«œ','æ“æœ‰å¯ä»¥é€†å¤©æ”¹å‘½çš„èƒ½åŠ›','å·²ç¶“æ­»äº¡åˆå¾©æ´»é','èº«ä»½æ˜¯å¤©ç•Œä½¿è€…','å‡ºç”Ÿæ–¼æ•µå°åœ‹åº¦','æŒæœ‰èƒ½æ§åˆ¶æ™‚é–“çš„è£ç½®','æ›¾ç¶“æ˜¯åæ´¾æ‰‹ä¸‹','å…¶çœŸæ­£ç›®çš„æ˜¯å¾©ä»‡','èº«é«”ä¸­å°å°è‘—é­”ç¥','æ›¾æ®ºæ­»è¦ªäºº','æ“æœ‰ä¸å¯å‘Šäººçš„æˆ€æƒ…','æ›¾åœ¨å¦ä¸€æ™‚ç©ºæ´»é','éˆé­‚è¢«æƒ¡éˆé™„èº«','æ›¾ç¶“æ˜¯ç‹æ—æˆå“¡','æ“æœ‰é çŸ¥èƒ½åŠ›','é«”å…§å°å°è‘—ç¥ç¸','æ›¾èˆ‡å¤–æ˜Ÿäººæ¥è§¸','æ˜¯é›™é‡é–“è«œ','å¾æœªå‡ºç”Ÿåœ¨é€™å€‹ä¸–ç•Œ','æ˜¯å¤±è¹¤ç‹å­/å…¬ä¸»','å…¶çˆ¶æ¯æ˜¯åå‰å¤§çš„è‹±é›„','æ›¾æš—ä¸­å¹«åŠ©éæ•µäºº','é«”å…§æµè‘—é¾çš„è¡€','æ›¾èˆ‡æƒ¡é­”åšäº¤æ˜“','å…¶å¯¦æ˜¯ç©¿è¶Šè€…','å‰ä¸–æ˜¯å¤§é­”æ³•å¸«','å¤±å»äº†éˆé­‚çš„ä¸€éƒ¨åˆ†','æ›¾ç¶“æ¯€æ‰ä¸€å€‹æ‘èŠ','è¦ºé†’äº†ç¦å¿ŒåŠ›é‡','æ›¾ç¶“çµ±æ²»ä¸–ç•Œ','èˆ‡ç¥ç§˜çµ„ç¹”æœ‰å‹¾çµ','æ“æœ‰æ­»äº¡å›æº¯çš„èƒ½åŠ›','éš±è—è‘—ç¬¬ä¸‰äººæ ¼','æ“æœ‰æ°¸ç”Ÿ','èº«é«”å…¶å¯¦æ˜¯è¤‡è£½å“','æ›¾ç¶“æ„›ä¸Šæ•µäºº','æ˜¯é è¨€ä¹‹å­','å…¶å¯¦æ˜¯å¦ä¸€æ€§åˆ¥','ä¸€éƒ¨åˆ†è¨˜æ†¶è¢«å°å°','æ›¾å·ç«Šç¥å™¨','å…§å¿ƒä½è‘—æƒ¡é­”','æ›¾ç¶“çŠ§ç‰²ä¸€å€‹åŸé®','çœŸå¯¦èº«ä»½æ˜¯é­”ç‹ä¹‹å­','èˆ‡å®¿æ•µæ˜¯å…„å¼Ÿå§å¦¹','è¢«æ¨™è¨˜ç‚ºå›å¾’','æ›¾åœ¨å¤¢ä¸­æ¯€æ»…ä¸–ç•Œ','æ˜¯å¤©ä½¿èˆ‡äººé¡çš„æ··è¡€','æ›¾ç¶“æ˜¯ç¥çš„ä½¿è€…','èƒŒè² è¡€æµ·æ·±ä»‡','é«”å…§æœ‰ä¸€æŠŠåŠ','æ“æœ‰å¬å–šäº¡éˆçš„èƒ½åŠ›','æ˜¯å¤±è½æ–‡æ˜çš„ç¹¼æ‰¿è€…','å…¶å¯¦æ˜¯ä¸€å€‹å¹»å½±','æ›¾ç¶“æ®ºéè‡³è¦ª','æ˜¯åæ´¾çš„çˆ¶è¦ª/æ¯è¦ª','éš±è—è‘—å·¨é¡è²¡å¯Œ','èˆ‡é¾ç°½è¨‚å¥‘ç´„','æ›¾æ˜¯åæ®ºæ‰‹','æ“æœ‰ç©¿æ¢­å¤¢å¢ƒçš„èƒ½åŠ›','èº«é«”è£¡æœ‰å¦ä¸€å€‹éˆé­‚','æ›¾ç¶“èƒŒå›æ•´å€‹åœ‹å®¶','æ˜¯å°æ‰‹çš„æ„›äºº','å…¶å¯¦æ—©å·²æ­»å»','æŒæœ‰é€šå¾€å¦ä¸€ä¸–ç•Œçš„é–€','è¢«é è¨€å°‡å¸¶ä¾†æ¯€æ»…','æ›¾æ˜¯æ•µè»çš„é ˜è¢–','æ›¾ç¶“æ‹¯æ•‘ä¸–ç•Œå»æ²’äººçŸ¥é“','æ˜¯æœªä¾†è‡ªå·±','è¢«æ”¹é€ é','æ›¾ç¶“æ˜¯æ©Ÿå™¨äºº','éš±è—è‘—ä¸€å€‹å­©å­','æ›¾åœ¨æ™‚é–“æ¼©æ¸¦è¿·å¤±','å…¶å¯¦æ˜¯é‚ªç¥çš„å­©å­','æ›¾èˆ‡å¦–ç²¾ç°½ç´„','éå»æ˜¯å¼·å¤§å·«å¸«','éˆé­‚è¢«è©›å’’','èˆ‡ç¥–å…ˆå°è©±','æŸéƒ¨åˆ†èº«é«”ä¸æ˜¯è‡ªå·±çš„','å…¶å¯¦æ˜¯å…‹éš†äºº','æœ‰æœªä¾†çš„è¨˜æ†¶','é çŸ¥è‡ªå·±æ­»äº¡','æ›¾ç¶“è¢«ç¥é¸ä¸­','é«”å…§å°å°è‘—é­”ç‹','éå»æ˜¯å¤©å®®å®ˆè¡›','æ›¾ç¶“æ˜¯æ˜Ÿéš›æµ·ç›œ'];
      const relationOptions = ['èˆ‡çˆ¶è¦ªé—œä¿‚ç–é›¢','èˆ‡èˆŠæƒ…äººæœ‰æœªäº†çµ','èˆ‡å¦ä¸€ä½è§’è‰²æœ‰èª“ç´„','æ›¾èƒŒå›éæœ€å¥½çš„æœ‹å‹','æ¬ äº†é»‘å¹«å·¨å‚µ','å°å°å¸«åˆæ•¬åˆæ¨','è¦–æ•µç‚ºå…„å¼Ÿ','ç§˜å¯†æ„›æ…•å¤¥ä¼´','è¢«å®¶æ—é€å‡º','èˆ‡å®¿æ•µäº’ç›¸å°Šé‡','æ¬ ä¸‹ä¸å¯é‚„æ¸…çš„æ•‘å‘½æ©æƒ…','èˆ‡åŒä¼´ç«¶çˆ­','èª“æ­»ä¿è­·å¼Ÿå¼Ÿ','æ›¾æ•‘éåæ´¾','æš—ä¸­åˆä½œåˆäº’ç›¸åˆ©ç”¨','é—œä¿‚è¤‡é›œçš„è¦ªæˆš','èˆ‡æ”¿åºœå­˜åœ¨ç‰½é€£','è¢«æµæ”¾å¾Œçµè­˜æ—…ä¼´','èˆ‡å¤è€ç¥ç¥‡æœ‰å¥‘ç´„','éš±çäº†å‰ä¸–çš„ç‰½çµ†','èˆ‡å‰ä»»æƒ…äººå†åº¦é‡é€¢','èˆ‡å®¿æ•µæ›¾æ˜¯å…„å¼Ÿ','æš—æˆ€åŒæ€§æœ‹å‹','è¢«å®¶æ—è¦–ç‚ºç•°é¡','èˆ‡æŸä½ç¥ç¥‡ç°½è¨‚å¥‘ç´„','æ˜¯å¦ä¸€äººç‰©çš„å¤±æ•£è¦ªäºº','å°æ•µäººå……æ»¿æƒ»éš±','èˆ‡æŸç”Ÿç‰©æœ‰å…±ç”Ÿé—œä¿‚','èˆ‡æ­·å²äººç‰©æœ‰è¡€ç·£','ç‚ºäº†å®¶æ—è€ŒçŠ§ç‰²å€‹äººå¹¸ç¦','æ›¾æ˜¯æƒ…æ•µ','ç›¸æ„›ç›¸æ®º','æ˜¯ç›¸äº’æ‰¶æŒçš„æ—…è¡Œå¤¥ä¼´','æ˜¯ä¸€è¦‹é˜æƒ…','å¹¼æ™‚ç©ä¼´','å‰ä¸–å¤«å¦»','äº’ç‚ºå¸«å¾’','å› æ©æ€¨çµç·£','å®¿æ•µå»äº’ç›¸ç†è§£','ä¸Šå¸èˆ‡ä¸‹å±¬','æ‚£é›£ä¹‹äº¤','æƒ…åŒæ‰‹è¶³','ç”Ÿæ­»ä¹‹äº¤','é‡ç”Ÿå¾Œçš„æ•µäºº','ç”Ÿå‘½äº’ç›¸ä¾å­˜','å‘½é‹çš„ç‰½çµ†','é¤Šçˆ¶èˆ‡é¤Šå­','é›™èƒèƒ','ä¸€æ–¹æ˜¯å¦å¤–ä¸€æ–¹çš„å½±å­','éˆé­‚éˆæ¥','å¥‘ç´„é—œä¿‚','æ›¾ç¶“æ•‘éå°æ–¹ä¸€å‘½','äº’ç‚ºå°æ–¹çš„æ‹¯æ•‘','è¡çªä¸æ–·çš„å¤¥ä¼´','é’æ¢…ç«¹é¦¬','ä¸æ‰“ä¸ç›¸è­˜','äº’ç›¸æ¬£è³','åŠè·¯å…„å¦¹','ç¾©æ°£ç›¸æŒº','å› èª¤æœƒè€Œæ•µå°','é›‡ä¸»èˆ‡å‚­å…µ','é›™æ–¹æœ‰å©šç´„','åŸå…ˆåŒé–€ï¼Œå¾Œåˆ†é“æšé‘£','ç¥èˆ‡ä¿¡å¾’','æŠ•æ©Ÿåˆä½œ','å½¼æ­¤åˆ©ç”¨','æœ‹å‹å…¼ç«¶çˆ­å°æ‰‹','æš—ä¸­å®ˆè­·','å› æ¬ŠåŠ›çˆ­é¬¥ç›¸è­˜','ç ´é¡é‡åœ“','é›™æ–¹æ˜¯é æˆ¿è¦ªæˆš','ç›¸äº’å‚¾æ…•','å‰ä¸–æ­»æ•µ','äº’ç‚ºé¡åƒ','è¼ªè¿´ä¸­çš„ç¾ˆçµ†','éºå¿—çš„ç¹¼æ‰¿è€…èˆ‡å‚³æ‰¿è€…','å¾’å¼Ÿèˆ‡å¸«å…„','ç”Ÿæ­»æ•µå°','ä»£æ›¿å°æ–¹å®Œæˆä½¿å‘½','è¢«è¿«æˆç‚ºåŒä¼´','ä¸€æ–¹æ¬ å¦ä¸€æ–¹äººæƒ…','å½¼æ­¤å¿ƒæœ‰æ„§ç–š','å…±åŒçš„æ•µäºº','æœ€å¥½çš„æœ‹å‹','èµ°å¤±å¾Œç›¸é‡','ç¥–å­«è·¨è¶Šæ™‚ç©ºç›¸é‡','åŒç‚ºç ”ç©¶ä¼™ä¼´','ç«¶çˆ­æ„›æ…•å°è±¡','ç„¡è¡€ç·£å»åƒå®¶äºº','å¸¸å¸¸åµæ¶å»é»˜å¥‘åè¶³','æœªå©šå¤«å¦»','äº’ç›¸ç‰½åˆ¶','ç›¸äº’æ‰¿è«¾ä¸€èµ·å†’éšª','è¦ªå­é—œä¿‚','è¢«é è¨€æœƒäº’ç›¸æ®˜æ®º','åŒæ™‚æ„›ä¸Šç¬¬ä¸‰è€…','æ›¾äº’æ•‘ç”Ÿå‘½','æ˜Ÿéš›æ—…ä¼´','åŒç‚ºå¤±è½æ—äºº','ç•°æ—æˆ€äºº','ä¸¦è‚©ä½œæˆ°','çµæ‹œå…„å¼Ÿ','é‡é€¢æ–¼æ—…é€”','å¤©ä½œä¹‹åˆ','è‡ªç”±èˆ‡è²¬ä»»çš„ç‰½çµ†'];

      function pickRandom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }

      // ==================== äººç‰©è¨­å®š ====================
      function addCharacterRow(randomize = false) {
        const row = document.createElement('div');
        row.className = 'character-row';
        updateCharacterIndices();
        const index = charactersContainer.children.length + 1;
        row.innerHTML = `
          <div class="char-index">äººç‰© ${index}</div>
          <select class="char-gender" style="flex: 0 0 70px; min-width: 70px;">
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
            <option value="ä¸æ˜">ä¸æ˜</option>
          </select>
          <input type="number" class="char-age" placeholder="å¹´é½¡" min="1" max="9999" style="flex: 0 0 70px; min-width: 70px;" />
          <input type="text" class="char-name" placeholder="å§“å" />
          <input type="text" class="char-personality" placeholder="å€‹æ€§" />
          <input type="text" class="char-goal" placeholder="ç›®æ¨™" />
          <input type="text" class="char-weakness" placeholder="å¼±é»" />
          <input type="text" class="char-secret" placeholder="ç§˜å¯†" />
          <input type="text" class="char-relation" placeholder="äººéš›" />
          <button type="button" class="char-random-btn btn-outline btn-small">ğŸ²</button>
          <button type="button" class="char-remove-btn btn-outline btn-small" title="ç§»é™¤æ­¤äººç‰©">âœ•</button>
        `;
        const randBtn = row.querySelector('.char-random-btn');
        randBtn.addEventListener('click', () => {
          randomizeRow(row, false);
          saveSettingsToLocal();
        });
        
        const removeBtn = row.querySelector('.char-remove-btn');
        removeBtn.addEventListener('click', () => {
          if (charactersContainer.children.length > 1) {
            row.remove();
            updateCharacterIndices();
            saveSettingsToLocal();
          } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä½äººç‰©ï¼');
          }
        });
        
        // ç›£è½è¼¸å…¥è®Šæ›´ä»¥è‡ªå‹•å„²å­˜
        row.querySelectorAll('input, select').forEach(el => {
          el.addEventListener('change', saveSettingsToLocal);
          el.addEventListener('input', debounce(saveSettingsToLocal, 500));
        });
        
        charactersContainer.appendChild(row);
        if (randomize) {
          // æ–°å¢äººç‰©æ™‚ï¼Œå…ˆæ”¶é›†å·²æœ‰çš„åå­—é¿å…é‡è¤‡
          usedNames.clear();
          Array.from(charactersContainer.children).forEach(r => {
            if (r !== row) {
              const name = r.querySelector('.char-name').value.trim();
              if (name) usedNames.add(name);
            }
          });
          randomizeRow(row, false);
        }
      }
      
      // æ›´æ–°äººç‰©ç·¨è™Ÿ
      function updateCharacterIndices() {
        Array.from(charactersContainer.children).forEach((row, idx) => {
          const indexEl = row.querySelector('.char-index');
          if (indexEl) indexEl.textContent = `äººç‰© ${idx + 1}`;
        });
      }
      
      // é˜²æŠ–å‡½æ•¸
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // æ™ºèƒ½éš¨æ©Ÿé¸æ“‡ï¼šé¿å…é‡è¤‡ï¼ˆäººåçµ•å°ä¸é‡è¤‡ï¼Œå…¶ä»–ç›¡é‡ä¸é‡è¤‡ï¼‰
      function pickRandomUnique(arr, usedSet, allowRepeat = false) {
        // éæ¿¾æ‰å·²ä½¿ç”¨çš„é¸é …
        const available = arr.filter(item => !usedSet.has(item));
        
        // å¦‚æœæ²’æœ‰å¯ç”¨é¸é …
        if (available.length === 0) {
          if (allowRepeat) {
            // å…è¨±é‡è¤‡æ™‚ï¼Œå¾å…¨éƒ¨é¸é …ä¸­é¸
            return arr[Math.floor(Math.random() * arr.length)];
          } else {
            // ä¸å…è¨±é‡è¤‡æ™‚ï¼Œè¿”å› nullï¼ˆäººåç”¨ï¼‰
            return null;
          }
        }
        
        const chosen = available[Math.floor(Math.random() * available.length)];
        usedSet.add(chosen);
        return chosen;
      }

      // ç”¨æ–¼è¿½è¹¤å·²ä½¿ç”¨çš„é¸é …
      let usedNames = new Set();
      let usedPersonalities = new Set();
      let usedGoals = new Set();
      let usedWeaknesses = new Set();
      let usedSecrets = new Set();
      let usedRelations = new Set();

      // é‡ç½®æ‰€æœ‰è¿½è¹¤ï¼ˆç•¶é‡æ–°éš¨æ©Ÿå…¨éƒ¨äººç‰©æ™‚ï¼‰
      function resetUsedOptions() {
        usedNames.clear();
        usedPersonalities.clear();
        usedGoals.clear();
        usedWeaknesses.clear();
        usedSecrets.clear();
        usedRelations.clear();
        
        // æŠŠç›®å‰å·²å¡«å…¥çš„äººååŠ å…¥ usedNamesï¼ˆé¿å…èˆ‡ç¾æœ‰é‡è¤‡ï¼‰
        Array.from(charactersContainer.children).forEach(row => {
          const name = row.querySelector('.char-name').value.trim();
          if (name) usedNames.add(name);
        });
      }

      // å–®è¡Œéš¨æ©ŸåŒ–ï¼ˆç”¨æ–¼å–®å€‹äººç‰©çš„éš¨æ©ŸæŒ‰éˆ•ï¼‰
      function randomizeRow(row, isFullRandom = false) {
        // å¦‚æœæ˜¯å–®ç¨éš¨æ©Ÿä¸€è¡Œï¼Œå…ˆæ”¶é›†å…¶ä»–è¡Œå·²ç”¨çš„åå­—
        if (!isFullRandom) {
          usedNames.clear();
          Array.from(charactersContainer.children).forEach(r => {
            if (r !== row) {
              const name = r.querySelector('.char-name').value.trim();
              if (name) usedNames.add(name);
            }
          });
        }
        
        // å…ˆéš¨æ©Ÿæ€§åˆ¥
        const genderSelect = row.querySelector('.char-gender');
        const genders = ['ç”·', 'å¥³'];
        genderSelect.value = genders[Math.floor(Math.random() * genders.length)];
        
        // æ ¹æ“šæ€§åˆ¥é¸æ“‡åå­—åº«
        const gender = genderSelect.value;
        let namePool;
        if (gender === 'ç”·') {
          namePool = maleNames;
        } else if (gender === 'å¥³') {
          namePool = femaleNames;
        } else {
          namePool = nameOptions; // ä¸æ˜æ€§åˆ¥ç”¨å…¨éƒ¨åå­—
        }
        
        // äººåï¼šçµ•å°ä¸é‡è¤‡
        const newName = pickRandomUnique(namePool, usedNames, false);
        if (newName) {
          row.querySelector('.char-name').value = newName;
        } else {
          // å¦‚æœè©²æ€§åˆ¥åå­—éƒ½ç”¨å®Œäº†ï¼Œå¾å…¨éƒ¨åå­—ä¸­é¸
          const fallbackName = pickRandomUnique(nameOptions, usedNames, false);
          if (fallbackName) {
            row.querySelector('.char-name').value = fallbackName;
          } else {
            // çœŸçš„éƒ½ç”¨å®Œäº†ï¼ŒåŠ ç·¨è™Ÿ
            const baseName = namePool[Math.floor(Math.random() * namePool.length)];
            row.querySelector('.char-name').value = baseName + (Math.floor(Math.random() * 100));
          }
        }
        
        // å…¶ä»–å±¬æ€§ï¼šç›¡é‡ä¸é‡è¤‡ï¼Œä½†å…è¨±åœ¨é¸é …ç”¨å®Œæ™‚é‡è¤‡
        row.querySelector('.char-personality').value = pickRandomUnique(personalityOptions, usedPersonalities, true);
        row.querySelector('.char-goal').value = pickRandomUnique(goalOptions, usedGoals, true);
        row.querySelector('.char-weakness').value = pickRandomUnique(weaknessOptions, usedWeaknesses, true);
        row.querySelector('.char-secret').value = pickRandomUnique(secretOptions, usedSecrets, true);
        row.querySelector('.char-relation').value = pickRandomUnique(relationOptions, usedRelations, true);
        
        // å¹´é½¡éš¨æ©Ÿï¼ˆæ ¹æ“šæ•…äº‹é¡å‹å¯èƒ½æœ‰ä¸åŒç¯„åœï¼Œé€™è£¡ç”¨é€šç”¨ç¯„åœï¼‰
        const ageRanges = [
          { min: 6, max: 12, weight: 1 },    // å…’ç«¥
          { min: 13, max: 17, weight: 2 },   // é’å°‘å¹´
          { min: 18, max: 25, weight: 4 },   // é’å¹´
          { min: 26, max: 35, weight: 3 },   // å£¯å¹´
          { min: 36, max: 50, weight: 2 },   // ä¸­å¹´
          { min: 51, max: 70, weight: 1 },   // è€å¹´
        ];
        const totalWeight = ageRanges.reduce((sum, r) => sum + r.weight, 0);
        let rand = Math.random() * totalWeight;
        let selectedRange = ageRanges[0];
        for (const range of ageRanges) {
          rand -= range.weight;
          if (rand <= 0) {
            selectedRange = range;
            break;
          }
        }
        row.querySelector('.char-age').value = Math.floor(Math.random() * (selectedRange.max - selectedRange.min + 1)) + selectedRange.min;
      }

      // å…¨éƒ¨äººç‰©éš¨æ©ŸåŒ–
      function randomizeAllCharacters() {
        // é‡ç½®è¿½è¹¤
        usedNames.clear();
        usedPersonalities.clear();
        usedGoals.clear();
        usedWeaknesses.clear();
        usedSecrets.clear();
        usedRelations.clear();
        
        // ä¾åºéš¨æ©ŸåŒ–æ¯ä¸€è¡Œ
        Array.from(charactersContainer.children).forEach(row => {
          randomizeRow(row, true);
        });
      }

      // ==================== æœ¬åœ°å„²å­˜è¨­å®š ====================
      function saveSettingsToLocal() {
        try {
          const settings = {
            theme: themeSelect.value,
            setting: settingSelect.value,
            style: styleSelect.value,
            chapters: chaptersInput.value,
            length: lengthInput.value,
            notes: notesInput.value,
            characters: []
          };
          
          Array.from(charactersContainer.children).forEach(row => {
            settings.characters.push({
              gender: row.querySelector('.char-gender').value,
              age: row.querySelector('.char-age').value,
              name: row.querySelector('.char-name').value,
              personality: row.querySelector('.char-personality').value,
              goal: row.querySelector('.char-goal').value,
              weakness: row.querySelector('.char-weakness').value,
              secret: row.querySelector('.char-secret').value,
              relation: row.querySelector('.char-relation').value
            });
          });
          
          localStorage.setItem('novelGeneratorSettings', JSON.stringify(settings));
        } catch (e) {
          console.warn('ç„¡æ³•å„²å­˜è¨­å®šï¼š', e);
        }
      }
      
      function loadSettingsFromLocal() {
        try {
          const raw = localStorage.getItem('novelGeneratorSettings');
          if (!raw) return false;
          
          const settings = JSON.parse(raw);
          let hasData = false;
          
          // è¼‰å…¥åŸºæœ¬è¨­å®š
          if (settings.theme) { themeSelect.value = settings.theme; hasData = true; }
          if (settings.setting) { settingSelect.value = settings.setting; hasData = true; }
          if (settings.style) { styleSelect.value = settings.style; hasData = true; }
          if (settings.chapters) { chaptersInput.value = settings.chapters; hasData = true; }
          if (settings.length) { lengthInput.value = settings.length; hasData = true; }
          if (settings.notes) { notesInput.value = settings.notes; hasData = true; }
          
          // è¼‰å…¥äººç‰©è¨­å®š
          if (settings.characters && settings.characters.length > 0) {
            // æ¸…ç©ºç¾æœ‰äººç‰©
            charactersContainer.innerHTML = '';
            
            settings.characters.forEach(char => {
              addCharacterRow(false); // ä¸éš¨æ©Ÿ
              const row = charactersContainer.lastElementChild;
              if (row) {
                row.querySelector('.char-gender').value = char.gender || 'ä¸æ˜';
                row.querySelector('.char-age').value = char.age || '';
                row.querySelector('.char-name').value = char.name || '';
                row.querySelector('.char-personality').value = char.personality || '';
                row.querySelector('.char-goal').value = char.goal || '';
                row.querySelector('.char-weakness').value = char.weakness || '';
                row.querySelector('.char-secret').value = char.secret || '';
                row.querySelector('.char-relation').value = char.relation || '';
              }
            });
            hasData = true;
          }
          
          console.log('è¨­å®šå·²å¾æœ¬åœ°è¼‰å…¥', settings);
          return hasData;
        } catch (e) {
          console.warn('ç„¡æ³•è¼‰å…¥è¨­å®šï¼š', e);
          return false;
        }
      }
      
      // ç›£è½åŸºæœ¬è¨­å®šçš„è®Šæ›´
      [themeSelect, settingSelect, styleSelect, chaptersInput, lengthInput, notesInput].forEach(el => {
        el.addEventListener('change', saveSettingsToLocal);
        el.addEventListener('input', debounce(saveSettingsToLocal, 500));
      });
      
      // å‹•æ…‹ç”Ÿæˆä¸‹æ‹‰é¸å–®é¸é …
      function populateSelectOptions() {
        // ä¸»é¡Œé¸é …
        themes.forEach(theme => {
          const option = document.createElement('option');
          option.value = theme;
          option.textContent = theme;
          themeSelect.appendChild(option);
        });
        
        // èƒŒæ™¯è¨­å®šé¸é …
        settingsData.forEach(setting => {
          const option = document.createElement('option');
          option.value = setting;
          option.textContent = setting;
          settingSelect.appendChild(option);
        });
        
        // é¢¨æ ¼é¸é …
        stylesArr.forEach(style => {
          const option = document.createElement('option');
          option.value = style;
          option.textContent = style;
          styleSelect.appendChild(option);
        });
      }

      // åˆå§‹åŒ–ï¼šè¼‰å…¥è¨­å®šæˆ–å»ºç«‹é è¨­äººç‰©
      (function initSettings() {
        // å…ˆç”Ÿæˆä¸‹æ‹‰é¸å–®é¸é …
        populateSelectOptions();
        
        // å˜—è©¦è¼‰å…¥å·²å„²å­˜çš„è¨­å®š
        const hasSettings = loadSettingsFromLocal();
        
        // å¦‚æœæ²’æœ‰å·²å„²å­˜çš„è¨­å®šï¼Œæ‰å»ºç«‹é è¨­äººç‰©
        if (!hasSettings) {
          addCharacterRow(true);
          addCharacterRow(true);
        }
        
        renderBookmarks();
      })();

      randomAllCharactersBtn.addEventListener('click', () => {
        randomizeAllCharacters();
        saveSettingsToLocal();
      });

      addCharacterBtn.addEventListener('click', () => {
        addCharacterRow(true);
        saveSettingsToLocal();
      });

      randomBtn.addEventListener('click', () => {
        themeSelect.value = pickRandom(themes);
        settingSelect.value = pickRandom(settingsData);
        styleSelect.value = pickRandom(stylesArr);
        chaptersInput.value = pickRandom(chapterOpts);
        lengthInput.value = pickRandom(lengthOpts);
        randomizeAllCharacters();
        saveSettingsToLocal();
      });

      // ==================== æ™ºèƒ½æµ®å‹•ç« ç¯€å°èˆª ====================

      // åˆ‡æ›é¢æ¿é¡¯ç¤º
      chapterNavToggle.addEventListener('click', () => {
        isPanelOpen = !isPanelOpen;
        chapterNavPanel.classList.toggle('open', isPanelOpen);
      });

      chapterNavClose.addEventListener('click', () => {
        isPanelOpen = false;
        chapterNavPanel.classList.remove('open');
      });

      // é»æ“Šé¢æ¿å¤–éƒ¨é—œé–‰
      document.addEventListener('click', (e) => {
        if (isPanelOpen && 
            !chapterNavPanel.contains(e.target) && 
            !chapterNavToggle.contains(e.target)) {
          isPanelOpen = false;
          chapterNavPanel.classList.remove('open');
        }
      });

      // é–±è®€é€²åº¦è¿½è¹¤
      window.addEventListener('scroll', () => {
        if (!resultDiv.textContent) return;
        
        const rect = resultDiv.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const docHeight = resultDiv.offsetHeight;
        
        // è¨ˆç®—é–±è®€é€²åº¦
        if (rect.top < windowHeight && rect.bottom > 0) {
          const visibleTop = Math.max(0, -rect.top);
          const progress = Math.min(100, (visibleTop / (docHeight - windowHeight)) * 100);
          readingProgress.style.width = Math.max(0, Math.min(100, progress)) + '%';
        }
        
        // è‡ªå‹•æ›´æ–°ç•¶å‰ç« ç¯€é«˜äº®
        updateCurrentChapter();
      });

      function updateCurrentChapter() {
        if (chapterMatches.length === 0) return;
        
        const scrollY = window.scrollY;
        const resultRect = resultDiv.getBoundingClientRect();
        const resultTop = resultRect.top + window.scrollY;
        
        let currentChapterIdx = 0;
        
        for (let i = 0; i < chapterMatches.length; i++) {
          const chapterTitle = chapterMatches[i].title;
          const textContent = resultDiv.textContent;
          const chapterIndex = textContent.indexOf(chapterTitle);
          
          // ä¼°ç®—ç« ç¯€åœ¨é é¢ä¸­çš„ä½ç½®
          const ratio = chapterIndex / textContent.length;
          const estimatedPos = resultTop + (resultDiv.offsetHeight * ratio);
          
          if (scrollY >= estimatedPos - 100) {
            currentChapterIdx = i;
          }
        }
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        const buttons = chapterNavList.querySelectorAll('button');
        buttons.forEach((btn, idx) => {
          btn.classList.toggle('active', idx === currentChapterIdx);
        });
      }

      function parseAndShowChapters(text) {
        chapterMatches = [];
        
        // ç­–ç•¥ï¼šåªåŒ¹é…æ­£æ–‡ä¸­çš„ç« ç¯€æ¨™é¡Œ
        // æ­£æ–‡ç« ç¯€ç‰¹å¾µï¼šä»¥ ## æˆ– ### é–‹é ­ï¼ˆmarkdownæ ¼å¼ï¼‰
        // ç›®éŒ„ç« ç¯€ç‰¹å¾µï¼šä»¥æ•¸å­—ç·¨è™Ÿé–‹é ­ï¼Œå¦‚ "1." "2." æˆ–æœ‰ ** ç²—é«”æ¨™è¨˜
        
        // ç« ç¯€æ¨¡å¼ï¼šç¬¬Xç« ã€åºç« ã€æ¥”å­ã€å°¾è²ã€çµ‚ç« ã€ç•ªå¤–ç­‰
        const chapterPattern = /(?:ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾é›¶\d]+ç« |åºç« |æ¥”å­|å¼•å­|å‰è¨€|å°¾è²|çµ‚ç« |ç•ªå¤–|å¾Œè¨˜|epilogue|prologue)[ï¼š:]*[^\n]*/i;
        
        const lines = text.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // åŒ¹é…ä»¥ ## æˆ– ### é–‹é ­çš„ç« ç¯€æ¨™é¡Œï¼ˆé€™æ˜¯æ­£æ–‡ç« ç¯€ï¼‰
          const markdownMatch = line.match(/^##[#]?\s*((?:ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾é›¶\d]+ç« |åºç« |æ¥”å­|å¼•å­|å‰è¨€|å°¾è²|çµ‚ç« |ç•ªå¤–|å¾Œè¨˜)[ï¼š:].*)$/i);
          
          if (markdownMatch) {
            // è¨ˆç®—é€™ä¸€è¡Œåœ¨åŸæ–‡ä¸­çš„ä½ç½®
            let index = 0;
            for (let j = 0; j < i; j++) {
              index += lines[j].length + 1; // +1 for \n
            }
            
            chapterMatches.push({
              title: markdownMatch[1].trim(),
              fullLine: line,
              index: index
            });
          }
        }
        
        // å¦‚æœæ²’æœ‰æ‰¾åˆ° ### æ ¼å¼ï¼Œå˜—è©¦æ‰¾ç¨ç«‹è¡Œçš„ç« ç¯€æ¨™é¡Œï¼ˆä¸æ˜¯åˆ—è¡¨é …ï¼‰
        if (chapterMatches.length === 0) {
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const prevLine = i > 0 ? lines[i - 1] : '';
            
            // æ’é™¤ç›®éŒ„é …ï¼šä¸ä»¥æ•¸å­—é–‹é ­ã€ä¸å« ** ç²—é«”ã€å‰ä¸€è¡Œæ˜¯ç©ºè¡Œ
            const isListItem = /^\d+\.\s/.test(line) || /\*\*/.test(line);
            const isAfterBlankLine = prevLine.trim() === '' || prevLine.trim() === '---';
            
            if (!isListItem && isAfterBlankLine) {
              const match = line.match(/^((?:ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾é›¶\d]+ç« |åºç« |æ¥”å­|å¼•å­|å‰è¨€|å°¾è²|çµ‚ç« |ç•ªå¤–|å¾Œè¨˜)[ï¼š:].*)$/i);
              if (match) {
                let index = 0;
                for (let j = 0; j < i; j++) {
                  index += lines[j].length + 1;
                }
                chapterMatches.push({
                  title: match[1].trim(),
                  fullLine: line,
                  index: index
                });
              }
            }
          }
        }
        
        // å»é™¤é‡è¤‡ï¼ˆä»¥ç« ç¯€ç·¨è™Ÿæˆ–åç¨±ç‚ºæº–ï¼‰
        const seenChapters = new Set();
        chapterMatches = chapterMatches.filter(m => {
          // æå–ç« ç¯€æ¨™è­˜ï¼ˆå¦‚ã€Œç¬¬ä¸€ç« ã€ã€Œåºç« ã€ã€Œæ¥”å­ã€ç­‰ï¼‰
          const chapterIdMatch = m.title.match(/ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾é›¶\d]+ç« |åºç« |æ¥”å­|å¼•å­|å‰è¨€|å°¾è²|çµ‚ç« |ç•ªå¤–|å¾Œè¨˜/i);
          if (chapterIdMatch) {
            const chapterId = chapterIdMatch[0];
            if (!seenChapters.has(chapterId)) {
              seenChapters.add(chapterId);
              return true;
            }
          }
          return false;
        });

        // åªè¦æœ‰ç« ç¯€å°±é¡¯ç¤ºï¼ˆæ”¹ç‚º >= 1ï¼‰
        if (chapterMatches.length >= 1) {
          // é¡¯ç¤ºæµ®å‹•å°èˆª
          chapterNavContainer.classList.add('show');
          chapterBadge.textContent = chapterMatches.length;
          
          // ç”Ÿæˆç« ç¯€åˆ—è¡¨
          chapterNavList.innerHTML = chapterMatches.map((m, i) => 
            `<button type="button" data-chapter="${i}">
              <span class="chapter-num">${i + 1}</span>
              ${m.title.substring(0, 20)}${m.title.length > 20 ? '...' : ''}
            </button>`
          ).join('');
          
          // ç¶å®šé»æ“Šäº‹ä»¶
          chapterNavList.querySelectorAll('button').forEach((btn, idx) => {
            btn.addEventListener('click', () => {
              const chapter = chapterMatches[idx];
              const fullText = resultDiv.textContent;
              
              // æœå°‹å®Œæ•´çš„ç« ç¯€è¡Œï¼ˆåŒ…å« ### æˆ–ä¸å«ï¼‰
              // å› ç‚º textContent ä¸æœƒä¿ç•™ ### ç¬¦è™Ÿï¼Œéœ€è¦æœå°‹æ¨™é¡Œæœ¬èº«
              const searchTitle = chapter.title;
              
              // å¾å„²å­˜çš„ index é™„è¿‘æœå°‹ï¼ˆé¿å…æ‰¾åˆ°ç›®éŒ„ï¼‰
              // æ‰¾æ‰€æœ‰å‡ºç¾ä½ç½®ï¼Œé¸æ“‡æœ€æ¥è¿‘å„²å­˜ index çš„é‚£å€‹
              let bestIndex = -1;
              let searchStart = 0;
              
              while (true) {
                const foundIndex = fullText.indexOf(searchTitle, searchStart);
                if (foundIndex === -1) break;
                
                // æª¢æŸ¥é€™å€‹ä½ç½®æ˜¯å¦æ›´æ¥è¿‘ç›®æ¨™
                if (bestIndex === -1 || Math.abs(foundIndex - chapter.index) < Math.abs(bestIndex - chapter.index)) {
                  // é¡å¤–æª¢æŸ¥ï¼šé€™å€‹ä½ç½®å‰é¢ä¸æ‡‰è©²æ˜¯æ•¸å­—ç·¨è™Ÿï¼ˆæ’é™¤ç›®éŒ„ï¼‰
                  const beforeText = fullText.substring(Math.max(0, foundIndex - 10), foundIndex);
                  const isInTOC = /\d+\.\s*$/.test(beforeText) || /\*\*\s*$/.test(beforeText);
                  
                  if (!isInTOC) {
                    bestIndex = foundIndex;
                  }
                }
                searchStart = foundIndex + 1;
              }
              
              if (bestIndex !== -1) {
                const beforeChapter = fullText.substring(0, bestIndex);
                const chapterText = searchTitle;
                const afterChapter = fullText.substring(bestIndex + searchTitle.length);
                
                resultDiv.innerHTML = 
                  escapeHtml(beforeChapter) + 
                  '<span id="chapter-target" style="scroll-margin-top: 20px;">' + escapeHtml(chapterText) + '</span>' + 
                  escapeHtml(afterChapter);
                
                const target = document.getElementById('chapter-target');
                if (target) {
                  target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  
                  // é«˜äº®æ•ˆæœ
                  target.style.background = 'linear-gradient(90deg, rgba(233, 69, 96, 0.3), rgba(244, 162, 97, 0.1))';
                  target.style.borderRadius = '4px';
                  target.style.padding = '4px 8px';
                  target.style.marginLeft = '-8px';
                  
                  setTimeout(() => {
                    target.style.transition = 'background 1.5s ease';
                    target.style.background = 'transparent';
                  }, 2000);
                }
              }
              
              // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
              chapterNavList.querySelectorAll('button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              
              // è¡Œå‹•è£ç½®ä¸Šè‡ªå‹•é—œé–‰é¢æ¿
              if (window.innerWidth <= 768) {
                isPanelOpen = false;
                chapterNavPanel.classList.remove('open');
              }
            });
          });
        } else {
          chapterNavContainer.classList.remove('show');
          chapterMatches = [];
        }
      }

      // HTML è½‰ç¾©å‡½æ•¸
      function escapeHtml(text) {
        return text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // ==================== ç”Ÿæˆæ•…äº‹ ====================
      generateBtn.addEventListener('click', async () => {
        hideStatus();
        resultDiv.textContent = '';
        chapterNavContainer.classList.remove('show');
        chapterMatches = [];
        localStorage.removeItem('savedStory');
        latestStory = '';
        downloadBtn.disabled = true;
        continueBtn.disabled = true;

        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        const theme = themeSelect.value.trim();
        const setting = settingSelect.value.trim();
        
        const characterRows = Array.from(charactersContainer.querySelectorAll('.character-row'));
        let charactersInfo = '';
        characterRows.forEach((row, idx) => {
          const fields = [];
          const gender = row.querySelector('.char-gender').value;
          const age = row.querySelector('.char-age').value.trim();
          const name = row.querySelector('.char-name').value.trim();
          const personality = row.querySelector('.char-personality').value.trim();
          const goal = row.querySelector('.char-goal').value.trim();
          const weakness = row.querySelector('.char-weakness').value.trim();
          const secret = row.querySelector('.char-secret').value.trim();
          const relation = row.querySelector('.char-relation').value.trim();
          if (name) fields.push(name);
          if (gender && gender !== 'ä¸æ˜') fields.push(`æ€§åˆ¥ï¼š${gender}`);
          if (age) fields.push(`å¹´é½¡ï¼š${age}æ­²`);
          if (personality) fields.push(`å€‹æ€§ï¼š${personality}`);
          if (goal) fields.push(`ç›®æ¨™ï¼š${goal}`);
          if (weakness) fields.push(`å¼±é»ï¼š${weakness}`);
          if (secret) fields.push(`ç§˜å¯†ï¼š${secret}`);
          if (relation) fields.push(`äººéš›ï¼š${relation}`);
          if (fields.length > 0) charactersInfo += `äººç‰©${idx + 1}ï¼š${fields.join('ï¼Œ')}ã€‚\n`;
        });
        
        const style = styleSelect.value.trim();
        const chapters = chaptersInput.value.trim();
        const length = lengthInput.value.trim();
        const notes = notesInput.value.trim();

        if (!apiKey) {
          showStatus('error', 'è«‹è¼¸å…¥ API é‡‘é‘°');
          return;
        }

        let prompt = '';
        if (theme) prompt += `ä¸»é¡Œï¼š${theme}ã€‚`;
        if (setting) prompt += `èƒŒæ™¯è¨­å®šï¼š${setting}ã€‚`;
        if (charactersInfo) prompt += `${charactersInfo}`;
        if (style) prompt += `æ•…äº‹é¢¨æ ¼ï¼š${style}ã€‚`;
        if (chapters) prompt += `æ•…äº‹åˆ†ç‚º ${chapters} ç« ç¯€ã€‚`;
        if (length) prompt += `ç¸½ç¯‡å¹…ç´„ ${length} å­—ã€‚`;
        if (notes) prompt += `å…¶ä»–èªªæ˜ï¼š${notes}ã€‚`;
        
        if (!theme && !setting && !charactersInfo && !style && !chapters && !length && !notes) {
          showStatus('error', 'è«‹è‡³å°‘å¡«å¯«ä¸€é …è¨­å®šæˆ–ä½¿ç”¨éš¨æ©Ÿå¡«å……');
          return;
        }
        
        prompt += `

ã€é‡è¦æŒ‡ç¤ºã€‘è«‹ç›´æ¥æ’°å¯«å°èªªã€Œæ­£æ–‡å…§å®¹ã€ï¼Œä¸è¦åªå¯«å¤§ç¶±ã€è¦åŠƒã€æ•…äº‹ç°¡ä»‹æˆ–ç« ç¯€åˆ—è¡¨ã€‚

è¦æ±‚ï¼š
1. ç›´æ¥é–‹å§‹å¯«æ•…äº‹æ­£æ–‡ï¼ŒåŒ…å«å ´æ™¯æå¯«ã€äººç‰©å°è©±ã€å¿ƒç†æ´»å‹•ã€æƒ…ç¯€ç™¼å±•
2. æ¯å€‹ç« ç¯€éƒ½è¦æœ‰å®Œæ•´çš„æ•…äº‹å…§å®¹ï¼ˆè‡³å°‘2000-3000å­—ï¼‰ï¼Œä¸æ˜¯ç°¡çŸ­çš„æ‘˜è¦
3. ç« ç¯€æ¨™é¡Œæ ¼å¼ï¼š### ç¬¬Xç« ï¼šæ¨™é¡Œï¼ˆæˆ– ### åºç« ï¼šæ¨™é¡Œï¼‰
4. ä½¿ç”¨ç¹é«”ä¸­æ–‡æ’°å¯«
5. æ•…äº‹è¦æœ‰èµ·æ‰¿è½‰åˆï¼Œæƒ…ç¯€å®Œæ•´
6. ç¦æ­¢å‡ºç¾ã€Œæ•…äº‹å¤§ç¶±ã€ã€Œç« ç¯€åˆ—è¡¨ã€ã€Œæ•…äº‹ç°¡ä»‹ã€ã€Œäººç‰©è¨­å®šã€ç­‰è¦åŠƒæ€§å…§å®¹
7. ç¦æ­¢ä½¿ç”¨æ¢åˆ—å¼èªªæ˜ï¼Œè¦ç”¨æ•˜äº‹æ–‡é«”

ç¾åœ¨é–‹å§‹æ’°å¯«å°èªªæ­£æ–‡ï¼š`;

        showStatus('loading', 'æ•…äº‹ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...');
        generateBtn.disabled = true;

        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
            }),
          });
          const data = await response.json();
          
          if (data.error) {
            showStatus('error', 'éŒ¯èª¤ï¼š' + data.error.message);
            return;
          }
          
          if (data.candidates && data.candidates.length > 0) {
            const parts = data.candidates[0].content.parts || [];
            const story = parts.map(p => p.text || '').join('');
            latestStory = story.trim();
            resultDiv.textContent = latestStory;
            
            try {
              localStorage.setItem('savedStory', latestStory);
            } catch (e) {
              console.warn('ç„¡æ³•å„²å­˜æ•…äº‹è‡³ localStorageï¼š', e);
            }
            
            showStatus('success', 'ç”Ÿæˆå®Œæˆï¼');
            downloadBtn.disabled = false;
            continueBtn.disabled = false;
            parseAndShowChapters(latestStory);
          } else {
            showStatus('error', 'æ²’æœ‰ç²å¾—å…§å®¹ï¼Œè«‹èª¿æ•´è¨­å®š');
          }
        } catch (err) {
          showStatus('error', 'è«‹æ±‚å¤±æ•—ï¼š' + err.message);
        } finally {
          generateBtn.disabled = false;
        }
      });

      // ==================== ç¹¼çºŒç”Ÿæˆ ====================
      continueBtn.addEventListener('click', async () => {
        if (!latestStory) {
          showStatus('error', 'å°šæœªæœ‰æ•…äº‹å¯ç¹¼çºŒï¼Œè«‹å…ˆç”Ÿæˆ');
          return;
        }
        
        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        
        if (!apiKey) {
          showStatus('error', 'è«‹è¼¸å…¥ API é‡‘é‘°');
          return;
        }

        const continuePrompt = latestStory + `

ã€é‡è¦æŒ‡ç¤ºã€‘è«‹ç¹¼çºŒæ’°å¯«å°èªªã€Œæ­£æ–‡å…§å®¹ã€ã€‚

è¦æ±‚ï¼š
1. ä¿æŒä»¥ä¸Šæ•…äº‹çš„ä¸»é¡Œã€èƒŒæ™¯ã€äººç‰©èˆ‡é¢¨æ ¼
2. ç›´æ¥ç¹¼çºŒå¯«æ•…äº‹æ­£æ–‡ï¼ŒåŒ…å«å ´æ™¯æå¯«ã€äººç‰©å°è©±ã€å¿ƒç†æ´»å‹•ã€æƒ…ç¯€ç™¼å±•
3. æ¯å€‹ç« ç¯€éƒ½è¦æœ‰å®Œæ•´çš„æ•…äº‹å…§å®¹ï¼ˆè‡³å°‘2000-3000å­—ï¼‰
4. å¦‚æœä¸Šä¸€ç« å°šæœªçµæŸï¼Œè«‹å…ˆå®Œæˆè©²ç« ç¯€
5. ç« ç¯€æ¨™é¡Œæ ¼å¼ï¼š### ç¬¬Xç« ï¼šæ¨™é¡Œ
6. ç¦æ­¢å‡ºç¾å¤§ç¶±ã€è¦åŠƒã€æ•…äº‹ç°¡ä»‹ç­‰å…§å®¹
7. ç¦æ­¢ä½¿ç”¨æ¢åˆ—å¼èªªæ˜ï¼Œè¦ç”¨æ•˜äº‹æ–‡é«”

ç¹¼çºŒæ’°å¯«å°èªªæ­£æ–‡ï¼š`;
        
        showStatus('loading', 'çºŒç¯‡ç”Ÿæˆä¸­...');
        continueBtn.disabled = true;
        generateBtn.disabled = true;

        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify({
              contents: [{ parts: [{ text: continuePrompt }] }],
            }),
          });
          const data = await response.json();
          
          if (data.error) {
            showStatus('error', 'éŒ¯èª¤ï¼š' + data.error.message);
            return;
          }
          
          if (data.candidates && data.candidates.length > 0) {
            const parts = data.candidates[0].content.parts || [];
            const continuation = parts.map(p => p.text || '').join('').trim();
            if (continuation) {
              latestStory += '\n\n' + continuation;
              resultDiv.textContent = latestStory;
              try {
                localStorage.setItem('savedStory', latestStory);
              } catch (e) {
                showStatus('error', 'æ•…äº‹å…§å®¹éé•·ï¼Œæœªèƒ½è‡ªå‹•å„²å­˜');
              }
              showStatus('success', 'çºŒç¯‡å®Œæˆï¼');
              downloadBtn.disabled = false;
              parseAndShowChapters(latestStory);
            } else {
              showStatus('error', 'æ²’æœ‰ç²å¾—çºŒç¯‡å…§å®¹ï¼Œå¯èƒ½å·²å®Œçµ');
            }
          } else {
            showStatus('error', 'æ²’æœ‰ç²å¾—çºŒç¯‡å…§å®¹ï¼Œå¯èƒ½å·²å®Œçµ');
          }
        } catch (err) {
          showStatus('error', 'è«‹æ±‚å¤±æ•—ï¼š' + err.message);
        } finally {
          continueBtn.disabled = false;
          generateBtn.disabled = false;
        }
      });

      // ==================== ä¸‹è¼‰åŠŸèƒ½ ====================
      function downloadFile(filename, text) {
        const link = document.createElement('a');
        link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function generateFilename() {
        // å–å¾—ä¸»é¡Œ
        const theme = themeSelect.value || '';
        
        // å–å¾—æ‰€æœ‰äººç‰©åå­—
        const characterRows = Array.from(charactersContainer.querySelectorAll('.character-row'));
        const names = characterRows
          .map(row => row.querySelector('.char-name').value.trim())
          .filter(name => name !== '');
        
        // å˜—è©¦å¾æ•…äº‹å…§å®¹ä¸­æå–æ¨™é¡Œï¼ˆé€šå¸¸åœ¨é–‹é ­æœ‰ ## æ¨™é¡Œ æ ¼å¼ï¼‰
        let storyTitle = '';
        if (latestStory) {
          const titleMatch = latestStory.match(/##\s*([^\n#]+)/);
          if (titleMatch) {
            storyTitle = titleMatch[1].trim();
          }
        }
        
        // çµ„åˆæª”å
        let filename = '';
        
        // å„ªå…ˆä½¿ç”¨æ•…äº‹æ¨™é¡Œ
        if (storyTitle) {
          filename = storyTitle;
        } else if (theme) {
          filename = theme;
        } else {
          filename = 'ç”Ÿæˆå°èªª';
        }
        
        // åŠ å…¥äººç‰©åå­—ï¼ˆæœ€å¤š3å€‹ï¼‰
        if (names.length > 0) {
          const displayNames = names.slice(0, 3).join('ã€');
          filename += `_${displayNames}`;
          if (names.length > 3) {
            filename += 'ç­‰';
          }
        }
        
        // ç§»é™¤ä¸é©åˆæª”åçš„å­—å…ƒ
        filename = filename.replace(/[\\/:*?"<>|]/g, '_');
        
        return filename + '.txt';
      }

      downloadBtn.addEventListener('click', () => {
        if (!latestStory) return;
        const filename = generateFilename();
        downloadFile(filename, latestStory);
      });

      // ==================== æ›¸ç±¤åŠŸèƒ½ (å¤§å¹…å„ªåŒ–) ====================
      function loadBookmarks() {
        try {
          const raw = localStorage.getItem('bookmarks');
          if (!raw) return [];
          return JSON.parse(raw);
        } catch (e) {
          console.warn('ç„¡æ³•è®€å–æ›¸ç±¤ï¼š', e);
          return [];
        }
      }

      function saveBookmarks(bookmarks) {
        try {
          localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        } catch (e) {
          showStatus('error', 'æ›¸ç±¤å„²å­˜å¤±æ•—ï¼Œå¯èƒ½å·²é”å„²å­˜ä¸Šé™');
        }
      }

      function formatDate(timestamp) {
        const date = new Date(timestamp);
        return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
      }

      function formatWordCount(text) {
        const count = text.length;
        if (count >= 10000) return (count / 10000).toFixed(1) + ' è¬å­—';
        if (count >= 1000) return (count / 1000).toFixed(1) + ' åƒå­—';
        return count + ' å­—';
      }

      function getFilteredAndSortedBookmarks() {
        let bookmarks = loadBookmarks();
        const searchTerm = bookmarkSearch.value.trim().toLowerCase();
        const sortBy = bookmarkSort.value;

        // æœå°‹éæ¿¾
        if (searchTerm) {
          bookmarks = bookmarks.filter(bm => 
            (bm.title && bm.title.toLowerCase().includes(searchTerm)) ||
            (bm.tags && bm.tags.some(t => t.toLowerCase().includes(searchTerm))) ||
            (bm.notes && bm.notes.toLowerCase().includes(searchTerm))
          );
        }

        // æ’åº
        switch (sortBy) {
          case 'newest':
            bookmarks.sort((a, b) => b.id - a.id);
            break;
          case 'oldest':
            bookmarks.sort((a, b) => a.id - b.id);
            break;
          case 'name':
            bookmarks.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            break;
          case 'length':
            bookmarks.sort((a, b) => (b.content?.length || 0) - (a.content?.length || 0));
            break;
        }

        return bookmarks;
      }

      function renderBookmarks() {
        const allBookmarks = loadBookmarks();
        const bookmarks = getFilteredAndSortedBookmarks();
        
        bookmarkCount.textContent = `${allBookmarks.length} ç¯‡`;
        bookmarkList.innerHTML = '';

        if (bookmarks.length === 0) {
          bookmarkList.innerHTML = `
            <li class="bookmark-empty">
              <div class="bookmark-empty-icon">ğŸ“š</div>
              <div>${allBookmarks.length === 0 ? 'é‚„æ²’æœ‰æ›¸ç±¤ï¼Œç”Ÿæˆæ•…äº‹å¾Œé»æ“Šã€Œå„²å­˜ç›®å‰æ•…äº‹ã€' : 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ›¸ç±¤'}</div>
            </li>
          `;
          return;
        }

        bookmarks.forEach(bm => {
          const li = document.createElement('li');
          li.className = 'bookmark-item';
          li.innerHTML = `
            <div class="bookmark-item-icon">ğŸ“–</div>
            <div class="bookmark-item-content">
              <div class="bookmark-item-title">${bm.title || 'æœªå‘½åæ›¸ç±¤'}</div>
              <div class="bookmark-item-meta">
                <span>ğŸ“… ${formatDate(bm.id)}</span>
                <span>ğŸ“ ${formatWordCount(bm.content || '')}</span>
                ${bm.tags && bm.tags.length > 0 ? `<span>ğŸ·ï¸ ${bm.tags.slice(0,3).join(', ')}</span>` : ''}
              </div>
            </div>
            <div class="bookmark-item-actions">
              <button type="button" class="btn-load" data-action="load">è¼‰å…¥</button>
              <button type="button" data-action="edit">ç·¨è¼¯</button>
              <button type="button" data-action="delete">åˆªé™¤</button>
            </div>
          `;

          // è¼‰å…¥
          li.querySelector('[data-action="load"]').addEventListener('click', () => {
            latestStory = bm.content;
            resultDiv.textContent = latestStory;
            downloadBtn.disabled = !latestStory;
            continueBtn.disabled = !latestStory;
            try {
              localStorage.setItem('savedStory', latestStory);
            } catch (e) {}
            showStatus('success', 'æ›¸ç±¤å·²è¼‰å…¥');
            parseAndShowChapters(latestStory);
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
          });

          // ç·¨è¼¯
          li.querySelector('[data-action="edit"]').addEventListener('click', () => {
            editingBookmarkId = bm.id;
            editBookmarkTitle.value = bm.title || '';
            editBookmarkTags.value = (bm.tags || []).join(', ');
            editBookmarkNotes.value = bm.notes || '';
            editModal.classList.add('show');
          });

          // åˆªé™¤
          li.querySelector('[data-action="delete"]').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ›¸ç±¤å—ï¼Ÿ')) {
              const list = loadBookmarks().filter(b => b.id !== bm.id);
              saveBookmarks(list);
              renderBookmarks();
              showStatus('success', 'æ›¸ç±¤å·²åˆªé™¤');
            }
          });

          bookmarkList.appendChild(li);
        });
      }

      // æ–°å¢æ›¸ç±¤
      addBookmarkBtn.addEventListener('click', () => {
        if (!latestStory || latestStory.trim() === '') {
          showStatus('error', 'æ²’æœ‰å¯å„²å­˜çš„å…§å®¹');
          return;
        }
        const bookmarks = loadBookmarks();
        let title = latestStory.trim().replace(/\s+/g, ' ').substring(0, 50);
        if (title.length < latestStory.trim().length) title += '...';
        
        const newBookmark = {
          id: Date.now(),
          title,
          content: latestStory,
          tags: [],
          notes: '',
        };
        bookmarks.push(newBookmark);
        saveBookmarks(bookmarks);
        renderBookmarks();
        showStatus('success', 'æ›¸ç±¤å·²å„²å­˜ï¼');
      });

      // æœå°‹å’Œæ’åº
      bookmarkSearch.addEventListener('input', renderBookmarks);
      bookmarkSort.addEventListener('change', renderBookmarks);

      // ç·¨è¼¯å½ˆçª—
      cancelEditBtn.addEventListener('click', () => {
        editModal.classList.remove('show');
        editingBookmarkId = null;
      });

      saveEditBtn.addEventListener('click', () => {
        if (!editingBookmarkId) return;
        const bookmarks = loadBookmarks();
        const bm = bookmarks.find(b => b.id === editingBookmarkId);
        if (bm) {
          bm.title = editBookmarkTitle.value.trim() || bm.title;
          bm.tags = editBookmarkTags.value.split(',').map(t => t.trim()).filter(t => t);
          bm.notes = editBookmarkNotes.value.trim();
          saveBookmarks(bookmarks);
          renderBookmarks();
          showStatus('success', 'æ›¸ç±¤å·²æ›´æ–°');
        }
        editModal.classList.remove('show');
        editingBookmarkId = null;
      });

      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) {
          editModal.classList.remove('show');
          editingBookmarkId = null;
        }
      });

      // åŒ¯å‡ºæ›¸ç±¤
      exportBookmarksBtn.addEventListener('click', () => {
        const bookmarks = loadBookmarks();
        if (bookmarks.length === 0) {
          showStatus('error', 'æ²’æœ‰æ›¸ç±¤å¯åŒ¯å‡º');
          return;
        }
        const dataStr = JSON.stringify(bookmarks, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `å°èªªæ›¸ç±¤_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        showStatus('success', 'æ›¸ç±¤å·²åŒ¯å‡º');
      });

      // åŒ¯å…¥æ›¸ç±¤
      importBookmarksBtn.addEventListener('click', () => {
        importFileInput.click();
      });

      importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (!Array.isArray(imported)) throw new Error('æ ¼å¼éŒ¯èª¤');
            
            const existing = loadBookmarks();
            const existingIds = new Set(existing.map(b => b.id));
            let added = 0;
            
            imported.forEach(bm => {
              if (bm.id && bm.content && !existingIds.has(bm.id)) {
                existing.push(bm);
                added++;
              }
            });
            
            saveBookmarks(existing);
            renderBookmarks();
            showStatus('success', `å·²åŒ¯å…¥ ${added} ç­†æ›¸ç±¤`);
          } catch (err) {
            showStatus('error', 'åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      });
    </script>
  </body>
</html>
