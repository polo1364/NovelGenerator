<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°èªªç”Ÿæˆå™¨ | AI å‰µä½œå·¥åŠ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;600;700&family=LXGW+WenKai+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #1a1a2e;
        --primary-light: #16213e;
        --accent: #e94560;
        --accent-hover: #ff6b6b;
        --gold: #f4a261;
        --gold-light: #f8c291;
        --text: #2d3436;
        --text-light: #636e72;
        --bg: #fefefe;
        --card-bg: #ffffff;
        --section-bg: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        --input-bg: #fff;
        --border: #e0e0e0;
        --shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 15px 50px rgba(0, 0, 0, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'LXGW WenKai TC', 'Noto Serif TC', serif;
        background: var(--bg);
        background-image: 
          radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.03) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(244, 162, 97, 0.03) 0%, transparent 50%),
          linear-gradient(180deg, #fefefe 0%, #f8f9fa 100%);
        color: var(--text);
        min-height: 100vh;
        padding: 40px 20px 80px;
      }

      /* é ‚éƒ¨è£é£¾æ¢ */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--gold), var(--accent));
        z-index: 1000;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
      }

      /* é ­éƒ¨å€åŸŸ */
      header {
        text-align: center;
        margin-bottom: 50px;
        position: relative;
      }

      header::after {
        content: 'âœ¦';
        display: block;
        font-size: 1.5rem;
        color: var(--gold);
        margin-top: 20px;
        animation: twinkle 2s ease-in-out infinite;
      }

      @keyframes twinkle {
        0%, 100% { opacity: 0.5; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
      }

      h1 {
        font-family: 'Noto Serif TC', serif;
        font-size: 3rem;
        font-weight: 700;
        margin: 0;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: 0.1em;
      }

      .subtitle {
        margin-top: 16px;
        color: var(--text-light);
        font-size: 1.1rem;
        line-height: 1.8;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      /* ä¸»å¡ç‰‡ */
      .card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: var(--shadow);
        padding: 40px;
        margin-bottom: 30px;
        border: 1px solid rgba(0, 0, 0, 0.03);
        transition: box-shadow 0.3s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-hover);
      }

      /* å€å¡Šæ¨£å¼ */
      .section {
        background: var(--section-bg);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }

      .section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, var(--accent), var(--gold));
        border-radius: 4px 0 0 4px;
      }

      .section-title {
        font-family: 'Noto Serif TC', serif;
        font-weight: 600;
        font-size: 1.3rem;
        color: var(--primary);
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title::before {
        content: attr(data-icon);
        font-size: 1.2rem;
      }

      /* è¼¸å…¥çµ„ä»¶ */
      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--primary);
        font-size: 0.95rem;
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .label-row label {
        font-weight: 500;
        color: var(--primary);
        margin-bottom: 0;
      }

      input[type="text"],
      input[type="number"],
      input[type="password"],
      select,
      textarea {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid var(--border);
        border-radius: 12px;
        background: var(--input-bg);
        font-family: inherit;
        font-size: 1rem;
        color: var(--text);
        transition: all 0.3s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.1);
      }

      textarea {
        min-height: 100px;
        resize: vertical;
        line-height: 1.6;
      }

      select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23636e72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px;
        padding-right: 45px;
      }

      /* API é‡‘é‘°å®¹å™¨ */
      .api-key-container {
        display: flex;
        gap: 10px;
      }

      .api-key-container input {
        flex: 1;
      }

      /* æŒ‰éˆ•æ¨£å¼ */
      button {
        font-family: inherit;
        font-size: 0.95rem;
        font-weight: 500;
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.4s, height 0.4s;
      }

      button:active::after {
        width: 300px;
        height: 300px;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent) 0%, #ff6b6b 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
      }

      .btn-secondary {
        background: var(--primary);
        color: #fff;
      }

      .btn-secondary:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
      }

      .btn-outline {
        background: transparent;
        color: var(--text);
        border: 2px solid var(--border);
      }

      .btn-outline:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .btn-gold {
        background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
        color: var(--primary);
        box-shadow: 0 4px 15px rgba(244, 162, 97, 0.3);
      }

      .btn-gold:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 162, 97, 0.4);
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 0.85rem;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }

      /* ä¸»æŒ‰éˆ•å€ */
      .buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 10px;
      }

      /* äººç‰©è¨­å®šå€ */
      .character-row {
        display: grid;
        grid-template-columns: 70px repeat(6, 1fr) auto;
        gap: 10px;
        margin-bottom: 14px;
        align-items: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
      }

      .character-row:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 12px rgba(233, 69, 96, 0.08);
      }

      .char-index {
        font-weight: 600;
        color: var(--accent);
        font-size: 0.9rem;
      }

      .character-row input {
        padding: 10px 12px;
        font-size: 0.9rem;
      }

      .character-row button {
        padding: 10px 14px;
        white-space: nowrap;
      }

      @media (max-width: 900px) {
        .character-row {
          grid-template-columns: 1fr 1fr;
        }
        .char-index {
          grid-column: 1 / -1;
        }
      }

      @media (max-width: 500px) {
        .character-row {
          grid-template-columns: 1fr;
        }
      }

      /* ç‹€æ…‹è¨Šæ¯ */
      .status {
        margin-top: 16px;
        padding: 14px 20px;
        border-radius: 10px;
        font-size: 0.95rem;
        display: none;
        align-items: center;
        gap: 10px;
      }

      .status.show {
        display: flex;
      }

      .status.loading {
        background: linear-gradient(90deg, #f8f9fa, #e9ecef, #f8f9fa);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        color: var(--text);
      }

      .status.success {
        background: #d4edda;
        color: #155724;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
      }

      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      .status-icon {
        font-size: 1.2rem;
      }

      /* è¼¸å‡ºå€ */
      .output {
        margin-top: 30px;
        padding: 40px;
        border: 2px solid var(--border);
        border-radius: 16px;
        background: linear-gradient(180deg, #fff 0%, #fafafa 100%);
        font-family: 'Noto Serif TC', serif;
        font-size: 1.15rem;
        line-height: 2;
        white-space: pre-wrap;
        color: var(--text);
        min-height: 200px;
        position: relative;
      }

      .output:empty::before {
        content: 'ç”Ÿæˆçš„æ•…äº‹å°‡æœƒåœ¨é€™è£¡é¡¯ç¤º...';
        color: #adb5bd;
        font-style: italic;
      }

      .output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .output-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--primary);
      }

      /* ======================= */
      /* æ›¸ç±¤åŠŸèƒ½ - å¤§å¹…å„ªåŒ– */
      /* ======================= */
      .bookmark-card {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: #fff;
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow);
      }

      .bookmark-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .bookmark-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .bookmark-title::before {
        content: 'ğŸ“š';
        font-size: 1.4rem;
      }

      .bookmark-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 400;
      }

      .bookmark-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .bookmark-actions button {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .bookmark-actions button:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      /* æ›¸ç±¤æœå°‹èˆ‡æ’åº */
      .bookmark-toolbar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .bookmark-search {
        flex: 1;
        min-width: 200px;
        position: relative;
      }

      .bookmark-search input {
        padding-left: 45px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
      }

      .bookmark-search input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .bookmark-search input:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: none;
      }

      .bookmark-search::before {
        content: 'ğŸ”';
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1rem;
        z-index: 1;
      }

      .bookmark-sort {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        min-width: 140px;
      }

      .bookmark-sort option {
        background: var(--primary);
        color: #fff;
      }

      /* æ›¸ç±¤åˆ—è¡¨ */
      .bookmark-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
      }

      .bookmark-list::-webkit-scrollbar {
        width: 6px;
      }

      .bookmark-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      .bookmark-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .bookmark-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      .bookmark-item:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateX(4px);
      }

      .bookmark-item-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
      }

      .bookmark-item-content {
        flex: 1;
        min-width: 0;
      }

      .bookmark-item-title {
        font-weight: 500;
        font-size: 1rem;
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .bookmark-item-meta {
        display: flex;
        gap: 16px;
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .bookmark-item-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .bookmark-item-actions button {
        padding: 8px 12px;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        border: none;
      }

      .bookmark-item-actions button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .bookmark-item-actions .btn-load {
        background: var(--gold);
        color: var(--primary);
      }

      .bookmark-item-actions .btn-load:hover {
        background: var(--gold-light);
      }

      .bookmark-empty {
        text-align: center;
        padding: 40px;
        opacity: 0.7;
      }

      .bookmark-empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
      }

      /* æ›¸ç±¤ç·¨è¼¯å½ˆçª— */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        padding: 20px;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: #fff;
        border-radius: 20px;
        padding: 32px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.3s ease;
        color: var(--text);
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
      }

      .modal-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 24px 0;
        color: var(--primary);
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      /* ç« ç¯€å°èˆª - æ™ºèƒ½æµ®å‹•å¼ */
      .chapter-nav-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 999;
        display: none;
      }

      .chapter-nav-container.show {
        display: block;
      }

      .chapter-nav-toggle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent) 0%, #ff6b6b 100%);
        color: #fff;
        border: none;
        box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .chapter-nav-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(233, 69, 96, 0.5);
      }

      .chapter-nav-toggle .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--primary);
        color: #fff;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
      }

      .chapter-nav-panel {
        position: absolute;
        top: 0;
        right: 60px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        padding: 16px;
        min-width: 250px;
        max-width: 350px;
        max-height: 70vh;
        overflow-y: auto;
        opacity: 0;
        visibility: hidden;
        transform: translateX(20px);
        transition: all 0.3s ease;
      }

      .chapter-nav-panel.open {
        opacity: 1;
        visibility: visible;
        transform: translateX(0);
      }

      .chapter-nav-panel::-webkit-scrollbar {
        width: 4px;
      }

      .chapter-nav-panel::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
      }

      .chapter-nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .chapter-nav-title {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
      }

      .chapter-nav-close {
        background: none;
        border: none;
        color: var(--text-light);
        cursor: pointer;
        padding: 4px;
        font-size: 1.2rem;
        line-height: 1;
      }

      .chapter-nav-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .chapter-nav-list button {
        padding: 10px 14px;
        font-size: 0.85rem;
        background: #f8f9fa;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 8px;
        text-align: left;
        transition: all 0.2s ease;
      }

      .chapter-nav-list button:hover {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
        transform: translateX(4px);
      }

      .chapter-nav-list button.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }

      .chapter-nav-list button .chapter-num {
        display: inline-block;
        background: rgba(0,0,0,0.1);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        margin-right: 8px;
      }

      .chapter-nav-list button.active .chapter-num {
        background: rgba(255,255,255,0.2);
      }

      /* é–±è®€é€²åº¦æŒ‡ç¤ºå™¨ */
      .reading-progress {
        position: fixed;
        top: 4px;
        left: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--gold));
        z-index: 1001;
        transition: width 0.1s ease;
      }

      @media (max-width: 768px) {
        .chapter-nav-container {
          top: auto;
          bottom: 20px;
          right: 16px;
        }

        .chapter-nav-panel {
          right: 0;
          top: auto;
          bottom: 60px;
          max-width: calc(100vw - 32px);
        }
      }

      /* å‹•ç•« */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card, .bookmark-card {
        animation: fadeInUp 0.6s ease-out;
      }

      .card:nth-child(2) { animation-delay: 0.1s; }
      .bookmark-card { animation-delay: 0.2s; }

      /* éŸ¿æ‡‰å¼ */
      @media (max-width: 768px) {
        body {
          padding: 20px 16px 60px;
        }

        h1 {
          font-size: 2rem;
        }

        .card {
          padding: 24px;
        }

        .section {
          padding: 20px;
        }

        .output {
          padding: 24px;
          font-size: 1.05rem;
        }

        .bookmark-card {
          padding: 20px;
        }

        .buttons {
          flex-direction: column;
        }

        .buttons button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>å°èªªç”Ÿæˆå™¨</h1>
        <p class="subtitle">
          çµåˆ AI çš„ç„¡é™å‰µæ„ï¼Œæ‰“é€ å°ˆå±¬æ–¼ä½ çš„é•·ç¯‡æ•…äº‹<br>
          è¨­å®šä¸»é¡Œã€äººç‰©ã€èƒŒæ™¯ï¼Œä¸€éµç”Ÿæˆç²¾å½©å°èªª
        </p>
      </header>

      <div class="card">
        <!-- åŸºæœ¬è¨­å®š -->
        <div class="section">
          <h2 class="section-title" data-icon="âš™ï¸">åŸºæœ¬è¨­å®š</h2>
          <div class="input-group">
            <label for="apiKey">Gemini API é‡‘é‘°</label>
            <div class="api-key-container">
              <input
                type="password"
                id="apiKey"
                placeholder="è«‹è¼¸å…¥æ‚¨çš„ API é‡‘é‘°"
                autocomplete="off"
              />
              <button type="button" id="toggleApiKeyVisibility" class="btn-outline btn-small">é¡¯ç¤º</button>
            </div>
          </div>
          <div class="input-group">
            <label for="model">é¸æ“‡æ¨¡å‹</label>
            <select id="model">
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-pro">Gemini Pro</option>
            </select>
          </div>
        </div>

        <!-- æ•…äº‹å…ƒç´  -->
        <div class="section">
          <h2 class="section-title" data-icon="ğŸ“–">æ•…äº‹å…ƒç´ </h2>
          <div class="input-group">
            <label for="theme">ä¸»é¡Œ</label>
            <select id="theme">
              <option value="">è«‹é¸æ“‡ä¸»é¡Œ</option>
              <option value="å¥‡å¹»å†’éšª">å¥‡å¹»å†’éšª</option>
              <option value="æœªä¾†ç§‘å¹»">æœªä¾†ç§‘å¹»</option>
              <option value="æµªæ¼«æ„›æƒ…">æµªæ¼«æ„›æƒ…</option>
              <option value="æ‡¸ç–‘æ¨ç†">æ‡¸ç–‘æ¨ç†</option>
              <option value="æ­·å²å‚³å¥‡">æ­·å²å‚³å¥‡</option>
              <option value="é’æ˜¥æˆé•·">é’æ˜¥æˆé•·</option>
              <option value="å†’éšªå²è©©">å†’éšªå²è©©</option>
              <option value="ç„å¹»ä¿®çœŸ">ç„å¹»ä¿®çœŸ</option>
              <option value="ç¾ä»£éƒ½å¸‚">ç¾ä»£éƒ½å¸‚</option>
              <option value="é­”æ³•å­¸é™¢">é­”æ³•å­¸é™¢</option>
              <option value="ææ€–é©šæ‚š">ææ€–é©šæ‚š</option>
              <option value="å–œåŠ‡é€—è¶£">å–œåŠ‡é€—è¶£</option>
              <option value="ç¾å¯¦ä¸»ç¾©">ç¾å¯¦ä¸»ç¾©</option>
              <option value="æ‡·èˆŠæ•…äº‹">æ‡·èˆŠæ•…äº‹</option>
              <option value="ç¥ç§˜å¥‡æ¡ˆ">ç¥ç§˜å¥‡æ¡ˆ</option>
              <option value="å‹•ç‰©å¯“è¨€">å‹•ç‰©å¯“è¨€</option>
              <option value="ç¤¾æœƒæ‰¹åˆ¤">ç¤¾æœƒæ‰¹åˆ¤</option>
              <option value="é­”å¹»ç¾å¯¦">é­”å¹»ç¾å¯¦</option>
              <option value="å¤è£æ­¦ä¿ ">å¤è£æ­¦ä¿ </option>
              <option value="æ™‚ç©ºç©¿è¶Š">æ™‚ç©ºç©¿è¶Š</option>
            </select>
          </div>
          <div class="input-group">
            <label for="setting">èƒŒæ™¯è¨­å®š</label>
            <select id="setting">
              <option value="">è«‹é¸æ“‡èƒŒæ™¯</option>
              <option value="è™›æ§‹çš„ä¸­ä¸–ç´€ç‹åœ‹">è™›æ§‹çš„ä¸­ä¸–ç´€ç‹åœ‹</option>
              <option value="21ä¸–ç´€çš„è‡ºç£éƒ½å¸‚">21ä¸–ç´€çš„è‡ºç£éƒ½å¸‚</option>
              <option value="é™é çš„å¤ªç©ºæ®–æ°‘åœ°">é™é çš„å¤ªç©ºæ®–æ°‘åœ°</option>
              <option value="è™›æ“¬å¯¦å¢ƒä¸–ç•Œ">è™›æ“¬å¯¦å¢ƒä¸–ç•Œ</option>
              <option value="å¤ä»£çš‡å®®">å¤ä»£çš‡å®®</option>
              <option value="æœ«æ—¥å¾Œçš„è’åœŸ">æœ«æ—¥å¾Œçš„è’åœŸ</option>
              <option value="è¿‘æœªä¾†çš„é«˜ç§‘æŠ€åŸå¸‚">è¿‘æœªä¾†çš„é«˜ç§‘æŠ€åŸå¸‚</option>
              <option value="é­”æ³•å­¸é™¢">é­”æ³•å­¸é™¢</option>
              <option value="è’¸æ±½é¾å…‹åŸå¸‚">è’¸æ±½é¾å…‹åŸå¸‚</option>
              <option value="æ·±æµ·ç‹åœ‹">æ·±æµ·ç‹åœ‹</option>
              <option value="ç¹è¯çš„éŠ€æ²³å•†å ´">ç¹è¯çš„éŠ€æ²³å•†å ´</option>
              <option value="éš±è—æ–¼é›²ç«¯çš„åŸå ¡">éš±è—æ–¼é›²ç«¯çš„åŸå ¡</option>
              <option value="å¤è€çš„å±±æ—æ‘è½">å¤è€çš„å±±æ—æ‘è½</option>
              <option value="é›ªå±±ä¸Šçš„ä¿®é“é™¢">é›ªå±±ä¸Šçš„ä¿®é“é™¢</option>
              <option value="ç†±å¸¶é›¨æ—æ·±è™•">ç†±å¸¶é›¨æ—æ·±è™•</option>
              <option value="å·¨å‹è¿·å®®éƒ½å¸‚">å·¨å‹è¿·å®®éƒ½å¸‚</option>
              <option value="æ®–æ°‘æµ·ç›œèˆ¹">æ®–æ°‘æµ·ç›œèˆ¹</option>
              <option value="å®‡å®™æˆ°è‰¦ä¸Š">å®‡å®™æˆ°è‰¦ä¸Š</option>
              <option value="æ˜æœå®®å»·">æ˜æœå®®å»·</option>
              <option value="å¹³è¡Œå®‡å®™">å¹³è¡Œå®‡å®™</option>
            </select>
          </div>
          <div class="input-group">
            <div class="label-row">
              <label>ä¸»è¦äººç‰©è¨­å®š</label>
              <div style="display: flex; gap: 8px;">
                <button id="randomAllCharactersBtn" type="button" class="btn-outline btn-small">ğŸ² éš¨æ©Ÿäººç‰©</button>
                <button id="addCharacterBtn" type="button" class="btn-outline btn-small">+ æ–°å¢äººç‰©</button>
              </div>
            </div>
            <div id="charactersContainer"></div>
          </div>
          <div class="input-group">
            <label for="style">æ•…äº‹é¢¨æ ¼</label>
            <select id="style">
              <option value="">è«‹é¸æ“‡é¢¨æ ¼</option>
              <option value="è©©æ„">è©©æ„</option>
              <option value="å¹½é»˜">å¹½é»˜</option>
              <option value="é»‘æš—">é»‘æš—</option>
              <option value="å‹µå¿—">å‹µå¿—</option>
              <option value="æµªæ¼«">æµªæ¼«</option>
              <option value="åˆºæ¿€">åˆºæ¿€</option>
              <option value="æº«é¦¨">æº«é¦¨</option>
              <option value="æ‡¸ç–‘">æ‡¸ç–‘</option>
              <option value="ç†±è¡€">ç†±è¡€</option>
              <option value="é­”å¹»">é­”å¹»</option>
              <option value="å¤å…¸è¯éº—">å¤å…¸è¯éº—</option>
              <option value="è’èª•">è’èª•</option>
              <option value="ç¾å¯¦ä¸»ç¾©">ç¾å¯¦ä¸»ç¾©</option>
              <option value="è¼•é¬†å¯«æ„">è¼•é¬†å¯«æ„</option>
              <option value="é…·ç‚«ç§‘æŠ€">é…·ç‚«ç§‘æŠ€</option>
              <option value="å„ªé›…æµªæ¼«">å„ªé›…æµªæ¼«</option>
              <option value="å¤§æ²³æˆ²åŠ‡">å¤§æ²³æˆ²åŠ‡</option>
              <option value="é»‘è‰²å¹½é»˜">é»‘è‰²å¹½é»˜</option>
              <option value="å¿ƒç†é©šæ‚š">å¿ƒç†é©šæ‚š</option>
              <option value="æµè¡Œç¶²çµ¡">æµè¡Œç¶²çµ¡</option>
            </select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="input-group" style="margin-bottom: 0;">
              <label for="chapters">ç« ç¯€æ•¸</label>
              <input type="number" id="chapters" placeholder="å¦‚ï¼š10" min="1" max="50" step="1" />
            </div>
            <div class="input-group" style="margin-bottom: 0;">
              <label for="length">é è¨ˆç¸½å­—æ•¸</label>
              <input type="number" id="length" placeholder="å¦‚ï¼š50000" min="1000" max="200000" step="1000" />
            </div>
          </div>
        </div>

        <!-- å…¶ä»–èªªæ˜ -->
        <div class="section">
          <h2 class="section-title" data-icon="âœï¸">å…¶ä»–èªªæ˜</h2>
          <div class="input-group" style="margin-bottom: 0;">
            <label for="notes">è£œå……èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="notes" placeholder="å¦‚æœ‰é¡å¤–æƒ…ç¯€æˆ–é¢¨æ ¼è¦æ±‚ï¼Œå¯åœ¨æ­¤è£œå……ã€‚ä¾‹å¦‚ï¼šå¸Œæœ›ä¸»è§’æœ‰åè½‰çš„çµå±€ã€åŠ å…¥æ™‚é–“æ—…è¡Œå…ƒç´ ç­‰ã€‚"></textarea>
          </div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="buttons">
          <button id="randomBtn" type="button" class="btn-gold">ğŸ² éš¨æ©Ÿå¡«å……</button>
          <button id="generateBtn" type="button" class="btn-primary">âœ¨ é–‹å§‹ç”Ÿæˆ</button>
          <button id="continueBtn" type="button" class="btn-secondary" disabled>â¤ ç¹¼çºŒç”Ÿæˆ</button>
          <button id="downloadBtn" type="button" class="btn-outline" disabled>â¬‡ ä¸‹è¼‰å°èªª</button>
        </div>

        <!-- ç‹€æ…‹è¨Šæ¯ -->
        <div id="status" class="status">
          <span class="status-icon"></span>
          <span class="status-text"></span>
        </div>

        <!-- è¼¸å‡ºå€ -->
        <div class="output-header" style="margin-top: 30px;">
          <span class="output-title">ğŸ“œ ç”Ÿæˆçµæœ</span>
        </div>
        <div id="result" class="output"></div>
      </div>

      <!-- æµ®å‹•ç« ç¯€å°èˆª -->
      <div id="chapterNavContainer" class="chapter-nav-container">
        <button id="chapterNavToggle" class="chapter-nav-toggle" title="ç« ç¯€å°èˆª">
          ğŸ“‘
          <span id="chapterBadge" class="badge">0</span>
        </button>
        <div id="chapterNavPanel" class="chapter-nav-panel">
          <div class="chapter-nav-header">
            <span class="chapter-nav-title">ğŸ“– ç« ç¯€ç›®éŒ„</span>
            <button id="chapterNavClose" class="chapter-nav-close">âœ•</button>
          </div>
          <div id="chapterNavList" class="chapter-nav-list"></div>
        </div>
      </div>

      <!-- é–±è®€é€²åº¦æ¢ -->
      <div id="readingProgress" class="reading-progress" style="width: 0%;"></div>

      <!-- æ›¸ç±¤å€ - å…¨æ–°è¨­è¨ˆ -->
      <div class="bookmark-card">
        <div class="bookmark-header">
          <h2 class="bookmark-title">
            æˆ‘çš„æ›¸ç±¤
            <span id="bookmarkCount" class="bookmark-count">0 ç¯‡</span>
          </h2>
          <div class="bookmark-actions">
            <button id="addBookmarkBtn" type="button" class="btn-small">ğŸ’¾ å„²å­˜ç›®å‰æ•…äº‹</button>
            <button id="exportBookmarksBtn" type="button" class="btn-small">ğŸ“¤ åŒ¯å‡ºå…¨éƒ¨</button>
            <button id="importBookmarksBtn" type="button" class="btn-small">ğŸ“¥ åŒ¯å…¥</button>
          </div>
        </div>

        <div class="bookmark-toolbar">
          <div class="bookmark-search">
            <input type="text" id="bookmarkSearch" placeholder="æœå°‹æ›¸ç±¤..." />
          </div>
          <select id="bookmarkSort" class="bookmark-sort">
            <option value="newest">æœ€æ–°å„ªå…ˆ</option>
            <option value="oldest">æœ€èˆŠå„ªå…ˆ</option>
            <option value="name">åç¨±æ’åº</option>
            <option value="length">é•·åº¦æ’åº</option>
          </select>
        </div>

        <ul id="bookmarkList" class="bookmark-list"></ul>
      </div>
    </div>

    <!-- ç·¨è¼¯æ›¸ç±¤å½ˆçª— -->
    <div id="editModal" class="modal-overlay">
      <div class="modal">
        <h3 class="modal-title">ç·¨è¼¯æ›¸ç±¤</h3>
        <div class="input-group">
          <label for="editBookmarkTitle">æ›¸ç±¤æ¨™é¡Œ</label>
          <input type="text" id="editBookmarkTitle" placeholder="è¼¸å…¥æ›¸ç±¤æ¨™é¡Œ" />
        </div>
        <div class="input-group">
          <label for="editBookmarkTags">æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
          <input type="text" id="editBookmarkTags" placeholder="å¦‚ï¼šå¥‡å¹», å†’éšª, ä¸»è§’å…‰ç’°" />
        </div>
        <div class="input-group" style="margin-bottom: 0;">
          <label for="editBookmarkNotes">å‚™è¨»</label>
          <textarea id="editBookmarkNotes" placeholder="æ·»åŠ å‚™è¨»..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" id="cancelEditBtn" class="btn-outline">å–æ¶ˆ</button>
          <button type="button" id="saveEditBtn" class="btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;" />

    <script>
      // ==================== å…ƒç´ å–å¾— ====================
      const apiKeyInput = document.getElementById('apiKey');
      const modelSelect = document.getElementById('model');
      const themeSelect = document.getElementById('theme');
      const settingSelect = document.getElementById('setting');
      const styleSelect = document.getElementById('style');
      const chaptersInput = document.getElementById('chapters');
      const lengthInput = document.getElementById('length');
      const notesInput = document.getElementById('notes');
      const randomBtn = document.getElementById('randomBtn');
      const generateBtn = document.getElementById('generateBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const continueBtn = document.getElementById('continueBtn');
      const statusDiv = document.getElementById('status');
      const resultDiv = document.getElementById('result');
      const toggleApiKeyVisibility = document.getElementById('toggleApiKeyVisibility');
      const charactersContainer = document.getElementById('charactersContainer');
      const randomAllCharactersBtn = document.getElementById('randomAllCharactersBtn');
      const addCharacterBtn = document.getElementById('addCharacterBtn');

      // æµ®å‹•ç« ç¯€å°èˆªå…ƒç´ 
      const chapterNavContainer = document.getElementById('chapterNavContainer');
      const chapterNavToggle = document.getElementById('chapterNavToggle');
      const chapterNavPanel = document.getElementById('chapterNavPanel');
      const chapterNavClose = document.getElementById('chapterNavClose');
      const chapterNavList = document.getElementById('chapterNavList');
      const chapterBadge = document.getElementById('chapterBadge');
      const readingProgress = document.getElementById('readingProgress');

      // æ›¸ç±¤å…ƒç´ 
      const addBookmarkBtn = document.getElementById('addBookmarkBtn');
      const exportBookmarksBtn = document.getElementById('exportBookmarksBtn');
      const importBookmarksBtn = document.getElementById('importBookmarksBtn');
      const importFileInput = document.getElementById('importFileInput');
      const bookmarkSearch = document.getElementById('bookmarkSearch');
      const bookmarkSort = document.getElementById('bookmarkSort');
      const bookmarkList = document.getElementById('bookmarkList');
      const bookmarkCount = document.getElementById('bookmarkCount');

      // ç·¨è¼¯å½ˆçª—å…ƒç´ 
      const editModal = document.getElementById('editModal');
      const editBookmarkTitle = document.getElementById('editBookmarkTitle');
      const editBookmarkTags = document.getElementById('editBookmarkTags');
      const editBookmarkNotes = document.getElementById('editBookmarkNotes');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const saveEditBtn = document.getElementById('saveEditBtn');

      let latestStory = '';
      let editingBookmarkId = null;
      let chapterMatches = [];
      let isPanelOpen = false;

      // ==================== ç‹€æ…‹é¡¯ç¤º ====================
      function showStatus(type, message) {
        const icons = {
          loading: 'â³',
          success: 'âœ…',
          error: 'âŒ'
        };
        statusDiv.className = `status show ${type}`;
        statusDiv.querySelector('.status-icon').textContent = icons[type] || '';
        statusDiv.querySelector('.status-text').textContent = message;
      }

      function hideStatus() {
        statusDiv.className = 'status';
      }

      // ==================== API é‡‘é‘° ====================
      const storedKey = localStorage.getItem('geminiApiKey');
      if (storedKey) apiKeyInput.value = storedKey;

      apiKeyInput.addEventListener('change', () => {
        const val = apiKeyInput.value.trim();
        if (val) {
          try {
            localStorage.setItem('geminiApiKey', val);
          } catch (e) {
            showStatus('error', 'API é‡‘é‘°å„²å­˜å¤±æ•—');
          }
        }
      });

      toggleApiKeyVisibility.addEventListener('click', () => {
        const isPassword = apiKeyInput.type === 'password';
        apiKeyInput.type = isPassword ? 'text' : 'password';
        toggleApiKeyVisibility.textContent = isPassword ? 'éš±è—' : 'é¡¯ç¤º';
      });

      // ==================== è¼‰å…¥å·²å„²å­˜çš„æ•…äº‹ ====================
      const savedStory = localStorage.getItem('savedStory');
      if (savedStory) {
        latestStory = savedStory;
        resultDiv.textContent = savedStory;
        downloadBtn.disabled = false;
        continueBtn.disabled = false;
        parseAndShowChapters(savedStory);
      }

      // ==================== éš¨æ©Ÿè³‡æ–™åº« ====================
      const themes = ['å¥‡å¹»å†’éšª','æœªä¾†ç§‘å¹»','æµªæ¼«æ„›æƒ…','æ‡¸ç–‘æ¨ç†','æ­·å²å‚³å¥‡','é’æ˜¥æˆé•·','å†’éšªå²è©©','ç„å¹»ä¿®çœŸ','ç¾ä»£éƒ½å¸‚','é­”æ³•å­¸é™¢','ææ€–é©šæ‚š','å–œåŠ‡é€—è¶£','ç¾å¯¦ä¸»ç¾©','æ‡·èˆŠæ•…äº‹','ç¥ç§˜å¥‡æ¡ˆ','å‹•ç‰©å¯“è¨€','ç¤¾æœƒæ‰¹åˆ¤','é­”å¹»ç¾å¯¦','å¤è£æ­¦ä¿ ','æ™‚ç©ºç©¿è¶Š'];
      const settings = ['è™›æ§‹çš„ä¸­ä¸–ç´€ç‹åœ‹','21ä¸–ç´€çš„è‡ºç£éƒ½å¸‚','é™é çš„å¤ªç©ºæ®–æ°‘åœ°','è™›æ“¬å¯¦å¢ƒä¸–ç•Œ','å¤ä»£çš‡å®®','æœ«æ—¥å¾Œçš„è’åœŸ','è¿‘æœªä¾†çš„é«˜ç§‘æŠ€åŸå¸‚','é­”æ³•å­¸é™¢','è’¸æ±½é¾å…‹åŸå¸‚','æ·±æµ·ç‹åœ‹','ç¹è¯çš„éŠ€æ²³å•†å ´','éš±è—æ–¼é›²ç«¯çš„åŸå ¡','å¤è€çš„å±±æ—æ‘è½','é›ªå±±ä¸Šçš„ä¿®é“é™¢','ç†±å¸¶é›¨æ—æ·±è™•','å·¨å‹è¿·å®®éƒ½å¸‚','æ®–æ°‘æµ·ç›œèˆ¹','å®‡å®™æˆ°è‰¦ä¸Š','æ˜æœå®®å»·','å¹³è¡Œå®‡å®™'];
      const stylesArr = ['è©©æ„','å¹½é»˜','é»‘æš—','å‹µå¿—','æµªæ¼«','åˆºæ¿€','æº«é¦¨','æ‡¸ç–‘','ç†±è¡€','é­”å¹»','å¤å…¸è¯éº—','è’èª•','ç¾å¯¦ä¸»ç¾©','è¼•é¬†å¯«æ„','é…·ç‚«ç§‘æŠ€','å„ªé›…æµªæ¼«','å¤§æ²³æˆ²åŠ‡','é»‘è‰²å¹½é»˜','å¿ƒç†é©šæ‚š','æµè¡Œç¶²çµ¡'];
      const chapterOpts = [5, 8, 10, 12, 15];
      const lengthOpts = [30000, 50000, 70000, 90000];

      const nameOptions = ['è‰¾ç³','æ´›æ©','å‡±äº','ç±³çˆ¾','å¸­æ©','è–‡æ‹‰','ç¥ˆå®‰','æœæ—','å¸Œçˆ¾ç¶­','èŠé›…','ä¼Šå‡¡','æ³•è˜­','æ ¼è˜­','æ¢…èŠ™','å®‰å¨œ','é›·æ ¼','ç´¢è²','è‰¾ç•¥ç‰¹','äºæ­·å…‹','è«å¦®å¡','è·¯è¥¿','ä¼ŠèŠ™','åŠ ç™¾åˆ—','äºç•¶','ç‘ªé›…','è‰¾å¾·','è–©æ‹‰','æ°ç™»','çªæ‹‰','å¾·ç‘å…‹'];
      const personalityOptions = ['å¤–å†·å…§ç†±','è‡ªå‘ä½†å˜´ç¡¬','æ¨‚è§€åˆè¡å‹•','å†·éœä½†ååŸ·','æº«æŸ”å»ä¸è¼•ä¿¡ä»»ä½•äºº','å …éŸŒè€Œæ²‰é»˜','å¹½é»˜é–‹æœ—','å–„è‰¯åˆå–®ç´”','å¤šç–‘ä¸”è¬¹æ…','è‡ªä¿¡è€Œå‚²æ…¢','æ‡¶æ•£å»è¶…å‡¡è°æ˜','ç¾©æ°£è€Œå›ºåŸ·','æ€¥èºä½†å¿ƒåœ°å–„è‰¯','è¬™è™›è€Œæ©Ÿæ™º','å¤©çœŸåˆå¥½å¥‡'];
      const goalOptions = ['æ‰¾å›å¤±è½çš„å®¶æ—å¾½ç« ','ç ´è§£ç¦æ›¸çš„å°å°','æ•‘å›è¢«è©›å’’çš„æœ‹å‹','æŸ¥å‡ºå­¸é™¢è£¡çš„å…§é¬¼','è­‰æ˜è‡ªå·±ä¸æ˜¯æ€ªç‰©','å°‹æ‰¾å¤±è¹¤çš„å¸«çˆ¶','å¾©ä»‡é›ªæ¥','æ‹¯æ•‘ä¸–ç•Œå…æ–¼æ¯€æ»…','é€ƒé›¢è‡ªèº«çš„å‘½é‹','å°‹æ±‚å…§å¿ƒçš„è‡ªç”±'];
      const weaknessOptions = ['å®³æ€•é»‘æš—','é‡åˆ°å£“åŠ›å°±èªªè¬Š','å¤ªå®¹æ˜“ç›¸ä¿¡åˆ¥äºº','å¼·è¿«ç—‡åš´é‡','ä¸€æ—¦æ‰¿è«¾å°±ä¸è‚¯å›é ­','ç•æ‡¼æ·±æµ·','æé«˜ç—‡','å®¹æ˜“ç™¼æ€’','éæ–¼å›ºåŸ·','æ‚£æœ‰å¤±çœ '];
      const secretOptions = ['å…¶å¯¦èƒ½è½è¦‹é­”æ–çš„è²éŸ³','æ›¾ç¶“æ–½æ”¾éç¦å’’','è¡€çµ±æœ‰çˆ­è­°','èˆ‡åæ´¾æœ‰è¡€ç·£é—œä¿‚','è¨˜æ†¶è¢«äººå‹•éæ‰‹è…³','èº«ä¸Šè—æœ‰å¤è€ç¬¦æ–‡','æ˜¯é è¨€ä¸­çš„å­©å­','éš±è—è‘—ç¬¬äºŒäººæ ¼','çœŸæ­£çš„èº«ä»½æ˜¯ç‹æ—','æ‰‹æ¡æœªä¾†çš„é è¨€'];
      const relationOptions = ['èˆ‡çˆ¶è¦ªé—œä¿‚ç–é›¢','èˆ‡èˆŠæƒ…äººæœ‰æœªäº†çµ','èˆ‡å¦ä¸€ä½è§’è‰²æœ‰èª“ç´„','æ›¾èƒŒå›éæœ€å¥½çš„æœ‹å‹','æ¬ äº†é»‘å¹«å·¨å‚µ','å°å°å¸«åˆæ•¬åˆæ¨','è¦–æ•µç‚ºå…„å¼Ÿ','ç§˜å¯†æ„›æ…•å¤¥ä¼´','è¢«å®¶æ—é€å‡º','èˆ‡å®¿æ•µäº’ç›¸å°Šé‡'];

      function pickRandom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }

      // ==================== äººç‰©è¨­å®š ====================
      function addCharacterRow(randomize = false) {
        const row = document.createElement('div');
        row.className = 'character-row';
        const index = charactersContainer.children.length + 1;
        row.innerHTML = `
          <div class="char-index">äººç‰© ${index}</div>
          <input type="text" class="char-name" placeholder="å§“å" />
          <input type="text" class="char-personality" placeholder="å€‹æ€§" />
          <input type="text" class="char-goal" placeholder="ç›®æ¨™" />
          <input type="text" class="char-weakness" placeholder="å¼±é»" />
          <input type="text" class="char-secret" placeholder="ç§˜å¯†" />
          <input type="text" class="char-relation" placeholder="äººéš›" />
          <button type="button" class="char-random-btn btn-outline btn-small">ğŸ²</button>
        `;
        const randBtn = row.querySelector('.char-random-btn');
        randBtn.addEventListener('click', () => randomizeRow(row));
        charactersContainer.appendChild(row);
        if (randomize) randomizeRow(row);
      }

      function randomizeRow(row) {
        row.querySelector('.char-name').value = pickRandom(nameOptions);
        row.querySelector('.char-personality').value = pickRandom(personalityOptions);
        row.querySelector('.char-goal').value = pickRandom(goalOptions);
        row.querySelector('.char-weakness').value = pickRandom(weaknessOptions);
        row.querySelector('.char-secret').value = pickRandom(secretOptions);
        row.querySelector('.char-relation').value = pickRandom(relationOptions);
      }

      document.addEventListener('DOMContentLoaded', () => {
        addCharacterRow(true);
        addCharacterRow(true);
        renderBookmarks();
      });

      randomAllCharactersBtn.addEventListener('click', () => {
        Array.from(charactersContainer.children).forEach(row => randomizeRow(row));
      });

      addCharacterBtn.addEventListener('click', () => addCharacterRow(true));

      randomBtn.addEventListener('click', () => {
        themeSelect.value = pickRandom(themes);
        settingSelect.value = pickRandom(settings);
        styleSelect.value = pickRandom(stylesArr);
        chaptersInput.value = pickRandom(chapterOpts);
        lengthInput.value = pickRandom(lengthOpts);
        Array.from(charactersContainer.children).forEach(row => randomizeRow(row));
      });

      // ==================== æ™ºèƒ½æµ®å‹•ç« ç¯€å°èˆª ====================

      // åˆ‡æ›é¢æ¿é¡¯ç¤º
      chapterNavToggle.addEventListener('click', () => {
        isPanelOpen = !isPanelOpen;
        chapterNavPanel.classList.toggle('open', isPanelOpen);
      });

      chapterNavClose.addEventListener('click', () => {
        isPanelOpen = false;
        chapterNavPanel.classList.remove('open');
      });

      // é»æ“Šé¢æ¿å¤–éƒ¨é—œé–‰
      document.addEventListener('click', (e) => {
        if (isPanelOpen && 
            !chapterNavPanel.contains(e.target) && 
            !chapterNavToggle.contains(e.target)) {
          isPanelOpen = false;
          chapterNavPanel.classList.remove('open');
        }
      });

      // é–±è®€é€²åº¦è¿½è¹¤
      window.addEventListener('scroll', () => {
        if (!resultDiv.textContent) return;
        
        const rect = resultDiv.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const docHeight = resultDiv.offsetHeight;
        
        // è¨ˆç®—é–±è®€é€²åº¦
        if (rect.top < windowHeight && rect.bottom > 0) {
          const visibleTop = Math.max(0, -rect.top);
          const progress = Math.min(100, (visibleTop / (docHeight - windowHeight)) * 100);
          readingProgress.style.width = Math.max(0, Math.min(100, progress)) + '%';
        }
        
        // è‡ªå‹•æ›´æ–°ç•¶å‰ç« ç¯€é«˜äº®
        updateCurrentChapter();
      });

      function updateCurrentChapter() {
        if (chapterMatches.length === 0) return;
        
        const scrollY = window.scrollY;
        const resultRect = resultDiv.getBoundingClientRect();
        const resultTop = resultRect.top + window.scrollY;
        
        let currentChapterIdx = 0;
        
        for (let i = 0; i < chapterMatches.length; i++) {
          const chapterTitle = chapterMatches[i].title;
          const textContent = resultDiv.textContent;
          const chapterIndex = textContent.indexOf(chapterTitle);
          
          // ä¼°ç®—ç« ç¯€åœ¨é é¢ä¸­çš„ä½ç½®
          const ratio = chapterIndex / textContent.length;
          const estimatedPos = resultTop + (resultDiv.offsetHeight * ratio);
          
          if (scrollY >= estimatedPos - 100) {
            currentChapterIdx = i;
          }
        }
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        const buttons = chapterNavList.querySelectorAll('button');
        buttons.forEach((btn, idx) => {
          btn.classList.toggle('active', idx === currentChapterIdx);
        });
      }

      function parseAndShowChapters(text) {
        const chapterRegex = /ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾é›¶\d]+ç« [ï¼š:][^\n]*/g;
        const rawMatches = [];
        let match;
        
        while ((match = chapterRegex.exec(text)) !== null) {
          rawMatches.push({
            title: match[0],
            index: match.index
          });
        }

        // å»é™¤é‡è¤‡çš„ç« ç¯€ï¼ˆæ ¹æ“šç« ç¯€åç¨±å»é‡ï¼Œåªä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç¾çš„ä½ç½®ï¼‰
        const seenTitles = new Set();
        chapterMatches = [];
        
        for (const m of rawMatches) {
          // æå–ç« ç¯€ç·¨è™Ÿä½œç‚ºå”¯ä¸€è­˜åˆ¥ï¼ˆå¦‚ã€Œç¬¬ä¸€ç« ã€ã€Œç¬¬äºŒç« ã€ï¼‰
          const chapterNumMatch = m.title.match(/ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾é›¶\d]+ç« /);
          if (chapterNumMatch) {
            const chapterNum = chapterNumMatch[0];
            if (!seenTitles.has(chapterNum)) {
              seenTitles.add(chapterNum);
              chapterMatches.push(m);
            }
          }
        }

        if (chapterMatches.length > 1) {
          // é¡¯ç¤ºæµ®å‹•å°èˆª
          chapterNavContainer.classList.add('show');
          chapterBadge.textContent = chapterMatches.length;
          
          // ç”Ÿæˆç« ç¯€åˆ—è¡¨
          chapterNavList.innerHTML = chapterMatches.map((m, i) => 
            `<button type="button" data-chapter="${i}">
              <span class="chapter-num">${i + 1}</span>
              ${m.title.substring(0, 20)}${m.title.length > 20 ? '...' : ''}
            </button>`
          ).join('');
          
          // ç¶å®šé»æ“Šäº‹ä»¶
          chapterNavList.querySelectorAll('button').forEach((btn, idx) => {
            btn.addEventListener('click', () => {
              const chapterTitle = chapterMatches[idx].title;
              const textContent = resultDiv.textContent;
              const chapterIndex = textContent.indexOf(chapterTitle);
              
              if (chapterIndex !== -1) {
                const fullText = resultDiv.textContent;
                const beforeChapter = fullText.substring(0, chapterIndex);
                const chapterText = fullText.substring(chapterIndex, chapterIndex + chapterTitle.length);
                const afterChapter = fullText.substring(chapterIndex + chapterTitle.length);
                
                resultDiv.innerHTML = 
                  escapeHtml(beforeChapter) + 
                  '<span id="chapter-target" style="scroll-margin-top: 20px;">' + escapeHtml(chapterText) + '</span>' + 
                  escapeHtml(afterChapter);
                
                const target = document.getElementById('chapter-target');
                if (target) {
                  target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  
                  // é«˜äº®æ•ˆæœ
                  target.style.background = 'linear-gradient(90deg, rgba(233, 69, 96, 0.3), rgba(244, 162, 97, 0.1))';
                  target.style.borderRadius = '4px';
                  target.style.padding = '4px 8px';
                  target.style.marginLeft = '-8px';
                  
                  setTimeout(() => {
                    target.style.transition = 'background 1.5s ease';
                    target.style.background = 'transparent';
                  }, 2000);
                }
              }
              
              // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
              chapterNavList.querySelectorAll('button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              
              // è¡Œå‹•è£ç½®ä¸Šè‡ªå‹•é—œé–‰é¢æ¿
              if (window.innerWidth <= 768) {
                isPanelOpen = false;
                chapterNavPanel.classList.remove('open');
              }
            });
          });
        } else {
          chapterNavContainer.classList.remove('show');
          chapterMatches = [];
        }
      }

      // HTML è½‰ç¾©å‡½æ•¸
      function escapeHtml(text) {
        return text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // ==================== ç”Ÿæˆæ•…äº‹ ====================
      generateBtn.addEventListener('click', async () => {
        hideStatus();
        resultDiv.textContent = '';
        chapterNav.style.display = 'none';
        localStorage.removeItem('savedStory');
        latestStory = '';
        downloadBtn.disabled = true;
        continueBtn.disabled = true;

        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        const theme = themeSelect.value.trim();
        const setting = settingSelect.value.trim();
        
        const characterRows = Array.from(charactersContainer.querySelectorAll('.character-row'));
        let charactersInfo = '';
        characterRows.forEach((row, idx) => {
          const fields = [];
          const name = row.querySelector('.char-name').value.trim();
          const personality = row.querySelector('.char-personality').value.trim();
          const goal = row.querySelector('.char-goal').value.trim();
          const weakness = row.querySelector('.char-weakness').value.trim();
          const secret = row.querySelector('.char-secret').value.trim();
          const relation = row.querySelector('.char-relation').value.trim();
          if (name) fields.push(name);
          if (personality) fields.push(`å€‹æ€§ï¼š${personality}`);
          if (goal) fields.push(`ç›®æ¨™ï¼š${goal}`);
          if (weakness) fields.push(`å¼±é»ï¼š${weakness}`);
          if (secret) fields.push(`ç§˜å¯†ï¼š${secret}`);
          if (relation) fields.push(`äººéš›ï¼š${relation}`);
          if (fields.length > 0) charactersInfo += `äººç‰©${idx + 1}ï¼š${fields.join('ï¼Œ')}ã€‚\n`;
        });
        
        const style = styleSelect.value.trim();
        const chapters = chaptersInput.value.trim();
        const length = lengthInput.value.trim();
        const notes = notesInput.value.trim();

        if (!apiKey) {
          showStatus('error', 'è«‹è¼¸å…¥ API é‡‘é‘°');
          return;
        }

        let prompt = '';
        if (theme) prompt += `ä¸»é¡Œï¼š${theme}ã€‚`;
        if (setting) prompt += `èƒŒæ™¯è¨­å®šï¼š${setting}ã€‚`;
        if (charactersInfo) prompt += `${charactersInfo}`;
        if (style) prompt += `æ•…äº‹é¢¨æ ¼ï¼š${style}ã€‚`;
        if (chapters) prompt += `æ•…äº‹åˆ†ç‚º ${chapters} ç« ç¯€ã€‚`;
        if (length) prompt += `ç¸½ç¯‡å¹…ç´„ ${length} å­—ã€‚`;
        if (notes) prompt += `å…¶ä»–èªªæ˜ï¼š${notes}ã€‚`;
        
        if (!theme && !setting && !charactersInfo && !style && !chapters && !length && !notes) {
          showStatus('error', 'è«‹è‡³å°‘å¡«å¯«ä¸€é …è¨­å®šæˆ–ä½¿ç”¨éš¨æ©Ÿå¡«å……');
          return;
        }
        
        prompt += 'è«‹ä»¥ç¹é«”ä¸­æ–‡æ’°å¯«é•·ç¯‡å°èªªï¼Œçµæ§‹å®Œæ•´ï¼Œæœ‰èµ·æ‰¿è½‰åˆï¼›è‹¥æœ‰æŒ‡å®šç« ç¯€ï¼Œè«‹æ¨™æ˜ç« ç¯€æ¨™é¡Œã€‚';

        showStatus('loading', 'æ•…äº‹ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...');
        generateBtn.disabled = true;

        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
            }),
          });
          const data = await response.json();
          
          if (data.error) {
            showStatus('error', 'éŒ¯èª¤ï¼š' + data.error.message);
            return;
          }
          
          if (data.candidates && data.candidates.length > 0) {
            const parts = data.candidates[0].content.parts || [];
            const story = parts.map(p => p.text || '').join('');
            latestStory = story.trim();
            resultDiv.textContent = latestStory;
            
            try {
              localStorage.setItem('savedStory', latestStory);
            } catch (e) {
              console.warn('ç„¡æ³•å„²å­˜æ•…äº‹è‡³ localStorageï¼š', e);
            }
            
            showStatus('success', 'ç”Ÿæˆå®Œæˆï¼');
            downloadBtn.disabled = false;
            continueBtn.disabled = false;
            parseAndShowChapters(latestStory);
          } else {
            showStatus('error', 'æ²’æœ‰ç²å¾—å…§å®¹ï¼Œè«‹èª¿æ•´è¨­å®š');
          }
        } catch (err) {
          showStatus('error', 'è«‹æ±‚å¤±æ•—ï¼š' + err.message);
        } finally {
          generateBtn.disabled = false;
        }
      });

      // ==================== ç¹¼çºŒç”Ÿæˆ ====================
      continueBtn.addEventListener('click', async () => {
        if (!latestStory) {
          showStatus('error', 'å°šæœªæœ‰æ•…äº‹å¯ç¹¼çºŒï¼Œè«‹å…ˆç”Ÿæˆ');
          return;
        }
        
        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        
        if (!apiKey) {
          showStatus('error', 'è«‹è¼¸å…¥ API é‡‘é‘°');
          return;
        }

        const continuePrompt = latestStory + '\n\nè«‹ä¿æŒä»¥ä¸Šæ•…äº‹çš„ä¸»é¡Œã€èƒŒæ™¯ã€äººç‰©èˆ‡é¢¨æ ¼ï¼Œç¹¼çºŒæ’°å¯«å¾ŒçºŒç« ç¯€æˆ–æ•…äº‹å…§å®¹ï¼Œç›´åˆ°æ­¤ç« ç¯€çµæŸæˆ–æ•…äº‹å®Œçµã€‚';
        
        showStatus('loading', 'çºŒç¯‡ç”Ÿæˆä¸­...');
        continueBtn.disabled = true;
        generateBtn.disabled = true;

        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify({
              contents: [{ parts: [{ text: continuePrompt }] }],
            }),
          });
          const data = await response.json();
          
          if (data.error) {
            showStatus('error', 'éŒ¯èª¤ï¼š' + data.error.message);
            return;
          }
          
          if (data.candidates && data.candidates.length > 0) {
            const parts = data.candidates[0].content.parts || [];
            const continuation = parts.map(p => p.text || '').join('').trim();
            if (continuation) {
              latestStory += '\n\n' + continuation;
              resultDiv.textContent = latestStory;
              try {
                localStorage.setItem('savedStory', latestStory);
              } catch (e) {
                showStatus('error', 'æ•…äº‹å…§å®¹éé•·ï¼Œæœªèƒ½è‡ªå‹•å„²å­˜');
              }
              showStatus('success', 'çºŒç¯‡å®Œæˆï¼');
              downloadBtn.disabled = false;
              parseAndShowChapters(latestStory);
            } else {
              showStatus('error', 'æ²’æœ‰ç²å¾—çºŒç¯‡å…§å®¹ï¼Œå¯èƒ½å·²å®Œçµ');
            }
          } else {
            showStatus('error', 'æ²’æœ‰ç²å¾—çºŒç¯‡å…§å®¹ï¼Œå¯èƒ½å·²å®Œçµ');
          }
        } catch (err) {
          showStatus('error', 'è«‹æ±‚å¤±æ•—ï¼š' + err.message);
        } finally {
          continueBtn.disabled = false;
          generateBtn.disabled = false;
        }
      });

      // ==================== ä¸‹è¼‰åŠŸèƒ½ ====================
      function downloadFile(filename, text) {
        const link = document.createElement('a');
        link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      downloadBtn.addEventListener('click', () => {
        if (!latestStory) return;
        const title = themeSelect.value || 'ç”Ÿæˆå°èªª';
        downloadFile(title + '.txt', latestStory);
      });

      // ==================== æ›¸ç±¤åŠŸèƒ½ (å¤§å¹…å„ªåŒ–) ====================
      function loadBookmarks() {
        try {
          const raw = localStorage.getItem('bookmarks');
          if (!raw) return [];
          return JSON.parse(raw);
        } catch (e) {
          console.warn('ç„¡æ³•è®€å–æ›¸ç±¤ï¼š', e);
          return [];
        }
      }

      function saveBookmarks(bookmarks) {
        try {
          localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        } catch (e) {
          showStatus('error', 'æ›¸ç±¤å„²å­˜å¤±æ•—ï¼Œå¯èƒ½å·²é”å„²å­˜ä¸Šé™');
        }
      }

      function formatDate(timestamp) {
        const date = new Date(timestamp);
        return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
      }

      function formatWordCount(text) {
        const count = text.length;
        if (count >= 10000) return (count / 10000).toFixed(1) + ' è¬å­—';
        if (count >= 1000) return (count / 1000).toFixed(1) + ' åƒå­—';
        return count + ' å­—';
      }

      function getFilteredAndSortedBookmarks() {
        let bookmarks = loadBookmarks();
        const searchTerm = bookmarkSearch.value.trim().toLowerCase();
        const sortBy = bookmarkSort.value;

        // æœå°‹éæ¿¾
        if (searchTerm) {
          bookmarks = bookmarks.filter(bm => 
            (bm.title && bm.title.toLowerCase().includes(searchTerm)) ||
            (bm.tags && bm.tags.some(t => t.toLowerCase().includes(searchTerm))) ||
            (bm.notes && bm.notes.toLowerCase().includes(searchTerm))
          );
        }

        // æ’åº
        switch (sortBy) {
          case 'newest':
            bookmarks.sort((a, b) => b.id - a.id);
            break;
          case 'oldest':
            bookmarks.sort((a, b) => a.id - b.id);
            break;
          case 'name':
            bookmarks.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            break;
          case 'length':
            bookmarks.sort((a, b) => (b.content?.length || 0) - (a.content?.length || 0));
            break;
        }

        return bookmarks;
      }

      function renderBookmarks() {
        const allBookmarks = loadBookmarks();
        const bookmarks = getFilteredAndSortedBookmarks();
        
        bookmarkCount.textContent = `${allBookmarks.length} ç¯‡`;
        bookmarkList.innerHTML = '';

        if (bookmarks.length === 0) {
          bookmarkList.innerHTML = `
            <li class="bookmark-empty">
              <div class="bookmark-empty-icon">ğŸ“š</div>
              <div>${allBookmarks.length === 0 ? 'é‚„æ²’æœ‰æ›¸ç±¤ï¼Œç”Ÿæˆæ•…äº‹å¾Œé»æ“Šã€Œå„²å­˜ç›®å‰æ•…äº‹ã€' : 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ›¸ç±¤'}</div>
            </li>
          `;
          return;
        }

        bookmarks.forEach(bm => {
          const li = document.createElement('li');
          li.className = 'bookmark-item';
          li.innerHTML = `
            <div class="bookmark-item-icon">ğŸ“–</div>
            <div class="bookmark-item-content">
              <div class="bookmark-item-title">${bm.title || 'æœªå‘½åæ›¸ç±¤'}</div>
              <div class="bookmark-item-meta">
                <span>ğŸ“… ${formatDate(bm.id)}</span>
                <span>ğŸ“ ${formatWordCount(bm.content || '')}</span>
                ${bm.tags && bm.tags.length > 0 ? `<span>ğŸ·ï¸ ${bm.tags.slice(0,3).join(', ')}</span>` : ''}
              </div>
            </div>
            <div class="bookmark-item-actions">
              <button type="button" class="btn-load" data-action="load">è¼‰å…¥</button>
              <button type="button" data-action="edit">ç·¨è¼¯</button>
              <button type="button" data-action="delete">åˆªé™¤</button>
            </div>
          `;

          // è¼‰å…¥
          li.querySelector('[data-action="load"]').addEventListener('click', () => {
            latestStory = bm.content;
            resultDiv.textContent = latestStory;
            downloadBtn.disabled = !latestStory;
            continueBtn.disabled = !latestStory;
            try {
              localStorage.setItem('savedStory', latestStory);
            } catch (e) {}
            showStatus('success', 'æ›¸ç±¤å·²è¼‰å…¥');
            parseAndShowChapters(latestStory);
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
          });

          // ç·¨è¼¯
          li.querySelector('[data-action="edit"]').addEventListener('click', () => {
            editingBookmarkId = bm.id;
            editBookmarkTitle.value = bm.title || '';
            editBookmarkTags.value = (bm.tags || []).join(', ');
            editBookmarkNotes.value = bm.notes || '';
            editModal.classList.add('show');
          });

          // åˆªé™¤
          li.querySelector('[data-action="delete"]').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ›¸ç±¤å—ï¼Ÿ')) {
              const list = loadBookmarks().filter(b => b.id !== bm.id);
              saveBookmarks(list);
              renderBookmarks();
              showStatus('success', 'æ›¸ç±¤å·²åˆªé™¤');
            }
          });

          bookmarkList.appendChild(li);
        });
      }

      // æ–°å¢æ›¸ç±¤
      addBookmarkBtn.addEventListener('click', () => {
        if (!latestStory || latestStory.trim() === '') {
          showStatus('error', 'æ²’æœ‰å¯å„²å­˜çš„å…§å®¹');
          return;
        }
        const bookmarks = loadBookmarks();
        let title = latestStory.trim().replace(/\s+/g, ' ').substring(0, 50);
        if (title.length < latestStory.trim().length) title += '...';
        
        const newBookmark = {
          id: Date.now(),
          title,
          content: latestStory,
          tags: [],
          notes: '',
        };
        bookmarks.push(newBookmark);
        saveBookmarks(bookmarks);
        renderBookmarks();
        showStatus('success', 'æ›¸ç±¤å·²å„²å­˜ï¼');
      });

      // æœå°‹å’Œæ’åº
      bookmarkSearch.addEventListener('input', renderBookmarks);
      bookmarkSort.addEventListener('change', renderBookmarks);

      // ç·¨è¼¯å½ˆçª—
      cancelEditBtn.addEventListener('click', () => {
        editModal.classList.remove('show');
        editingBookmarkId = null;
      });

      saveEditBtn.addEventListener('click', () => {
        if (!editingBookmarkId) return;
        const bookmarks = loadBookmarks();
        const bm = bookmarks.find(b => b.id === editingBookmarkId);
        if (bm) {
          bm.title = editBookmarkTitle.value.trim() || bm.title;
          bm.tags = editBookmarkTags.value.split(',').map(t => t.trim()).filter(t => t);
          bm.notes = editBookmarkNotes.value.trim();
          saveBookmarks(bookmarks);
          renderBookmarks();
          showStatus('success', 'æ›¸ç±¤å·²æ›´æ–°');
        }
        editModal.classList.remove('show');
        editingBookmarkId = null;
      });

      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) {
          editModal.classList.remove('show');
          editingBookmarkId = null;
        }
      });

      // åŒ¯å‡ºæ›¸ç±¤
      exportBookmarksBtn.addEventListener('click', () => {
        const bookmarks = loadBookmarks();
        if (bookmarks.length === 0) {
          showStatus('error', 'æ²’æœ‰æ›¸ç±¤å¯åŒ¯å‡º');
          return;
        }
        const dataStr = JSON.stringify(bookmarks, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `å°èªªæ›¸ç±¤_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        showStatus('success', 'æ›¸ç±¤å·²åŒ¯å‡º');
      });

      // åŒ¯å…¥æ›¸ç±¤
      importBookmarksBtn.addEventListener('click', () => {
        importFileInput.click();
      });

      importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (!Array.isArray(imported)) throw new Error('æ ¼å¼éŒ¯èª¤');
            
            const existing = loadBookmarks();
            const existingIds = new Set(existing.map(b => b.id));
            let added = 0;
            
            imported.forEach(bm => {
              if (bm.id && bm.content && !existingIds.has(bm.id)) {
                existing.push(bm);
                added++;
              }
            });
            
            saveBookmarks(existing);
            renderBookmarks();
            showStatus('success', `å·²åŒ¯å…¥ ${added} ç­†æ›¸ç±¤`);
          } catch (err) {
            showStatus('error', 'åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      });

      // åˆå§‹åŒ–æ›¸ç±¤åˆ—è¡¨
      renderBookmarks();
    </script>
  </body>
</html>
