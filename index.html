<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°èªªç”Ÿæˆå™¨ | AI å‰µä½œå·¥åŠ</title>
    
    <!-- PWA æ”¯æ´ -->
    <meta name="description" content="AI å°èªªç”Ÿæˆå™¨ - é›¢ç·šå¯ç”¨çš„å‰µä½œå·¥å…·">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å°èªªç”Ÿæˆå™¨">
    
    <!-- é›¢ç·šå­—é«”å‚™æ´ -->
    <style>
      /* é›¢ç·šæ™‚ä½¿ç”¨ç³»çµ±å­—é«” */
      @font-face {
        font-family: 'Offline Serif';
        src: local('Noto Serif TC'), local('Noto Serif CJK TC'), local('Source Han Serif TC'), 
             local('PingFang TC'), local('Microsoft JhengHei'), local('å¾®è»Ÿæ­£é»‘é«”'),
             local('Heiti TC'), local('Apple LiGothic'), local('SimHei');
        font-weight: 400 700;
        font-display: swap;
      }
    </style>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;600;700&family=LXGW+WenKai+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #1a1a2e;
        --primary-light: #16213e;
        --accent: #e94560;
        --accent-hover: #ff6b6b;
        --gold: #f4a261;
        --gold-light: #f8c291;
        --text: #2d3436;
        --text-light: #636e72;
        --bg: #fefefe;
        --card-bg: #ffffff;
        --section-bg: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        --input-bg: #fff;
        --border: #e0e0e0;
        --shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 15px 50px rgba(0, 0, 0, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'LXGW WenKai TC', 'Noto Serif TC', 'Offline Serif', 'PingFang TC', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
        background: var(--bg);
        background-image: 
          radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.03) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(244, 162, 97, 0.03) 0%, transparent 50%),
          linear-gradient(180deg, #fefefe 0%, #f8f9fa 100%);
        color: var(--text);
        min-height: 100vh;
        padding: 40px 20px 80px;
      }

      /* é ‚éƒ¨è£é£¾æ¢ */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--gold), var(--accent));
        z-index: 1000;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
      }

      /* é ­éƒ¨å€åŸŸ */
      header {
        text-align: center;
        margin-bottom: 50px;
        position: relative;
      }

      header::after {
        content: 'âœ¦';
        display: block;
        font-size: 1.5rem;
        color: var(--gold);
        margin-top: 20px;
        animation: twinkle 2s ease-in-out infinite;
      }

      @keyframes twinkle {
        0%, 100% { opacity: 0.5; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
      }

      h1 {
        font-family: 'Noto Serif TC', serif;
        font-size: 3rem;
        font-weight: 700;
        margin: 0;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: 0.1em;
      }

      .subtitle {
        margin-top: 16px;
        color: var(--text-light);
        font-size: 1.1rem;
        line-height: 1.8;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      /* ä¸»å¡ç‰‡ */
      .card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: var(--shadow);
        padding: 40px;
        margin-bottom: 30px;
        border: 1px solid rgba(0, 0, 0, 0.03);
        transition: box-shadow 0.3s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-hover);
      }

      /* å€å¡Šæ¨£å¼ */
      .section {
        background: var(--section-bg);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }

      .section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, var(--accent), var(--gold));
        border-radius: 4px 0 0 4px;
      }

      .section-title {
        font-family: 'Noto Serif TC', serif;
        font-weight: 600;
        font-size: 1.3rem;
        color: var(--primary);
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title::before {
        content: attr(data-icon);
        font-size: 1.2rem;
      }

      /* è¼¸å…¥çµ„ä»¶ */
      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--primary);
        font-size: 0.95rem;
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .label-row label {
        font-weight: 500;
        color: var(--primary);
        margin-bottom: 0;
      }

      input[type="text"],
      input[type="number"],
      input[type="password"],
      select,
      textarea {
        width: 100%;
        padding: 14px 18px;
        border: 2px solid var(--border);
        border-radius: 12px;
        background: var(--input-bg);
        font-family: inherit;
        font-size: 1rem;
        color: var(--text);
        transition: all 0.3s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.1);
      }

      textarea {
        min-height: 100px;
        resize: vertical;
        line-height: 1.6;
      }

      select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23636e72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px;
        padding-right: 45px;
      }

      /* API é‡‘é‘°å®¹å™¨ */
      .api-key-container {
        display: flex;
        gap: 10px;
      }

      .api-key-container input {
        flex: 1;
      }

      /* æŒ‰éˆ•æ¨£å¼ */
      button {
        font-family: inherit;
        font-size: 0.95rem;
        font-weight: 500;
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.4s, height 0.4s;
      }

      button:active::after {
        width: 300px;
        height: 300px;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--accent) 0%, #ff6b6b 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
      }

      .btn-secondary {
        background: var(--primary);
        color: #fff;
      }

      .btn-secondary:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
      }

      .btn-outline {
        background: transparent;
        color: var(--text);
        border: 2px solid var(--border);
      }

      .btn-outline:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .btn-gold {
        background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
        color: var(--primary);
        box-shadow: 0 4px 15px rgba(244, 162, 97, 0.3);
      }

      .btn-gold:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 162, 97, 0.4);
      }

      .btn-small {
        padding: 8px 16px;
        font-size: 0.85rem;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }

      /* ä¸»æŒ‰éˆ•å€ */
      .buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 10px;
      }

      /* ä¸‹è¼‰ä¸‹æ‹‰é¸å–® */
      .download-dropdown {
        position: relative;
        display: inline-block;
      }
      
      .download-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 6px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        z-index: 100;
        min-width: 200px;
        overflow: hidden;
        animation: dropdownFade 0.2s ease;
      }
      
      @keyframes dropdownFade {
        from {
          opacity: 0;
          transform: translateY(-8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .download-dropdown.open .download-menu {
        display: block;
      }
      
      .download-menu button {
        display: block;
        width: 100%;
        padding: 14px 18px;
        background: none;
        border: none;
        text-align: left;
        font-size: 0.95rem;
        color: var(--text);
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
      }
      
      .download-menu button:hover {
        background: linear-gradient(135deg, rgba(233, 69, 96, 0.08), rgba(244, 162, 97, 0.08));
        color: var(--accent);
      }
      
      .download-menu button:first-child {
        border-bottom: 1px solid var(--border);
      }
      
      .download-menu button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* äººç‰©è¨­å®šå€ */
      .character-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 14px;
        align-items: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
      }

      .character-row:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 12px rgba(233, 69, 96, 0.08);
      }

      .char-index {
        font-weight: 600;
        color: var(--accent);
        font-size: 0.9rem;
        width: 55px;
        flex-shrink: 0;
      }

      .character-row input,
      .character-row select {
        padding: 10px 12px;
        font-size: 0.9rem;
      }

      .character-row .char-gender {
        width: 75px;
        flex-shrink: 0;
      }
      
      .character-row .char-age {
        width: 70px;
        flex-shrink: 0;
      }
      
      .character-row .char-name {
        width: 90px;
        flex-shrink: 0;
      }
      
      .character-row .char-personality,
      .character-row .char-goal,
      .character-row .char-weakness,
      .character-row .char-secret,
      .character-row .char-relation {
        flex: 1;
        min-width: 110px;
      }

      .character-row button {
        padding: 10px 14px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      .char-remove-btn {
        color: #999;
        border-color: #ddd;
      }
      
      .char-remove-btn:hover {
        color: #e94560;
        border-color: #e94560;
        background: rgba(233, 69, 96, 0.1);
      }

      /* å¸¶ datalist çš„è¼¸å…¥æ¡†æ¨£å¼ */
      .character-row input[list] {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 8px center;
        padding-right: 28px;
        cursor: pointer;
      }
      
      .character-row input[list]:focus {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23e94560' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
      }
      
      .character-row input[list]::placeholder {
        color: #aaa;
      }

      /* éŸ¿æ‡‰å¼ - äººç‰©è¨­å®š */
      @media (max-width: 1200px) {
        .character-row .char-personality,
        .character-row .char-goal,
        .character-row .char-weakness,
        .character-row .char-secret,
        .character-row .char-relation {
          min-width: 100px;
        }
      }

      @media (max-width: 900px) {
        .character-row {
          padding: 14px;
        }
        .char-index {
          width: 100%;
          padding-bottom: 8px;
          margin-bottom: 4px;
          border-bottom: 1px dashed var(--border);
        }
        .character-row .char-personality,
        .character-row .char-goal,
        .character-row .char-weakness,
        .character-row .char-secret,
        .character-row .char-relation {
          min-width: calc(33% - 10px);
          flex: 1 1 calc(33% - 10px);
        }
      }

      @media (max-width: 600px) {
        .character-row {
          padding: 12px;
          gap: 8px;
        }
        .character-row .char-gender {
          width: 70px;
        }
        .character-row .char-age {
          width: 65px;
        }
        .character-row .char-name {
          flex: 1;
          min-width: 80px;
        }
        .character-row .char-personality,
        .character-row .char-goal,
        .character-row .char-weakness,
        .character-row .char-secret,
        .character-row .char-relation {
          min-width: calc(50% - 5px);
          flex: 1 1 calc(50% - 5px);
        }
      }

      @media (max-width: 450px) {
        .character-row .char-personality,
        .character-row .char-goal,
        .character-row .char-weakness,
        .character-row .char-secret,
        .character-row .char-relation {
          min-width: 100%;
          flex: 1 1 100%;
        }
        .character-row button {
          flex: 1;
        }
      }
        }
      }

      /* ç‹€æ…‹è¨Šæ¯ */
      .status {
        margin-top: 16px;
        padding: 14px 20px;
        border-radius: 10px;
        font-size: 0.95rem;
        display: none;
        align-items: center;
        gap: 10px;
      }

      .status.show {
        display: flex;
      }

      .status.loading {
        background: linear-gradient(90deg, #f8f9fa, #e9ecef, #f8f9fa);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        color: var(--text);
      }

      .status.success {
        background: #d4edda;
        color: #155724;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
      }

      .status.warning {
        background: #fff3cd;
        color: #856404;
      }

      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      .status-icon {
        font-size: 1.2rem;
      }

      /* è¼¸å‡ºå€ */
      .output {
        margin-top: 30px;
        padding: 40px;
        border: 2px solid var(--border);
        border-radius: 16px;
        background: linear-gradient(180deg, #fff 0%, #fafafa 100%);
        font-family: 'Noto Serif TC', serif;
        font-size: 1.15rem;
        line-height: 2;
        white-space: pre-wrap;
        color: var(--text);
        min-height: 200px;
        position: relative;
      }

      .output:empty::before {
        content: 'ç”Ÿæˆçš„æ•…äº‹å°‡æœƒåœ¨é€™è£¡é¡¯ç¤º...';
        color: #adb5bd;
        font-style: italic;
      }

      .output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .output-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--primary);
      }

      /* ======================= */
      /* æ›¸ç±¤åŠŸèƒ½ - å¤§å¹…å„ªåŒ– */
      /* ======================= */
      .bookmark-card {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        color: #fff;
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow);
      }

      .bookmark-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
      }

      .bookmark-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .bookmark-title::before {
        content: 'ğŸ“š';
        font-size: 1.4rem;
      }

      .bookmark-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 400;
      }

      .bookmark-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .bookmark-actions button {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .bookmark-actions button:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      /* æ›¸ç±¤æœå°‹èˆ‡æ’åº */
      .bookmark-toolbar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .bookmark-search {
        flex: 1;
        min-width: 200px;
        position: relative;
      }

      .bookmark-search input {
        padding-left: 45px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
      }

      .bookmark-search input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .bookmark-search input:focus {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.4);
        box-shadow: none;
      }

      .bookmark-search::before {
        content: 'ğŸ”';
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1rem;
        z-index: 1;
      }

      .bookmark-sort {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        min-width: 140px;
      }

      .bookmark-sort option {
        background: var(--primary);
        color: #fff;
      }

      /* æ›¸ç±¤åˆ—è¡¨ */
      .bookmark-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 400px;
        overflow-y: auto;
      }

      .bookmark-list::-webkit-scrollbar {
        width: 6px;
      }

      .bookmark-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      .bookmark-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .bookmark-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
        border: 1px solid transparent;
      }

      .bookmark-item:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateX(4px);
      }

      .bookmark-item-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
      }

      .bookmark-item-content {
        flex: 1;
        min-width: 0;
      }

      .bookmark-item-title {
        font-weight: 500;
        font-size: 1rem;
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .bookmark-item-meta {
        display: flex;
        gap: 16px;
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .bookmark-item-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .bookmark-item-actions button {
        padding: 8px 12px;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        border: none;
      }

      .bookmark-item-actions button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .bookmark-item-actions .btn-load {
        background: var(--gold);
        color: var(--primary);
      }

      .bookmark-item-actions .btn-load:hover {
        background: var(--gold-light);
      }

      .bookmark-empty {
        text-align: center;
        padding: 40px;
        opacity: 0.7;
      }

      .bookmark-empty-icon {
        font-size: 3rem;
        margin-bottom: 16px;
      }

      /* æ›¸ç±¤ç·¨è¼¯å½ˆçª— */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        padding: 20px;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: #fff;
        border-radius: 20px;
        padding: 32px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.3s ease;
        color: var(--text);
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
      }

      .modal-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0 0 24px 0;
        color: var(--primary);
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      /* ç« ç¯€å°èˆª - æ™ºèƒ½æµ®å‹•å¼ */
      .chapter-nav-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 999;
        display: none;
      }

      .chapter-nav-container.show {
        display: block;
      }

      .chapter-nav-toggle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent) 0%, #ff6b6b 100%);
        color: #fff;
        border: none;
        box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .chapter-nav-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(233, 69, 96, 0.5);
      }

      .chapter-nav-toggle .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--primary);
        color: #fff;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
      }

      .chapter-nav-panel {
        position: absolute;
        top: 0;
        right: 60px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        padding: 16px;
        min-width: 250px;
        max-width: 350px;
        max-height: 70vh;
        overflow-y: auto;
        opacity: 0;
        visibility: hidden;
        transform: translateX(20px);
        transition: all 0.3s ease;
      }

      .chapter-nav-panel.open {
        opacity: 1;
        visibility: visible;
        transform: translateX(0);
      }

      .chapter-nav-panel::-webkit-scrollbar {
        width: 4px;
      }

      .chapter-nav-panel::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
      }

      .chapter-nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .chapter-nav-title {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
      }

      .chapter-nav-close {
        background: none;
        border: none;
        color: var(--text-light);
        cursor: pointer;
        padding: 4px;
        font-size: 1.2rem;
        line-height: 1;
      }

      .chapter-nav-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .chapter-nav-list button {
        padding: 10px 14px;
        font-size: 0.85rem;
        background: #f8f9fa;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 8px;
        text-align: left;
        transition: all 0.2s ease;
      }

      .chapter-nav-list button:hover {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
        transform: translateX(4px);
      }

      .chapter-nav-list button.active {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }

      .chapter-nav-list button .chapter-num {
        display: inline-block;
        background: rgba(0,0,0,0.1);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        margin-right: 8px;
      }

      .chapter-nav-list button.active .chapter-num {
        background: rgba(255,255,255,0.2);
      }

      /* é–±è®€é€²åº¦æŒ‡ç¤ºå™¨ */
      .reading-progress {
        position: fixed;
        top: 4px;
        left: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent), var(--gold));
        z-index: 1001;
        transition: width 0.1s ease;
      }

      @media (max-width: 768px) {
        .chapter-nav-container {
          top: auto;
          bottom: 20px;
          right: 16px;
        }

        .chapter-nav-panel {
          right: 0;
          top: auto;
          bottom: 60px;
          max-width: calc(100vw - 32px);
        }
      }

      /* å‹•ç•« */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card, .bookmark-card {
        animation: fadeInUp 0.6s ease-out;
      }

      .card:nth-child(2) { animation-delay: 0.1s; }
      .bookmark-card { animation-delay: 0.2s; }

      /* éŸ¿æ‡‰å¼ */
      @media (max-width: 768px) {
        body {
          padding: 20px 16px 60px;
        }

        h1 {
          font-size: 2rem;
        }

        .card {
          padding: 24px;
        }

        .section {
          padding: 20px;
        }

        .output {
          padding: 24px;
          font-size: 1.05rem;
        }

        .bookmark-card {
          padding: 20px;
        }

        .buttons {
          flex-direction: column;
        }

        .buttons button {
          width: 100%;
        }
      }

      /* æœ—è®€æ§åˆ¶é¢æ¿æ¨£å¼ */
      .speech-panel {
        background: linear-gradient(135deg, #fff9f0 0%, #fff 100%);
        border: 2px solid var(--accent);
        border-radius: 16px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 8px 32px rgba(233, 69, 96, 0.15);
      }

      .speech-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
      }

      .speech-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--accent);
      }

      .speech-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #999;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .speech-close:hover {
        background: rgba(233, 69, 96, 0.1);
        color: var(--accent);
      }

      /* æ®µè½ç¯„åœé¸æ“‡å™¨ */
      .range-selector {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      .segment-input {
        width: 60px !important;
        min-width: 60px !important;
        flex: none !important;
        text-align: center;
        padding: 6px 8px !important;
        font-size: 0.9rem;
      }

      .range-selector span {
        color: var(--text-light);
        font-size: 0.9rem;
      }

      .range-selector .btn-small {
        padding: 6px 10px;
        font-size: 0.8rem;
        margin-left: 8px;
      }

      .segment-info {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-top: 6px;
        margin-bottom: 10px;
      }

      .speech-extra-buttons {
        margin-top: 14px;
        padding-top: 14px;
        border-top: 1px dashed var(--border);
      }

      .btn-full {
        width: 100%;
        justify-content: center;
      }

      @media (max-width: 500px) {
        .range-selector {
          font-size: 0.85rem;
        }
        .segment-input {
          width: 50px !important;
          min-width: 50px !important;
        }
      }

      /* ç‰¹æ®Šå…ƒç´ å¤šé¸æ ¼å­ */
      .special-elements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        margin-top: 8px;
      }

      .special-element-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.8);
        border: 2px solid var(--border);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
      }

      .special-element-item:hover {
        border-color: var(--accent);
        background: rgba(233, 69, 96, 0.05);
      }

      .special-element-item.selected {
        border-color: var(--accent);
        background: linear-gradient(135deg, rgba(233, 69, 96, 0.1), rgba(244, 162, 97, 0.1));
        box-shadow: 0 2px 8px rgba(233, 69, 96, 0.15);
      }

      .special-element-item input[type="checkbox"] {
        display: none;
      }

      .special-element-item .checkbox-custom {
        width: 18px;
        height: 18px;
        border: 2px solid var(--border);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .special-element-item.selected .checkbox-custom {
        background: var(--accent);
        border-color: var(--accent);
      }

      .special-element-item.selected .checkbox-custom::after {
        content: 'âœ“';
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .special-element-item .element-label {
        font-size: 0.9rem;
        color: var(--text);
      }

      .special-element-item .element-icon {
        font-size: 1.1rem;
      }

      @media (max-width: 600px) {
        .special-elements-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .speech-controls {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .speech-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .speech-row label {
        min-width: 80px;
        font-weight: 500;
        color: var(--text);
      }

      .speech-row select,
      .speech-row input[type="range"] {
        flex: 1;
      }

      .speech-row input[type="range"] {
        -webkit-appearance: none;
        height: 6px;
        background: linear-gradient(to right, var(--accent), var(--gold));
        border-radius: 3px;
        cursor: pointer;
      }

      .speech-row input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: var(--accent);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(233, 69, 96, 0.3);
      }

      .speech-row span {
        min-width: 45px;
        text-align: right;
        font-size: 0.9rem;
        color: #666;
      }

      .speech-buttons {
        display: flex;
        gap: 12px;
        margin-top: 8px;
      }

      .speech-buttons button {
        flex: 1;
      }

      .speech-progress {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px dashed var(--border);
      }

      .speech-progress-bar {
        height: 8px;
        background: #eee;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .speech-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--gold));
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 4px;
      }

      #speechProgressText {
        font-size: 0.85rem;
        color: #666;
      }

      /* æœ—è®€ä¸­çš„æ–‡å­—é«˜äº® */
      .speaking-highlight {
        background: linear-gradient(120deg, rgba(255, 215, 0, 0.3) 0%, rgba(233, 69, 96, 0.2) 100%);
        border-radius: 4px;
        padding: 2px 4px;
        transition: background 0.3s;
      }

      @media (max-width: 600px) {
        .speech-row {
          flex-wrap: wrap;
        }
        
        .speech-row label {
          min-width: 100%;
          margin-bottom: 4px;
        }
        
        .speech-buttons {
          flex-direction: column;
        }
      }

      /* é›¢ç·šç‹€æ…‹æç¤º */
      .offline-banner {
        position: fixed;
        top: 4px;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #f39c12, #e74c3c);
        color: white;
        text-align: center;
        padding: 8px 16px;
        font-size: 0.9rem;
        z-index: 9999;
        display: none;
        animation: slideDown 0.3s ease;
      }

      .offline-banner.show {
        display: block;
      }

      .offline-banner.online {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
      }

      @keyframes slideDown {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* é›¢ç·šæ¨¡å¼ä¸‹ç¦ç”¨ç”ŸæˆæŒ‰éˆ•çš„æ¨£å¼ */
      .offline-disabled {
        opacity: 0.5;
        cursor: not-allowed;
        position: relative;
      }

      .offline-disabled::after {
        content: 'ğŸ“´ éœ€è¦ç¶²è·¯';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.75rem;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <!-- é›¢ç·šç‹€æ…‹æç¤º -->
    <div id="offlineBanner" class="offline-banner">
      ğŸ“´ ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼ - æœ—è®€ã€é–±è®€ã€åŒ¯å‡ºã€åŒ¯å…¥åŠŸèƒ½ä»å¯ä½¿ç”¨
    </div>

    <div class="container">
      <header>
        <h1>å°èªªç”Ÿæˆå™¨</h1>
        <p class="subtitle">
          çµåˆ AI çš„ç„¡é™å‰µæ„ï¼Œæ‰“é€ å°ˆå±¬æ–¼ä½ çš„é•·ç¯‡æ•…äº‹<br>
          è¨­å®šä¸»é¡Œã€äººç‰©ã€èƒŒæ™¯ï¼Œä¸€éµç”Ÿæˆç²¾å½©å°èªª<br>
          <small style="opacity: 0.7;">ğŸ’¡ æ”¯æ´é›¢ç·šé–±è®€ã€æœ—è®€ã€åŒ¯å‡ºã€åŒ¯å…¥æ›¸ç±¤</small>
        </p>
      </header>

      <div class="card">
        <!-- åŸºæœ¬è¨­å®š -->
        <div class="section">
          <h2 class="section-title" data-icon="âš™ï¸">åŸºæœ¬è¨­å®š</h2>
          <div class="input-group">
            <label for="apiKey">Gemini API é‡‘é‘°</label>
            <div class="api-key-container">
              <input
                type="password"
                id="apiKey"
                placeholder="è«‹è¼¸å…¥æ‚¨çš„ API é‡‘é‘°"
                autocomplete="off"
              />
              <button type="button" id="toggleApiKeyVisibility" class="btn-outline btn-small">é¡¯ç¤º</button>
            </div>
          </div>
          <div class="input-group">
            <label for="model">é¸æ“‡æ¨¡å‹</label>
            <select id="model">
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-pro">Gemini Pro</option>
            </select>
          </div>
        </div>

        <!-- æ•…äº‹å…ƒç´  -->
        <div class="section">
          <h2 class="section-title" data-icon="ğŸ“–">æ•…äº‹å…ƒç´ </h2>
          <div class="input-group">
            <label for="theme">ä¸»é¡Œ</label>
            <select id="theme">
              <option value="">è«‹é¸æ“‡ä¸»é¡Œ</option>
            </select>
          </div>
          <div class="input-group">
            <label for="setting">èƒŒæ™¯è¨­å®š</label>
            <select id="setting">
              <option value="">è«‹é¸æ“‡èƒŒæ™¯</option>
            </select>
          </div>
          <div class="input-group">
            <div class="label-row">
              <label>ä¸»è¦äººç‰©è¨­å®š</label>
              <div style="display: flex; gap: 8px;">
                <button id="randomAllCharactersBtn" type="button" class="btn-outline btn-small">ğŸ² éš¨æ©Ÿäººç‰©</button>
                <button id="addCharacterBtn" type="button" class="btn-outline btn-small">+ æ–°å¢äººç‰©</button>
              </div>
            </div>
            <div id="charactersContainer"></div>
          </div>
          <div class="input-group">
            <label for="style">æ•…äº‹é¢¨æ ¼</label>
            <select id="style">
              <option value="">è«‹é¸æ“‡é¢¨æ ¼</option>
            </select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="input-group" style="margin-bottom: 0;">
              <label for="chapters">ç« ç¯€æ•¸</label>
              <input type="number" id="chapters" placeholder="å¦‚ï¼š10" min="1" max="50" step="1" />
            </div>
            <div class="input-group" style="margin-bottom: 0;">
              <label for="length">é è¨ˆç¸½å­—æ•¸</label>
              <input type="number" id="length" placeholder="å¦‚ï¼š50000" min="1000" max="200000" step="1000" />
            </div>
          </div>
        </div>

        <!-- é€²éšè¨­å®š -->
        <div class="section">
          <h2 class="section-title" data-icon="ğŸ›ï¸">é€²éšè¨­å®š</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="input-group" style="margin-bottom: 0;">
              <label for="narrative">æ•˜äº‹è¦–è§’</label>
              <select id="narrative">
                <option value="">è«‹é¸æ“‡è¦–è§’</option>
              </select>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
              <label for="era">æ™‚ä»£è¨­å®š</label>
              <select id="era">
                <option value="">è«‹é¸æ“‡æ™‚ä»£</option>
              </select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <div class="input-group" style="margin-bottom: 0;">
              <label for="pacing">æ•…äº‹ç¯€å¥</label>
              <select id="pacing">
                <option value="">è«‹é¸æ“‡ç¯€å¥</option>
              </select>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
              <label for="rating">å…§å®¹åˆ†ç´š</label>
              <select id="rating">
                <option value="">è«‹é¸æ“‡åˆ†ç´š</option>
              </select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <div class="input-group" style="margin-bottom: 0;">
              <label for="worldComplexity">ä¸–ç•Œè§€è¤‡é›œåº¦</label>
              <select id="worldComplexity">
                <option value="">è«‹é¸æ“‡è¤‡é›œåº¦</option>
              </select>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
              <label for="emotionalTone">æƒ…æ„ŸåŸºèª¿</label>
              <select id="emotionalTone">
                <option value="">è«‹é¸æ“‡åŸºèª¿</option>
              </select>
            </div>
          </div>
          <div class="input-group" style="margin-top: 16px;">
            <label for="ending">çµå±€å‚¾å‘</label>
            <select id="ending">
              <option value="">è«‹é¸æ“‡çµå±€</option>
            </select>
          </div>
          
          <!-- ç‰¹æ®Šå…ƒç´ å¤šé¸ -->
          <div class="input-group" style="margin-top: 16px;">
            <label>ç‰¹æ®Šå…ƒç´ ï¼ˆå¯å¤šé¸ï¼‰</label>
            <div id="specialElementsContainer" class="special-elements-grid"></div>
          </div>
        </div>

        <!-- å…¶ä»–èªªæ˜ -->
        <div class="section">
          <h2 class="section-title" data-icon="âœï¸">å…¶ä»–èªªæ˜</h2>
          <div class="input-group" style="margin-bottom: 0;">
            <label for="notes">è£œå……èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="notes" placeholder="å¦‚æœ‰é¡å¤–æƒ…ç¯€æˆ–é¢¨æ ¼è¦æ±‚ï¼Œå¯åœ¨æ­¤è£œå……ã€‚ä¾‹å¦‚ï¼šå¸Œæœ›ä¸»è§’æœ‰åè½‰çš„çµå±€ã€åŠ å…¥æ™‚é–“æ—…è¡Œå…ƒç´ ç­‰ã€‚"></textarea>
          </div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="buttons">
          <button id="randomBtn" type="button" class="btn-gold">ğŸ² éš¨æ©Ÿå¡«å……</button>
          <button id="generateBtn" type="button" class="btn-primary">âœ¨ é–‹å§‹ç”Ÿæˆ</button>
          <button id="continueBtn" type="button" class="btn-secondary" disabled>â¤ ç¹¼çºŒç”Ÿæˆ</button>
          
          <!-- ä¸‹è¼‰é¸å–® -->
          <div class="download-dropdown">
            <button id="downloadBtn" type="button" class="btn-outline" disabled>â¬‡ ä¸‹è¼‰å°èªª â–¾</button>
            <div class="download-menu" id="downloadMenu">
              <button type="button" data-format="txt">ğŸ“„ TXT ç´”æ–‡å­—æª”</button>
              <button type="button" data-format="html">ğŸ“± HTML æ‰‹æ©Ÿé–±è®€ç‰ˆ</button>
            </div>
          </div>
          
          <button id="speakBtn" type="button" class="btn-outline" disabled>ğŸ”Š æœ—è®€æ–‡ç« </button>
        </div>

        <!-- ç‹€æ…‹è¨Šæ¯ -->
        <div id="status" class="status">
          <span class="status-icon"></span>
          <span class="status-text"></span>
        </div>

        <!-- æœ—è®€æ§åˆ¶é¢æ¿ -->
        <div id="speechPanel" class="speech-panel" style="display: none;">
          <div class="speech-header">
            <span class="speech-title">ğŸ™ï¸ æœ—è®€æ§åˆ¶</span>
            <button id="closeSpeechPanel" class="speech-close">âœ•</button>
          </div>
          <div class="speech-controls">
            <div class="speech-row">
              <label>èªéŸ³ï¼š</label>
              <select id="voiceSelect"></select>
            </div>
            <div class="speech-row">
              <label>èªé€Ÿï¼š</label>
              <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" />
              <span id="rateValue">1.0x</span>
            </div>
            <div class="speech-row">
              <label>éŸ³èª¿ï¼š</label>
              <input type="range" id="speechPitch" min="0.5" max="2" step="0.1" value="1" />
              <span id="pitchValue">1.0</span>
            </div>
            <div class="speech-row">
              <label>æƒ…ç·’æ¨¡å¼ï¼š</label>
              <select id="emotionMode">
                <option value="auto">ğŸ­ è‡ªå‹•åµæ¸¬</option>
                <option value="narration">ğŸ“– å¹³ç©©æ•˜è¿°</option>
                <option value="dramatic">ğŸ¬ æˆ²åŠ‡å¼µåŠ›</option>
                <option value="gentle">ğŸŒ¸ æº«æŸ”ç´°è†©</option>
                <option value="excited">âš¡ æ¿€æ˜‚ç†±è¡€</option>
                <option value="sad">ğŸ’§ æ‚²å‚·ä½æ²‰</option>
                <option value="mysterious">ğŸŒ™ ç¥ç§˜æ‡¸ç–‘</option>
              </select>
            </div>
            <div class="speech-row">
              <label>æœ—è®€ç¯„åœï¼š</label>
              <div class="range-selector">
                <span>å¾ç¬¬</span>
                <input type="number" id="startSegment" min="1" value="1" class="segment-input" />
                <span>æ®µ åˆ°ç¬¬</span>
                <input type="number" id="endSegment" min="1" value="1" class="segment-input" />
                <span>æ®µ</span>
                <button id="readAllBtn" class="btn-small btn-outline" title="æœ—è®€å…¨éƒ¨">å…¨éƒ¨</button>
              </div>
            </div>
            <div id="segmentInfo" class="segment-info">å…± 0 æ®µ</div>
            <div class="speech-buttons">
              <button id="playPauseBtn" class="btn-primary">â–¶ï¸ é–‹å§‹æœ—è®€</button>
              <button id="stopSpeechBtn" class="btn-outline">â¹ï¸ åœæ­¢</button>
              <button id="resetSpeechBtn" class="btn-outline" title="æ¸…é™¤é€²åº¦ï¼Œå¾é ­é–‹å§‹">ğŸ”„ é‡ç½®</button>
            </div>
            <div class="speech-progress">
              <div class="speech-progress-bar">
                <div id="speechProgressFill" class="speech-progress-fill"></div>
              </div>
              <span id="speechProgressText">æº–å‚™å°±ç·’</span>
            </div>
            <div class="speech-extra-buttons">
              <button id="copyAllBtn" class="btn-outline btn-full">ğŸ“‹ è¤‡è£½å…¨æ–‡ï¼ˆå¯è²¼åˆ°å…¶ä»– App æœ—è®€ï¼‰</button>
            </div>
          </div>
        </div>

        <!-- è¼¸å‡ºå€ -->
        <div class="output-header" style="margin-top: 30px;">
          <span class="output-title">ğŸ“œ ç”Ÿæˆçµæœ</span>
        </div>
        <div id="result" class="output"></div>
      </div>

      <!-- æµ®å‹•ç« ç¯€å°èˆª -->
      <div id="chapterNavContainer" class="chapter-nav-container">
        <button id="chapterNavToggle" class="chapter-nav-toggle" title="ç« ç¯€å°èˆª">
          ğŸ“‘
          <span id="chapterBadge" class="badge">0</span>
        </button>
        <div id="chapterNavPanel" class="chapter-nav-panel">
          <div class="chapter-nav-header">
            <span class="chapter-nav-title">ğŸ“– ç« ç¯€ç›®éŒ„</span>
            <button id="chapterNavClose" class="chapter-nav-close">âœ•</button>
          </div>
          <div id="chapterNavList" class="chapter-nav-list"></div>
        </div>
      </div>

      <!-- é–±è®€é€²åº¦æ¢ -->
      <div id="readingProgress" class="reading-progress" style="width: 0%;"></div>

      <!-- æ›¸ç±¤å€ - å…¨æ–°è¨­è¨ˆ -->
      <div class="bookmark-card">
        <div class="bookmark-header">
          <h2 class="bookmark-title">
            æˆ‘çš„æ›¸ç±¤
            <span id="bookmarkCount" class="bookmark-count">0 ç¯‡</span>
          </h2>
          <div class="bookmark-actions">
            <button id="addBookmarkBtn" type="button" class="btn-small">ğŸ’¾ å„²å­˜ç›®å‰æ•…äº‹</button>
            <button id="exportBookmarksBtn" type="button" class="btn-small">ğŸ“¤ åŒ¯å‡ºå…¨éƒ¨</button>
            <button id="importBookmarksBtn" type="button" class="btn-small">ğŸ“¥ åŒ¯å…¥</button>
          </div>
        </div>

        <div class="bookmark-toolbar">
          <div class="bookmark-search">
            <input type="text" id="bookmarkSearch" placeholder="æœå°‹æ›¸ç±¤..." />
          </div>
          <select id="bookmarkSort" class="bookmark-sort">
            <option value="newest">æœ€æ–°å„ªå…ˆ</option>
            <option value="oldest">æœ€èˆŠå„ªå…ˆ</option>
            <option value="name">åç¨±æ’åº</option>
            <option value="length">é•·åº¦æ’åº</option>
          </select>
        </div>

        <ul id="bookmarkList" class="bookmark-list"></ul>
      </div>
    </div>

    <!-- ç·¨è¼¯æ›¸ç±¤å½ˆçª— -->
    <div id="editModal" class="modal-overlay">
      <div class="modal">
        <h3 class="modal-title">ç·¨è¼¯æ›¸ç±¤</h3>
        <div class="input-group">
          <label for="editBookmarkTitle">æ›¸ç±¤æ¨™é¡Œ</label>
          <input type="text" id="editBookmarkTitle" placeholder="è¼¸å…¥æ›¸ç±¤æ¨™é¡Œ" />
        </div>
        <div class="input-group">
          <label for="editBookmarkTags">æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
          <input type="text" id="editBookmarkTags" placeholder="å¦‚ï¼šå¥‡å¹», å†’éšª, ä¸»è§’å…‰ç’°" />
        </div>
        <div class="input-group" style="margin-bottom: 0;">
          <label for="editBookmarkNotes">å‚™è¨»</label>
          <textarea id="editBookmarkNotes" placeholder="æ·»åŠ å‚™è¨»..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" id="cancelEditBtn" class="btn-outline">å–æ¶ˆ</button>
          <button type="button" id="saveEditBtn" class="btn-primary">å„²å­˜</button>
        </div>
      </div>
    </div>

    <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;" />

    <!-- äººç‰©è¨­å®šä¸‹æ‹‰é¸å–®çš„ datalistï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰ -->
    <datalist id="personality-list"></datalist>
    <datalist id="goal-list"></datalist>
    <datalist id="weakness-list"></datalist>
    <datalist id="secret-list"></datalist>
    <datalist id="relation-list"></datalist>

    <script>
      // ==================== é›¢ç·šæ¨¡å¼æª¢æ¸¬ ====================
      const offlineBanner = document.getElementById('offlineBanner');
      let isOnline = navigator.onLine;

      function updateOnlineStatus() {
        isOnline = navigator.onLine;
        
        if (!isOnline) {
          offlineBanner.textContent = 'ğŸ“´ ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼ - æœ—è®€ã€é–±è®€ã€åŒ¯å‡ºã€åŒ¯å…¥åŠŸèƒ½ä»å¯ä½¿ç”¨';
          offlineBanner.classList.remove('online');
          offlineBanner.classList.add('show');
          
          // ç¦ç”¨éœ€è¦ç¶²è·¯çš„æŒ‰éˆ•
          if (generateBtn) {
            generateBtn.disabled = true;
            generateBtn.title = 'é›¢ç·šæ¨¡å¼ä¸‹ç„¡æ³•ç”Ÿæˆæ•…äº‹';
          }
          if (continueBtn) {
            continueBtn.disabled = true;
            continueBtn.title = 'é›¢ç·šæ¨¡å¼ä¸‹ç„¡æ³•ç¹¼çºŒç”Ÿæˆ';
          }
        } else {
          offlineBanner.textContent = 'âœ… å·²æ¢å¾©ç¶²è·¯é€£ç·š';
          offlineBanner.classList.add('online');
          offlineBanner.classList.add('show');
          
          // æ¢å¾©æŒ‰éˆ•
          if (generateBtn) {
            generateBtn.disabled = false;
            generateBtn.title = '';
          }
          if (continueBtn && latestStory) {
            continueBtn.disabled = false;
            continueBtn.title = '';
          }
          
          // 3ç§’å¾Œéš±è—æç¤º
          setTimeout(() => {
            offlineBanner.classList.remove('show');
          }, 3000);
        }
      }

      // ç›£è½ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);

      // åˆå§‹æª¢æŸ¥
      if (!navigator.onLine) {
        setTimeout(updateOnlineStatus, 500);
      }

      // ==================== å…ƒç´ å–å¾— ====================
      const apiKeyInput = document.getElementById('apiKey');
      const modelSelect = document.getElementById('model');
      const themeSelect = document.getElementById('theme');
      const settingSelect = document.getElementById('setting');
      const styleSelect = document.getElementById('style');
      const chaptersInput = document.getElementById('chapters');
      const lengthInput = document.getElementById('length');
      const notesInput = document.getElementById('notes');
      const randomBtn = document.getElementById('randomBtn');
      const generateBtn = document.getElementById('generateBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const continueBtn = document.getElementById('continueBtn');
      const statusDiv = document.getElementById('status');
      const resultDiv = document.getElementById('result');
      const toggleApiKeyVisibility = document.getElementById('toggleApiKeyVisibility');
      const charactersContainer = document.getElementById('charactersContainer');
      const randomAllCharactersBtn = document.getElementById('randomAllCharactersBtn');
      const addCharacterBtn = document.getElementById('addCharacterBtn');

      // é€²éšè¨­å®šå…ƒç´ 
      const narrativeSelect = document.getElementById('narrative');
      const eraSelect = document.getElementById('era');
      const pacingSelect = document.getElementById('pacing');
      const ratingSelect = document.getElementById('rating');
      const worldComplexitySelect = document.getElementById('worldComplexity');
      const emotionalToneSelect = document.getElementById('emotionalTone');
      const endingSelect = document.getElementById('ending');
      const specialElementsContainer = document.getElementById('specialElementsContainer');

      // æµ®å‹•ç« ç¯€å°èˆªå…ƒç´ 
      const chapterNavContainer = document.getElementById('chapterNavContainer');
      const chapterNavToggle = document.getElementById('chapterNavToggle');
      const chapterNavPanel = document.getElementById('chapterNavPanel');
      const chapterNavClose = document.getElementById('chapterNavClose');
      const chapterNavList = document.getElementById('chapterNavList');
      const chapterBadge = document.getElementById('chapterBadge');
      const readingProgress = document.getElementById('readingProgress');

      // æ›¸ç±¤å…ƒç´ 
      const addBookmarkBtn = document.getElementById('addBookmarkBtn');
      const exportBookmarksBtn = document.getElementById('exportBookmarksBtn');
      const importBookmarksBtn = document.getElementById('importBookmarksBtn');
      const importFileInput = document.getElementById('importFileInput');
      const bookmarkSearch = document.getElementById('bookmarkSearch');
      const bookmarkSort = document.getElementById('bookmarkSort');
      const bookmarkList = document.getElementById('bookmarkList');
      const bookmarkCount = document.getElementById('bookmarkCount');

      // æœ—è®€å…ƒç´ 
      const speakBtn = document.getElementById('speakBtn');
      const speechPanel = document.getElementById('speechPanel');
      const closeSpeechPanel = document.getElementById('closeSpeechPanel');
      const voiceSelect = document.getElementById('voiceSelect');
      const speechRate = document.getElementById('speechRate');
      const speechPitch = document.getElementById('speechPitch');
      const rateValue = document.getElementById('rateValue');
      const pitchValue = document.getElementById('pitchValue');
      const emotionMode = document.getElementById('emotionMode');
      const playPauseBtn = document.getElementById('playPauseBtn');
      const stopSpeechBtn = document.getElementById('stopSpeechBtn');
      const resetSpeechBtn = document.getElementById('resetSpeechBtn');
      const speechProgressFill = document.getElementById('speechProgressFill');
      const speechProgressText = document.getElementById('speechProgressText');

      // ç·¨è¼¯å½ˆçª—å…ƒç´ 
      const editModal = document.getElementById('editModal');
      const editBookmarkTitle = document.getElementById('editBookmarkTitle');
      const editBookmarkTags = document.getElementById('editBookmarkTags');
      const editBookmarkNotes = document.getElementById('editBookmarkNotes');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const saveEditBtn = document.getElementById('saveEditBtn');

      let latestStory = '';
      let editingBookmarkId = null;
      let chapterMatches = [];
      let isPanelOpen = false;

      // ==================== ç‹€æ…‹é¡¯ç¤º ====================
      function showStatus(type, message) {
        const icons = {
          loading: 'â³',
          success: 'âœ…',
          error: 'âŒ',
          warning: 'âš ï¸'
        };
        statusDiv.className = `status show ${type}`;
        statusDiv.querySelector('.status-icon').textContent = icons[type] || '';
        statusDiv.querySelector('.status-text').textContent = message;
      }

      function hideStatus() {
        statusDiv.className = 'status';
      }

      // ==================== API é‡‘é‘° ====================
      const storedKey = localStorage.getItem('geminiApiKey');
      if (storedKey) apiKeyInput.value = storedKey;

      apiKeyInput.addEventListener('change', () => {
        const val = apiKeyInput.value.trim();
        if (val) {
          try {
            localStorage.setItem('geminiApiKey', val);
          } catch (e) {
            showStatus('error', 'API é‡‘é‘°å„²å­˜å¤±æ•—');
          }
        }
      });

      toggleApiKeyVisibility.addEventListener('click', () => {
        const isPassword = apiKeyInput.type === 'password';
        apiKeyInput.type = isPassword ? 'text' : 'password';
        toggleApiKeyVisibility.textContent = isPassword ? 'éš±è—' : 'é¡¯ç¤º';
      });

      // ==================== è¼‰å…¥å·²å„²å­˜çš„æ•…äº‹ ====================
      const savedStory = localStorage.getItem('savedStory');
      if (savedStory) {
        latestStory = savedStory;
        resultDiv.textContent = savedStory;
        downloadBtn.disabled = false;
        continueBtn.disabled = false;
        speakBtn.disabled = false;
        parseAndShowChapters(savedStory);
      }

      // ==================== éš¨æ©Ÿè³‡æ–™åº« ====================
      const themes = [
        // å¥‡å¹»é¡
        'å¥‡å¹»å†’éšª','å²è©©å¥‡å¹»','é»‘æš—å¥‡å¹»','éƒ½å¸‚å¥‡å¹»','ç«¥è©±æ”¹ç·¨','ç¥è©±å‚³èªª','ç²¾éˆèˆ‡çŸ®äºº','é¾èˆ‡é­”æ³•','ç•°ä¸–ç•Œè½‰ç”Ÿ','å‹‡è€…èˆ‡é­”ç‹',
        // ç§‘å¹»é¡
        'æœªä¾†ç§‘å¹»','å¤ªç©ºæ­ŒåŠ‡','è³½åšé¾å…‹','å¾Œå•Ÿç¤ºéŒ„','äººå·¥æ™ºæ…§','æ™‚é–“æ—…è¡Œ','å¤–æ˜Ÿæ–‡æ˜','åŸºå› æ”¹é€ ','è™›æ“¬å¯¦å¢ƒ','æ©Ÿç”²æˆ°çˆ­',
        // æ„›æƒ…é¡
        'æµªæ¼«æ„›æƒ…','ç¦å¿Œä¹‹æˆ€','é’æ¢…ç«¹é¦¬','è¾¦å…¬å®¤æˆ€æƒ…','è±ªé–€æ©æ€¨','è·¨è¶Šæ™‚ç©ºçš„æ„›','ç•°æ—ä¹‹æˆ€','è™æˆ€æƒ…æ·±','ç”œèœœæ—¥å¸¸','å©šå¾Œç”Ÿæ´»',
        // æ‡¸ç–‘æ¨ç†é¡
        'æ‡¸ç–‘æ¨ç†','å¯†å®¤æ®ºäºº','é€£ç’°æ®ºæ‰‹','æ³•åº­æ”»é˜²','è­¦åŒªå°æ±º','é–“è«œè«œæˆ°','çŠ¯ç½ªå¿ƒç†','å†·æ¡ˆé‡å•Ÿ','å¾©ä»‡è¨ˆç•«','å®Œç¾çŠ¯ç½ª',
        // æ­·å²é¡
        'æ­·å²å‚³å¥‡','å®®å»·é¬¥çˆ­','æˆ°åœ‹é¢¨é›²','ä¸‰åœ‹æ¼”ç¾©','æ°‘åœ‹é¢¨è¯','å¤ä»£å•†æˆ°','æ±Ÿæ¹–æ©æ€¨','å¸ç‹å°‡ç›¸','äº‚ä¸–è‹±é›„','æ­·å²ç©¿è¶Š',
        // ææ€–é©šæ‚šé¡
        'ææ€–é©šæ‚š','å¿ƒç†ææ€–','éˆç•°é¬¼æ€ª','å…‹è˜‡é­¯ç¥è©±','éƒ½å¸‚æ€ªè«‡','è©›å’’å‚³èªª','é¬¼å±‹æ¢éšª','æœ«æ—¥ç”Ÿå­˜','å–ªå±å±æ©Ÿ','é‚ªæ•™å„€å¼',
        // æ­¦ä¿ ä»™ä¿ é¡
        'å¤è£æ­¦ä¿ ','ä»™ä¿ ä¿®çœŸ','ç„å¹»ä¿®çœŸ','æ±Ÿæ¹–ä¿ å®¢','é–€æ´¾çˆ­é¬¥','åŠèˆ‡æƒ…ä»‡','é£›å‡æˆä»™','å¦–é­”é¬¼æ€ª','é“æ³•è‡ªç„¶','æ­¦æ—è‡³å°Š',
        // ç¾ä»£é¡
        'ç¾ä»£éƒ½å¸‚','è·å ´é¢¨é›²','å¨›æ¨‚åœˆ','é«”è‚²ç«¶æŠ€','é›»ç«¶ç†±è¡€','å‰µæ¥­å¥®é¬¥','æ ¡åœ’é’æ˜¥','å®¶åº­å€«ç†','ç¤¾æœƒå¯«å¯¦','ç¶²ç´…ç”Ÿæ´»',
        // å…¶ä»–é¡å‹
        'è»äº‹æˆ°çˆ­','æµ·æ´‹å†’éšª','è¥¿éƒ¨æ‹“è’','åŒ—æ­ç¶­äº¬','æ¢éšªå°‹å¯¶','å‹•ç‰©è¦–è§’','ç¾é£Ÿæ–™ç†','é†«ç™‚è·äºº','æ³•å¾‹æ­£ç¾©','éŸ³æ¨‚å¤¢æƒ³',
        // ç‰¹æ®Šé¡Œæ
        'æœ«ä¸–å»¢åœŸ','ç•°èƒ½è¦ºé†’','ç³»çµ±æµ','ç„¡é™æµ','å‰¯æœ¬éŠæˆ²','ç›´æ’­æ±‚ç”Ÿ','è¦å‰‡æ€ªè«‡','è©­ç•°éŠæˆ²','éˆæ°£å¾©ç”¦','è«¸å¤©è¬ç•Œ'
      ];
      
      const settingsData = [
        // å¥‡å¹»ä¸–ç•Œ
        'è™›æ§‹çš„ä¸­ä¸–ç´€ç‹åœ‹','ç²¾éˆæ—çš„æ£®æ—åœ‹åº¦','çŸ®äººçš„åœ°åº•åŸå¸‚','é¾æ—ç›¤æ“šçš„ç«å±±å³¶','é­”æ³•å¸«çš„æµ®ç©ºå¡”','è¢«è©›å’’çš„é»‘æš—æ£®æ—','ç¥è–çš„å…‰æ˜ç¥æ®¿','äº¡éˆæ©«è¡Œçš„è’åŸ','æµ·å¦–å‡ºæ²’çš„ç¥ç§˜æµ·åŸŸ','éš±è—åœ¨è¿·éœ§ä¸­çš„ä»™å¢ƒ',
        // ç§‘å¹»ä¸–ç•Œ
        '21ä¸–ç´€çš„è‡ºç£éƒ½å¸‚','é™é çš„å¤ªç©ºæ®–æ°‘åœ°','è™›æ“¬å¯¦å¢ƒä¸–ç•Œ','è¿‘æœªä¾†çš„é«˜ç§‘æŠ€åŸå¸‚','ç¹è¯çš„éŠ€æ²³å•†å ´','å®‡å®™æˆ°è‰¦ä¸Š','ç«æ˜Ÿæ®–æ°‘åŸºåœ°','æµ·åº•éƒ½å¸‚äºç‰¹è˜­ææ–¯','è³½åšé¾å…‹çš„éœ“è™¹éƒ½å¸‚','äººå·¥æ™ºæ…§çµ±æ²»çš„åŸå¸‚',
        // æ­·å²å ´æ™¯
        'å¤ä»£çš‡å®®','æ˜æœå®®å»·','å”æœé•·å®‰åŸ','å®‹ä»£ç¹è¯æ±´äº¬','æˆ°åœ‹æ™‚ä»£çš„åŸå ¡','ä¸‰åœ‹æ™‚æœŸçš„æˆ°å ´','æ¸…æœç´«ç¦åŸ','æ°‘åœ‹æ™‚æœŸçš„ä¸Šæµ·ç˜','å¤ç¾…é¦¬ç«¶æŠ€å ´','åŸƒåŠæ³•è€ç‹å®®',
        // ç¾ä»£å ´æ™¯
        'ç¹è¯çš„ç¾ä»£å¤§éƒ½æœƒ','å¯§éœçš„é„‰æ‘å°é®','ç¥ç§˜çš„ç§ç«‹å­¸æ ¡','é ‚ç´šçš„è·¨åœ‹ä¼æ¥­','ç†±é¬§çš„å¤œå¸‚è¡—é“','é«˜ç´šçš„ç™¾è²¨å•†å ´','é™°æš—çš„åœ°ä¸‹é»‘å¸‚','è±ªè¯çš„åº¦å‡å‹åœ°','å¿™ç¢Œçš„é†«é™¢','åš´è‚…çš„æ³•é™¢',
        // ç‰¹æ®Šå ´æ™¯
        'æœ«æ—¥å¾Œçš„è’åœŸ','é­”æ³•å­¸é™¢','è’¸æ±½é¾å…‹åŸå¸‚','æ·±æµ·ç‹åœ‹','éš±è—æ–¼é›²ç«¯çš„åŸå ¡','å¤è€çš„å±±æ—æ‘è½','é›ªå±±ä¸Šçš„ä¿®é“é™¢','ç†±å¸¶é›¨æ—æ·±è™•','å·¨å‹è¿·å®®éƒ½å¸‚','æ®–æ°‘æµ·ç›œèˆ¹',
        // ç•°ä¸–ç•Œ
        'å¹³è¡Œå®‡å®™','ç•°æ¬¡å…ƒç©ºé–“','å¤¢å¢ƒä¸–ç•Œ','éˆç•Œèˆ‡å†¥åºœ','å¤©ç•Œèˆ‡ä»™å¢ƒ','åœ°ç„æ·±æ·µ','æ™‚é–“è£‚ç¸«ä¹‹ä¸­','é‡å­ç–ŠåŠ çš„ä¸–ç•Œ','éŠæˆ²å‰¯æœ¬ç©ºé–“','è«¸ç¥çš„é ˜åŸŸ',
        // æ—¥å¸¸å ´æ™¯
        'æº«é¦¨çš„å’–å•¡å»³','è€èˆŠçš„æ›¸åº—','ç¥ç§˜çš„å¤è‘£åº—','ç†±é¬§çš„éŠæ¨‚åœ’','å®‰éœçš„åœ–æ›¸é¤¨','æ··äº‚çš„æ¼”å”±æœƒç¾å ´','ç·Šå¼µçš„è€ƒè©¦ç¾å ´','æµªæ¼«çš„æµ·é‚Š','å£¯éº—çš„å±±é ‚','å¯§éœçš„å¯ºå»Ÿ',
        // ç‰¹æ®Šç’°å¢ƒ
        'èˆ‡ä¸–éš”çµ•çš„å­¤å³¶','æ°¸å¤œçš„æ¥µåœ°','æ²™æ¼ ä¸­çš„ç¶ æ´²','æ¼‚æµ®åœ¨ç©ºä¸­çš„å³¶å¶¼','åœ°ä¸‹æ·±è™•çš„æ´ç©´','æ´»ç«å±±å£','å†°å°çš„å¤åŸ','è¢«éºå¿˜çš„å¤æ–‡æ˜éºè·¡','ç•°å½¢èŸ²å·¢','æ©Ÿæ¢°æ˜Ÿçƒ'
      ];
      
      const stylesArr = [
        // æƒ…æ„ŸåŸºèª¿
        'è©©æ„','å¹½é»˜','é»‘æš—','å‹µå¿—','æµªæ¼«','æº«é¦¨','æ‚²å‚·','ç†±è¡€','å†·é…·','æº«æŸ”',
        // æ•˜äº‹é¢¨æ ¼
        'æ‡¸ç–‘','åˆºæ¿€','è¼•é¬†','ç·Šå¼µ','å²è©©','ç´°è†©','ç²—ç·','è¯éº—','ç°¡ç´„','å¯«å¯¦',
        // æ–‡å­¸é¢¨æ ¼
        'å¤å…¸è¯éº—','è’èª•','ç¾å¯¦ä¸»ç¾©','é­”å¹»ç¾å¯¦','æ„è­˜æµ','é»‘è‰²å¹½é»˜','è«·åˆº','æ‰¹åˆ¤','å“²ç†','æŠ’æƒ…',
        // æ°›åœé¢¨æ ¼
        'å¿ƒç†é©šæ‚š','é™°é¬±å£“æŠ‘','æ˜äº®æ­¡å¿«','ç¥ç§˜è©­ç•°','èŠåš´è‚…ç©†','ä¿çš®å¯æ„›','æˆç†Ÿç©©é‡','é’æ˜¥æ´»åŠ›','è’¼æ¶¼æ‚²å£¯','å¤¢å¹»è¿·é›¢',
        // ç¯€å¥é¢¨æ ¼
        'å¿«ç¯€å¥','æ…¢ç†±','è·Œå®•èµ·ä¼','å¹³é‹ªç›´æ•˜','å€’æ•˜æ’æ•˜','å¤šç·šä¸¦é€²','å–®ç·šæ·±å…¥','ç¾¤åƒæå¯«','ç¬¬ä¸€äººç¨±','å…¨çŸ¥è¦–è§’',
        // ç‰¹è‰²é¢¨æ ¼
        'è¼•å°èªªé¢¨','ç¶²æ–‡çˆ½æ–‡','æ–‡è—æ¸…æ–°','ç¡¬æ ¸å¯«å¯¦','è»Ÿç§‘å¹»','ç¡¬ç§‘å¹»','æ–°æ­¦ä¿ ','å¤è¨€','ç¾è¨€','ç”œå¯µ'
      ];
      const chapterOpts = [5, 8, 10, 12, 15];
      const lengthOpts = [30000, 50000, 70000, 90000];

      const nameOptions = ['è‰¾ç³','æ´›æ©','å‡±äº','ç±³çˆ¾','å¸­æ©','è–‡æ‹‰','ç¥ˆå®‰','æœæ—','å¸Œçˆ¾ç¶­','èŠé›…','ä¼Šå‡¡','æ³•è˜­','æ ¼è˜­','æ¢…èŠ™','å®‰å¨œ','é›·æ ¼','ç´¢è²','è‰¾ç•¥ç‰¹','äºæ­·å…‹','è«å¦®å¡','è·¯è¥¿','ä¼ŠèŠ™','åŠ ç™¾åˆ—','äºç•¶','ç‘ªé›…','è‰¾å¾·','è–©æ‹‰','æ°ç™»','çªæ‹‰','å¾·ç‘å…‹','å‡±ç‘Ÿç³','é¦¬ä¸','ç¾…çµ²','å¥§åˆ©ç¶­','æ˜†æ±€','å“ˆè‰','ä¼¯ç´å¾·','æµ·å€«','ä¸¹å°¼çˆ¾','é›·åˆ‡çˆ¾','å±±å§†','è‰¾è–‡','è«¾äº','è‰¾ç±³è‰','å¸ƒèŠæ©','è‰¾èœœè‰äº','é”ç±³å®‰','éœ²è¥¿äº','ç±³è˜­é”','äºæ­·å±±å¤§','æ³¢ç³å¨œ','äº¨åˆ©','è˜‡è²äº','è²»å—å¤š','å…‹èŠå…’','åŸƒå¾·åŠ ','æ­æ–‡','è‰äº','æŸ¥çˆ¾æ–¯','å“ˆå¨œ','æ°å…‹','ç‘ªè’‚çˆ¾é”','æ‰˜å°¼','å¨œå¡”è‰','é”ç‘æ–¯','å…‹é‡Œæ–¯','è‰¾ç‘ª','ç¾…ä¼¯ç‰¹','å‡±ç‰¹','æ ¼è•¾çµ²','è«é‡Œæ–¯','æ™®æ‹‰å¤š','å‹æ‹‰','ç¶­å…‹å¤š','å‡±è‰','è²åˆ©æ™®','ç‘ç§‹','å²è’‚å¤«','ç¾…ä¼Š','å“ˆå¾·æ£®','å¦®å¯','å…‹éº—çµ²æ±€','èŠæ˜‚','æ¢…æ ¹','æœè˜­','é¦¬é›…','è˜­æ–¯æ´›ç‰¹','å¡ç¾…çˆ¾','ä¼Šéº—èç™½','ä¼Šè–©è²æ‹‰','è€ƒç‰¹å°¼','è”£ç´','å”å¨œ','å¡å¾·é‡Œå…‹','å¸ƒè˜­å¦®','é›·è’™','å‡±è–©ç³','é˜¿èŠå…‹æ–¯','åŠ å¸ƒé‡ŒåŸƒæ‹‰','è¥¿è’™'];
      
      // ç”·æ€§åå­—
      const maleNames = ['æ´›æ©','ç±³çˆ¾','å¸­æ©','ç¥ˆå®‰','æœæ—','ä¼Šå‡¡','æ³•è˜­','æ ¼è˜­','é›·æ ¼','è‰¾ç•¥ç‰¹','äºæ­·å…‹','åŠ ç™¾åˆ—','äºç•¶','è‰¾å¾·','æ°ç™»','å¾·ç‘å…‹','é¦¬ä¸','å¥§åˆ©ç¶­','æ˜†æ±€','ä¼¯ç´å¾·','ä¸¹å°¼çˆ¾','å±±å§†','è«¾äº','å¸ƒèŠæ©','é”ç±³å®‰','äºæ­·å±±å¤§','äº¨åˆ©','è²»å—å¤š','åŸƒå¾·åŠ ','æ­æ–‡','æŸ¥çˆ¾æ–¯','æ°å…‹','æ‰˜å°¼','é”ç‘æ–¯','å…‹é‡Œæ–¯','ç¾…ä¼¯ç‰¹','è«é‡Œæ–¯','æ™®æ‹‰å¤š','ç¶­å…‹å¤š','è²åˆ©æ™®','å²è’‚å¤«','ç¾…ä¼Š','å“ˆå¾·æ£®','èŠæ˜‚','æœè˜­','è˜­æ–¯æ´›ç‰¹','å¡å¾·é‡Œå…‹','é›·è’™','é˜¿èŠå…‹æ–¯','è¥¿è’™','å¨å»‰','è©¹å§†æ–¯','éº¥å…‹','å¤§è¡›','ç´„ç‘Ÿå¤«','ç†æŸ¥','æ¹¯ç‘ªæ–¯','å®‰å¾·é­¯','ä¹”æ²»','è‰¾å€«','å‡±æ–‡','ä¹”ç´æ£®','ä¹”èˆ’äº','èŠæ©','å°¼å¤æ‹‰æ–¯','è´¾æ–¯æ±€','å¸ƒå…°ç™»','æ³°å‹’','äºšä¼¦','æ°ç‘ç±³','è‚–æ©','å¾·é‡Œå…‹','é©¬ä¿®','ä¿ç½—','å¡å°”','æ–‡æ£®ç‰¹'];
      
      // å¥³æ€§åå­—
      const femaleNames = ['è‰¾ç³','å‡±äº','è–‡æ‹‰','å¸Œçˆ¾ç¶­','èŠé›…','æ¢…èŠ™','å®‰å¨œ','ç´¢è²','è«å¦®å¡','è·¯è¥¿','ä¼ŠèŠ™','ç‘ªé›…','è–©æ‹‰','çªæ‹‰','å‡±ç‘Ÿç³','ç¾…çµ²','å“ˆè‰','æµ·å€«','é›·åˆ‡çˆ¾','è‰¾è–‡','è‰¾ç±³è‰','è‰¾èœœè‰äº','éœ²è¥¿äº','ç±³è˜­é”','æ³¢ç³å¨œ','è˜‡è²äº','å…‹èŠå…’','è‰äº','å“ˆå¨œ','ç‘ªè’‚çˆ¾é”','å¨œå¡”è‰','è‰¾ç‘ª','å‡±ç‰¹','æ ¼è•¾çµ²','å‹æ‹‰','å‡±è‰','ç‘ç§‹','å¦®å¯','å…‹éº—çµ²æ±€','æ¢…æ ¹','é¦¬é›…','å¡ç¾…çˆ¾','ä¼Šéº—èç™½','ä¼Šè–©è²æ‹‰','è€ƒç‰¹å°¼','è”£ç´','å”å¨œ','å¸ƒè˜­å¦®','å‡±è–©ç³','åŠ å¸ƒé‡ŒåŸƒæ‹‰','è‰¾è‰çµ²','ç¶­å¤šåˆ©äº','å¥§è‰ç¶­äº','å¤æ´›ç‰¹','é˜¿æ›¼é”','æ½”è¥¿å¡','çå¦®ä½›','èœœé›ªå…’','å¦®å¨œ','å…‹è˜¿ä¼Š','èæ›¼çŠ','é»›å®‰å¨œ','å‡±è’‚','è‰¾è‰æ£®','å¸ƒéº—å§¬ç‰¹','è«å¦®å…‹','å®‰çªæ‹‰','å²é»›è¥¿','å¦é›…','è˜¿æ‹‰','æ½˜ä¹ƒæ‹‰'];
      // ========== å€‹æ€§é¸é …ï¼ˆåˆ†é¡æ•´ç†ï¼‰==========
      const personalityOptions = [
        // ã€æ­£é¢ç‰¹è³ªã€‘
        'å¤–å†·å…§ç†±','æ¨‚è§€é–‹æœ—','å–„è‰¯å–®ç´”','æº«æŸ”é«”è²¼','å‹‡æ•¢ç„¡ç•','æ­£ç¾©æ„Ÿå¼·','å¹½é»˜é¢¨è¶£','è¬™è™›ä½èª¿',
        'æ©Ÿæ™ºéˆæ´»','å–„è§£äººæ„','ç†±æƒ…å‹å–„','çœŸèª å¦ç‡','å …æ¯…ä¸å±ˆ','å¯Œæœ‰å‰µæ„','æ¨‚æ–¼åŠ©äºº','å°ˆæ³¨åŸ·è‘—',
        'éš¨å’ŒåŒ…å®¹','ç´°å¿ƒé«”è²¼','ç¨ç«‹è‡ªä¸»','è²¬ä»»æ„Ÿå¼·','é ˜å°é­…åŠ›','ç©æ¥µé€²å–','å¿ƒæ€ç¸å¯†','æ²‰ç©©å¯é ',
        // ã€è¤‡é›œç‰¹è³ªã€‘
        'å¤–å‘ä½†å…§å¿ƒå­¤ç¨','è‡ªå‘ä½†å˜´ç¡¬','å†·éœä½†ååŸ·','æº«æŸ”å»ä¸è¼•ä¿¡','å …éŸŒè€Œæ²‰é»˜','æ‡¶æ•£å»å¤©æ‰',
        'ç¾©æ°£ä½†å›ºåŸ·','æ€¥èºä½†å¿ƒå–„','ç©ä¸–ä¸æ­ä½†é‡æƒ…','è¡¨é¢é–‹æœ—å…§å¿ƒé™°æš—','çœ‹ä¼¼å†·æ¼ å¯¦å‰‡æ·±æƒ…',
        'å‚²å¬Œ','ç—…å¬Œ','å¤©ç„¶å‘†','ä¸‰ç„¡å°‘å¥³/å°‘å¹´','ä¸­äºŒç—…','è…¹é»‘','æ¯’èˆŒ','å‚²æ…¢ä½†æœ‰å¯¦åŠ›',
        // ã€è² é¢ç‰¹è³ªã€‘
        'å†·é…·ç„¡æƒ…','å¤šç–‘è¬¹æ…','å­¤åƒ»æ²‰é»˜','å„ªæŸ”å¯¡æ–·','è¡å‹•æ˜“æ€’','è‡ªç§è‡ªåˆ©','å¿ƒç‹ æ‰‹è¾£','é™°æ™´ä¸å®š',
        'å«‰å¦’å¿ƒå¼·','æ§åˆ¶æ¬²å¼·','æ‚²è§€å­ä¸–','è‡ªè² å‚²æ…¢','åè¦†ç„¡å¸¸','è™›å½åšä½œ','å ±å¾©å¿ƒé‡','ååŸ·ç‹‚',
        // ã€ç‰¹æ®Šæ€§æ ¼ã€‘
        'é›™é‡äººæ ¼','è§£é›¢æ€§æ ¼','ç¤¾æä½†ç¶²è·¯ç¤¾ç‰›','é¢ç™±å¿ƒç†±','è©±ç™†','æ²‰é»˜å¯¡è¨€','ç˜‹æ‰¹ç¾äºº','æ¸…å†·ç¦æ¬²',
        'ç‹¼ç‹—å‹','å¥¶ç‹—å‹','å¤§å‹çŠ¬æ€§æ ¼','è²“ç³»æ€§æ ¼','ç‹ç‹¸æ€§æ ¼','é‡æ€§ä¸ç¾ˆ','æ›¸å·æ°£','æ±Ÿæ¹–æ°£',
        'ä»™æ°£é£„é£„','é‚ªé­…ç‹‚ç‹·','æ†‚é¬±è©©äºº','æˆ°é¬¥ç‹‚äºº','å’Œå¹³ä¸»ç¾©è€…','å®Œç¾ä¸»ç¾©','è™›ç„¡ä¸»ç¾©','ç†æƒ³ä¸»ç¾©'
      ];

      // ========== ç›®æ¨™é¸é …ï¼ˆå¤§å¹…æ“´å……ï¼‰==========
      const goalOptions = [
        // ã€å¾©ä»‡/æ¸…ç®—é¡ã€‘
        'ç‚ºå®¶äººå ±ä»‡','ç‚ºå¸«é–€å¾©ä»‡','ç‚ºæ•…é„‰å¾©ä»‡','ç‚ºæ„›äººå¾©ä»‡','æ¨ç¿»æš´æ”¿','æ¸…ç®—èˆŠå¸³','æ´—åˆ·å†¤å±ˆ','è¨å›å…¬é“',
        'æ®ºæ­»ä»‡äºº','æ¯€æ»…æ•µå°å‹¢åŠ›','è®“èƒŒå›è€…ä»˜å‡ºä»£åƒ¹','å‘æ•´å€‹ä¸–ç•Œå¾©ä»‡','ç‚ºå‰ä¸–å¾©ä»‡','è¿½æ®ºé€ƒäº¡çš„å…‡æ‰‹',
        // ã€å°‹æ‰¾/æ¢ç´¢é¡ã€‘
        'å°‹æ‰¾å¤±è¹¤çš„è¦ªäºº','å°‹æ‰¾çœŸæ­£çš„èº«ä¸–','å°‹æ‰¾å‚³èªªä¸­çš„å¯¶è—','å°‹æ‰¾é•·ç”Ÿä¸è€çš„ç§˜å¯†','å°‹æ‰¾æ²»ç—…çš„éˆè—¥',
        'å°‹æ‰¾å¤±è½çš„æ–‡æ˜','å°‹æ‰¾é€šå¾€ç•°ä¸–ç•Œçš„é–€','å°‹æ‰¾å‰ä¸–çš„è¨˜æ†¶','å°‹æ‰¾ç¥å™¨ç¢ç‰‡','å°‹æ‰¾é è¨€ä¸­çš„æ•‘ä¸–ä¸»',
        'æ¢ç´¢æœªçŸ¥å¤§é™¸','æ¢ç´¢æ·±æµ·éºè·¡','æ¢ç´¢æ˜Ÿéš›','æ¢ç´¢å¤¢å¢ƒä¸–ç•Œ','æ¢ç´¢æ™‚é–“ç¸«éš™','è§£é–‹å¤è€è¬é¡Œ',
        // ã€æ‹¯æ•‘/ä¿è­·é¡ã€‘
        'æ‹¯æ•‘ä¸–ç•Œ','æ‹¯æ•‘è¢«å›°çš„æ„›äºº','æ‹¯æ•‘ç€•è‡¨æ»…çµ•çš„ç¨®æ—','ä¿è­·æ•…é„‰','ä¿è­·æœ€å¾Œçš„å¸Œæœ›','å®ˆè­·é‡è¦ä¹‹äºº',
        'é˜»æ­¢æœ«æ—¥','é˜»æ­¢ç˜Ÿç–«è”“å»¶','é˜»æ­¢æˆ°çˆ­','é˜»æ­¢é»‘æš—å„€å¼','é˜»æ­¢æ™‚ç©ºå´©å¡Œ','é˜»æ­¢äººå·¥æ™ºèƒ½æš´èµ°',
        'æ²»ç™’è¢«è©›å’’çš„äºº','è§£é™¤å°å°','æ‰“ç ´çµç•Œ','æ¶ˆæ»…é‚ªæƒ¡çµ„ç¹”','æ·¨åŒ–æ±¡æŸ“ä¹‹åœ°',
        // ã€æˆé•·/è¶…è¶Šé¡ã€‘
        'æˆç‚ºæœ€å¼·è€…','æˆç‚ºä¸€ä»£å®—å¸«','çªç ´ä¿®ç‚ºç“¶é ¸','ç²å¾—ç¥çš„èªå¯','è¶…è¶Šå‰äºº','è­‰æ˜è‡ªå·±çš„åƒ¹å€¼',
        'æ‰“æ•—å®¿æ•µ','æˆ°å‹å¿ƒé­”','å…‹æœéå»çš„å‰µå‚·','æ“ºè„«å‘½é‹æŸç¸›','æ‰“ç ´éšç´šé™åˆ¶','æ¨ç¿»ä¸å…¬çš„åˆ¶åº¦',
        'å¯¦ç¾ç§‘å­¸çªç ´','å‰µé€ æ–°çš„é­”æ³•é«”ç³»','é–‹å‰µæ–°çš„æ™‚ä»£','ç•™åé’å²',
        // ã€å»ºè¨­/çµ±æ²»é¡ã€‘
        'å»ºç«‹ç†æƒ³åœ‹åº¦','çµ±ä¸€å¤©ä¸‹','é‡å»ºå®¶åœ’','å¾©èˆˆå®¶æ—','å»ºç«‹å•†æ¥­å¸åœ‹','å‰µå»ºé–€æ´¾','åŸ¹é¤Šæ¥ç­äºº',
        'æ”¹è®Šä¸–ç•Œç§©åº','æ¨è¡Œæ–°çš„åˆ¶åº¦','å»ºé€ é€šå¤©å¡”','é–‹é—¢æ–°ä¸–ç•Œ','æ®–æ°‘å¤–æ˜Ÿ','å»ºç«‹AIçƒæ‰˜é‚¦',
        // ã€æƒ…æ„Ÿ/å€‹äººé¡ã€‘
        'æ‰¾åˆ°çœŸæ„›','èˆ‡å¤±æ•£çš„æ„›äººé‡é€¢','è¿½æ±‚è‡ªç”±','å°‹æ±‚å…§å¿ƒå¹³éœ','è´–ç½ª','å®Œæˆè‡¨çµ‚éºé¡˜',
        'é«”é©—äººé–“ç™¾æ…‹','æ´»å‡ºçœŸæ­£çš„è‡ªå·±','æ‰¾åˆ°äººç”Ÿæ„ç¾©','ç•™ä¸‹å‚³ä¸–ä¹‹ä½œ','å¹³å‡¡åº¦éä¸€ç”Ÿ',
        // ã€è™›æ“¬/ç¾ä»£é¡ã€‘
        'æˆç‚ºé›»ç«¶å† è»','æˆç‚ºé ‚æµå¶åƒ','å‰µæ¥­æˆåŠŸ','è²¡å‹™è‡ªç”±','ç§»æ°‘ç«æ˜Ÿ','é€²å…¥è™›æ“¬ä¸–ç•Œ',
        'ç ´è§£ç³»çµ±æ¼æ´','æˆç‚ºé»‘å®¢ä¹‹ç‹','æ§åˆ¶å…¨çƒç¶²çµ¡','ç²å¾—è¶…èƒ½åŠ›','å®ŒæˆåŸºå› é€²åŒ–','ä¸Šå‚³æ„è­˜æ°¸ç”Ÿ',
        // ã€å¥‡å¹»/ç‰¹æ®Šé¡ã€‘
        'æ”¶é›†ä¸ƒé¾ç ','é›†é½Šç„¡é™å¯¶çŸ³','æˆç‚ºé­”ç‹','æ¨ç¿»ç¥ç•Œ','èˆ‡é¾çµå¥‘','ç²å¾—ç³»çµ±èªå¯',
        'å®Œæˆä¸»ç¥ä»»å‹™','é€ƒé›¢ç„¡é™æµä¸–ç•Œ','æ”»ç•¥æ‰€æœ‰è§’è‰²','æ”¹å¯«åŠ‡æœ¬','æˆç‚ºç©¿æ›¸å¤§ä½¬','è®“åæ´¾æ´—ç™½'
      ];

      // ========== å¼±é»é¸é …ï¼ˆå¤§å¹…æ“´å……ï¼‰==========
      const weaknessOptions = [
        // ã€ç”Ÿç†å¼±é»ã€‘
        'é«”åŠ›æ¥µå·®','è¦–åŠ›ä¸ä½³','è½åŠ›å—æ','å‘³è¦ºé²éˆ','å®¹æ˜“ç”Ÿç—…','æ…¢æ€§ç—…çºèº«','ä½è¡€ç³–','è²§è¡€',
        'å¤±çœ ç—‡','å—œç¡ç—‡','éæ•é«”è³ª','å°é™½å…‰éæ•','å°æŸç¨®å…ƒç´ éæ•','èº«é«”æœ‰èˆŠå‚·','æ®˜ç–¾','æ¯’ç´ ç´¯ç©',
        'å£½å‘½å°‡ç›¡','æ¯æ—¥éœ€æœè—¥','èº«é«”è¢«å°å°','åŠ›é‡æœƒæš´èµ°','ä½¿ç”¨èƒ½åŠ›æœƒæŠ˜å£½',
        // ã€å¿ƒç†å¼±é»ã€‘
        'æé«˜','ææ°´','æé»‘','æç«','å¹½é–‰ææ‡¼','ç¤¾äº¤ææ‡¼','å¯†é›†ææ‡¼','æ€•è›‡','æ€•èŸ²','æ€•é¬¼',
        'æ€•è¡€','æ€•é†«é™¢','æ€•æ‰“é‡','æ€•æ­»äº¡','æ€•è¢«æ‹‹æ£„','æ€•å­¤ç¨','æ€•å¤±æ•—','æ€•è¦ªå¯†é—œä¿‚',
        'å‰µå‚·å¾Œéºç—‡','ç«¥å¹´é™°å½±','å™©å¤¢çºèº«','è½åˆ°ç‰¹å®šè²éŸ³æœƒå´©æ½°','çœ‹åˆ°ç‰¹å®šå ´æ™¯æœƒå¤±æ§',
        // ã€æ€§æ ¼å¼±é»ã€‘
        'éæ–¼å–„è‰¯','éæ–¼å¿ƒè»Ÿ','éæ–¼ä¿¡ä»»ä»–äºº','ç„¡æ³•æ‹’çµ•è«‹æ±‚','å„ªæŸ”å¯¡æ–·','è¡å‹•æ˜“æ€’','ä¸‰åˆ†é˜ç†±åº¦',
        'æ‹–å»¶ç—‡','å®Œç¾ä¸»ç¾©','å¼·è¿«ç—‡','æ§åˆ¶æ¬²éå¼·','å«‰å¦’å¿ƒé‡','å ±å¾©å¿ƒå¼·','å¤ªåœ¨æ„ä»–äººçœ‹æ³•',
        'éåº¦è‡ªè²¬','è‡ªå‘','è‡ªè² ','å›ºåŸ·å·±è¦‹','ä¸æœƒè®Šé€š','æƒ…ç·’åŒ–','å®¹æ˜“è¢«æ¿€æ€’','æ„›é€å¼·',
        // ã€èƒ½åŠ›å¼±é»ã€‘
        'ä¸æ“…é•·è¬Šè¨€','è·¯ç—´','è‡‰ç›²','æ‰‹æ®˜','å»šè—ç½é›£','äº”éŸ³ä¸å…¨','æ•¸å­¸ç™½ç—´','ç§‘æŠ€è‹¦æ‰‹',
        'ä¸æœƒæ¸¸æ³³','ä¸æœƒé¨è»Š','ææ©Ÿ','æšˆè»Šæšˆèˆ¹','ä¸æ“…ç¤¾äº¤','ä¸æœƒç†è²¡','å¥å¿˜','æ³¨æ„åŠ›ç¼ºå¤±',
        // ã€è¨­å®šå¼±é»ã€‘
        'ç‰¹å®šå’’èªæœƒå¤±æ•ˆ','æ»¿æœˆæœƒå¤±æ§','è¦‹åˆ°åå­—æ¶æœƒè™›å¼±','ç„¡æ³•é€²å…¥è–åœ°','è¢«ç‰¹å®šæè³ªæ‰€å‚·æœƒè‡´å‘½',
        'çœŸåè¢«çŸ¥é“æœƒè¢«æ§åˆ¶','å¼±é»åœ¨å¿ƒè‡Ÿéƒ¨ä½','éœ€è¦å®šæœŸå¸å–èƒ½é‡','é›¢é–‹æ°´æºæœƒè™›å¼±','ä¸èƒ½è¦‹å…‰',
        'åŠ›é‡ä¾†æºæœƒè¢«å‰å¥ª','å¥‘ç´„æœ‰è‡´å‘½æ¢æ¬¾','ä½¿ç”¨èƒ½åŠ›æœƒå–ªå¤±è¨˜æ†¶','æ¯æ¬¡é‡ç”Ÿæœƒä¸Ÿå¤±ä¸€æ®µè¨˜æ†¶',
        // ã€æƒ…æ„Ÿå¼±é»ã€‘
        'åŸ·è‘—æ–¼éå»','ç„¡æ³•æ”¾ä¸‹ä»‡æ¨','å°ç‰¹å®šäººç‰©è¨€è½è¨ˆå¾','å®¹æ˜“è¢«ç¾è‰²è¿·æƒ‘','è¦‹ä¸å¾—åˆ¥äººå—è‹¦',
        'æœƒç‚ºé‡è¦ä¹‹äººä¸é¡§ä¸€åˆ‡','ç„¡æ³•å°å­©å­ä¸‹æ‰‹','è½ä¸å¾—è¦ªäººè¢«ä¾®è¾±','å°æ•…é„‰æœ‰åŸ·å¿µ','æœƒè¢«çœŸå¿ƒè©±æ‰“å‹•',
        // ã€ç¾ä»£/ç¾å¯¦å¼±é»ã€‘
        'ç¶²è·¯æˆç™®','æ‰‹æ©Ÿä¾è³´ç—‡','å’–å•¡å› ä¸Šç™®','ç¤¾ç¾¤åª’é«”ç„¦æ…®','é¸æ“‡å›°é›£ç—‡','è³¼ç‰©ç‹‚','å›¤ç©ç—‡',
        'å·¥ä½œç‹‚','éå‹é«”è³ª','ç„¡æ³•è™•ç†äººéš›é—œä¿‚','æƒ…å•†ä½','ä¸æœƒçœ‹æ°£æ°›','èªªè©±ç›´æ¥æ˜“å¾—ç½ªäºº'
      ];

      // ========== ç§˜å¯†é¸é …ï¼ˆå¤§å¹…æ“´å……ï¼‰==========
      const secretOptions = [
        // ã€èº«ä»½ç§˜å¯†ã€‘
        'çœŸå¯¦èº«ä»½æ˜¯ç‹æ—','çœŸå¯¦èº«ä»½æ˜¯é­”ç‹','çœŸå¯¦èº«ä»½æ˜¯ç¥çš„å­©å­','æ˜¯å¤±è½å¸åœ‹çš„ç¹¼æ‰¿äºº','æ˜¯é è¨€ä¹‹å­',
        'æ˜¯è‡¥åº•é–“è«œ','æ˜¯é›™é¢é–“è«œ','æ˜¯é€ƒäº¡çš„é€šç·çŠ¯','æ˜¯æ”¹é ­æ›é¢çš„å¾©ä»‡è€…','æ˜¯éš±å±…çš„çµ•ä¸–é«˜æ‰‹',
        'æ˜¯ç©¿è¶Šè€…','æ˜¯é‡ç”Ÿè€…','æ˜¯ç³»çµ±å®¿ä¸»','æ˜¯ç©å®¶','æ˜¯æ›¸ä¸­è§’è‰²è¦ºé†’äº†','æ˜¯AIè¦ºé†’é«”',
        'æ˜¯å…‹éš†äºº','æ˜¯äººé€ äºº','æ˜¯æ©Ÿå™¨äºº','æ˜¯å¤–æ˜Ÿäºº','æ˜¯å¦–æ€ªè®Šçš„','æ˜¯ç¥ç¸åŒ–å½¢','æ˜¯å¸è¡€é¬¼',
        'å…¶å¯¦æ˜¯å¦ä¸€å€‹æ€§åˆ¥','æœ‰é›™é‡äººæ ¼','å…¶å¯¦å·²ç¶“æ­»äº†åªæ˜¯ä¸çŸ¥é“',
        // ã€è¡€çµ±ç§˜å¯†ã€‘
        'é«”å…§æœ‰é¾æ—è¡€è„ˆ','é«”å…§å°å°è‘—é‚ªç¥','é«”å…§æœ‰é å¤ç¥ç¸','èˆ‡é­”æ—æœ‰è¡€ç·£','æ˜¯ç¥èˆ‡äººçš„æ··è¡€',
        'æ˜¯ç¦å¿Œä¹‹æˆ€çš„ç”¢ç‰©','æ˜¯å¯¦é©—é«”','è¡€æ¶²æœ‰ç‰¹æ®Šèƒ½åŠ›','è¡€çµ±è¢«è©›å’’','æ˜¯æœ€å¾Œä¸€å€‹ç´”è¡€',
        // ã€éå»ç§˜å¯†ã€‘
        'æ›¾ç¶“æ®ºéäºº','æ›¾ç¶“æ¯€æ»…éä¸€å€‹åŸå¸‚','æ›¾ç¶“èƒŒå›éæ‘¯å‹','æ›¾ç¶“æ˜¯åæ´¾','æ›¾ç¶“æ˜¯é‚ªæ•™æˆå“¡',
        'æ›¾èˆ‡æƒ¡é­”ç°½ç´„','æ›¾åœ¨åœ°ç„å¾…é','æ›¾ç¶“æ­·éç„¡æ•¸è¼ªè¿´','æ›¾ç¶“å¤±å»éè¨˜æ†¶','éå»æ˜¯æ®ºæ‰‹',
        'æ›¾ç¶“æ„›éæ•µäºº','æ›¾æ‹‹æ£„éå­©å­','æ›¾è¦‹æ­»ä¸æ•‘','æ›¾ç‚ºäº†æ´»å‘½å‡ºè³£åŒä¼´','åšéä¸å¯å‘Šäººçš„äº¤æ˜“',
        // ã€èƒ½åŠ›ç§˜å¯†ã€‘
        'æ“æœ‰é çŸ¥èƒ½åŠ›','æ“æœ‰è®€å¿ƒè¡“','èƒ½çœ‹è¦‹é¬¼é­‚','èƒ½è½åˆ°ä»–äººå¿ƒè²','èƒ½ç©¿æ¢­å¤¢å¢ƒ','èƒ½æ“æ§æ™‚é–“',
        'æ“æœ‰æ¯€æ»…ä¸–ç•Œçš„åŠ›é‡','æ“æœ‰èµ·æ­»å›ç”Ÿçš„èƒ½åŠ›','æ“æœ‰æ­»äº¡å›æº¯','èƒ½èˆ‡å‹•ç‰©äº¤æµ','èƒ½ä½¿ç”¨ç¦è¡“',
        'èº«é«”é‡Œå°å°è‘—å¼·å¤§å­˜åœ¨','æ“æœ‰ç³»çµ±','æ“æœ‰é‡‘æ‰‹æŒ‡','åŠ›é‡ä¸€ç›´åœ¨å£“åˆ¶ä¸­',
        // ã€æƒ…æ„Ÿç§˜å¯†ã€‘
        'æš—æˆ€è‘—æŸäºº','æ›¾ç¶“æ·±æ„›éä»‡æ•µ','æœ‰ä¸€æ®µä¸èƒ½èªªçš„æˆ€æƒ…','æœ‰ç§ç”Ÿå­','æ›¾è¢«æ„›äººèƒŒå›',
        'å…¶å¯¦æ¨è‘—è¡¨é¢è¦ªè¿‘çš„äºº','å‡è£æ„›è‘—ä¸æ„›çš„äºº','æ„›ä¸Šäº†ä¸è©²æ„›çš„äºº','ç‚ºæ„›åšéç˜‹ç‹‚çš„äº‹',
        // ã€ç¾ä»£ç§˜å¯†ã€‘
        'æ˜¯ç¶²ç´…çš„å°è™Ÿ','æ˜¯åŒ¿åä½œå®¶','æœ‰é¾å¤§çš„ç§˜å¯†è²¡ç”¢','æ˜¯åœ°ä¸‹å‹¢åŠ›çš„é‡‘ä¸»','æœ‰æµ·å¤–ç§˜å¯†èº«ä»½',
        'å¾äº‹ç°è‰²è·æ¥­','æ˜¯é§­å®¢','æ˜¯è·æ¥­è©é¨™','æœ‰è¦‹ä¸å¾—å…‰çš„æ”¶å…¥ä¾†æº','åœ¨æš—ç¶²æœ‰èº«ä»½',
        'æŒæ¡æŸäººçš„æŠŠæŸ„','çŸ¥é“æŸå€‹é©šå¤©å¤§ç§˜å¯†','æ˜¯ç›®æ“Šè€…','æ˜¯çŸ¥æƒ…è€…','è¢«å¨è„…ä¿å®ˆç§˜å¯†',
        // ã€å¥‡å¹»ç§˜å¯†ã€‘
        'èˆ‡ç¥ç°½è¨‚äº†å¥‘ç´„','èˆ‡å¦–ç²¾æœ‰ç´„å®š','çŸ¥é“ä¸–ç•Œçš„çœŸç›¸','è¦‹éå‰µä¸–çš„å ´æ™¯','è¨˜å¾—å‰ä¸–æ‰€æœ‰è¨˜æ†¶',
        'æ˜¯å¾æœªä¾†ä¾†çš„','æ˜¯å¾å¹³è¡Œä¸–ç•Œä¾†çš„','æ´»äº†å¹¾ç™¾å¹´','ç¶“æ­·éä¸–ç•Œæ¯€æ»…','çŸ¥é“æ‰€æœ‰äººçš„å‘½é‹'
      ];

      // ========== äººéš›é—œä¿‚é¸é …ï¼ˆå¤§å¹…æ“´å……ï¼‰==========
      const relationOptions = [
        // ã€è¡€ç·£é—œä¿‚ã€‘
        'å¤±æ•£å¤šå¹´çš„å…„å¼Ÿå§å¦¹','åŒçˆ¶ç•°æ¯çš„å…„å¦¹','ç´ æœªè¬€é¢çš„é›™èƒèƒ','éš±ççš„è¦ªå­é—œä¿‚','ç§ç”Ÿå­',
        'é ˜é¤Šçš„å­©å­','è·¨è¶Šæ™‚ç©ºçš„ç¥–å­«','è½‰ä¸–çš„è¦ªäºº','å…¶å¯¦æ˜¯é æˆ¿è¦ªæˆš','å½è£çš„å®¶äºº',
        // ã€æ„›æƒ…é—œä¿‚ã€‘
        'é’æ¢…ç«¹é¦¬','ä¸€è¦‹é¾æƒ…','å‘½ä¸­æ³¨å®š','å‰ä¸–æˆ€äºº','è·¨è¶Šç¨®æ—çš„æ„›æƒ…','ç¦å¿Œä¹‹æˆ€','å¸«ç”Ÿæˆ€',
        'ä»‡äººä¹‹å­/å¥³','åŒ…è¾¦å©šç´„','æ”¿æ²»è¯å§»','åŒæ€§æ„›äºº','æš—æˆ€å¤šå¹´','æ„›è€Œä¸å¾—','ç›¸æ„›ç›¸æ®º',
        'åˆ†æ‰‹å¾Œå†ç›¸é‡','è¢«æ„›äººèƒŒå›','ç‚ºæ„›æ”¾æ£„ä¸€åˆ‡','ç•°åœ°æˆ€','ç¶²æˆ€','è™æˆ€','ç—…æ…‹ä¾æˆ€',
        // ã€å‹æƒ…é—œä¿‚ã€‘
        'æœ€å¥½çš„æœ‹å‹','æ‚£é›£ä¹‹äº¤','ç”Ÿæ­»ä¹‹äº¤','ä¸€èµ·é•·å¤§','æ›¾ç¶“æ•‘å‘½æ©äºº','æ›¾è¢«å°æ–¹æ•‘é',
        'ä¸æ‰“ä¸ç›¸è­˜','äº¦æ•µäº¦å‹','è¡¨é¢æœ‹å‹','åˆ©ç›ŠåŒç›Ÿ','å…±åŒç§˜å¯†','å¡‘è† å§å¦¹','çœŸå¿ƒæ›çµ•æƒ…',
        // ã€å¸«å¾’é—œä¿‚ã€‘
        'å¸«å¾’','å¸«å…„å¼Ÿå§å¦¹','å›å‡ºå¸«é–€','å¼’å¸«','ç¹¼æ‰¿è¡£ç¼½','åç¾©ä¸Šçš„å¾’å¼Ÿ','ç§˜å¯†æ•™å°',
        'å¸«ç”Ÿè½‰ç‚ºæˆ€äºº','å°å¸«çˆ¶åˆæ•¬åˆæ¨','å¸«å¾’åç›®','è¶…è¶Šå¸«çˆ¶',
        // ã€ä¸»å¾é—œä¿‚ã€‘
        'ä¸»äººèˆ‡åƒ•å¾','å›ç‹èˆ‡è‡£å­','é›‡ä¸»èˆ‡å“¡å·¥','ä¸»äººèˆ‡å¥‘ç´„è€…','å¬å–šå¸«èˆ‡å¬å–šç¸',
        'é¦´ç¸å¸«èˆ‡éˆç¸','é ˜ä¸»èˆ‡é¨å£«','ç¥èˆ‡ä¿¡å¾’','ç³»çµ±èˆ‡å®¿ä¸»','å‰µé€ è€…èˆ‡è¢«é€ ç‰©',
        // ã€æ•µå°é—œä¿‚ã€‘
        'å®¿æ•µ','ä¸–ä»‡','æ®ºçˆ¶/æ¯ä¹‹ä»‡','æ»…é–€ä¹‹ä»‡','æƒ…æ•µ','ç«¶çˆ­å°æ‰‹','æ”¿æ•µ','æš—ä¸­è¼ƒå‹',
        'è¡¨é¢å’Œå¹³å¯¦å‰‡å°ç«‹','è¢«è¿«æ•µå°','å› èª¤æœƒæˆä»‡','å¾æœ‹å‹è®Šæˆæ•µäºº','å¿…é ˆæ®ºæ­»å°æ–¹',
        // ã€è¤‡é›œé—œä¿‚ã€‘
        'äº’ç›¸åˆ©ç”¨','äº’ç›¸ç‰½åˆ¶','äº’ç›¸çŒœå¿Œå»åˆåˆä½œ','è¡¨é¢ä»‡æ•µå¯¦å‰‡åˆä½œ','é›™é¢é–“è«œ',
        'çŸ¥é“å°æ–¹ç§˜å¯†','è¢«å°æ–¹å¨è„…','æ¬ å°æ–¹äººæƒ…','æœ‰æŠŠæŸ„åœ¨å°æ–¹æ‰‹ä¸Š','å‘½é‹ç¶å®š',
        'éˆé­‚é€£çµ','å¿ƒéˆæ„Ÿæ‡‰','å…±ç”¨ä¸€å€‹èº«é«”','ä¸€æ–¹æ˜¯å¦ä¸€æ–¹çš„åˆ†èº«/å½±å­','äº’ç‚ºå°æ–¹çš„å…‰èˆ‡æš—',
        // ã€ç‰¹æ®Šé—œä¿‚ã€‘
        'ç©¿è¶Šå‰å°±èªè­˜','æ›¸ä¸­è®€éå°æ–¹çš„æ•…äº‹','å¤¢ä¸­è¦‹é','ä¼¼æ›¾ç›¸è­˜','å‘½é‹çš„ç¾ˆçµ†',
        'è¼ªè¿´ä¸­åè¦†ç›¸é‡','ä¸åŒæ™‚ç©ºçš„åŒä¸€äºº','å¹³è¡Œä¸–ç•Œçš„è‡ªå·±','æœªä¾†çš„è‡ªå·±','éå»çš„è‡ªå·±',
        // ã€çµ„ç¹”é—œä¿‚ã€‘
        'åŒé–€','åŒäº‹','åŒå­¸','å®¤å‹','é„°å±…','åŒä¸€å€‹çµ„ç¹”æˆå“¡','åˆä½œå¤¥ä¼´','æŠ•è³‡é—œä¿‚',
        'å‚µå‹™é—œä¿‚','å¥‘ç´„é—œä¿‚','åŒç›Ÿ','è‡¨æ™‚çµ„éšŠ','è¢«è¿«åˆä½œ','åˆ©ç›Šæ†ç¶',
        // ã€ç¾ä»£é—œä¿‚ã€‘
        'ç¶²å‹','ç²‰çµ²èˆ‡å¶åƒ','ç›´æ’­é–“èªè­˜','éŠæˆ²éšŠå‹','ç›¸è¦ªå°è±¡','å‰ä»»çš„æœ‹å‹','é–¨èœœçš„å‰ä»»',
        'ç”²æ–¹ä¹™æ–¹','é†«æ‚£é—œä¿‚','å¾‹å¸«èˆ‡å§”è¨—äºº','è¨˜è€…èˆ‡ç·šäºº','è­¦å¯Ÿèˆ‡ç·šäºº'
      ];

      // ==================== å¡«å…… Datalist ====================
      function populateDatalist(listId, options) {
        const datalist = document.getElementById(listId);
        if (datalist) {
          datalist.innerHTML = options.map(opt => `<option value="${opt}">`).join('');
        }
      }
      
      // åˆå§‹åŒ–æ‰€æœ‰ datalist
      populateDatalist('personality-list', personalityOptions);
      populateDatalist('goal-list', goalOptions);
      populateDatalist('weakness-list', weaknessOptions);
      populateDatalist('secret-list', secretOptions);
      populateDatalist('relation-list', relationOptions);

      // ==================== é€²éšè¨­å®šè³‡æ–™ ====================
      // æ•˜äº‹è¦–è§’
      const narrativeOptions = [
        { value: 'ç¬¬ä¸€äººç¨±', label: 'ç¬¬ä¸€äººç¨± - ã€Œæˆ‘èµ°é€²æˆ¿é–“...ã€' },
        { value: 'ç¬¬ä¸‰äººç¨±é™çŸ¥', label: 'ç¬¬ä¸‰äººç¨±é™çŸ¥ - è·Ÿéš¨ä¸»è§’è¦–è§’' },
        { value: 'ç¬¬ä¸‰äººç¨±å…¨çŸ¥', label: 'ç¬¬ä¸‰äººç¨±å…¨çŸ¥ - ä¸Šå¸è¦–è§’' },
        { value: 'å¤šè¦–è§’åˆ‡æ›', label: 'å¤šè¦–è§’åˆ‡æ› - æ¯ç« ä¸åŒè§’è‰²' },
        { value: 'ç¬¬äºŒäººç¨±', label: 'ç¬¬äºŒäººç¨± - ã€Œä½ èµ°é€²æˆ¿é–“...ã€' },
        { value: 'æ›¸ä¿¡é«”', label: 'æ›¸ä¿¡é«” - ä»¥æ›¸ä¿¡/æ—¥è¨˜å‘ˆç¾' },
        { value: 'å›æ†¶éŒ„', label: 'å›æ†¶éŒ„ - ä¸»è§’å›é¡§å¾€äº‹' },
        { value: 'æ—ç™½æ•˜è¿°', label: 'æ—ç™½æ•˜è¿° - æ•…äº‹å¤–çš„è¬›è¿°è€…' }
      ];

      // æ™‚ä»£è¨­å®š
      const eraOptions = [
        { value: 'é å¤ç¥è©±æ™‚ä»£', label: 'ğŸ›ï¸ é å¤/ç¥è©±æ™‚ä»£' },
        { value: 'å…ˆç§¦æ™‚ä»£', label: 'âš”ï¸ å…ˆç§¦æ™‚ä»£ï¼ˆæ˜¥ç§‹æˆ°åœ‹ï¼‰' },
        { value: 'ç§¦æ¼¢æ™‚ä»£', label: 'ğŸ¯ ç§¦æ¼¢æ™‚ä»£' },
        { value: 'é­æ™‰å—åŒ—æœ', label: 'ğŸ­ é­æ™‰å—åŒ—æœ' },
        { value: 'éš‹å”æ™‚ä»£', label: 'ğŸŒ¸ éš‹å”ç››ä¸–' },
        { value: 'å®‹å…ƒæ™‚ä»£', label: 'ğŸ“œ å®‹å…ƒæ™‚ä»£' },
        { value: 'æ˜æ¸…æ™‚ä»£', label: 'ğŸ® æ˜æ¸…æ™‚ä»£' },
        { value: 'æ°‘åœ‹æ™‚ä»£', label: 'ğŸ© æ°‘åœ‹æ™‚ä»£ï¼ˆ1912-1949ï¼‰' },
        { value: 'äºŒæˆ°æ™‚æœŸ', label: 'ğŸ’£ äºŒæˆ°æ™‚æœŸ' },
        { value: 'å†·æˆ°æ™‚æœŸ', label: 'ğŸ•µï¸ å†·æˆ°æ™‚æœŸï¼ˆ1950-1990ï¼‰' },
        { value: 'ç¾ä»£', label: 'ğŸ™ï¸ ç¾ä»£ï¼ˆç•¶ä»£ç¤¾æœƒï¼‰' },
        { value: 'è¿‘æœªä¾†', label: 'ğŸ”® è¿‘æœªä¾†ï¼ˆ2050-2100ï¼‰' },
        { value: 'é æœªä¾†', label: 'ğŸš€ é æœªä¾†ï¼ˆæ˜Ÿéš›æ™‚ä»£ï¼‰' },
        { value: 'æœ«æ—¥å¾Œ', label: 'â˜¢ï¸ æœ«æ—¥å¾Œä¸–ç•Œ' },
        { value: 'æ¶ç©ºæ­·å²', label: 'ğŸŒ€ æ¶ç©ºæ­·å²' },
        { value: 'å¹³è¡Œæ™‚ç©º', label: 'ğŸ”„ å¹³è¡Œæ™‚ç©º' },
        { value: 'æ™‚é–“ç©¿è¶Š', label: 'â³ è·¨è¶Šå¤šå€‹æ™‚ä»£' },
        { value: 'è¥¿æ–¹ä¸­ä¸–ç´€', label: 'ğŸ° è¥¿æ–¹ä¸­ä¸–ç´€' },
        { value: 'ç¶­å¤šåˆ©äºæ™‚ä»£', label: 'ğŸ‘’ ç¶­å¤šåˆ©äºæ™‚ä»£' },
        { value: 'å·¥æ¥­é©å‘½', label: 'âš™ï¸ å·¥æ¥­é©å‘½æ™‚æœŸ' }
      ];

      // æ•…äº‹ç¯€å¥
      const pacingOptions = [
        { value: 'æ…¢ç†±é‹ªé™³', label: 'ğŸ¢ æ…¢ç†±é‹ªé™³ - ç´°è†©æå¯«ï¼Œæ…¢æ…¢å±•é–‹' },
        { value: 'æ¨™æº–ç¯€å¥', label: 'âš–ï¸ æ¨™æº–ç¯€å¥ - å¹³è¡¡æ•˜è¿°èˆ‡å‹•ä½œ' },
        { value: 'å¿«ç¯€å¥', label: 'ğŸƒ å¿«ç¯€å¥ - ç·Šæ¹Šåˆºæ¿€ï¼Œäº‹ä»¶å¯†é›†' },
        { value: 'çˆ½æ–‡ç¯€å¥', label: 'âš¡ çˆ½æ–‡ç¯€å¥ - é«˜æ½®è¿­èµ·ï¼Œæ‰“è‡‰ä¸æ–·' },
        { value: 'æ‡¸ç–‘ç¯€å¥', label: 'ğŸ” æ‡¸ç–‘ç¯€å¥ - å±¤å±¤å‰ç¹­ï¼ŒçœŸç›¸æ¼¸éœ²' },
        { value: 'æ–‡è—ç¯€å¥', label: 'ğŸ­ æ–‡è—ç¯€å¥ - é‡è¦–å…§å¿ƒï¼Œæ·¡åŒ–æƒ…ç¯€' },
        { value: 'å²è©©ç¯€å¥', label: 'ğŸ“– å²è©©ç¯€å¥ - å®å¤§æ•˜äº‹ï¼Œæ™‚é–“è·¨åº¦é•·' },
        { value: 'æ—¥å¸¸ç¯€å¥', label: 'â˜• æ—¥å¸¸ç¯€å¥ - ç”Ÿæ´»ç‘£äº‹ï¼Œæ²»ç™’èˆ’é©' }
      ];

      // å…§å®¹åˆ†ç´š
      const ratingOptions = [
        { value: 'å…¨å¹´é½¡', label: 'ğŸ‘¶ å…¨å¹´é½¡ - é©åˆæ‰€æœ‰äººé–±è®€' },
        { value: 'è¼•åº¦', label: 'ğŸ”¹ è¼•åº¦ - å¯æœ‰è¼•å¾®æš´åŠ›/æ›–æ˜§' },
        { value: 'æˆäººå‘', label: 'ğŸ”¸ æˆäººå‘ - è¼ƒæ¿€çƒˆçš„æˆ°é¬¥/æƒ…æ„Ÿæå¯«' },
        { value: 'ç´”æ„›å‘', label: 'ğŸ’• ç´”æ„›å‘ - æ„Ÿæƒ…ç‚ºä¸»ï¼Œæ¸…æ°´ç„¡è™' },
        { value: 'æš—é»‘å‘', label: 'ğŸ–¤ æš—é»‘å‘ - é»‘æš—åŠ‡æƒ…ï¼Œé“å¾·ç°è‰²' }
      ];

      // ä¸–ç•Œè§€è¤‡é›œåº¦
      const worldComplexityOptions = [
        { value: 'ç°¡å–®', label: 'ğŸ”˜ ç°¡å–® - å–®ä¸€å ´æ™¯/å‹¢åŠ›ï¼Œæ˜“æ–¼ç†è§£' },
        { value: 'ä¸­ç­‰', label: 'ğŸ”µ ä¸­ç­‰ - 2-3å€‹é™£ç‡Ÿ/åœ‹å®¶' },
        { value: 'è¤‡é›œ', label: 'ğŸ”´ è¤‡é›œ - å¤šåœ‹/å¤šå‹¢åŠ›/è©³ç´°è¨­å®š' },
        { value: 'å²è©©ç´š', label: 'ğŸŒŸ å²è©©ç´š - é¾å¤§ä¸–ç•Œè§€ï¼Œå¤šç·šä¸¦é€²' },
        { value: 'æ¥µç°¡', label: 'âšª æ¥µç°¡ - èƒŒæ™¯æ¨¡ç³Šï¼Œèšç„¦è§’è‰²' }
      ];

      // æƒ…æ„ŸåŸºèª¿
      const emotionalToneOptions = [
        { value: 'æ­¡æ¨‚è¼•é¬†', label: 'ğŸ˜„ æ­¡æ¨‚è¼•é¬† - HEå‘ï¼Œæç¬‘æ—¥å¸¸' },
        { value: 'æº«é¦¨æ²»ç™’', label: 'ğŸŒ¸ æº«é¦¨æ²»ç™’ - æš–å¿ƒæ•…äº‹' },
        { value: 'è™å¿ƒç³¾çµ', label: 'ğŸ’” è™å¿ƒç³¾çµ - æƒ…æ„Ÿæ‹‰æ‰¯' },
        { value: 'é»‘æš—æ²‰é‡', label: 'ğŸ–¤ é»‘æš—æ²‰é‡ - BEå‘ï¼Œæ‚²åŠ‡' },
        { value: 'ç†±è¡€ç‡ƒå‘', label: 'ğŸ”¥ ç†±è¡€ç‡ƒå‘ - æˆ°é¬¥/ç«¶æŠ€/æˆé•·' },
        { value: 'æ‡¸ç–‘ç·Šå¼µ', label: 'ğŸ˜° æ‡¸ç–‘ç·Šå¼µ - ä»¤äººå±æ¯' },
        { value: 'æµªæ¼«ç”œèœœ', label: 'ğŸ’— æµªæ¼«ç”œèœœ - æˆ€æ„›ç‚ºä¸»' },
        { value: 'å²è©©å£¯é—˜', label: 'âš”ï¸ å²è©©å£¯é—˜ - å®å¤§è‹±é›„æ•˜äº‹' },
        { value: 'è«·åˆºå¹½é»˜', label: 'ğŸ˜ è«·åˆºå¹½é»˜ - é»‘è‰²å–œåŠ‡' },
        { value: 'å“²ç†æ·±æ²‰', label: 'ğŸ¤” å“²ç†æ·±æ²‰ - æ¢è¨äººç”Ÿæ„ç¾©' },
        { value: 'è©­ç•°é©šæ‚š', label: 'ğŸ‘» è©­ç•°é©šæ‚š - ææ€–æ°›åœ' },
        { value: 'é’æ˜¥æ´»åŠ›', label: 'ğŸŒˆ é’æ˜¥æ´»åŠ› - æ ¡åœ’/æˆé•·' }
      ];

      // çµå±€å‚¾å‘
      const endingOptions = [
        { value: 'HE', label: 'ğŸ˜Š HEï¼ˆHappy Endï¼‰- åœ“æ»¿çµå±€' },
        { value: 'BE', label: 'ğŸ˜¢ BEï¼ˆBad Endï¼‰- æ‚²åŠ‡çµå±€' },
        { value: 'OE', label: 'ğŸ¤” OEï¼ˆOpen Endï¼‰- é–‹æ”¾å¼çµå±€' },
        { value: 'é€†è½‰çµå±€', label: 'ğŸ˜± é€†è½‰çµå±€ - æœ€å¾Œå¤§åè½‰' },
        { value: 'TE', label: 'âœ¨ TEï¼ˆTrue Endï¼‰- çœŸçµå±€/éš±è—çµå±€' },
        { value: 'åŠé–‹æ”¾', label: 'ğŸŒ… åŠé–‹æ”¾ - ä¸»ç·šå®Œçµï¼Œç•™æœ‰é¤˜éŸ»' },
        { value: 'è¼ªè¿´çµå±€', label: 'ğŸ”„ è¼ªè¿´çµå±€ - é¦–å°¾å‘¼æ‡‰/é‡æ–°é–‹å§‹' },
        { value: 'å¤šçµå±€', label: 'ğŸ”€ å¤šçµå±€æš—ç¤º - å¯èƒ½èµ°å‘ä¸åŒåˆ†æ”¯' }
      ];

      // ç‰¹æ®Šå…ƒç´ 
      const specialElements = [
        { id: 'system', icon: 'ğŸ“Š', label: 'ç³»çµ±/é¢æ¿' },
        { id: 'transmigration', icon: 'ğŸ”„', label: 'ç©¿è¶Š/é‡ç”Ÿ' },
        { id: 'goldenFinger', icon: 'âœ¨', label: 'é‡‘æ‰‹æŒ‡/å¤–æ›' },
        { id: 'harem', icon: 'ğŸ‘¥', label: 'å¾Œå®®/é€†å¾Œå®®' },
        { id: 'invincible', icon: 'ğŸ’ª', label: 'ç„¡æ•µæµ' },
        { id: 'farming', icon: 'ğŸŒ¾', label: 'ç¨®ç”°/ç¶“ç‡Ÿ' },
        { id: 'food', icon: 'ğŸœ', label: 'ç¾é£Ÿæå¯«' },
        { id: 'pet', icon: 'ğŸ¾', label: 'å¯µç‰©/éˆç¸' },
        { id: 'faction', icon: 'âš”ï¸', label: 'é™£ç‡Ÿå°ç«‹' },
        { id: 'competition', icon: 'ğŸ†', label: 'æ¯”è³½/ç«¶æŠ€' },
        { id: 'revenge', icon: 'ğŸ—¡ï¸', label: 'å¾©ä»‡ä¸»ç·š' },
        { id: 'puzzle', icon: 'ğŸ§©', label: 'è§£è¬/æ¢éšª' },
        { id: 'romance', icon: 'ğŸ’•', label: 'æˆ€æ„›ç·š' },
        { id: 'mystery', icon: 'ğŸ”®', label: 'ç¥ç§˜åŠ›é‡' },
        { id: 'kingdom', icon: 'ğŸ‘‘', label: 'ç‹åœ‹å»ºè¨­' },
        { id: 'upgrade', icon: 'ğŸ“ˆ', label: 'å‡ç´šæ‰“æ€ª' },
        { id: 'dungeon', icon: 'ğŸ°', label: 'å‰¯æœ¬/è¿·å®®' },
        { id: 'survival', icon: 'ğŸ•ï¸', label: 'ç”Ÿå­˜æŒ‘æˆ°' },
        { id: 'conspiracy', icon: 'ğŸ•¸ï¸', label: 'é™°è¬€è«–' },
        { id: 'family', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', label: 'å®¶æ—èˆˆè¡°' },
        { id: 'school', icon: 'ğŸ«', label: 'å­¸é™¢/é–€æ´¾' },
        { id: 'military', icon: 'ğŸ–ï¸', label: 'è»äº‹æˆ°çˆ­' },
        { id: 'politics', icon: 'ğŸ›ï¸', label: 'æ¬Šè¬€æ”¿æ²»' },
        { id: 'technology', icon: 'ğŸ¤–', label: 'ç§‘æŠ€å…ƒç´ ' },
        { id: 'magic', icon: 'ğŸª„', label: 'é­”æ³•é«”ç³»' },
        { id: 'martial', icon: 'ğŸ¥‹', label: 'æ­¦åŠŸä¿®ç…‰' },
        { id: 'trade', icon: 'ğŸ’°', label: 'å•†æˆ°ç¶“å•†' },
        { id: 'heist', icon: 'ğŸ­', label: 'ç›œè³Š/è©é¨™' },
        { id: 'apocalypse', icon: 'â˜ ï¸', label: 'æœ«æ—¥å±æ©Ÿ' },
        { id: 'timeLoop', icon: 'â°', label: 'æ™‚é–“è¼ªè¿´' }
      ];

      function pickRandom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }

      // ==================== äººç‰©è¨­å®š ====================
      function addCharacterRow(randomize = false) {
        const row = document.createElement('div');
        row.className = 'character-row';
        updateCharacterIndices();
        const index = charactersContainer.children.length + 1;
        row.innerHTML = `
          <div class="char-index">äººç‰© ${index}</div>
          <select class="char-gender" style="flex: 0 0 70px; min-width: 70px;">
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
            <option value="ä¸æ˜">ä¸æ˜</option>
          </select>
          <input type="number" class="char-age" placeholder="å¹´é½¡" min="1" max="9999" style="flex: 0 0 70px; min-width: 70px;" />
          <input type="text" class="char-name" placeholder="å§“å" />
          <input type="text" class="char-personality" placeholder="å€‹æ€§" list="personality-list" />
          <input type="text" class="char-goal" placeholder="ç›®æ¨™" list="goal-list" />
          <input type="text" class="char-weakness" placeholder="å¼±é»" list="weakness-list" />
          <input type="text" class="char-secret" placeholder="ç§˜å¯†" list="secret-list" />
          <input type="text" class="char-relation" placeholder="äººéš›" list="relation-list" />
          <button type="button" class="char-random-btn btn-outline btn-small">ğŸ²</button>
          <button type="button" class="char-remove-btn btn-outline btn-small" title="ç§»é™¤æ­¤äººç‰©">âœ•</button>
        `;
        const randBtn = row.querySelector('.char-random-btn');
        randBtn.addEventListener('click', () => {
          randomizeRow(row, false);
          saveSettingsToLocal();
        });
        
        const removeBtn = row.querySelector('.char-remove-btn');
        removeBtn.addEventListener('click', () => {
          if (charactersContainer.children.length > 1) {
            row.remove();
            updateCharacterIndices();
            saveSettingsToLocal();
          } else {
            alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä½äººç‰©ï¼');
          }
        });
        
        // ç›£è½è¼¸å…¥è®Šæ›´ä»¥è‡ªå‹•å„²å­˜
        row.querySelectorAll('input, select').forEach(el => {
          el.addEventListener('change', saveSettingsToLocal);
          el.addEventListener('input', debounce(saveSettingsToLocal, 500));
        });
        
        charactersContainer.appendChild(row);
        if (randomize) {
          // æ–°å¢äººç‰©æ™‚ï¼Œå…ˆæ”¶é›†å·²æœ‰çš„åå­—é¿å…é‡è¤‡
          usedNames.clear();
          Array.from(charactersContainer.children).forEach(r => {
            if (r !== row) {
              const name = r.querySelector('.char-name').value.trim();
              if (name) usedNames.add(name);
            }
          });
          randomizeRow(row, false);
        }
      }
      
      // æ›´æ–°äººç‰©ç·¨è™Ÿ
      function updateCharacterIndices() {
        Array.from(charactersContainer.children).forEach((row, idx) => {
          const indexEl = row.querySelector('.char-index');
          if (indexEl) indexEl.textContent = `äººç‰© ${idx + 1}`;
        });
      }
      
      // é˜²æŠ–å‡½æ•¸
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // æ™ºèƒ½éš¨æ©Ÿé¸æ“‡ï¼šé¿å…é‡è¤‡ï¼ˆäººåçµ•å°ä¸é‡è¤‡ï¼Œå…¶ä»–ç›¡é‡ä¸é‡è¤‡ï¼‰
      function pickRandomUnique(arr, usedSet, allowRepeat = false) {
        // éæ¿¾æ‰å·²ä½¿ç”¨çš„é¸é …
        const available = arr.filter(item => !usedSet.has(item));
        
        // å¦‚æœæ²’æœ‰å¯ç”¨é¸é …
        if (available.length === 0) {
          if (allowRepeat) {
            // å…è¨±é‡è¤‡æ™‚ï¼Œå¾å…¨éƒ¨é¸é …ä¸­é¸
            return arr[Math.floor(Math.random() * arr.length)];
          } else {
            // ä¸å…è¨±é‡è¤‡æ™‚ï¼Œè¿”å› nullï¼ˆäººåç”¨ï¼‰
            return null;
          }
        }
        
        const chosen = available[Math.floor(Math.random() * available.length)];
        usedSet.add(chosen);
        return chosen;
      }

      // ç”¨æ–¼è¿½è¹¤å·²ä½¿ç”¨çš„é¸é …
      let usedNames = new Set();
      let usedPersonalities = new Set();
      let usedGoals = new Set();
      let usedWeaknesses = new Set();
      let usedSecrets = new Set();
      let usedRelations = new Set();

      // é‡ç½®æ‰€æœ‰è¿½è¹¤ï¼ˆç•¶é‡æ–°éš¨æ©Ÿå…¨éƒ¨äººç‰©æ™‚ï¼‰
      function resetUsedOptions() {
        usedNames.clear();
        usedPersonalities.clear();
        usedGoals.clear();
        usedWeaknesses.clear();
        usedSecrets.clear();
        usedRelations.clear();
        
        // æŠŠç›®å‰å·²å¡«å…¥çš„äººååŠ å…¥ usedNamesï¼ˆé¿å…èˆ‡ç¾æœ‰é‡è¤‡ï¼‰
        Array.from(charactersContainer.children).forEach(row => {
          const name = row.querySelector('.char-name').value.trim();
          if (name) usedNames.add(name);
        });
      }

      // å–®è¡Œéš¨æ©ŸåŒ–ï¼ˆç”¨æ–¼å–®å€‹äººç‰©çš„éš¨æ©ŸæŒ‰éˆ•ï¼‰
      function randomizeRow(row, isFullRandom = false) {
        // å¦‚æœæ˜¯å–®ç¨éš¨æ©Ÿä¸€è¡Œï¼Œå…ˆæ”¶é›†å…¶ä»–è¡Œå·²ç”¨çš„åå­—
        if (!isFullRandom) {
          usedNames.clear();
          Array.from(charactersContainer.children).forEach(r => {
            if (r !== row) {
              const name = r.querySelector('.char-name').value.trim();
              if (name) usedNames.add(name);
            }
          });
        }
        
        // å…ˆéš¨æ©Ÿæ€§åˆ¥
        const genderSelect = row.querySelector('.char-gender');
        const genders = ['ç”·', 'å¥³'];
        genderSelect.value = genders[Math.floor(Math.random() * genders.length)];
        
        // æ ¹æ“šæ€§åˆ¥é¸æ“‡åå­—åº«
        const gender = genderSelect.value;
        let namePool;
        if (gender === 'ç”·') {
          namePool = maleNames;
        } else if (gender === 'å¥³') {
          namePool = femaleNames;
        } else {
          namePool = nameOptions; // ä¸æ˜æ€§åˆ¥ç”¨å…¨éƒ¨åå­—
        }
        
        // äººåï¼šçµ•å°ä¸é‡è¤‡
        const newName = pickRandomUnique(namePool, usedNames, false);
        if (newName) {
          row.querySelector('.char-name').value = newName;
        } else {
          // å¦‚æœè©²æ€§åˆ¥åå­—éƒ½ç”¨å®Œäº†ï¼Œå¾å…¨éƒ¨åå­—ä¸­é¸
          const fallbackName = pickRandomUnique(nameOptions, usedNames, false);
          if (fallbackName) {
            row.querySelector('.char-name').value = fallbackName;
          } else {
            // çœŸçš„éƒ½ç”¨å®Œäº†ï¼ŒåŠ ç·¨è™Ÿ
            const baseName = namePool[Math.floor(Math.random() * namePool.length)];
            row.querySelector('.char-name').value = baseName + (Math.floor(Math.random() * 100));
          }
        }
        
        // å…¶ä»–å±¬æ€§ï¼šç›¡é‡ä¸é‡è¤‡ï¼Œä½†å…è¨±åœ¨é¸é …ç”¨å®Œæ™‚é‡è¤‡
        row.querySelector('.char-personality').value = pickRandomUnique(personalityOptions, usedPersonalities, true);
        row.querySelector('.char-goal').value = pickRandomUnique(goalOptions, usedGoals, true);
        row.querySelector('.char-weakness').value = pickRandomUnique(weaknessOptions, usedWeaknesses, true);
        row.querySelector('.char-secret').value = pickRandomUnique(secretOptions, usedSecrets, true);
        row.querySelector('.char-relation').value = pickRandomUnique(relationOptions, usedRelations, true);
        
        // å¹´é½¡éš¨æ©Ÿï¼ˆæ ¹æ“šæ•…äº‹é¡å‹å¯èƒ½æœ‰ä¸åŒç¯„åœï¼Œé€™è£¡ç”¨é€šç”¨ç¯„åœï¼‰
        const ageRanges = [
          { min: 6, max: 12, weight: 1 },    // å…’ç«¥
          { min: 13, max: 17, weight: 2 },   // é’å°‘å¹´
          { min: 18, max: 25, weight: 4 },   // é’å¹´
          { min: 26, max: 35, weight: 3 },   // å£¯å¹´
          { min: 36, max: 50, weight: 2 },   // ä¸­å¹´
          { min: 51, max: 70, weight: 1 },   // è€å¹´
        ];
        const totalWeight = ageRanges.reduce((sum, r) => sum + r.weight, 0);
        let rand = Math.random() * totalWeight;
        let selectedRange = ageRanges[0];
        for (const range of ageRanges) {
          rand -= range.weight;
          if (rand <= 0) {
            selectedRange = range;
            break;
          }
        }
        row.querySelector('.char-age').value = Math.floor(Math.random() * (selectedRange.max - selectedRange.min + 1)) + selectedRange.min;
      }

      // å…¨éƒ¨äººç‰©éš¨æ©ŸåŒ–
      function randomizeAllCharacters() {
        // é‡ç½®è¿½è¹¤
        usedNames.clear();
        usedPersonalities.clear();
        usedGoals.clear();
        usedWeaknesses.clear();
        usedSecrets.clear();
        usedRelations.clear();
        
        // ä¾åºéš¨æ©ŸåŒ–æ¯ä¸€è¡Œ
        Array.from(charactersContainer.children).forEach(row => {
          randomizeRow(row, true);
        });
      }

      // ==================== æœ¬åœ°å„²å­˜è¨­å®š ====================
      function saveSettingsToLocal() {
        try {
          // æ”¶é›†å·²é¸æ“‡çš„ç‰¹æ®Šå…ƒç´ 
          const selectedElements = [];
          specialElementsContainer.querySelectorAll('.special-element-item.selected').forEach(item => {
            selectedElements.push(item.dataset.id);
          });

          const settings = {
            theme: themeSelect.value,
            setting: settingSelect.value,
            style: styleSelect.value,
            chapters: chaptersInput.value,
            length: lengthInput.value,
            notes: notesInput.value,
            // é€²éšè¨­å®š
            narrative: narrativeSelect.value,
            era: eraSelect.value,
            pacing: pacingSelect.value,
            rating: ratingSelect.value,
            worldComplexity: worldComplexitySelect.value,
            emotionalTone: emotionalToneSelect.value,
            ending: endingSelect.value,
            specialElements: selectedElements,
            characters: []
          };
          
          Array.from(charactersContainer.children).forEach(row => {
            settings.characters.push({
              gender: row.querySelector('.char-gender').value,
              age: row.querySelector('.char-age').value,
              name: row.querySelector('.char-name').value,
              personality: row.querySelector('.char-personality').value,
              goal: row.querySelector('.char-goal').value,
              weakness: row.querySelector('.char-weakness').value,
              secret: row.querySelector('.char-secret').value,
              relation: row.querySelector('.char-relation').value
            });
          });
          
          localStorage.setItem('novelGeneratorSettings', JSON.stringify(settings));
        } catch (e) {
          console.warn('ç„¡æ³•å„²å­˜è¨­å®šï¼š', e);
        }
      }
      
      function loadSettingsFromLocal() {
        try {
          const raw = localStorage.getItem('novelGeneratorSettings');
          if (!raw) return false;
          
          const settings = JSON.parse(raw);
          let hasData = false;
          
          // è¼‰å…¥åŸºæœ¬è¨­å®š
          if (settings.theme) { themeSelect.value = settings.theme; hasData = true; }
          if (settings.setting) { settingSelect.value = settings.setting; hasData = true; }
          if (settings.style) { styleSelect.value = settings.style; hasData = true; }
          if (settings.chapters) { chaptersInput.value = settings.chapters; hasData = true; }
          if (settings.length) { lengthInput.value = settings.length; hasData = true; }
          if (settings.notes) { notesInput.value = settings.notes; hasData = true; }

          // è¼‰å…¥é€²éšè¨­å®š
          if (settings.narrative) { narrativeSelect.value = settings.narrative; hasData = true; }
          if (settings.era) { eraSelect.value = settings.era; hasData = true; }
          if (settings.pacing) { pacingSelect.value = settings.pacing; hasData = true; }
          if (settings.rating) { ratingSelect.value = settings.rating; hasData = true; }
          if (settings.worldComplexity) { worldComplexitySelect.value = settings.worldComplexity; hasData = true; }
          if (settings.emotionalTone) { emotionalToneSelect.value = settings.emotionalTone; hasData = true; }
          if (settings.ending) { endingSelect.value = settings.ending; hasData = true; }

          // è¼‰å…¥ç‰¹æ®Šå…ƒç´ 
          if (settings.specialElements && settings.specialElements.length > 0) {
            settings.specialElements.forEach(id => {
              const item = specialElementsContainer.querySelector(`[data-id="${id}"]`);
              if (item) {
                item.classList.add('selected');
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = true;
              }
            });
            hasData = true;
          }
          
          // è¼‰å…¥äººç‰©è¨­å®š
          if (settings.characters && settings.characters.length > 0) {
            // æ¸…ç©ºç¾æœ‰äººç‰©
            charactersContainer.innerHTML = '';
            
            settings.characters.forEach(char => {
              addCharacterRow(false); // ä¸éš¨æ©Ÿ
              const row = charactersContainer.lastElementChild;
              if (row) {
                row.querySelector('.char-gender').value = char.gender || 'ä¸æ˜';
                row.querySelector('.char-age').value = char.age || '';
                row.querySelector('.char-name').value = char.name || '';
                row.querySelector('.char-personality').value = char.personality || '';
                row.querySelector('.char-goal').value = char.goal || '';
                row.querySelector('.char-weakness').value = char.weakness || '';
                row.querySelector('.char-secret').value = char.secret || '';
                row.querySelector('.char-relation').value = char.relation || '';
              }
            });
            hasData = true;
          }
          
          console.log('è¨­å®šå·²å¾æœ¬åœ°è¼‰å…¥', settings);
          return hasData;
        } catch (e) {
          console.warn('ç„¡æ³•è¼‰å…¥è¨­å®šï¼š', e);
          return false;
        }
      }
      
      // ç›£è½åŸºæœ¬è¨­å®šçš„è®Šæ›´
      [themeSelect, settingSelect, styleSelect, chaptersInput, lengthInput, notesInput,
       narrativeSelect, eraSelect, pacingSelect, ratingSelect, worldComplexitySelect, emotionalToneSelect, endingSelect].forEach(el => {
        el.addEventListener('change', saveSettingsToLocal);
        el.addEventListener('input', debounce(saveSettingsToLocal, 500));
      });
      
      // å‹•æ…‹ç”Ÿæˆä¸‹æ‹‰é¸å–®é¸é …
      function populateSelectOptions() {
        // ä¸»é¡Œé¸é …
        themes.forEach(theme => {
          const option = document.createElement('option');
          option.value = theme;
          option.textContent = theme;
          themeSelect.appendChild(option);
        });
        
        // èƒŒæ™¯è¨­å®šé¸é …
        settingsData.forEach(setting => {
          const option = document.createElement('option');
          option.value = setting;
          option.textContent = setting;
          settingSelect.appendChild(option);
        });
        
        // é¢¨æ ¼é¸é …
        stylesArr.forEach(style => {
          const option = document.createElement('option');
          option.value = style;
          option.textContent = style;
          styleSelect.appendChild(option);
        });

        // æ•˜äº‹è¦–è§’é¸é …
        narrativeOptions.forEach(item => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.label;
          narrativeSelect.appendChild(option);
        });

        // æ™‚ä»£è¨­å®šé¸é …
        eraOptions.forEach(item => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.label;
          eraSelect.appendChild(option);
        });

        // æ•…äº‹ç¯€å¥é¸é …
        pacingOptions.forEach(item => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.label;
          pacingSelect.appendChild(option);
        });

        // å…§å®¹åˆ†ç´šé¸é …
        ratingOptions.forEach(item => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.label;
          ratingSelect.appendChild(option);
        });

        // ä¸–ç•Œè§€è¤‡é›œåº¦é¸é …
        worldComplexityOptions.forEach(item => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.label;
          worldComplexitySelect.appendChild(option);
        });

        // æƒ…æ„ŸåŸºèª¿é¸é …
        emotionalToneOptions.forEach(item => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.label;
          emotionalToneSelect.appendChild(option);
        });

        // çµå±€å‚¾å‘é¸é …
        endingOptions.forEach(item => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.label;
          endingSelect.appendChild(option);
        });

        // ç‰¹æ®Šå…ƒç´ å¤šé¸
        specialElements.forEach(item => {
          const div = document.createElement('div');
          div.className = 'special-element-item';
          div.dataset.id = item.id;
          div.innerHTML = `
            <input type="checkbox" id="element-${item.id}" />
            <span class="checkbox-custom"></span>
            <span class="element-icon">${item.icon}</span>
            <span class="element-label">${item.label}</span>
          `;
          div.addEventListener('click', () => {
            div.classList.toggle('selected');
            const checkbox = div.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            saveSettingsToLocal();
          });
          specialElementsContainer.appendChild(div);
        });
      }

      // åˆå§‹åŒ–ï¼šè¼‰å…¥è¨­å®šæˆ–å»ºç«‹é è¨­äººç‰©
      (function initSettings() {
        // å…ˆç”Ÿæˆä¸‹æ‹‰é¸å–®é¸é …
        populateSelectOptions();
        
        // å˜—è©¦è¼‰å…¥å·²å„²å­˜çš„è¨­å®š
        const hasSettings = loadSettingsFromLocal();
        
        // å¦‚æœæ²’æœ‰å·²å„²å­˜çš„è¨­å®šï¼Œæ‰å»ºç«‹é è¨­äººç‰©
        if (!hasSettings) {
          addCharacterRow(true);
          addCharacterRow(true);
        }
        
        renderBookmarks();
      })();

      randomAllCharactersBtn.addEventListener('click', () => {
        randomizeAllCharacters();
        saveSettingsToLocal();
      });

      addCharacterBtn.addEventListener('click', () => {
        addCharacterRow(true);
        saveSettingsToLocal();
      });

      randomBtn.addEventListener('click', () => {
        themeSelect.value = pickRandom(themes);
        settingSelect.value = pickRandom(settingsData);
        styleSelect.value = pickRandom(stylesArr);
        chaptersInput.value = pickRandom(chapterOpts);
        lengthInput.value = pickRandom(lengthOpts);
        
        // é€²éšè¨­å®šéš¨æ©Ÿ
        narrativeSelect.value = pickRandom(narrativeOptions).value;
        eraSelect.value = pickRandom(eraOptions).value;
        pacingSelect.value = pickRandom(pacingOptions).value;
        ratingSelect.value = pickRandom(ratingOptions).value;
        worldComplexitySelect.value = pickRandom(worldComplexityOptions).value;
        emotionalToneSelect.value = pickRandom(emotionalToneOptions).value;
        endingSelect.value = pickRandom(endingOptions).value;
        
        // éš¨æ©Ÿé¸æ“‡ 2-5 å€‹ç‰¹æ®Šå…ƒç´ 
        const allItems = specialElementsContainer.querySelectorAll('.special-element-item');
        allItems.forEach(item => {
          item.classList.remove('selected');
          const checkbox = item.querySelector('input[type="checkbox"]');
          if (checkbox) checkbox.checked = false;
        });
        
        const shuffled = Array.from(allItems).sort(() => Math.random() - 0.5);
        const numToSelect = Math.floor(Math.random() * 4) + 2; // 2-5 å€‹
        shuffled.slice(0, numToSelect).forEach(item => {
          item.classList.add('selected');
          const checkbox = item.querySelector('input[type="checkbox"]');
          if (checkbox) checkbox.checked = true;
        });
        
        randomizeAllCharacters();
        saveSettingsToLocal();
      });

      // ==================== æ™ºèƒ½æµ®å‹•ç« ç¯€å°èˆª ====================

      // åˆ‡æ›é¢æ¿é¡¯ç¤º
      chapterNavToggle.addEventListener('click', () => {
        isPanelOpen = !isPanelOpen;
        chapterNavPanel.classList.toggle('open', isPanelOpen);
      });

      chapterNavClose.addEventListener('click', () => {
        isPanelOpen = false;
        chapterNavPanel.classList.remove('open');
      });

      // é»æ“Šé¢æ¿å¤–éƒ¨é—œé–‰
      document.addEventListener('click', (e) => {
        if (isPanelOpen && 
            !chapterNavPanel.contains(e.target) && 
            !chapterNavToggle.contains(e.target)) {
          isPanelOpen = false;
          chapterNavPanel.classList.remove('open');
        }
      });

      // é–±è®€é€²åº¦è¿½è¹¤
      window.addEventListener('scroll', () => {
        if (!resultDiv.textContent) return;
        
        const rect = resultDiv.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const docHeight = resultDiv.offsetHeight;
        
        // è¨ˆç®—é–±è®€é€²åº¦
        if (rect.top < windowHeight && rect.bottom > 0) {
          const visibleTop = Math.max(0, -rect.top);
          const progress = Math.min(100, (visibleTop / (docHeight - windowHeight)) * 100);
          readingProgress.style.width = Math.max(0, Math.min(100, progress)) + '%';
        }
        
        // è‡ªå‹•æ›´æ–°ç•¶å‰ç« ç¯€é«˜äº®
        updateCurrentChapter();
      });

      function updateCurrentChapter() {
        if (chapterMatches.length === 0) return;
        
        const scrollY = window.scrollY;
        const resultRect = resultDiv.getBoundingClientRect();
        const resultTop = resultRect.top + window.scrollY;
        
        let currentChapterIdx = 0;
        
        for (let i = 0; i < chapterMatches.length; i++) {
          const chapterTitle = chapterMatches[i].title;
          const textContent = resultDiv.textContent;
          const chapterIndex = textContent.indexOf(chapterTitle);
          
          // ä¼°ç®—ç« ç¯€åœ¨é é¢ä¸­çš„ä½ç½®
          const ratio = chapterIndex / textContent.length;
          const estimatedPos = resultTop + (resultDiv.offsetHeight * ratio);
          
          if (scrollY >= estimatedPos - 100) {
            currentChapterIdx = i;
          }
        }
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        const buttons = chapterNavList.querySelectorAll('button');
        buttons.forEach((btn, idx) => {
          btn.classList.toggle('active', idx === currentChapterIdx);
        });
      }

      function parseAndShowChapters(text) {
        chapterMatches = [];
        
        // ç­–ç•¥ï¼šåªåŒ¹é…æ­£æ–‡ä¸­çš„ç« ç¯€æ¨™é¡Œ
        // æ­£æ–‡ç« ç¯€ç‰¹å¾µï¼šä»¥ ## æˆ– ### é–‹é ­ï¼ˆmarkdownæ ¼å¼ï¼‰
        // ç›®éŒ„ç« ç¯€ç‰¹å¾µï¼šä»¥æ•¸å­—ç·¨è™Ÿé–‹é ­ï¼Œå¦‚ "1." "2." æˆ–æœ‰ ** ç²—é«”æ¨™è¨˜
        
        // ç« ç¯€æ¨¡å¼ï¼šç¬¬Xç« ã€åºç« ã€æ¥”å­ã€å°¾è²ã€çµ‚ç« ã€ç•ªå¤–ç­‰
        // æ”¯æ´ï¼šä¸€äºŒä¸‰...ï¼ˆå°å¯«ï¼‰ã€å£¹è²³åƒ...ï¼ˆå¤§å¯«ï¼‰ã€1234...ï¼ˆé˜¿æ‹‰ä¼¯æ•¸å­—ï¼‰
        const chapterNumPattern = '[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾é›¶å£¹è²³åƒè‚†ä¼é™¸æŸ’æŒç–æ‹¾ä½°\\d]+';
        const chapterPattern = new RegExp(`(?:ç¬¬${chapterNumPattern}ç« |åºç« |æ¥”å­|å¼•å­|å‰è¨€|å°¾è²|çµ‚ç« |ç•ªå¤–|å¾Œè¨˜|epilogue|prologue)[ï¼š:]*[^\\n]*`, 'i');
        
        const lines = text.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // åŒ¹é…ä»¥ ## æˆ– ### é–‹é ­çš„ç« ç¯€æ¨™é¡Œï¼ˆé€™æ˜¯æ­£æ–‡ç« ç¯€ï¼‰
          const markdownRegex = new RegExp(`^##[#]?\\s*((?:ç¬¬${chapterNumPattern}ç« |åºç« |æ¥”å­|å¼•å­|å‰è¨€|å°¾è²|çµ‚ç« |ç•ªå¤–|å¾Œè¨˜)[ï¼š:].*)$`, 'i');
          const markdownMatch = line.match(markdownRegex);
          
          if (markdownMatch) {
            // è¨ˆç®—é€™ä¸€è¡Œåœ¨åŸæ–‡ä¸­çš„ä½ç½®
            let index = 0;
            for (let j = 0; j < i; j++) {
              index += lines[j].length + 1; // +1 for \n
            }
            
            chapterMatches.push({
              title: markdownMatch[1].trim(),
              fullLine: line,
              index: index
            });
          }
        }
        
        // å¦‚æœæ²’æœ‰æ‰¾åˆ° ### æ ¼å¼ï¼Œå˜—è©¦æ‰¾ç¨ç«‹è¡Œçš„ç« ç¯€æ¨™é¡Œï¼ˆä¸æ˜¯åˆ—è¡¨é …ï¼‰
        if (chapterMatches.length === 0) {
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const prevLine = i > 0 ? lines[i - 1] : '';
            
            // æ’é™¤ç›®éŒ„é …ï¼šä¸ä»¥æ•¸å­—é–‹é ­ã€ä¸å« ** ç²—é«”ã€å‰ä¸€è¡Œæ˜¯ç©ºè¡Œ
            const isListItem = /^\d+\.\s/.test(line) || /\*\*/.test(line);
            const isAfterBlankLine = prevLine.trim() === '' || prevLine.trim() === '---';
            
            if (!isListItem && isAfterBlankLine) {
              const standaloneRegex = new RegExp(`^((?:ç¬¬${chapterNumPattern}ç« |åºç« |æ¥”å­|å¼•å­|å‰è¨€|å°¾è²|çµ‚ç« |ç•ªå¤–|å¾Œè¨˜)[ï¼š:].*)$`, 'i');
              const match = line.match(standaloneRegex);
              if (match) {
                let index = 0;
                for (let j = 0; j < i; j++) {
                  index += lines[j].length + 1;
                }
                chapterMatches.push({
                  title: match[1].trim(),
                  fullLine: line,
                  index: index
                });
              }
            }
          }
        }
        
        // å»é™¤é‡è¤‡ï¼ˆä»¥ç« ç¯€ç·¨è™Ÿæˆ–åç¨±ç‚ºæº–ï¼‰
        const seenChapters = new Set();
        chapterMatches = chapterMatches.filter(m => {
          // æå–ç« ç¯€æ¨™è­˜ï¼ˆå¦‚ã€Œç¬¬ä¸€ç« ã€ã€Œç¬¬å£¹ç« ã€ã€Œåºç« ã€ã€Œæ¥”å­ã€ç­‰ï¼‰
          const chapterIdRegex = new RegExp(`ç¬¬${chapterNumPattern}ç« |åºç« |æ¥”å­|å¼•å­|å‰è¨€|å°¾è²|çµ‚ç« |ç•ªå¤–|å¾Œè¨˜`, 'i');
          const chapterIdMatch = m.title.match(chapterIdRegex);
          if (chapterIdMatch) {
            const chapterId = chapterIdMatch[0];
            if (!seenChapters.has(chapterId)) {
              seenChapters.add(chapterId);
              return true;
            }
          }
          return false;
        });

        // åªè¦æœ‰ç« ç¯€å°±é¡¯ç¤ºï¼ˆæ”¹ç‚º >= 1ï¼‰
        if (chapterMatches.length >= 1) {
          // é¡¯ç¤ºæµ®å‹•å°èˆª
          chapterNavContainer.classList.add('show');
          chapterBadge.textContent = chapterMatches.length;
          
          // ç”Ÿæˆç« ç¯€åˆ—è¡¨
          chapterNavList.innerHTML = chapterMatches.map((m, i) => 
            `<button type="button" data-chapter="${i}">
              <span class="chapter-num">${i + 1}</span>
              ${m.title.substring(0, 20)}${m.title.length > 20 ? '...' : ''}
            </button>`
          ).join('');
          
          // ç¶å®šé»æ“Šäº‹ä»¶
          chapterNavList.querySelectorAll('button').forEach((btn, idx) => {
            btn.addEventListener('click', () => {
              const chapter = chapterMatches[idx];
              const fullText = resultDiv.textContent;
              
              // æœå°‹å®Œæ•´çš„ç« ç¯€è¡Œï¼ˆåŒ…å« ### æˆ–ä¸å«ï¼‰
              // å› ç‚º textContent ä¸æœƒä¿ç•™ ### ç¬¦è™Ÿï¼Œéœ€è¦æœå°‹æ¨™é¡Œæœ¬èº«
              const searchTitle = chapter.title;
              
              // å¾å„²å­˜çš„ index é™„è¿‘æœå°‹ï¼ˆé¿å…æ‰¾åˆ°ç›®éŒ„ï¼‰
              // æ‰¾æ‰€æœ‰å‡ºç¾ä½ç½®ï¼Œé¸æ“‡æœ€æ¥è¿‘å„²å­˜ index çš„é‚£å€‹
              let bestIndex = -1;
              let searchStart = 0;
              
              while (true) {
                const foundIndex = fullText.indexOf(searchTitle, searchStart);
                if (foundIndex === -1) break;
                
                // æª¢æŸ¥é€™å€‹ä½ç½®æ˜¯å¦æ›´æ¥è¿‘ç›®æ¨™
                if (bestIndex === -1 || Math.abs(foundIndex - chapter.index) < Math.abs(bestIndex - chapter.index)) {
                  // é¡å¤–æª¢æŸ¥ï¼šé€™å€‹ä½ç½®å‰é¢ä¸æ‡‰è©²æ˜¯æ•¸å­—ç·¨è™Ÿï¼ˆæ’é™¤ç›®éŒ„ï¼‰
                  const beforeText = fullText.substring(Math.max(0, foundIndex - 10), foundIndex);
                  const isInTOC = /\d+\.\s*$/.test(beforeText) || /\*\*\s*$/.test(beforeText);
                  
                  if (!isInTOC) {
                    bestIndex = foundIndex;
                  }
                }
                searchStart = foundIndex + 1;
              }
              
              if (bestIndex !== -1) {
                const beforeChapter = fullText.substring(0, bestIndex);
                const chapterText = searchTitle;
                const afterChapter = fullText.substring(bestIndex + searchTitle.length);
                
                resultDiv.innerHTML = 
                  escapeHtml(beforeChapter) + 
                  '<span id="chapter-target" style="scroll-margin-top: 20px;">' + escapeHtml(chapterText) + '</span>' + 
                  escapeHtml(afterChapter);
                
                const target = document.getElementById('chapter-target');
                if (target) {
                  target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  
                  // é«˜äº®æ•ˆæœ
                  target.style.background = 'linear-gradient(90deg, rgba(233, 69, 96, 0.3), rgba(244, 162, 97, 0.1))';
                  target.style.borderRadius = '4px';
                  target.style.padding = '4px 8px';
                  target.style.marginLeft = '-8px';
                  
                  setTimeout(() => {
                    target.style.transition = 'background 1.5s ease';
                    target.style.background = 'transparent';
                  }, 2000);
                }
              }
              
              // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
              chapterNavList.querySelectorAll('button').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              
              // è¡Œå‹•è£ç½®ä¸Šè‡ªå‹•é—œé–‰é¢æ¿
              if (window.innerWidth <= 768) {
                isPanelOpen = false;
                chapterNavPanel.classList.remove('open');
              }
            });
          });
        } else {
          chapterNavContainer.classList.remove('show');
          chapterMatches = [];
        }
      }

      // HTML è½‰ç¾©å‡½æ•¸
      function escapeHtml(text) {
        return text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // ==================== ç”Ÿæˆæ•…äº‹ ====================
      generateBtn.addEventListener('click', async () => {
        // æª¢æŸ¥é›¢ç·šç‹€æ…‹
        if (!navigator.onLine) {
          showStatus('error', 'ğŸ“´ ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼ï¼Œç„¡æ³•ç”Ÿæˆæ•…äº‹ã€‚è«‹é€£æ¥ç¶²è·¯å¾Œå†è©¦ã€‚');
          return;
        }
        
        hideStatus();
        resultDiv.textContent = '';
        chapterNavContainer.classList.remove('show');
        chapterMatches = [];
        localStorage.removeItem('savedStory');
        latestStory = '';
        downloadBtn.disabled = true;
        continueBtn.disabled = true;

        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        const theme = themeSelect.value.trim();
        const setting = settingSelect.value.trim();
        
        const characterRows = Array.from(charactersContainer.querySelectorAll('.character-row'));
        let charactersInfo = '';
        characterRows.forEach((row, idx) => {
          const fields = [];
          const gender = row.querySelector('.char-gender').value;
          const age = row.querySelector('.char-age').value.trim();
          const name = row.querySelector('.char-name').value.trim();
          const personality = row.querySelector('.char-personality').value.trim();
          const goal = row.querySelector('.char-goal').value.trim();
          const weakness = row.querySelector('.char-weakness').value.trim();
          const secret = row.querySelector('.char-secret').value.trim();
          const relation = row.querySelector('.char-relation').value.trim();
          if (name) fields.push(name);
          if (gender && gender !== 'ä¸æ˜') fields.push(`æ€§åˆ¥ï¼š${gender}`);
          if (age) fields.push(`å¹´é½¡ï¼š${age}æ­²`);
          if (personality) fields.push(`å€‹æ€§ï¼š${personality}`);
          if (goal) fields.push(`ç›®æ¨™ï¼š${goal}`);
          if (weakness) fields.push(`å¼±é»ï¼š${weakness}`);
          if (secret) fields.push(`ç§˜å¯†ï¼š${secret}`);
          if (relation) fields.push(`äººéš›ï¼š${relation}`);
          if (fields.length > 0) charactersInfo += `äººç‰©${idx + 1}ï¼š${fields.join('ï¼Œ')}ã€‚\n`;
        });
        
        const style = styleSelect.value.trim();
        const chapters = chaptersInput.value.trim();
        const length = lengthInput.value.trim();
        const notes = notesInput.value.trim();

        // é€²éšè¨­å®š
        const narrative = narrativeSelect.value.trim();
        const era = eraSelect.value.trim();
        const pacing = pacingSelect.value.trim();
        const rating = ratingSelect.value.trim();
        const worldComplexity = worldComplexitySelect.value.trim();
        const emotionalTone = emotionalToneSelect.value.trim();
        const ending = endingSelect.value.trim();
        
        // æ”¶é›†ç‰¹æ®Šå…ƒç´ 
        const selectedElements = [];
        specialElementsContainer.querySelectorAll('.special-element-item.selected').forEach(item => {
          const label = item.querySelector('.element-label').textContent;
          selectedElements.push(label);
        });

        if (!apiKey) {
          showStatus('error', 'è«‹è¼¸å…¥ API é‡‘é‘°');
          return;
        }

        let prompt = '';
        if (theme) prompt += `ä¸»é¡Œï¼š${theme}ã€‚`;
        if (setting) prompt += `èƒŒæ™¯è¨­å®šï¼š${setting}ã€‚`;
        if (era) prompt += `æ™‚ä»£èƒŒæ™¯ï¼š${era}ã€‚`;
        if (charactersInfo) prompt += `${charactersInfo}`;
        if (style) prompt += `æ•…äº‹é¢¨æ ¼ï¼š${style}ã€‚`;
        if (narrative) prompt += `æ•˜äº‹è¦–è§’ï¼š${narrative}ã€‚`;
        if (pacing) prompt += `æ•…äº‹ç¯€å¥ï¼š${pacing}ã€‚`;
        if (emotionalTone) prompt += `æƒ…æ„ŸåŸºèª¿ï¼š${emotionalTone}ã€‚`;
        if (worldComplexity) prompt += `ä¸–ç•Œè§€è¤‡é›œåº¦ï¼š${worldComplexity}ã€‚`;
        if (rating) prompt += `å…§å®¹åˆ†ç´šï¼š${rating}ã€‚`;
        if (ending) prompt += `çµå±€å‚¾å‘ï¼š${ending}ã€‚`;
        if (selectedElements.length > 0) prompt += `ç‰¹æ®Šå…ƒç´ ï¼š${selectedElements.join('ã€')}ã€‚`;
        if (chapters) prompt += `æ•…äº‹åˆ†ç‚º ${chapters} ç« ç¯€ã€‚`;
        if (length) prompt += `ç¸½ç¯‡å¹…ç´„ ${length} å­—ã€‚`;
        if (notes) prompt += `å…¶ä»–èªªæ˜ï¼š${notes}ã€‚`;
        
        if (!theme && !setting && !charactersInfo && !style && !chapters && !length && !notes) {
          showStatus('error', 'è«‹è‡³å°‘å¡«å¯«ä¸€é …è¨­å®šæˆ–ä½¿ç”¨éš¨æ©Ÿå¡«å……');
          return;
        }
        
        prompt += `

ã€é‡è¦æŒ‡ç¤ºã€‘è«‹ç›´æ¥æ’°å¯«å°èªªã€Œæ­£æ–‡å…§å®¹ã€ï¼Œä¸è¦åªå¯«å¤§ç¶±ã€è¦åŠƒã€æ•…äº‹ç°¡ä»‹æˆ–ç« ç¯€åˆ—è¡¨ã€‚

è¦æ±‚ï¼š
1. ç›´æ¥é–‹å§‹å¯«æ•…äº‹æ­£æ–‡ï¼ŒåŒ…å«å ´æ™¯æå¯«ã€äººç‰©å°è©±ã€å¿ƒç†æ´»å‹•ã€æƒ…ç¯€ç™¼å±•
2. æ¯å€‹ç« ç¯€éƒ½è¦æœ‰å®Œæ•´çš„æ•…äº‹å…§å®¹ï¼ˆè‡³å°‘2000-3000å­—ï¼‰ï¼Œä¸æ˜¯ç°¡çŸ­çš„æ‘˜è¦
3. ç« ç¯€æ¨™é¡Œæ ¼å¼ï¼š### ç¬¬Xç« ï¼šæ¨™é¡Œï¼ˆæˆ– ### åºç« ï¼šæ¨™é¡Œï¼‰
4. ä½¿ç”¨ç¹é«”ä¸­æ–‡æ’°å¯«
5. æ•…äº‹è¦æœ‰èµ·æ‰¿è½‰åˆï¼Œæƒ…ç¯€å®Œæ•´
6. ç¦æ­¢å‡ºç¾ã€Œæ•…äº‹å¤§ç¶±ã€ã€Œç« ç¯€åˆ—è¡¨ã€ã€Œæ•…äº‹ç°¡ä»‹ã€ã€Œäººç‰©è¨­å®šã€ç­‰è¦åŠƒæ€§å…§å®¹
7. ç¦æ­¢ä½¿ç”¨æ¢åˆ—å¼èªªæ˜ï¼Œè¦ç”¨æ•˜äº‹æ–‡é«”
8. åš´æ ¼éµå®ˆæŒ‡å®šçš„æ•˜äº‹è¦–è§’ã€æ•…äº‹ç¯€å¥ã€æƒ…æ„ŸåŸºèª¿
9. ç¢ºä¿ç‰¹æ®Šå…ƒç´ è‡ªç„¶èå…¥æ•…äº‹ä¸­

ç¾åœ¨é–‹å§‹æ’°å¯«å°èªªæ­£æ–‡ï¼š`;

        showStatus('loading', 'æ•…äº‹ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...');
        generateBtn.disabled = true;

        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
            }),
          });
          const data = await response.json();
          
          if (data.error) {
            showStatus('error', 'éŒ¯èª¤ï¼š' + data.error.message);
            return;
          }
          
          if (data.candidates && data.candidates.length > 0) {
            const parts = data.candidates[0].content.parts || [];
            const story = parts.map(p => p.text || '').join('');
            latestStory = story.trim();
            resultDiv.textContent = latestStory;
            
            try {
              localStorage.setItem('savedStory', latestStory);
            } catch (e) {
              console.warn('ç„¡æ³•å„²å­˜æ•…äº‹è‡³ localStorageï¼š', e);
            }
            
            showStatus('success', 'ç”Ÿæˆå®Œæˆï¼');
            downloadBtn.disabled = false;
            continueBtn.disabled = false;
            speakBtn.disabled = false;
            parseAndShowChapters(latestStory);
          } else {
            showStatus('error', 'æ²’æœ‰ç²å¾—å…§å®¹ï¼Œè«‹èª¿æ•´è¨­å®š');
          }
        } catch (err) {
          showStatus('error', 'è«‹æ±‚å¤±æ•—ï¼š' + err.message);
        } finally {
          generateBtn.disabled = false;
        }
      });

      // ==================== ç¹¼çºŒç”Ÿæˆ ====================
      continueBtn.addEventListener('click', async () => {
        // æª¢æŸ¥é›¢ç·šç‹€æ…‹
        if (!navigator.onLine) {
          showStatus('error', 'ğŸ“´ ç›®å‰ç‚ºé›¢ç·šæ¨¡å¼ï¼Œç„¡æ³•ç¹¼çºŒç”Ÿæˆã€‚è«‹é€£æ¥ç¶²è·¯å¾Œå†è©¦ã€‚');
          return;
        }
        
        if (!latestStory) {
          showStatus('error', 'å°šæœªæœ‰æ•…äº‹å¯ç¹¼çºŒï¼Œè«‹å…ˆç”Ÿæˆ');
          return;
        }
        
        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        
        if (!apiKey) {
          showStatus('error', 'è«‹è¼¸å…¥ API é‡‘é‘°');
          return;
        }

        const continuePrompt = latestStory + `

ã€é‡è¦æŒ‡ç¤ºã€‘è«‹ç¹¼çºŒæ’°å¯«å°èªªã€Œæ­£æ–‡å…§å®¹ã€ã€‚

è¦æ±‚ï¼š
1. ä¿æŒä»¥ä¸Šæ•…äº‹çš„ä¸»é¡Œã€èƒŒæ™¯ã€äººç‰©èˆ‡é¢¨æ ¼
2. ç›´æ¥ç¹¼çºŒå¯«æ•…äº‹æ­£æ–‡ï¼ŒåŒ…å«å ´æ™¯æå¯«ã€äººç‰©å°è©±ã€å¿ƒç†æ´»å‹•ã€æƒ…ç¯€ç™¼å±•
3. æ¯å€‹ç« ç¯€éƒ½è¦æœ‰å®Œæ•´çš„æ•…äº‹å…§å®¹ï¼ˆè‡³å°‘2000-3000å­—ï¼‰
4. å¦‚æœä¸Šä¸€ç« å°šæœªçµæŸï¼Œè«‹å…ˆå®Œæˆè©²ç« ç¯€
5. ç« ç¯€æ¨™é¡Œæ ¼å¼ï¼š### ç¬¬Xç« ï¼šæ¨™é¡Œ
6. ç¦æ­¢å‡ºç¾å¤§ç¶±ã€è¦åŠƒã€æ•…äº‹ç°¡ä»‹ç­‰å…§å®¹
7. ç¦æ­¢ä½¿ç”¨æ¢åˆ—å¼èªªæ˜ï¼Œè¦ç”¨æ•˜äº‹æ–‡é«”

ç¹¼çºŒæ’°å¯«å°èªªæ­£æ–‡ï¼š`;
        
        showStatus('loading', 'çºŒç¯‡ç”Ÿæˆä¸­...');
        continueBtn.disabled = true;
        generateBtn.disabled = true;

        try {
          const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify({
              contents: [{ parts: [{ text: continuePrompt }] }],
            }),
          });
          const data = await response.json();
          
          if (data.error) {
            showStatus('error', 'éŒ¯èª¤ï¼š' + data.error.message);
            return;
          }
          
          if (data.candidates && data.candidates.length > 0) {
            const parts = data.candidates[0].content.parts || [];
            const continuation = parts.map(p => p.text || '').join('').trim();
            if (continuation) {
              latestStory += '\n\n' + continuation;
              resultDiv.textContent = latestStory;
              try {
                localStorage.setItem('savedStory', latestStory);
              } catch (e) {
                showStatus('error', 'æ•…äº‹å…§å®¹éé•·ï¼Œæœªèƒ½è‡ªå‹•å„²å­˜');
              }
              showStatus('success', 'çºŒç¯‡å®Œæˆï¼');
              downloadBtn.disabled = false;
              speakBtn.disabled = false;
              parseAndShowChapters(latestStory);
            } else {
              showStatus('error', 'æ²’æœ‰ç²å¾—çºŒç¯‡å…§å®¹ï¼Œå¯èƒ½å·²å®Œçµ');
            }
          } else {
            showStatus('error', 'æ²’æœ‰ç²å¾—çºŒç¯‡å…§å®¹ï¼Œå¯èƒ½å·²å®Œçµ');
          }
        } catch (err) {
          showStatus('error', 'è«‹æ±‚å¤±æ•—ï¼š' + err.message);
        } finally {
          continueBtn.disabled = false;
          generateBtn.disabled = false;
        }
      });

      // ==================== ä¸‹è¼‰åŠŸèƒ½ ====================
      function downloadFile(filename, text, mimeType = 'text/plain') {
        const link = document.createElement('a');
        link.setAttribute('href', `data:${mimeType};charset=utf-8,` + encodeURIComponent(text));
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function generateFilename(extension = 'txt') {
        // å–å¾—ä¸»é¡Œ
        const theme = themeSelect.value || '';
        
        // å–å¾—æ‰€æœ‰äººç‰©åå­—
        const characterRows = Array.from(charactersContainer.querySelectorAll('.character-row'));
        const names = characterRows
          .map(row => row.querySelector('.char-name').value.trim())
          .filter(name => name !== '');
        
        // å˜—è©¦å¾æ•…äº‹å…§å®¹ä¸­æå–æ¨™é¡Œï¼ˆé€šå¸¸åœ¨é–‹é ­æœ‰ ## æ¨™é¡Œ æ ¼å¼ï¼‰
        let storyTitle = '';
        if (latestStory) {
          const titleMatch = latestStory.match(/##\s*([^\n#]+)/);
          if (titleMatch) {
            storyTitle = titleMatch[1].trim();
          }
        }
        
        // çµ„åˆæª”å
        let filename = '';
        
        // å„ªå…ˆä½¿ç”¨æ•…äº‹æ¨™é¡Œ
        if (storyTitle) {
          filename = storyTitle;
        } else if (theme) {
          filename = theme;
        } else {
          filename = 'ç”Ÿæˆå°èªª';
        }
        
        // åŠ å…¥äººç‰©åå­—ï¼ˆæœ€å¤š3å€‹ï¼‰
        if (names.length > 0) {
          const displayNames = names.slice(0, 3).join('ã€');
          filename += `_${displayNames}`;
          if (names.length > 3) {
            filename += 'ç­‰';
          }
        }
        
        // ç§»é™¤ä¸é©åˆæª”åçš„å­—å…ƒ
        filename = filename.replace(/[\\/:*?"<>|]/g, '_');
        
        return filename + '.' + extension;
      }

      // ç”Ÿæˆæ‰‹æ©Ÿé–±è®€ç‰ˆ HTMLï¼ˆå®Œå…¨é›¢ç·šå¯ç”¨ï¼‰
      function generateMobileHTML(text) {
        // æå–æ¨™é¡Œ
        let title = 'å°èªªé–±è®€';
        const titleMatch = text.match(/##\s*([^\n#]+)/);
        if (titleMatch) {
          title = titleMatch[1].trim();
        }
        
        // è™•ç†æ–‡å­—å…§å®¹
        // 1. å°‡ ### æ¨™é¡Œè½‰ç‚º HTML æ¨™ç±¤
        // 2. å°‡æ®µè½è½‰ç‚º <p> æ¨™ç±¤
        // 3. ä¿ç•™ç©ºè¡Œä½œç‚ºæ®µè½åˆ†éš”
        
        let processedContent = text
          // ç« ç¯€æ¨™é¡Œ (### ç¬¬Xç« ï¼šæ¨™é¡Œ)
          .replace(/^###\s*(.+)$/gm, '<h2 class="chapter-title">$1</h2>')
          // ä¸»æ¨™é¡Œ (## æ¨™é¡Œ)
          .replace(/^##\s*(.+)$/gm, '<h1 class="main-title">$1</h1>')
          // åˆ†éš”ç·š
          .replace(/^[-â€”]{3,}$/gm, '<hr class="divider">')
          // ç²—é«”
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          // æ–œé«”
          .replace(/\*(.+?)\*/g, '<em>$1</em>');
        
        // å°‡é€£çºŒæ–‡å­—è½‰ç‚ºæ®µè½
        const lines = processedContent.split('\n');
        let htmlContent = '';
        let currentParagraph = '';
        
        for (const line of lines) {
          const trimmed = line.trim();
          
          if (trimmed === '') {
            // ç©ºè¡Œï¼šçµæŸç•¶å‰æ®µè½
            if (currentParagraph) {
              htmlContent += `<p>${currentParagraph}</p>\n`;
              currentParagraph = '';
            }
          } else if (trimmed.startsWith('<h1') || trimmed.startsWith('<h2') || trimmed.startsWith('<hr')) {
            // å·²è™•ç†çš„ HTML æ¨™ç±¤ï¼šå…ˆçµæŸç•¶å‰æ®µè½ï¼Œå†æ·»åŠ æ¨™ç±¤
            if (currentParagraph) {
              htmlContent += `<p>${currentParagraph}</p>\n`;
              currentParagraph = '';
            }
            htmlContent += trimmed + '\n';
          } else {
            // æ™®é€šæ–‡å­—ï¼šç´¯åŠ åˆ°ç•¶å‰æ®µè½
            currentParagraph += (currentParagraph ? '' : '') + trimmed;
          }
        }
        
        // è™•ç†æœ€å¾Œä¸€å€‹æ®µè½
        if (currentParagraph) {
          htmlContent += `<p>${currentParagraph}</p>\n`;
        }
        
        // è¨ˆç®—å­—æ•¸
        const wordCount = text.replace(/[\\s\\n#*_\\-]/g, '').length;
        const wordCountDisplay = wordCount >= 10000 
          ? (wordCount / 10000).toFixed(1) + ' è¬å­—'
          : wordCount >= 1000 
            ? (wordCount / 1000).toFixed(1) + ' åƒå­—'
            : wordCount + ' å­—';
        
        // ç”Ÿæˆå®Œæ•´çš„é›¢ç·š HTML
        return `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#faf8f5">
  <title>${title}</title>
  <style>
    /* ===== åŸºç¤é‡ç½® ===== */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* ===== CSS è®Šæ•¸ï¼ˆæ”¯æ´æ·±è‰²æ¨¡å¼ï¼‰===== */
    :root {
      --bg: #faf8f5;
      --bg-card: #ffffff;
      --text: #2c2c2c;
      --text-light: #666666;
      --accent: #d4a574;
      --border: #e8e4e0;
      --shadow: rgba(0, 0, 0, 0.06);
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1a1a1a;
        --bg-card: #242424;
        --text: #e8e4e0;
        --text-light: #999999;
        --accent: #d4a574;
        --border: #333333;
        --shadow: rgba(0, 0, 0, 0.3);
      }
    }
    
    /* ===== ä¸»é«”æ¨£å¼ ===== */
    html {
      scroll-behavior: smooth;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 
        "Noto Serif TC", 
        "Source Han Serif TC", 
        "PingFang TC", 
        "Microsoft JhengHei", 
        "å¾®è»Ÿæ­£é»‘é«”",
        "Apple LiGothic",
        serif;
      font-size: 18px;
      line-height: 1.9;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* ===== é ‚éƒ¨è³‡è¨Šæ¬„ ===== */
    .header {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      box-shadow: 0 2px 8px var(--shadow);
    }
    
    .header-title {
      font-size: 14px;
      color: var(--text-light);
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60%;
    }
    
    .header-info {
      font-size: 12px;
      color: var(--text-light);
    }
    
    /* ===== æ§åˆ¶é¢æ¿ ===== */
    .controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }
    
    .control-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: var(--bg-card);
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px var(--shadow);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
    
    /* ===== è¨­å®šé¢æ¿ ===== */
    .settings-panel {
      display: none;
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 32px var(--shadow);
      z-index: 101;
      min-width: 200px;
    }
    
    .settings-panel.show {
      display: block;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .setting-item {
      margin-bottom: 16px;
    }
    
    .setting-item:last-child {
      margin-bottom: 0;
    }
    
    .setting-label {
      display: block;
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 8px;
    }
    
    .setting-buttons {
      display: flex;
      gap: 8px;
    }
    
    .setting-btn {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .setting-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    /* ===== å…§å®¹å€åŸŸ ===== */
    .content {
      max-width: 700px;
      margin: 0 auto;
      padding: 30px 24px 100px;
    }
    
    /* ===== æ¨™é¡Œæ¨£å¼ ===== */
    .main-title {
      font-size: 1.6em;
      font-weight: 700;
      text-align: center;
      margin: 0 0 30px 0;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--accent);
      color: var(--text);
      line-height: 1.4;
    }
    
    .chapter-title {
      font-size: 1.25em;
      font-weight: 600;
      margin: 50px 0 25px 0;
      padding: 15px 0;
      color: var(--text);
      border-left: 4px solid var(--accent);
      padding-left: 16px;
      background: linear-gradient(90deg, var(--bg-card), transparent);
    }
    
    /* ===== æ®µè½æ¨£å¼ ===== */
    p {
      margin: 0 0 1.5em 0;
      text-align: justify;
      text-indent: 2em;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    /* ===== åˆ†éš”ç·š ===== */
    .divider {
      border: none;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border), transparent);
      margin: 40px 0;
    }
    
    /* ===== å¼·èª¿æ¨£å¼ ===== */
    strong {
      color: var(--accent);
      font-weight: 600;
    }
    
    em {
      font-style: italic;
      color: var(--text-light);
    }
    
    /* ===== å›åˆ°é ‚éƒ¨æŒ‰éˆ• ===== */
    .back-to-top {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .back-to-top.show {
      opacity: 1;
      pointer-events: auto;
    }
    
    /* ===== å­—é«”å¤§å°è®ŠåŒ– ===== */
    body.font-small {
      font-size: 16px;
    }
    
    body.font-medium {
      font-size: 18px;
    }
    
    body.font-large {
      font-size: 21px;
    }
    
    body.font-xlarge {
      font-size: 24px;
    }
    
    /* ===== è¡Œè·è®ŠåŒ– ===== */
    body.line-compact {
      line-height: 1.6;
    }
    
    body.line-normal {
      line-height: 1.9;
    }
    
    body.line-loose {
      line-height: 2.2;
    }
    
    /* ===== éŸ¿æ‡‰å¼èª¿æ•´ ===== */
    @media (max-width: 480px) {
      body {
        font-size: 17px;
      }
      
      .content {
        padding: 20px 18px 100px;
      }
      
      .main-title {
        font-size: 1.4em;
      }
      
      .chapter-title {
        font-size: 1.15em;
      }
    }
    
    /* ===== é–±è®€é€²åº¦æ¢ ===== */
    .progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: var(--accent);
      width: 0%;
      z-index: 1000;
      transition: width 0.1s;
    }
  </style>
</head>
<body class="font-medium line-normal">
  <!-- é–±è®€é€²åº¦æ¢ -->
  <div class="progress-bar" id="progressBar"></div>
  
  <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
  <header class="header">
    <h1 class="header-title">${title}</h1>
    <span class="header-info">${wordCountDisplay}</span>
  </header>
  
  <!-- ä¸»è¦å…§å®¹ -->
  <main class="content">
    ${htmlContent}
  </main>
  
  <!-- æ§åˆ¶æŒ‰éˆ• -->
  <div class="controls">
    <button class="control-btn back-to-top" id="backToTop" title="å›åˆ°é ‚éƒ¨">â†‘</button>
    <button class="control-btn" id="settingsBtn" title="é–±è®€è¨­å®š">âš™</button>
  </div>
  
  <!-- è¨­å®šé¢æ¿ -->
  <div class="settings-panel" id="settingsPanel">
    <div class="setting-item">
      <span class="setting-label">å­—é«”å¤§å°</span>
      <div class="setting-buttons">
        <button class="setting-btn" data-font="small">å°</button>
        <button class="setting-btn active" data-font="medium">ä¸­</button>
        <button class="setting-btn" data-font="large">å¤§</button>
        <button class="setting-btn" data-font="xlarge">ç‰¹å¤§</button>
      </div>
    </div>
    <div class="setting-item">
      <span class="setting-label">è¡Œè·</span>
      <div class="setting-buttons">
        <button class="setting-btn" data-line="compact">ç·Šæ¹Š</button>
        <button class="setting-btn active" data-line="normal">æ¨™æº–</button>
        <button class="setting-btn" data-line="loose">å¯¬é¬†</button>
      </div>
    </div>
  </div>
  
  <` + `script>
    // é–±è®€é€²åº¦
    const progressBar = document.getElementById('progressBar');
    const backToTop = document.getElementById('backToTop');
    
    window.addEventListener('scroll', () => {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = (scrollTop / docHeight) * 100;
      progressBar.style.width = progress + '%';
      
      // é¡¯ç¤º/éš±è—å›åˆ°é ‚éƒ¨æŒ‰éˆ•
      if (scrollTop > 500) {
        backToTop.classList.add('show');
      } else {
        backToTop.classList.remove('show');
      }
    });
    
    // å›åˆ°é ‚éƒ¨
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // è¨­å®šé¢æ¿
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    
    settingsBtn.addEventListener('click', () => {
      settingsPanel.classList.toggle('show');
    });
    
    // é»æ“Šå¤–éƒ¨é—œé–‰è¨­å®šé¢æ¿
    document.addEventListener('click', (e) => {
      if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
        settingsPanel.classList.remove('show');
      }
    });
    
    // å­—é«”å¤§å°è¨­å®š
    document.querySelectorAll('[data-font]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-font]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.body.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
        document.body.classList.add('font-' + btn.dataset.font);
        
        // å„²å­˜è¨­å®š
        localStorage.setItem('reader-font', btn.dataset.font);
      });
    });
    
    // è¡Œè·è¨­å®š
    document.querySelectorAll('[data-line]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-line]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.body.classList.remove('line-compact', 'line-normal', 'line-loose');
        document.body.classList.add('line-' + btn.dataset.line);
        
        // å„²å­˜è¨­å®š
        localStorage.setItem('reader-line', btn.dataset.line);
      });
    });
    
    // è¼‰å…¥å·²å„²å­˜çš„è¨­å®š
    const savedFont = localStorage.getItem('reader-font');
    const savedLine = localStorage.getItem('reader-line');
    
    if (savedFont) {
      document.querySelectorAll('[data-font]').forEach(b => b.classList.remove('active'));
      const fontBtn = document.querySelector('[data-font="' + savedFont + '"]');
      if (fontBtn) {
        fontBtn.classList.add('active');
        document.body.classList.remove('font-small', 'font-medium', 'font-large', 'font-xlarge');
        document.body.classList.add('font-' + savedFont);
      }
    }
    
    if (savedLine) {
      document.querySelectorAll('[data-line]').forEach(b => b.classList.remove('active'));
      const lineBtn = document.querySelector('[data-line="' + savedLine + '"]');
      if (lineBtn) {
        lineBtn.classList.add('active');
        document.body.classList.remove('line-compact', 'line-normal', 'line-loose');
        document.body.classList.add('line-' + savedLine);
      }
    }
  <` + `/script>
</body>
</html>`;
      }

      // ä¸‹è¼‰ä¸‹æ‹‰é¸å–®æ§åˆ¶
      const downloadDropdown = document.querySelector('.download-dropdown');
      const downloadMenu = document.getElementById('downloadMenu');
      
      downloadBtn.addEventListener('click', (e) => {
        if (downloadBtn.disabled) return;
        e.stopPropagation();
        downloadDropdown.classList.toggle('open');
      });
      
      // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
      document.addEventListener('click', (e) => {
        if (!downloadDropdown.contains(e.target)) {
          downloadDropdown.classList.remove('open');
        }
      });
      
      // ä¸‹è¼‰é¸é …é»æ“Šäº‹ä»¶
      // å„ªåŒ– TXT æ ¼å¼ï¼Œè®“æ‰‹æ©Ÿé–±è®€æ›´èˆ’é©
      function optimizeTxtForMobile(text) {
        const MAX_LINE_WIDTH = 25; // æ¯è¡Œæœ€å¤§å­—æ•¸ï¼ˆé©åˆæ‰‹æ©Ÿè¢å¹•ï¼‰
        
        let result = '';
        const paragraphs = text.split(/\n/);
        
        for (let i = 0; i < paragraphs.length; i++) {
          const para = paragraphs[i];
          const trimmed = para.trim();
          
          // ç©ºè¡Œä¿ç•™
          if (trimmed === '') {
            result += '\n';
            continue;
          }
          
          // æª¢æ¸¬æ˜¯å¦ç‚ºæ¨™é¡Œè¡Œï¼ˆ## æˆ– ### é–‹é ­ï¼Œæˆ–ã€Œç¬¬Xç« ã€ç­‰ï¼‰
          const isTitle = /^#{1,3}\s/.test(trimmed) || 
                          /^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒè¬é›¶å£¹è²³åƒè‚†ä¼é™¸æŸ’æŒç–æ‹¾ä½°ä»Ÿ\d]+[ç« ç¯€å›å·éƒ¨é›†ç¯‡]/.test(trimmed) ||
                          /^[åºæ¥”çµ‚å°¾ç•ªå¤–]/.test(trimmed) ||
                          /^[-â€”=]{3,}$/.test(trimmed);
          
          if (isTitle) {
            // æ¨™é¡Œï¼šç§»é™¤ markdown ç¬¦è™Ÿï¼Œå‰å¾ŒåŠ ç©ºè¡Œ
            let titleText = trimmed.replace(/^#{1,3}\s*/, '');
            
            // åŠ å…¥åˆ†éš”ç·šè£é£¾
            if (/^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒè¬é›¶å£¹è²³åƒè‚†ä¼é™¸æŸ’æŒç–æ‹¾ä½°ä»Ÿ\d]+[ç« ç¯€å›å·éƒ¨é›†ç¯‡]/.test(titleText) ||
                /^[åºæ¥”çµ‚å°¾ç•ªå¤–]/.test(titleText)) {
              result += '\n';
              result += 'â•'.repeat(20) + '\n';
              result += '\n';
              result += 'ã€€ã€€' + titleText + '\n';
              result += '\n';
              result += 'â•'.repeat(20) + '\n';
            } else {
              // ä¸»æ¨™é¡Œ
              result += '\n';
              result += 'â˜… ' + titleText + ' â˜…\n';
            }
            result += '\n';
            continue;
          }
          
          // æ™®é€šæ®µè½ï¼šè‡ªå‹•æ›è¡Œ
          // å…ˆè™•ç†é¦–è¡Œç¸®æ’
          let content = trimmed;
          let lines = [];
          let currentLine = 'ã€€ã€€'; // é¦–è¡Œç¸®æ’ï¼ˆå…©å€‹å…¨å½¢ç©ºæ ¼ï¼‰
          
          for (let j = 0; j < content.length; j++) {
            const char = content[j];
            currentLine += char;
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›è¡Œ
            // è¨ˆç®—å¯¦éš›å¯¬åº¦ï¼ˆä¸­æ–‡å­—ç®—1ï¼Œè‹±æ–‡å­—æ¯/æ•¸å­—ç®—0.5ï¼‰
            const lineWidth = [...currentLine].reduce((sum, c) => {
              return sum + (/[\u4e00-\u9fff\u3000-\u303f\uff00-\uffef]/.test(c) ? 1 : 0.5);
            }, 0);
            
            if (lineWidth >= MAX_LINE_WIDTH) {
              // å˜—è©¦åœ¨æ¨™é»ç¬¦è™Ÿè™•æ–·è¡Œ
              const lastPunctuationIndex = currentLine.search(/[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€ã€ã€ï¼‰ã€‘â€¦â€”ï½\s][^ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€ã€ã€ï¼‰ã€‘â€¦â€”ï½\s]*$/);
              
              if (lastPunctuationIndex > currentLine.length * 0.5) {
                // åœ¨æ¨™é»å¾Œæ–·è¡Œ
                lines.push(currentLine.substring(0, lastPunctuationIndex + 1));
                currentLine = currentLine.substring(lastPunctuationIndex + 1);
              } else {
                // ç›´æ¥æ–·è¡Œ
                lines.push(currentLine);
                currentLine = '';
              }
            }
          }
          
          // åŠ å…¥æœ€å¾Œä¸€è¡Œ
          if (currentLine) {
            lines.push(currentLine);
          }
          
          result += lines.join('\n') + '\n\n';
        }
        
        // æ¸…ç†å¤šé¤˜ç©ºè¡Œï¼ˆè¶…é2å€‹é€£çºŒç©ºè¡Œè®Šæˆ2å€‹ï¼‰
        result = result.replace(/\n{4,}/g, '\n\n\n');
        
        return result.trim();
      }

      downloadMenu.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!latestStory) return;
          
          const format = btn.dataset.format;
          
          if (format === 'txt') {
            // ä¸‹è¼‰å„ªåŒ–å¾Œçš„ TXT
            const optimizedTxt = optimizeTxtForMobile(latestStory);
            const filename = generateFilename('txt');
            downloadFile(filename, optimizedTxt, 'text/plain');
            showStatus('success', `ğŸ“„ å·²ä¸‹è¼‰ ${filename}`);
          } else if (format === 'html') {
            // ä¸‹è¼‰ HTML æ‰‹æ©Ÿé–±è®€ç‰ˆ
            const htmlContent = generateMobileHTML(latestStory);
            const filename = generateFilename('html');
            downloadFile(filename, htmlContent, 'text/html');
            showStatus('success', `ğŸ“± å·²ä¸‹è¼‰ ${filename}ï¼ˆæ‰‹æ©Ÿé–±è®€ç‰ˆï¼‰`);
          }
          
          downloadDropdown.classList.remove('open');
        });
      });

      // ==================== æ›¸ç±¤åŠŸèƒ½ (å¤§å¹…å„ªåŒ–) ====================
      function loadBookmarks() {
        try {
          const raw = localStorage.getItem('bookmarks');
          if (!raw) return [];
          return JSON.parse(raw);
        } catch (e) {
          console.warn('ç„¡æ³•è®€å–æ›¸ç±¤ï¼š', e);
          return [];
        }
      }

      function saveBookmarks(bookmarks) {
        try {
          localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        } catch (e) {
          showStatus('error', 'æ›¸ç±¤å„²å­˜å¤±æ•—ï¼Œå¯èƒ½å·²é”å„²å­˜ä¸Šé™');
        }
      }

      function formatDate(timestamp) {
        const date = new Date(timestamp);
        return `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
      }

      function formatWordCount(text) {
        const count = text.length;
        if (count >= 10000) return (count / 10000).toFixed(1) + ' è¬å­—';
        if (count >= 1000) return (count / 1000).toFixed(1) + ' åƒå­—';
        return count + ' å­—';
      }

      function getFilteredAndSortedBookmarks() {
        let bookmarks = loadBookmarks();
        const searchTerm = bookmarkSearch.value.trim().toLowerCase();
        const sortBy = bookmarkSort.value;

        // æœå°‹éæ¿¾
        if (searchTerm) {
          bookmarks = bookmarks.filter(bm => 
            (bm.title && bm.title.toLowerCase().includes(searchTerm)) ||
            (bm.tags && bm.tags.some(t => t.toLowerCase().includes(searchTerm))) ||
            (bm.notes && bm.notes.toLowerCase().includes(searchTerm))
          );
        }

        // æ’åº
        switch (sortBy) {
          case 'newest':
            bookmarks.sort((a, b) => b.id - a.id);
            break;
          case 'oldest':
            bookmarks.sort((a, b) => a.id - b.id);
            break;
          case 'name':
            bookmarks.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            break;
          case 'length':
            bookmarks.sort((a, b) => (b.content?.length || 0) - (a.content?.length || 0));
            break;
        }

        return bookmarks;
      }

      function renderBookmarks() {
        const allBookmarks = loadBookmarks();
        const bookmarks = getFilteredAndSortedBookmarks();
        
        bookmarkCount.textContent = `${allBookmarks.length} ç¯‡`;
        bookmarkList.innerHTML = '';

        if (bookmarks.length === 0) {
          bookmarkList.innerHTML = `
            <li class="bookmark-empty">
              <div class="bookmark-empty-icon">ğŸ“š</div>
              <div>${allBookmarks.length === 0 ? 'é‚„æ²’æœ‰æ›¸ç±¤ï¼Œç”Ÿæˆæ•…äº‹å¾Œé»æ“Šã€Œå„²å­˜ç›®å‰æ•…äº‹ã€' : 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ›¸ç±¤'}</div>
            </li>
          `;
          return;
        }

        bookmarks.forEach(bm => {
          const li = document.createElement('li');
          li.className = 'bookmark-item';
          li.innerHTML = `
            <div class="bookmark-item-icon">ğŸ“–</div>
            <div class="bookmark-item-content">
              <div class="bookmark-item-title">${bm.title || 'æœªå‘½åæ›¸ç±¤'}</div>
              <div class="bookmark-item-meta">
                <span>ğŸ“… ${formatDate(bm.id)}</span>
                <span>ğŸ“ ${formatWordCount(bm.content || '')}</span>
                ${bm.tags && bm.tags.length > 0 ? `<span>ğŸ·ï¸ ${bm.tags.slice(0,3).join(', ')}</span>` : ''}
              </div>
            </div>
            <div class="bookmark-item-actions">
              <button type="button" class="btn-load" data-action="load">è¼‰å…¥</button>
              <button type="button" data-action="edit">ç·¨è¼¯</button>
              <button type="button" data-action="delete">åˆªé™¤</button>
            </div>
          `;

          // è¼‰å…¥
          li.querySelector('[data-action="load"]').addEventListener('click', () => {
            latestStory = bm.content;
            resultDiv.textContent = latestStory;
            downloadBtn.disabled = !latestStory;
            continueBtn.disabled = !latestStory;
            speakBtn.disabled = !latestStory;
            try {
              localStorage.setItem('savedStory', latestStory);
            } catch (e) {}
            showStatus('success', 'æ›¸ç±¤å·²è¼‰å…¥');
            parseAndShowChapters(latestStory);
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
          });

          // ç·¨è¼¯
          li.querySelector('[data-action="edit"]').addEventListener('click', () => {
            editingBookmarkId = bm.id;
            editBookmarkTitle.value = bm.title || '';
            editBookmarkTags.value = (bm.tags || []).join(', ');
            editBookmarkNotes.value = bm.notes || '';
            editModal.classList.add('show');
          });

          // åˆªé™¤
          li.querySelector('[data-action="delete"]').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ›¸ç±¤å—ï¼Ÿ')) {
              const list = loadBookmarks().filter(b => b.id !== bm.id);
              saveBookmarks(list);
              renderBookmarks();
              showStatus('success', 'æ›¸ç±¤å·²åˆªé™¤');
            }
          });

          bookmarkList.appendChild(li);
        });
      }

      // æ–°å¢æ›¸ç±¤
      addBookmarkBtn.addEventListener('click', () => {
        if (!latestStory || latestStory.trim() === '') {
          showStatus('error', 'æ²’æœ‰å¯å„²å­˜çš„å…§å®¹');
          return;
        }
        const bookmarks = loadBookmarks();
        let title = latestStory.trim().replace(/\s+/g, ' ').substring(0, 50);
        if (title.length < latestStory.trim().length) title += '...';
        
        const newBookmark = {
          id: Date.now(),
          title,
          content: latestStory,
          tags: [],
          notes: '',
        };
        bookmarks.push(newBookmark);
        saveBookmarks(bookmarks);
        renderBookmarks();
        showStatus('success', 'æ›¸ç±¤å·²å„²å­˜ï¼');
      });

      // æœå°‹å’Œæ’åº
      bookmarkSearch.addEventListener('input', renderBookmarks);
      bookmarkSort.addEventListener('change', renderBookmarks);

      // ç·¨è¼¯å½ˆçª—
      cancelEditBtn.addEventListener('click', () => {
        editModal.classList.remove('show');
        editingBookmarkId = null;
      });

      saveEditBtn.addEventListener('click', () => {
        if (!editingBookmarkId) return;
        const bookmarks = loadBookmarks();
        const bm = bookmarks.find(b => b.id === editingBookmarkId);
        if (bm) {
          bm.title = editBookmarkTitle.value.trim() || bm.title;
          bm.tags = editBookmarkTags.value.split(',').map(t => t.trim()).filter(t => t);
          bm.notes = editBookmarkNotes.value.trim();
          saveBookmarks(bookmarks);
          renderBookmarks();
          showStatus('success', 'æ›¸ç±¤å·²æ›´æ–°');
        }
        editModal.classList.remove('show');
        editingBookmarkId = null;
      });

      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) {
          editModal.classList.remove('show');
          editingBookmarkId = null;
        }
      });

      // åŒ¯å‡ºæ›¸ç±¤
      exportBookmarksBtn.addEventListener('click', () => {
        const bookmarks = loadBookmarks();
        if (bookmarks.length === 0) {
          showStatus('error', 'æ²’æœ‰æ›¸ç±¤å¯åŒ¯å‡º');
          return;
        }
        const dataStr = JSON.stringify(bookmarks, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `å°èªªæ›¸ç±¤_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        showStatus('success', 'æ›¸ç±¤å·²åŒ¯å‡º');
      });

      // åŒ¯å…¥æ›¸ç±¤
      importBookmarksBtn.addEventListener('click', () => {
        importFileInput.click();
      });

      importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (!Array.isArray(imported)) throw new Error('æ ¼å¼éŒ¯èª¤ï¼šä¸æ˜¯é™£åˆ—');
            
            if (imported.length === 0) {
              showStatus('error', 'åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆä¸­æ²’æœ‰æ›¸ç±¤');
              return;
            }
            
            const existing = loadBookmarks();
            const existingIds = new Set(existing.map(b => b.id));
            let added = 0;
            let skipped = 0;
            
            imported.forEach(bm => {
              // ç¢ºä¿æ›¸ç±¤æœ‰å¿…è¦çš„æ¬„ä½
              if (bm.content) {
                // å¦‚æœæ²’æœ‰ idï¼Œç”Ÿæˆä¸€å€‹æ–°çš„
                if (!bm.id) {
                  bm.id = Date.now() + Math.random();
                }
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if (!existingIds.has(bm.id)) {
                  existing.push(bm);
                  existingIds.add(bm.id);
                  added++;
                } else {
                  skipped++;
                }
              }
            });
            
            if (added > 0) {
              saveBookmarks(existing);
              renderBookmarks();
              
              if (skipped > 0) {
                showStatus('success', `å·²åŒ¯å…¥ ${added} ç­†æ›¸ç±¤ï¼ˆ${skipped} ç­†é‡è¤‡å·²è·³éï¼‰`);
              } else {
                showStatus('success', `å·²åŒ¯å…¥ ${added} ç­†æ›¸ç±¤`);
              }
            } else if (skipped > 0) {
              showStatus('warning', `æ‰€æœ‰ ${skipped} ç­†æ›¸ç±¤éƒ½å·²å­˜åœ¨ï¼Œæ²’æœ‰æ–°å¢`);
            } else {
              showStatus('error', 'åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„æ›¸ç±¤');
            }
            
            // å¼·åˆ¶é‡æ–°æ¸²æŸ“
            setTimeout(() => {
              renderBookmarks();
            }, 100);
            
          } catch (err) {
            console.error('åŒ¯å…¥éŒ¯èª¤ï¼š', err);
            showStatus('error', 'åŒ¯å…¥å¤±æ•—ï¼š' + (err.message || 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤'));
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      });

      // ==================== æƒ…ç·’æœ—è®€åŠŸèƒ½ ====================
      let speechSynth = window.speechSynthesis;
      let currentUtterance = null;
      let isSpeaking = false;
      let isPaused = false;
      let speechSegments = [];
      let currentSegmentIndex = 0;
      let availableVoices = [];

      // å„²å­˜æœ—è®€é€²åº¦
      function saveSpeechProgress() {
        try {
          const progress = {
            segmentIndex: currentSegmentIndex,
            rate: speechRate.value,
            pitch: speechPitch.value,
            voice: voiceSelect.value,
            emotion: emotionMode.value,
            timestamp: Date.now()
          };
          localStorage.setItem('speechProgress', JSON.stringify(progress));
        } catch (e) {
          console.warn('ç„¡æ³•å„²å­˜æœ—è®€é€²åº¦ï¼š', e);
        }
      }

      // è¼‰å…¥æœ—è®€é€²åº¦
      function loadSpeechProgress() {
        try {
          const raw = localStorage.getItem('speechProgress');
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          return null;
        }
      }

      // æ¸…é™¤æœ—è®€é€²åº¦
      function clearSpeechProgress() {
        try {
          localStorage.removeItem('speechProgress');
        } catch (e) {}
      }

      // è¼‰å…¥èªéŸ³åˆ—è¡¨ï¼ˆåªé¡¯ç¤ºä¸­æ–‡èªéŸ³ï¼‰
      function loadVoices() {
        availableVoices = speechSynth.getVoices();
        voiceSelect.innerHTML = '';
        
        // åªç¯©é¸ä¸­æ–‡èªéŸ³
        const zhVoices = availableVoices.filter(v => 
          v.lang.includes('zh') || 
          v.lang.includes('TW') || 
          v.lang.includes('CN') ||
          v.lang.includes('HK') ||
          v.name.includes('ä¸­æ–‡') ||
          v.name.includes('Chinese') ||
          v.name.includes('Mandarin') ||
          v.name.includes('Cantonese')
        );
        
        // æŒ‰èªè¨€åˆ†é¡
        const twVoices = zhVoices.filter(v => v.lang.includes('TW') || v.lang.includes('zh-Hant') || v.name.includes('å°'));
        const cnVoices = zhVoices.filter(v => (v.lang.includes('CN') || v.lang.includes('zh-Hans') || v.lang === 'zh') && !twVoices.includes(v));
        const hkVoices = zhVoices.filter(v => v.lang.includes('HK') || v.name.includes('ç²µ') || v.name.includes('Cantonese'));
        const otherZhVoices = zhVoices.filter(v => !twVoices.includes(v) && !cnVoices.includes(v) && !hkVoices.includes(v));
        
        // ç°¡åŒ–èªéŸ³åç¨±é¡¯ç¤º
        function formatVoiceName(voice) {
          let name = voice.name;
          // ç§»é™¤å¸¸è¦‹çš„å†—é•·å‰ç¶´
          name = name.replace(/Microsoft /g, '');
          name = name.replace(/Google /g, '');
          name = name.replace(/Apple /g, '');
          name = name.replace(/ Online \(Natural\)/g, '');
          name = name.replace(/ - Chinese \(.*\)/g, '');
          
          // æ·»åŠ èªè¨€æ¨™è¨˜
          if (voice.lang.includes('TW') || voice.lang.includes('zh-Hant')) {
            return `ğŸ‡¹ğŸ‡¼ ${name}`;
          } else if (voice.lang.includes('CN') || voice.lang.includes('zh-Hans') || voice.lang === 'zh') {
            return `ğŸ‡¨ğŸ‡³ ${name}`;
          } else if (voice.lang.includes('HK')) {
            return `ğŸ‡­ğŸ‡° ${name}`;
          }
          return name;
        }
        
        // ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ï¼‰
        if (twVoices.length > 0) {
          const group = document.createElement('optgroup');
          group.label = 'ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ï¼‰';
          twVoices.forEach((voice, i) => {
            const option = document.createElement('option');
            option.value = voice.name;
            option.textContent = formatVoiceName(voice);
            if (i === 0) option.selected = true;
            group.appendChild(option);
          });
          voiceSelect.appendChild(group);
        }
        
        // ç°¡é«”ä¸­æ–‡ï¼ˆä¸­åœ‹ï¼‰
        if (cnVoices.length > 0) {
          const group = document.createElement('optgroup');
          group.label = 'ğŸ‡¨ğŸ‡³ ç°¡é«”ä¸­æ–‡ï¼ˆä¸­åœ‹ï¼‰';
          cnVoices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.name;
            option.textContent = formatVoiceName(voice);
            group.appendChild(option);
          });
          voiceSelect.appendChild(group);
        }
        
        // ç²µèªï¼ˆé¦™æ¸¯ï¼‰
        if (hkVoices.length > 0) {
          const group = document.createElement('optgroup');
          group.label = 'ğŸ‡­ğŸ‡° ç²µèªï¼ˆé¦™æ¸¯ï¼‰';
          hkVoices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.name;
            option.textContent = formatVoiceName(voice);
            group.appendChild(option);
          });
          voiceSelect.appendChild(group);
        }
        
        // å…¶ä»–ä¸­æ–‡
        if (otherZhVoices.length > 0) {
          const group = document.createElement('optgroup');
          group.label = 'ğŸŒ å…¶ä»–ä¸­æ–‡';
          otherZhVoices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.name;
            option.textContent = formatVoiceName(voice);
            group.appendChild(option);
          });
          voiceSelect.appendChild(group);
        }
        
        // å¦‚æœå®Œå…¨æ²’æœ‰ä¸­æ–‡èªéŸ³
        if (zhVoices.length === 0) {
          const option = document.createElement('option');
          option.textContent = 'âš ï¸ æœªæ‰¾åˆ°ä¸­æ–‡èªéŸ³';
          option.disabled = true;
          voiceSelect.appendChild(option);
          
          // é¡¯ç¤ºæç¤º
          const hint = document.createElement('option');
          hint.textContent = 'è«‹åœ¨ç³»çµ±è¨­å®šä¸­å®‰è£ä¸­æ–‡èªéŸ³';
          hint.disabled = true;
          voiceSelect.appendChild(hint);
        }
      }

      // åˆå§‹åŒ–èªéŸ³
      loadVoices();
      if (speechSynth.onvoiceschanged !== undefined) {
        speechSynth.onvoiceschanged = loadVoices;
      }

      // æƒ…ç·’åˆ†æèˆ‡åƒæ•¸èª¿æ•´
      function analyzeEmotion(text) {
        const mode = emotionMode.value;
        if (mode !== 'auto') {
          return getEmotionParams(mode);
        }
        
        // è‡ªå‹•åµæ¸¬æƒ…ç·’
        const sadKeywords = ['æ‚²å‚·', 'å“­æ³£', 'æ·šæ°´', 'æ­»äº¡', 'é›¢åˆ¥', 'ç—›è‹¦', 'çµ•æœ›', 'å¿ƒç¢', 'å“€å‚·', 'æ‚¼å¿µ', 'å˜†æ¯', 'æ†‚æ„'];
        const excitedKeywords = ['æ¿€å‹•', 'èˆˆå¥®', 'å‹åˆ©', 'è¡åˆº', 'çˆ†ç™¼', 'ç†±è¡€', 'ç‡ƒç‡’', 'æˆ°é¬¥', 'å¶å–Š', 'å¥®èµ·', 'æ€’å¼', 'çªç ´'];
        const mysteriousKeywords = ['ç¥ç§˜', 'é™°æ£®', 'è©­ç•°', 'é»‘æš—', 'æœªçŸ¥', 'ç§˜å¯†', 'éš±è—', 'ææ€–', 'æ‡¸ç–‘', 'è¬åœ˜', 'å¹½æš—', 'è©›å’’'];
        const gentleKeywords = ['æº«æŸ”', 'è¼•è²', 'å¾®ç¬‘', 'æ„›æƒ…', 'ç”œèœœ', 'æ“æŠ±', 'è¦ªå»', 'æº«æš–', 'å‘¢å–ƒ', 'æŸ”æƒ…', 'æµªæ¼«', 'å¿ƒå‹•'];
        const dramaticKeywords = ['éœ‡é©š', 'æ­éœ²', 'è½‰æŠ˜', 'æ„å¤–', 'çœŸç›¸', 'èƒŒå›', 'å¾©ä»‡', 'å‘½é‹', 'å°æ±º', 'é«˜æ½®', 'æ±ºæˆ°'];
        
        let sadScore = sadKeywords.filter(k => text.includes(k)).length;
        let excitedScore = excitedKeywords.filter(k => text.includes(k)).length;
        let mysteriousScore = mysteriousKeywords.filter(k => text.includes(k)).length;
        let gentleScore = gentleKeywords.filter(k => text.includes(k)).length;
        let dramaticScore = dramaticKeywords.filter(k => text.includes(k)).length;
        
        // æª¢æŸ¥æ¨™é»ç¬¦è™Ÿ
        if ((text.match(/ï¼/g) || []).length > 2) excitedScore += 2;
        if ((text.match(/ï¼Ÿ/g) || []).length > 2) mysteriousScore += 1;
        if ((text.match(/â‹¯|â€¦/g) || []).length > 1) sadScore += 1;
        
        const maxScore = Math.max(sadScore, excitedScore, mysteriousScore, gentleScore, dramaticScore);
        
        if (maxScore === 0) return getEmotionParams('narration');
        if (sadScore === maxScore) return getEmotionParams('sad');
        if (excitedScore === maxScore) return getEmotionParams('excited');
        if (mysteriousScore === maxScore) return getEmotionParams('mysterious');
        if (gentleScore === maxScore) return getEmotionParams('gentle');
        if (dramaticScore === maxScore) return getEmotionParams('dramatic');
        
        return getEmotionParams('narration');
      }

      function getEmotionParams(emotion) {
        const baseRate = parseFloat(speechRate.value);
        const basePitch = parseFloat(speechPitch.value);
        
        switch (emotion) {
          case 'sad':
            return { rate: baseRate * 0.8, pitch: basePitch * 0.85, volume: 0.85, pause: 400 };
          case 'excited':
            return { rate: baseRate * 1.15, pitch: basePitch * 1.1, volume: 1.0, pause: 150 };
          case 'mysterious':
            return { rate: baseRate * 0.85, pitch: basePitch * 0.9, volume: 0.9, pause: 350 };
          case 'gentle':
            return { rate: baseRate * 0.9, pitch: basePitch * 1.05, volume: 0.85, pause: 250 };
          case 'dramatic':
            return { rate: baseRate * 1.0, pitch: basePitch * 1.0, volume: 1.0, pause: 300 };
          case 'narration':
          default:
            return { rate: baseRate, pitch: basePitch, volume: 0.95, pause: 200 };
        }
      }

      // åˆ†å‰²æ–‡å­—ç‚ºæ®µè½ï¼ˆä¿æŒæƒ…ç·’é€£è²«ï¼‰
      function splitTextToSegments(text) {
        // æŒ‰æ®µè½å’Œå¥è™Ÿåˆ†å‰²
        const paragraphs = text.split(/\n\n+/);
        const segments = [];
        
        paragraphs.forEach(para => {
          if (!para.trim()) return;
          
          // è¼ƒé•·æ®µè½å†ç´°åˆ†
          if (para.length > 200) {
            const sentences = para.split(/(?<=[ã€‚ï¼ï¼Ÿ])/);
            let chunk = '';
            sentences.forEach(s => {
              if ((chunk + s).length > 150) {
                if (chunk) segments.push(chunk.trim());
                chunk = s;
              } else {
                chunk += s;
              }
            });
            if (chunk) segments.push(chunk.trim());
          } else {
            segments.push(para.trim());
          }
        });
        
        return segments.filter(s => s.length > 0);
      }

      // æœ—è®€å–®ä¸€æ®µè½
      function speakSegment(index) {
        if (index >= speechSegments.length) {
          // æœ—è®€å®Œæˆ
          stopSpeech();
          clearSpeechProgress();
          speechProgressText.textContent = 'âœ… æœ—è®€å®Œæˆ';
          return;
        }
        
        currentSegmentIndex = index;
        saveSpeechProgress(); // å„²å­˜ç•¶å‰é€²åº¦
        
        const text = speechSegments[index];
        const params = analyzeEmotion(text);
        
        const utterance = new SpeechSynthesisUtterance(text);
        
        // è¨­å®šèªéŸ³
        const selectedVoice = availableVoices.find(v => v.name === voiceSelect.value);
        if (selectedVoice) utterance.voice = selectedVoice;
        
        utterance.rate = params.rate;
        utterance.pitch = params.pitch;
        utterance.volume = params.volume;
        
        utterance.onend = () => {
          // æ®µè½é–“åœé “
          setTimeout(() => {
            if (isSpeaking && !isPaused) {
              speakSegment(index + 1);
            }
          }, params.pause);
        };
        
        utterance.onerror = (e) => {
          console.error('æœ—è®€éŒ¯èª¤ï¼š', e);
          if (isSpeaking) speakSegment(index + 1);
        };
        
        // æ›´æ–°é€²åº¦
        const progress = ((index + 1) / speechSegments.length) * 100;
        speechProgressFill.style.width = progress + '%';
        speechProgressText.textContent = `æ­£åœ¨æœ—è®€ ${index + 1}/${speechSegments.length} æ®µ...`;
        
        currentUtterance = utterance;
        speechSynth.speak(utterance);
      }

      // æ›´æ–°æ®µè½ç¯„åœè¼¸å…¥çš„æœ€å¤§å€¼
      function updateSegmentInputs() {
        const text = resultDiv.textContent || latestStory || '';
        const segments = splitTextToSegments(text);
        const total = segments.length;
        
        const startInput = document.getElementById('startSegment');
        const endInput = document.getElementById('endSegment');
        const segmentInfo = document.getElementById('segmentInfo');
        
        startInput.max = total || 1;
        endInput.max = total || 1;
        endInput.value = total || 1;
        
        segmentInfo.textContent = `å…± ${total} æ®µ`;
        
        return segments;
      }

      // é–‹å§‹/æš«åœæœ—è®€
      function toggleSpeech() {
        if (!latestStory) {
          showStatus('error', 'æ²’æœ‰å¯æœ—è®€çš„å…§å®¹');
          return;
        }
        
        if (isSpeaking && !isPaused) {
          // æš«åœ
          speechSynth.pause();
          isPaused = true;
          saveSpeechProgress(); // æš«åœæ™‚å„²å­˜é€²åº¦
          playPauseBtn.textContent = 'â–¶ï¸ ç¹¼çºŒæœ—è®€';
          speechProgressText.textContent = 'â¸ï¸ å·²æš«åœ';
        } else if (isPaused) {
          // ç¹¼çºŒ
          speechSynth.resume();
          isPaused = false;
          playPauseBtn.textContent = 'â¸ï¸ æš«åœ';
          speechProgressText.textContent = `æ­£åœ¨æœ—è®€ ${currentSegmentIndex + 1}/${speechSegments.length} æ®µ...`;
        } else {
          // é–‹å§‹æ–°æœ—è®€
          const text = resultDiv.textContent || latestStory;
          const allSegments = splitTextToSegments(text);
          
          if (allSegments.length === 0) {
            showStatus('error', 'æ²’æœ‰å¯æœ—è®€çš„å…§å®¹');
            return;
          }
          
          // ç²å–æ®µè½ç¯„åœ
          const startInput = document.getElementById('startSegment');
          const endInput = document.getElementById('endSegment');
          let startIdx = parseInt(startInput.value) - 1 || 0;
          let endIdx = parseInt(endInput.value) || allSegments.length;
          
          // é©—è­‰ç¯„åœ
          startIdx = Math.max(0, Math.min(startIdx, allSegments.length - 1));
          endIdx = Math.max(startIdx + 1, Math.min(endIdx, allSegments.length));
          
          // åªé¸å–æŒ‡å®šç¯„åœçš„æ®µè½
          speechSegments = allSegments.slice(startIdx, endIdx);
          
          if (speechSegments.length === 0) {
            showStatus('error', 'æ²’æœ‰å¯æœ—è®€çš„å…§å®¹');
            return;
          }
          
          // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„é€²åº¦ï¼ˆåªåœ¨æœ—è®€å…¨éƒ¨æ™‚æª¢æŸ¥ï¼‰
          const savedProgress = loadSpeechProgress();
          let startIndex = 0;
          
          const isReadingAll = startIdx === 0 && endIdx === allSegments.length;
          
          if (isReadingAll && savedProgress && savedProgress.segmentIndex > 0 && savedProgress.segmentIndex < speechSegments.length) {
            // è©¢å•æ˜¯å¦å¾ä¸Šæ¬¡ä½ç½®ç¹¼çºŒ
            const resumeFromSaved = confirm(`ç™¼ç¾ä¸Šæ¬¡æœ—è®€é€²åº¦ï¼ˆç¬¬ ${savedProgress.segmentIndex + 1}/${speechSegments.length} æ®µï¼‰\n\né»æ“Šã€Œç¢ºå®šã€å¾ä¸Šæ¬¡ä½ç½®ç¹¼çºŒ\né»æ“Šã€Œå–æ¶ˆã€å¾é ­é–‹å§‹`);
            
            if (resumeFromSaved) {
              startIndex = savedProgress.segmentIndex;
              // æ¢å¾©è¨­å®š
              if (savedProgress.rate) speechRate.value = savedProgress.rate;
              if (savedProgress.pitch) speechPitch.value = savedProgress.pitch;
              if (savedProgress.emotion) emotionMode.value = savedProgress.emotion;
              rateValue.textContent = speechRate.value + 'x';
              pitchValue.textContent = speechPitch.value;
              // èªéŸ³éœ€è¦åœ¨èªéŸ³åˆ—è¡¨è¼‰å…¥å¾Œè¨­å®š
              setTimeout(() => {
                if (savedProgress.voice && availableVoices.find(v => v.name === savedProgress.voice)) {
                  voiceSelect.value = savedProgress.voice;
                }
              }, 100);
            } else {
              clearSpeechProgress();
            }
          }
          
          isSpeaking = true;
          isPaused = false;
          playPauseBtn.textContent = 'â¸ï¸ æš«åœ';
          
          // é¡¯ç¤ºæœ—è®€ç¯„åœ
          if (!isReadingAll) {
            speechProgressText.textContent = `æœ—è®€ç¯„åœï¼šç¬¬ ${startIdx + 1} - ${endIdx} æ®µ`;
          }
          
          speakSegment(startIndex);
        }
      }

      // åœæ­¢æœ—è®€
      function stopSpeech() {
        speechSynth.cancel();
        isSpeaking = false;
        isPaused = false;
        saveSpeechProgress(); // åœæ­¢æ™‚ä¹Ÿå„²å­˜é€²åº¦
        currentSegmentIndex = 0;
        playPauseBtn.textContent = 'â–¶ï¸ é–‹å§‹æœ—è®€';
        speechProgressFill.style.width = '0%';
        speechProgressText.textContent = 'æº–å‚™å°±ç·’';
      }
      
      // é‡ç½®æœ—è®€ï¼ˆå¾é ­é–‹å§‹ï¼‰
      function resetSpeech() {
        stopSpeech();
        clearSpeechProgress();
        currentSegmentIndex = 0;
        speechProgressText.textContent = 'å·²é‡ç½®ï¼Œæº–å‚™å¾é ­é–‹å§‹';
        
        // é‡ç½®æ®µè½ç¯„åœ
        const startInput = document.getElementById('startSegment');
        startInput.value = 1;
        updateSegmentInputs();
      }

      // è¤‡è£½å…¨æ–‡
      function copyAllText() {
        const text = resultDiv.textContent || latestStory || '';
        if (!text) {
          showStatus('error', 'æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
          return;
        }
        
        navigator.clipboard.writeText(text).then(() => {
          showStatus('success', 'ğŸ“‹ å·²è¤‡è£½å…¨æ–‡ï¼å¯è²¼åˆ°å…¶ä»– App é€²è¡Œæœ—è®€');
        }).catch(err => {
          // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ textarea
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            showStatus('success', 'ğŸ“‹ å·²è¤‡è£½å…¨æ–‡ï¼');
          } catch (e) {
            showStatus('error', 'è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½');
          }
          document.body.removeChild(textarea);
        });
      }

      // äº‹ä»¶ç¶å®š
      speakBtn.addEventListener('click', () => {
        speechPanel.style.display = 'block';
        speechPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // æ›´æ–°æ®µè½è³‡è¨Š
        updateSegmentInputs();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„é€²åº¦ï¼Œé¡¯ç¤ºæç¤º
        const savedProgress = loadSpeechProgress();
        if (savedProgress && savedProgress.segmentIndex > 0) {
          speechProgressText.textContent = `ğŸ“ ä¸Šæ¬¡é€²åº¦ï¼šç¬¬ ${savedProgress.segmentIndex + 1} æ®µ`;
        }
      });

      closeSpeechPanel.addEventListener('click', () => {
        stopSpeech();
        speechPanel.style.display = 'none';
      });

      playPauseBtn.addEventListener('click', toggleSpeech);
      stopSpeechBtn.addEventListener('click', stopSpeech);
      resetSpeechBtn.addEventListener('click', resetSpeech);
      
      // è¤‡è£½å…¨æ–‡æŒ‰éˆ•
      document.getElementById('copyAllBtn').addEventListener('click', copyAllText);
      
      // æœ—è®€å…¨éƒ¨æŒ‰éˆ•
      document.getElementById('readAllBtn').addEventListener('click', () => {
        const startInput = document.getElementById('startSegment');
        const endInput = document.getElementById('endSegment');
        startInput.value = 1;
        updateSegmentInputs();
      });
      
      // æ®µè½è¼¸å…¥é©—è­‰
      document.getElementById('startSegment').addEventListener('change', function() {
        const endInput = document.getElementById('endSegment');
        if (parseInt(this.value) > parseInt(endInput.value)) {
          endInput.value = this.value;
        }
        if (parseInt(this.value) < 1) this.value = 1;
      });
      
      document.getElementById('endSegment').addEventListener('change', function() {
        const startInput = document.getElementById('startSegment');
        if (parseInt(this.value) < parseInt(startInput.value)) {
          this.value = startInput.value;
        }
        if (parseInt(this.value) < 1) this.value = 1;
      });

      speechRate.addEventListener('input', () => {
        rateValue.textContent = speechRate.value + 'x';
      });

      speechPitch.addEventListener('input', () => {
        pitchValue.textContent = speechPitch.value;
      });

      // é é¢é›¢é–‹æ™‚å„²å­˜é€²åº¦
      window.addEventListener('beforeunload', () => {
        if (isSpeaking || currentSegmentIndex > 0) {
          saveSpeechProgress();
        }
        speechSynth.cancel();
      });
    </script>
  </body>
</html>
