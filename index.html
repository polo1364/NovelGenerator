<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>小說生成器</title>
    <style>
      :root {
        --primary: #4e73df;
        --primary-hover: #3c5ec5;
        --secondary: #6c757d;
        --secondary-hover: #5a6268;
        --background: #f2f4f8;
        --card-bg: #ffffff;
        --section-bg: #f8f9fc;
        --input-bg: #fdfdfd;
      }
      body {
        margin: 0;
        font-family: 'Segoe UI', Roboto, sans-serif;
        background: var(--background);
        color: #333;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 40px 20px;
      }
      .card {
        background: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
        max-width: 900px;
        width: 100%;
        padding: 32px;
      }
      h1 {
        font-size: 2rem;
        margin: 0;
        color: var(--primary);
      }
      .subtitle {
        margin-top: 6px;
        margin-bottom: 26px;
        color: var(--secondary);
        font-size: 0.95rem;
      }
      .section {
        background: var(--section-bg);
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .section-title {
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--primary);
        margin-top: 0;
        margin-bottom: 14px;
      }
      .input-group {
        margin-bottom: 14px;
      }
      .input-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
        color: var(--primary);
      }
      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }
      .label-row label {
        font-weight: 600;
        color: var(--primary);
      }
      .label-row button {
        background: var(--secondary);
        color: #fff;
        padding: 6px 12px;
        font-size: 0.85rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s ease;
        margin-left: 8px;
      }
      .label-row button:hover {
        background: var(--secondary-hover);
      }

      /* API 金鑰輸入與顯示隱藏控制 */
      .api-key-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .api-key-container button.api-toggle {
        background: var(--secondary);
        color: #fff;
        padding: 6px 12px;
        font-size: 0.85rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s ease;
        white-space: nowrap;
      }
      .api-key-container button.api-toggle:hover {
        background: var(--secondary-hover);
      }

      /* 主要人物動態行 */
      .character-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
        align-items: center;
      }

      /* 人物行首的編號標籤 */
      .character-row .char-index {
        flex: 0 0 64px;
        font-weight: 600;
        color: var(--primary);
        display: flex;
        align-items: center;
      }

      .character-row input {
        flex: 1 1 140px;
        min-width: 120px;
      }

      .character-row button {
        background: var(--secondary);
        color: #fff;
        padding: 6px 12px;
        font-size: 0.85rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s ease;
        white-space: nowrap;
      }

      .character-row button:hover {
        background: var(--secondary-hover);
      }

      /* 章節按鈕容器與按鈕樣式 */
      .chapter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 20px;
      }
      .chapter-buttons button {
        background: var(--primary);
        color: #fff;
        padding: 6px 12px;
        font-size: 0.9rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .chapter-buttons button:hover {
        background: var(--primary-hover);
      }
      .chapter-buttons button.active {
        background: var(--secondary);
      }
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: var(--input-bg);
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.2);
      }
      textarea {
        min-height: 90px;
        resize: vertical;
      }
      .buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
      }
      button {
        background: var(--primary);
        color: #fff;
        padding: 10px 24px;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      button:hover {
        background: var(--primary-hover);
      }
      button:disabled {
        background: #b8c4e3;
        cursor: not-allowed;
      }
      .status {
        margin-top: 10px;
        font-size: 0.95rem;
        color: var(--secondary);
      }
      .output {
        margin-top: 20px;
        padding: 24px;
        border: 1px solid #e6e6e6;
        border-radius: 4px;
        background: #ffffff;
        font-family: 'Noto Serif TC', serif;
        font-size: 1.1rem;
        line-height: 1.8;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>小說生成器</h1>
      <p class="subtitle">
        組合主題、背景、人物與章節數，產出專屬於您的長篇故事。完成後可以直接閱讀或下載純文字檔。
      </p>

      <!-- 基本設定 -->
      <div class="section">
      <h2 class="section-title">基本設定</h2>
      <div class="input-group">
        <label for="apiKey">Gemini API 金鑰</label>
        <div class="api-key-container">
          <input
            type="password"
            id="apiKey"
            placeholder="請輸入您的 API 金鑰"
            autocomplete="off"
          />
          <button type="button" id="toggleApiKeyVisibility" class="api-toggle">顯示</button>
        </div>
      </div>
      <div class="input-group">
        <label for="model">選擇模型</label>
        <select id="model">
          <option value="gemini-2.5-flash">gemini‑2.5‑flash</option>
          <option value="gemini-pro">gemini‑pro</option>
        </select>
      </div>
      </div>

      <!-- 故事元素 -->
      <div class="section">
        <h2 class="section-title">故事元素</h2>
        <div class="input-group">
          <label for="theme">主題</label>
          <select id="theme">
            <option value="">請選擇主題</option>
            <option value="奇幻冒險">奇幻冒險</option>
            <option value="未來科幻">未來科幻</option>
            <option value="浪漫愛情">浪漫愛情</option>
            <option value="懸疑推理">懸疑推理</option>
            <option value="歷史傳奇">歷史傳奇</option>
            <option value="青春成長">青春成長</option>
            <option value="冒險史詩">冒險史詩</option>
            <option value="玄幻修真">玄幻修真</option>
            <option value="現代都市">現代都市</option>
            <option value="魔法學院">魔法學院</option>
            <option value="恐怖驚悚">恐怖驚悚</option>
            <option value="喜劇逗趣">喜劇逗趣</option>
            <option value="現實主義">現實主義</option>
            <option value="懷舊故事">懷舊故事</option>
            <option value="神秘奇案">神秘奇案</option>
            <option value="動物寓言">動物寓言</option>
            <option value="社會批判">社會批判</option>
            <option value="魔幻現實">魔幻現實</option>
            <option value="古裝武俠">古裝武俠</option>
            <option value="時空穿越">時空穿越</option>
          </select>
        </div>
        <div class="input-group">
          <label for="setting">背景設定</label>
          <select id="setting">
            <option value="">請選擇背景</option>
            <option value="虛構的中世紀王國">虛構的中世紀王國</option>
            <option value="21世紀的臺灣都市">21世紀的臺灣都市</option>
            <option value="遙遠的太空殖民地">遙遠的太空殖民地</option>
            <option value="虛擬實境世界">虛擬實境世界</option>
            <option value="古代皇宮">古代皇宮</option>
            <option value="末日後的荒土">末日後的荒土</option>
            <option value="近未來的高科技城市">近未來的高科技城市</option>
            <option value="魔法學院">魔法學院</option>
            <option value="蒸汽龐克城市">蒸汽龐克城市</option>
            <option value="深海王國">深海王國</option>
            <option value="繁華的銀河商場">繁華的銀河商場</option>
            <option value="隱藏於雲端的城堡">隱藏於雲端的城堡</option>
            <option value="古老的山林村落">古老的山林村落</option>
            <option value="雪山上的修道院">雪山上的修道院</option>
            <option value="熱帶雨林深處">熱帶雨林深處</option>
            <option value="巨型迷宮都市">巨型迷宮都市</option>
            <option value="殖民海盜船">殖民海盜船</option>
            <option value="宇宙戰艦上">宇宙戰艦上</option>
            <option value="明朝宮廷">明朝宮廷</option>
            <option value="平行宇宙">平行宇宙</option>
          </select>
        </div>
        <div class="input-group">
          <div class="label-row">
            <label>主要人物設定</label>
            <div>
              <button id="randomAllCharactersBtn" type="button">隨機人物</button>
              <button id="addCharacterBtn" type="button">新增人物</button>
            </div>
          </div>
          <div id="charactersContainer"></div>
        </div>
        <div class="input-group">
          <label for="style">故事風格</label>
          <select id="style">
            <option value="">請選擇風格</option>
            <option value="詩意">詩意</option>
            <option value="幽默">幽默</option>
            <option value="黑暗">黑暗</option>
            <option value="勵志">勵志</option>
            <option value="浪漫">浪漫</option>
            <option value="刺激">刺激</option>
            <option value="溫馨">溫馨</option>
            <option value="懸疑">懸疑</option>
            <option value="熱血">熱血</option>
            <option value="魔幻">魔幻</option>
            <option value="古典華麗">古典華麗</option>
            <option value="荒誕">荒誕</option>
            <option value="現實主義">現實主義</option>
            <option value="輕鬆寫意">輕鬆寫意</option>
            <option value="酷炫科技">酷炫科技</option>
            <option value="優雅浪漫">優雅浪漫</option>
            <option value="大河戲劇">大河戲劇</option>
            <option value="黑色幽默">黑色幽默</option>
            <option value="心理驚悚">心理驚悚</option>
            <option value="流行網絡">流行網絡</option>
          </select>
        </div>
        <div class="input-group">
          <label for="chapters">章節數</label>
          <input
            type="number"
            id="chapters"
            placeholder="如：10"
            min="1"
            max="50"
            step="1"
          />
        </div>
        <div class="input-group">
          <label for="length">預計總字數</label>
          <input
            type="number"
            id="length"
            placeholder="如：50000"
            min="1000"
            max="200000"
            step="1000"
          />
        </div>
      </div>

      <!-- 其他說明 -->
      <div class="section">
        <h2 class="section-title">其他說明</h2>
        <div class="input-group">
          <label for="notes">補充說明（選填）</label>
          <textarea
            id="notes"
            placeholder="如有額外情節或風格要求，可在此補充。"
          ></textarea>
        </div>
      </div>

      <!-- 控制按鈕 -->
      <div class="buttons">
        <button id="randomBtn" type="button">隨機填充</button>
        <button id="generateBtn" type="button">開始生成</button>
        <!-- 繼續生成按鈕在產出初始內容後顯示 -->
        <button id="continueBtn" type="button" disabled>繼續生成</button>
        <button id="downloadBtn" type="button" disabled>下載小說</button>
      </div>
      <div id="status" class="status"></div>
      <div id="result" class="output"></div>
    </div>

    <script>
      // 取得元素
      const apiKeyInput = document.getElementById('apiKey');
      const modelSelect = document.getElementById('model');
      const themeSelect = document.getElementById('theme');
      const settingSelect = document.getElementById('setting');
      const styleSelect = document.getElementById('style');
      const chaptersInput = document.getElementById('chapters');
      const lengthInput = document.getElementById('length');
      const notesInput = document.getElementById('notes');
      const randomBtn = document.getElementById('randomBtn');
      const generateBtn = document.getElementById('generateBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const continueBtn = document.getElementById('continueBtn');
      const statusDiv = document.getElementById('status');
      const resultDiv = document.getElementById('result');

      // API 金鑰顯示/隱藏按鈕
      const toggleApiKeyVisibility = document.getElementById('toggleApiKeyVisibility');

      // 新增角色相關元素
      const charactersContainer = document.getElementById('charactersContainer');
      const randomAllCharactersBtn = document.getElementById('randomAllCharactersBtn');
      const addCharacterBtn = document.getElementById('addCharacterBtn');

      // 目前產出的故事文字
      let latestStory = '';

      // 儲存與讀取 API 金鑰
      const storedKey = localStorage.getItem('geminiApiKey');
      if (storedKey) {
        apiKeyInput.value = storedKey;
      }
      apiKeyInput.addEventListener('change', () => {
        const val = apiKeyInput.value.trim();
        if (val) localStorage.setItem('geminiApiKey', val);
      });

      // 載入先前生成並儲存的故事（如果有）
      const savedStory = localStorage.getItem('savedStory');
      if (savedStory) {
        latestStory = savedStory;
        resultDiv.textContent = savedStory;
        downloadBtn.disabled = false;
        continueBtn.disabled = false;
      }

      // 切換 API 金鑰顯示/隱藏
      if (toggleApiKeyVisibility) {
        toggleApiKeyVisibility.addEventListener('click', () => {
          const currentType = apiKeyInput.getAttribute('type');
          if (currentType === 'password') {
            apiKeyInput.setAttribute('type', 'text');
            toggleApiKeyVisibility.textContent = '隱藏';
          } else {
            apiKeyInput.setAttribute('type', 'password');
            toggleApiKeyVisibility.textContent = '顯示';
          }
        });
      }

      // 隨機資料庫
      const themes = [
        '奇幻冒險',
        '未來科幻',
        '浪漫愛情',
        '懸疑推理',
        '歷史傳奇',
        '青春成長',
        '冒險史詩',
        '玄幻修真',
        '現代都市',
        '魔法學院',
        '恐怖驚悚',
        '喜劇逗趣',
        '現實主義',
        '懷舊故事',
        '神秘奇案',
        '動物寓言',
        '社會批判',
        '魔幻現實',
        '古裝武俠',
        '時空穿越',
      ];
      const settings = [
        '虛構的中世紀王國',
        '21世紀的臺灣都市',
        '遙遠的太空殖民地',
        '虛擬實境世界',
        '古代皇宮',
        '末日後的荒土',
        '近未來的高科技城市',
        '魔法學院',
        '蒸汽龐克城市',
        '深海王國',
      ];
      const charactersSamples = [
        '一位勇敢的少年與他的神秘導師',
        '一個叛逆的黑客與一名懷有秘密的特工',
        '一位失憶的戰士與一個外星科學家',
        '一名平凡少女與她的魔法朋友',
        '一個失去家園的旅人與一隻會說話的動物',
        '一位年輕的巫師與他的忠實貓咪夥伴',
        '一名落魄騎士與他的騙子朋友',
        '一個熱血少年和沉默寡言的劍士',
        '一位外星公主與地球少年',
        '一名機器人與它的創造者',
      ];
      const stylesArr = [
        '詩意',
        '幽默',
        '黑暗',
        '勵志',
        '浪漫',
        '刺激',
        '溫馨',
        '懸疑',
        '熱血',
        '魔幻',
      ];

      // 擴充選項：額外主題、背景與風格
      // 為了保持向下相容，我們將新的類別透過 push 方式加入原本陣列
      // 主題清單已在上方擴充，不再重複加入
      settings.push(
        '繁華的銀河商場',
        '隱藏於雲端的城堡',
        '古老的山林村落',
        '雪山上的修道院',
        '熱帶雨林深處',
        '巨型迷宮都市',
        '殖民海盜船',
        '宇宙戰艦上',
        '明朝宮廷',
        '平行宇宙'
      );
      stylesArr.push(
        '古典華麗',
        '荒誕',
        '現實主義',
        '輕鬆寫意',
        '酷炫科技',
        '優雅浪漫',
        '大河戲劇',
        '黑色幽默',
        '心理驚悚',
        '流行網絡'
      );
      const chapterOpts = [5, 8, 10, 12, 15];
      const lengthOpts = [30000, 50000, 70000, 90000];

  // 角色元素資料庫
  const nameOptions = [
    '艾琳','洛恩','凱亞','米爾','席恩','薇拉','祈安','杜林','希爾維','萊雅',
    '伊凡','法蘭','格蘭','梅芙','安娜','雷格','索菲','艾略特','亞歷克','莫妮卡',
    '路西','伊芙','加百列','亞當','瑪雅','艾德','薩拉','杰登','琪拉','德瑞克',
    '凱瑟琳','馬丁','羅絲','奧利維','昆汀','哈莉','伯納德','海倫','丹尼爾','雷切爾',
    '山姆','艾薇','諾亞','艾米莉','布萊恩','艾蜜莉亞','達米安','露西亞','米蘭達','亞歷山大',
    '波琳娜','亨利','蘇菲亞','費南多','克萊兒','埃德加','歐文','莉亞','查爾斯','哈娜',
    '杰克','瑪蒂爾達','托尼','娜塔莉','達瑞斯','克里斯','艾瑪','羅伯特','凱特','格蕾絲',
    '莫里斯','普拉多','勞拉','維克多','凱莉','菲利普','瑞秋','史蒂夫','羅伊','哈德森',
    '妮可','克麗絲汀','萊昂','梅根','杜蘭','馬雅','蘭斯洛特','卡羅爾','伊麗莎白','伊薩貝拉',
    '考特尼','蔣琴','唐娜','塞德里克','布蘭妮','雷蒙','凱薩琳','阿萊克斯','加布里埃拉','西蒙'
  ];
  const personalityOptions = [
    '外冷內熱','自卑但嘴硬','樂觀又衝動','冷靜但偏執','溫柔卻不輕信任何人','堅韌而沉默',
    '幽默開朗','善良又單純','多疑且謹慎','自信而傲慢','懶散卻超凡聰明','義氣而固執',
    '急躁但心地善良','謙虛而機智','天真又好奇','冷酷無情','善於交際','孤僻沉默',
    '勇敢衝動','理性克制',
    '愛幻想','孤單','嫉妒心強','勇於挑戰','樂於助人','多愁善感','懶散','好動','機智靈活','心直口快',
    '優柔寡斷','善於隱忍','頑強','懷疑一切','思維嚴謹','黑暗內心','衝動火爆','陰晴不定','客觀理性','自律自省',
    '貪心','粗枝大葉','孤高自傲','悲天憫人','求知欲強','保守傳統','冒險精神','浪漫情懷','鐵面無私','情感豐沛',
    '不拘小節','嬉皮笑臉','深謀遠慮','勇敢無畏','友善熱情','純真孩氣','冷漠疏離','心思纖細','謙遜低調','剛愎自用',
    '風趣幽默','充滿正義感','善於操控','常常懷疑自己','樂觀開朗','感性細膩','玩世不恭','奮發向上','無厘頭','固執己見',
    '反覆無常','忍耐力強','憨厚老實','孤僻怪異','古怪多變','嫉惡如仇','天真浪漫','豪放不羈','富有創意','隨遇而安',
    '心狠手辣','重視禮節','熱愛自由','貪玩','節儉','心地善良','喜歡冒險','專注執著','真誠坦率','小心翼翼'
    ,'倔強固執','天馬行空','善解人意','易燃易爆炸','過度樂觀','莫名自信','唯我獨尊','嫉惡如仇','悲觀厭世','凡事求真'
  ];
  const goalOptions = [
    '找回失落的家族徽章','破解禁書的封印','救回被詛咒的朋友','查出學院裡的內鬼','證明自己不是怪物',
    '尋找失蹤的師父','復仇雪恥','拯救世界免於毀滅','逃離自身的命運','尋求內心的自由',
    '揭開古老遺跡的秘密','完成父母未竟的夢想','打倒暴政的君王','尋找傳說中的寶藏','守護故鄉免於侵略',
    '破解血統之謎','治癒自己的病痛','成為最強者','阻止末日降臨','改變未來的預言',
    '統治整個國度','找到通往平行世界的門','破解古老魔法的謎語','阻止邪惡教團復活','拯救族人免於滅絕',
    '與心愛之人重逢','找出真正的身世','讓世界和平','消滅所有黑暗力量','完成最後一任務',
    '揭露巨大陰謀','修復破碎的王國','找到失蹤的寶藏','治癒世界的疾病','摧毀邪惡組織',
    '報復前世的仇敵','探索未知星系','保護自然環境','發現永恆之泉','統一各族勢力',
    '尋找失傳的魔法卷軸','解放奴役的人民','阻止黑暗儀式','完成祖先的遺願','建立和平的世界',
    '揭開身世之謎','戰勝心魔','擺脫家族詛咒','實現冒險夢想','奪回失去的王位',
    '找到傳說中的武器','復活已逝的愛人','破除命運束縛','從奴役中解放族人','尋求真正的友誼',
    '建立強大的團隊','開創新秩序','揭開古墓的秘密','穿越時空拯救世界','追求藝術極致',
    '完成一場史詩之旅','阻止時空崩壞','推翻腐敗政權','尋找永恆的愛情','保護弱小',
    '拯救被遺忘的種族','阻止瘟疫蔓延','尋找新的家園','實現科學突破','救贖自己',
    '治療親人的疾病','打破命運輪迴','組織反抗軍','守護神秘寶石','阻止世界融合',
    '找回失去的能力','尋求力量的來源','證明自己的價值','成為傳說中的英雄','阻止末日機器',
    '重建家園','找到記憶碎片','守護生命之樹','維持世界平衡','拯救被囚禁的靈魂',
    '探索海底世界','阻止洪水','追尋真理','成為最偉大的巫師','開創新世界',
    '繼承神的力量','阻止瘋狂科學家','完成最後的冒險','找到宇宙的起源','救助孤兒院',
    '解開歷史謎團','平息戰爭','召喚神龍'
    ,'尋找失散多年的親人','突破自我極限','統一四海八荒','實現和平共處','追求神秘力量'
  ];
  const weaknessOptions = [
    '害怕黑暗','遇到壓力就說謊','太容易相信別人','強迫症嚴重','一旦承諾就不肯回頭',
    '畏懼深海','恐高症','容易發怒','過於固執','患有失眠','對魔法過敏','不擅長謊言',
    '心軟','容易焦慮','懼怕孤獨','怕血','記憶衰退','常自我懷疑','體力差','情緒起伏大',
    '恐水','三分鐘熱度','貪吃','愛睡覺','沒自信','容易嫉妒','怕蛇','無法拒絕他人','懼怕孤獨','受到金錢誘惑',
    '懦弱','怕寂寞','怕失敗','眼神不好','迷失自我','容易暈血','過度同情心','情緒不穩','飲食失調','缺乏耐心',
    '怕被拒絕','易感寂寞','時間管理差','容易分心','優柔寡斷','怕寵物','對聲音過敏','會暈車','不會游泳','怕蜘蛛',
    '對金錢著迷','過於誠實','不能保守秘密','健忘','反射神經差','害怕蛙','愛出風頭','情緒化','傲慢自大','懷疑一切',
    '受不起批評','追求完美','過度開朗','得失心重','過於善良','常常遲到','自控力差','容易煩惱','懷舊','過於現實',
    '怕痛','不擅交際','愛拖延','不善理財','怕換環境','低血糖','怕雷','愛哭','怕醫院','無安全感',
    '太在意他人眼光','怕火','怕蟑螂','怕雨','怕被孤立','怕未知','怕黑夜','恐懼高壓','怕失去朋友','過於衝動',
    '易怒','有強迫症','潔癖','過於挑剔','缺乏信心','害怕說謊','金錢迷惑'
    ,'過度自責','怕黑怕鬼','無法長時間專注','過於敏感','喜歡攀比'
  ];
  const secretOptions = [
    '其實能聽見魔杖的聲音','曾經施放過禁咒','血統有爭議','與反派有血緣關係','記憶被人動過手腳',
    '身上藏有古老符文','是預言中的孩子','隱藏著第二人格','真正的身份是王族','手握未來的預言',
    '擁有毀滅世界的力量','殺過無辜的人','靈魂被分裂','與神靈簽下契約','體內寄宿龍族血脈',
    '被人控制思想','持有禁書','曾是敵軍間諜','擁有可以逆天改命的能力','已經死亡又復活過',
    '身份是天界使者','出生於敵對國度','持有能控制時間的裝置','曾經是反派手下','其真正目的是復仇',
    '身體中封印著魔神','曾殺死親人','擁有不可告人的戀情','曾在另一時空活過','靈魂被惡靈附身',
    '曾經是王族成員','擁有預知能力','體內封印著神獸','曾與外星人接觸','是雙重間諜',
    '從未出生在這個世界','是失蹤王子/公主','其父母是名偉大的英雄','曾暗中幫助過敵人','體內流著龍的血',
    '曾與惡魔做交易','其實是穿越者','前世是大魔法師','失去了靈魂的一部分','曾經毀掉一個村莊',
    '覺醒了禁忌力量','曾經統治世界','與神秘組織有勾結','擁有死亡回溯的能力','隱藏著第三人格',
    '擁有永生','身體其實是複製品','曾經愛上敵人','是預言之子','其實是另一性別',
    '一部分記憶被封印','曾偷竊神器','內心住著惡魔','曾經犧牲一個城鎮','真實身份是魔王之子',
    '與宿敵是兄弟姐妹','被標記為叛徒','曾在夢中毀滅世界','是天使與人類的混血','曾經是神的使者',
    '背負血海深仇','體內有一把劍','擁有召喚亡靈的能力','是失落文明的繼承者','其實是一個幻影',
    '曾經殺過至親','是反派的父親/母親','隱藏著巨額財富','與龍簽訂契約','曾是名殺手',
    '擁有穿梭夢境的能力','身體裡有另一個靈魂','曾經背叛整個國家','是對手的愛人','其實早已死去',
    '持有通往另一世界的門','被預言將帶來毀滅','曾是敵軍的領袖','曾經拯救世界卻沒人知道','是未來自己',
    '被改造過','曾經是機器人','隱藏著一個孩子','曾在時間漩渦迷失','其實是邪神的孩子',
    '曾與妖精簽約','過去是強大巫師','靈魂被詛咒','與祖先對話','某部分身體不是自己的',
    '其實是克隆人','有未來的記憶','預知自己死亡','曾經被神選中','體內封印著魔王',
    '過去是天宮守衛','曾經是星際海盜'
  ];
  const relationOptions = [
    '與父親關係疏離','與舊情人有未了結','與另一位角色有誓約','曾背叛過最好的朋友','欠了黑幫巨債',
    '對導師又敬又恨','視敵為兄弟','秘密愛慕夥伴','被家族逐出','與宿敵互相尊重',
    '欠下不可還清的救命恩情','與同伴競爭','誓死保護弟弟','曾救過反派','暗中合作又互相利用',
    '關係複雜的親戚','與政府存在牽連','被流放後結識旅伴','與古老神祇有契約','隱瞞了前世的牽絆',
    '與前任情人再度重逢','與宿敵曾是兄弟','暗戀同性朋友','被家族視為異類','與某位神祇簽訂契約',
    '是另一人物的失散親人','對敵人充滿惻隱','與某生物有共生關係','與歷史人物有血緣','為了家族而犧牲個人幸福',
    '曾是情敵','相愛相殺','是相互扶持的旅行夥伴','是一見鐘情','幼時玩伴',
    '前世夫妻','互為師徒','因恩怨結緣','宿敵卻互相理解','上司與下屬',
    '患難之交','情同手足','生死之交','重生後的敵人','生命互相依存',
    '命運的牽絆','養父與養子','雙胞胎','一方是另外一方的影子','靈魂鏈接',
    '契約關係','曾經救過對方一命','互為對方的拯救','衝突不斷的夥伴','青梅竹馬',
    '不打不相識','互相欣賞','半路兄妹','義氣相挺','因誤會而敵對',
    '雇主與傭兵','雙方有婚約','原先同門，後分道揚鑣','神與信徒','投機合作',
    '彼此利用','朋友兼競爭對手','暗中守護','因權力爭鬥相識','破鏡重圓',
    '雙方是遠房親戚','相互傾慕','前世死敵','互為鏡像','輪迴中的羈絆',
    '遺志的繼承者與傳承者','徒弟與師兄','生死敵對','代替對方完成使命','被迫成為同伴',
    '一方欠另一方人情','彼此心有愧疚','共同的敵人','最好的朋友','走失後相遇',
    '祖孫跨越時空相遇','同為研究伙伴','競爭愛慕對象','無血緣卻像家人','常常吵架卻默契十足',
    '未婚夫妻','互相牽制','相互承諾一起冒險','親子關係','被預言會互相殘殺',
    '同時愛上第三者','曾互救生命','星際旅伴','同為失落族人','異族戀人',
    '並肩作戰','結拜兄弟','重逢於旅途','天作之合','自由與責任的牽絆'
  ];

  // 初始化兩個人物行（預設隨機）
  document.addEventListener('DOMContentLoaded', () => {
    addCharacterRow(true);
    addCharacterRow(true);
  });

      function pickRandom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }

  // 建立單個人物行
  function addCharacterRow(randomize = false) {
    const row = document.createElement('div');
    row.className = 'character-row';
    // 計算當前索引以顯示人物編號
    const index = charactersContainer.children.length + 1;
    row.innerHTML = `
      <div class="char-index">人物${index}</div>
      <input type="text" class="char-name" placeholder="姓名 / 角色" />
      <input type="text" class="char-personality" placeholder="個性 (如 外冷內熱)" />
      <input type="text" class="char-goal" placeholder="目標 (如 拯救世界)" />
      <input type="text" class="char-weakness" placeholder="弱點 (如 害怕黑暗)" />
      <input type="text" class="char-secret" placeholder="秘密 (如 身世謎樣)" />
      <input type="text" class="char-relation" placeholder="人際 (如 與人有誓約)" />
      <button type="button" class="char-random-btn">隨機</button>
    `;
    // 隨機按鈕事件
    const randBtn = row.querySelector('.char-random-btn');
    randBtn.addEventListener('click', () => randomizeRow(row));
    charactersContainer.appendChild(row);
    if (randomize) randomizeRow(row);
  }

  // 隨機化單個人物行
  function randomizeRow(row) {
    row.querySelector('.char-name').value = pickRandom(nameOptions);
    row.querySelector('.char-personality').value = pickRandom(personalityOptions);
    row.querySelector('.char-goal').value = pickRandom(goalOptions);
    row.querySelector('.char-weakness').value = pickRandom(weaknessOptions);
    row.querySelector('.char-secret').value = pickRandom(secretOptions);
    row.querySelector('.char-relation').value = pickRandom(relationOptions);
  }

      // 隨機填充按鈕：填入所有欄位
      randomBtn.addEventListener('click', () => {
        themeSelect.value = pickRandom(themes);
        settingSelect.value = pickRandom(settings);
        styleSelect.value = pickRandom(stylesArr);
        chaptersInput.value = pickRandom(chapterOpts);
        lengthInput.value = pickRandom(lengthOpts);
    // 隨機化所有人物行
    Array.from(charactersContainer.children).forEach((row) => randomizeRow(row));
      });

  // 隨機化所有人物按鈕
  randomAllCharactersBtn.addEventListener('click', () => {
    Array.from(charactersContainer.children).forEach((row) => randomizeRow(row));
  });

  // 新增人物按鈕
  addCharacterBtn.addEventListener('click', () => {
    addCharacterRow(true);
  });

      // 下載功能
      function downloadFile(filename, text) {
        const link = document.createElement('a');
        link.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      downloadBtn.addEventListener('click', () => {
        if (!latestStory) return;
        const title = themeSelect.value || '生成小說';
        downloadFile(title + '.txt', latestStory);
      });

      // 繼續生成：在已有故事基礎上請求後續內容
      continueBtn.addEventListener('click', async () => {
        statusDiv.textContent = '';
        statusDiv.style.color = varSecondaryColor();
        // 如果沒有已生成的故事則不處理
        if (!latestStory) {
          statusDiv.textContent = '尚未有故事可繼續，請先生成。';
          statusDiv.style.color = '#e84d3d';
          return;
        }
        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        if (!apiKey) {
          statusDiv.textContent = '請輸入 API 金鑰。';
          statusDiv.style.color = '#e84d3d';
          return;
        }
        // 組成續篇提示語：將目前故事作為前文，請模型延續
        const continuePrompt = latestStory + '\n\n請保持以上故事的主題、背景、人物與風格，繼續撰寫後續章節或故事內容，直到此章節結束或故事完結。';
        statusDiv.textContent = '續篇生成中...';
        statusDiv.style.color = varSecondaryColor();
        // 禁用按鈕避免重複請求
        continueBtn.disabled = true;
        generateBtn.disabled = true;
        try {
          const endpoint =
            'https://generativelanguage.googleapis.com/v1beta/models/' + encodeURIComponent(model) + ':generateContent';
          const payload = {
            contents: [
              {
                parts: [
                  { text: continuePrompt },
                ],
              },
            ],
          };
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          if (data.error) {
            statusDiv.textContent = '錯誤：' + data.error.message;
            statusDiv.style.color = '#e84d3d';
            continueBtn.disabled = false;
            generateBtn.disabled = false;
            return;
          }
          if (data.candidates && data.candidates.length > 0) {
            const parts = data.candidates[0].content.parts || [];
            const continuation = parts.map((p) => p.text || '').join('').trim();
            if (continuation) {
              // 追加新內容
              latestStory += '\n\n' + continuation;
              resultDiv.textContent = latestStory;
              localStorage.setItem('savedStory', latestStory);
              statusDiv.textContent = '續篇完成！';
              statusDiv.style.color = '#008a00';
              downloadBtn.disabled = false;
            } else {
              statusDiv.textContent = '沒有獲得續篇內容，可能已完結。';
              statusDiv.style.color = '#e84d3d';
            }
          } else {
            statusDiv.textContent = '沒有獲得續篇內容，可能已完結。';
            statusDiv.style.color = '#e84d3d';
          }
        } catch (err) {
          statusDiv.textContent = '請求失敗：' + err.message;
          statusDiv.style.color = '#e84d3d';
        } finally {
          continueBtn.disabled = false;
          generateBtn.disabled = false;
        }
      });


      // 生成小說
      generateBtn.addEventListener('click', async () => {
        statusDiv.textContent = '';
        statusDiv.style.color = varSecondaryColor();
        resultDiv.textContent = '';
        // 清除先前儲存的故事，使舊故事在點擊生成後消失
        localStorage.removeItem('savedStory');
        latestStory = '';
        downloadBtn.disabled = true;
        continueBtn.disabled = true;

        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        const theme = themeSelect.value.trim();
        const setting = settingSelect.value.trim();
        // 組合人物資訊
        const characterRows = Array.from(charactersContainer.querySelectorAll('.character-row'));
        let charactersInfo = '';
        characterRows.forEach((row, idx) => {
          const name = row.querySelector('.char-name').value.trim();
          const personality = row.querySelector('.char-personality').value.trim();
          const goal = row.querySelector('.char-goal').value.trim();
          const weakness = row.querySelector('.char-weakness').value.trim();
          const secret = row.querySelector('.char-secret').value.trim();
          const relation = row.querySelector('.char-relation').value.trim();
          const fields = [];
          if (name) fields.push(name);
          if (personality) fields.push(`個性：${personality}`);
          if (goal) fields.push(`目標：${goal}`);
          if (weakness) fields.push(`弱點：${weakness}`);
          if (secret) fields.push(`秘密：${secret}`);
          if (relation) fields.push(`人際：${relation}`);
          if (fields.length > 0) {
            charactersInfo += `人物${idx + 1}：${fields.join('，')}。\n`;
          }
        });
        const style = styleSelect.value.trim();
        const chapters = chaptersInput.value.trim();
        const length = lengthInput.value.trim();
        const notes = notesInput.value.trim();

        if (!apiKey) {
          statusDiv.textContent = '請輸入 API 金鑰。';
          statusDiv.style.color = '#e84d3d';
          return;
        }
        // 構建提示語
        let prompt = '';
        if (theme) prompt += `主題：${theme}。`;
        if (setting) prompt += `背景設定：${setting}。`;
        if (charactersInfo) prompt += `${charactersInfo}`;
        if (style) prompt += `故事風格：${style}。`;
        if (chapters) prompt += `故事分為 ${chapters} 章節。`;
        if (length) prompt += `總篇幅約 ${length} 字。`;
        if (notes) prompt += `其他說明：${notes}。`;
        if (!theme && !setting && !charactersInfo && !style && !chapters && !length && !notes) {
          statusDiv.textContent = '請至少填寫一項設定或使用隨機填充。';
          statusDiv.style.color = '#e84d3d';
          return;
        }
        prompt += '請以繁體中文撰寫長篇小說，結構完整，有起承轉合；若有指定章節，請標明章節標題。';

        statusDiv.textContent = '生成中...';
        statusDiv.style.color = varSecondaryColor();
        try {
          const endpoint =
            'https://generativelanguage.googleapis.com/v1beta/models/' + encodeURIComponent(model) + ':generateContent';
          const payload = {
            contents: [
              {
                parts: [
                  { text: prompt },
                ],
              },
            ],
          };
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify(payload),
          });
          const data = await response.json();
          if (data.error) {
            statusDiv.textContent = '錯誤：' + data.error.message;
            statusDiv.style.color = '#e84d3d';
            return;
          }
          if (data.candidates && data.candidates.length > 0) {
            const parts = data.candidates[0].content.parts || [];
            const story = parts.map((p) => p.text || '').join('');
            latestStory = story.trim();
            // 顯示全文並儲存到 localStorage
            resultDiv.textContent = latestStory;
            localStorage.setItem('savedStory', latestStory);
            statusDiv.textContent = '生成完成！';
            statusDiv.style.color = '#008a00';
            downloadBtn.disabled = false;
            continueBtn.disabled = false;
          } else {
            statusDiv.textContent = '沒有獲得內容，請調整設定。';
            statusDiv.style.color = '#e84d3d';
          }
        } catch (err) {
          statusDiv.textContent = '請求失敗：' + err.message;
          statusDiv.style.color = '#e84d3d';
        }
      });

      function varSecondaryColor() {
        return getComputedStyle(document.documentElement).getPropertyValue('--secondary') || '#6c757d';
      }
    </script>
  </body>
</html>
