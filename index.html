<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å°èªªç”Ÿæˆå™¨</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1630;
      --panel2:#111b3a;
      --text:#e8ecff;
      --muted:#aab3da;
      --line:rgba(255,255,255,.09);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --danger:#ff6b6b;
      --ok:#67e8a5;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --focus: 0 0 0 3px rgba(110,231,255,.18);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC","Microsoft JhengHei", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(167,139,250,.20), transparent 55%),
        radial-gradient(900px 650px at 90% 10%, rgba(110,231,255,.18), transparent 50%),
        radial-gradient(900px 900px at 40% 120%, rgba(110,231,255,.09), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .app{
      max-width:1180px;
      padding:22px 18px 26px;
      margin:0 auto;
    }
    .topbar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.45), transparent 60%),
        linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.95));
      box-shadow: 0 12px 30px rgba(110,231,255,.12);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background:linear-gradient(45deg, rgba(255,255,255,.35), transparent 50%, rgba(255,255,255,.12));
      transform:rotate(20deg);
    }
    .title h1{
      margin:0; font-size:18px; letter-spacing:.4px;
    }
    .title p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .pillrow{
      display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;
      margin-top:4px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.10);
      box-shadow: 0 0 0 2px rgba(255,255,255,.04) inset;
    }
    .dot.ok{background:rgba(103,232,165,.95)}
    .dot.bad{background:rgba(255,107,107,.95)}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
      .pillrow{justify-content:flex-start}
      .topbar{flex-direction:column; align-items:stretch;}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background:
        radial-gradient(600px 200px at 20% 0%, rgba(110,231,255,.08), transparent 70%),
        radial-gradient(480px 240px at 90% 0%, rgba(167,139,250,.08), transparent 70%),
        rgba(0,0,0,.02);
    }
    .cardHeader h2{
      margin:0; font-size:14px; letter-spacing:.35px;
    }
    .cardHeader small{color:var(--muted)}
    .cardBody{padding:14px}
    .section{
      padding:12px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.10);
      margin-bottom:12px;
    }
    .section:last-child{margin-bottom:0}
    .sectionTitle{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .sectionTitle b{font-size:13px}
    .sectionTitle span{color:var(--muted); font-size:12px}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .row{grid-template-columns: 1fr;}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      letter-spacing:.2px;
    }
    .field{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      color: var(--text);
      padding:10px 10px;
      outline:none;
      transition: .15s ease;
      font-size:14px;
    }
    .field:focus{box-shadow:var(--focus); border-color: rgba(110,231,255,.5)}
    textarea.field{min-height:92px; resize:vertical; line-height:1.45}
    select.field{appearance:none}
    .hint{
      margin-top:6px;
      font-size:12px;
      color: rgba(170,179,218,.85);
      line-height:1.35;
    }
    .inline{
      display:flex; gap:8px; align-items:center;
    }
    .btns{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: .15s ease;
      font-weight:650;
      letter-spacing:.15px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0px)}
    .btnPrimary{
      background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.95));
      border-color: rgba(255,255,255,.22);
      color: #0b1020;
    }
    .btnDanger{
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.35);
      color: #ffd4d4;
    }
    .btnGhost{
      background: transparent;
    }
    .btnSmall{
      padding:8px 10px;
      font-size:12px;
      border-radius: 12px;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:11px;
      white-space:nowrap;
    }
    .divider{
      height:1px; background:var(--line); margin:12px 0;
    }
    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:8px;
      border:1px dashed rgba(255,255,255,.16);
      border-radius: 14px;
      background: rgba(0,0,0,.08);
    }
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--text);
    }
    .chip button{
      border:none;
      background: transparent;
      color: rgba(232,236,255,.75);
      cursor:pointer;
      font-size:14px;
      line-height:1;
      padding:0 2px;
    }

    .outputWrap{
      display:flex; flex-direction:column;
      min-height: 560px;
    }
    .outTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.06);
    }
    .statusLine{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .statusLine strong{color:var(--text)}
    .outBody{
      padding:14px;
      flex:1;
      overflow:auto;
    }
    .out{
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.6;
      font-size:14px;
    }
    .out code, .out pre{
      font-family:var(--mono);
      font-size:12.5px;
      background: rgba(255,255,255,.05);
      padding:2px 6px;
      border-radius:10px;
    }
    .log{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.14);
      padding:10px;
      font-family:var(--mono);
      font-size:12px;
      color: rgba(232,236,255,.78);
      overflow:auto;
      max-height: 220px;
      display:none;
      white-space:pre-wrap;
    }
    .log.show{display:block}
    .warn{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,107,107,.30);
      background: rgba(255,107,107,.10);
      color: #ffd4d4;
      font-size:12px;
      line-height:1.4;
      margin-bottom:12px;
      display:none;
    }
    .warn.show{display:block}
    .okTip{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(103,232,165,.20);
      background: rgba(103,232,165,.08);
      color: rgba(232,255,244,.92);
      font-size:12px;
      line-height:1.4;
      margin-bottom:12px;
      display:none;
    }
    .okTip.show{display:block}
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:2px 6px;
      border:1px solid var(--line);
      border-bottom-color: rgba(255,255,255,.18);
      border-radius: 8px;
      background: rgba(0,0,0,.20);
      color: rgba(232,236,255,.85);
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>å°èªªç”Ÿæˆå™¨ï¼ˆç›´è§€ç‰ˆï¼‰</h1>
          <p>åƒã€Œç”Ÿè²¼åœ–ã€é‚£æ¨£ä¸€éµå‡ºç¨¿ï¼šä¸»é¡Œã€äººè¨­å¯é¸å¯è‡ªè¨‚ï¼Œç”Ÿæˆå¾Œå¯è¤‡è£½/ä¸‹è¼‰ã€‚<br>æç¤ºï¼šç”¨ <span class="kbd">http://localhost</span> é–‹å•Ÿæ‰ä¸æœƒè¢« <span class="kbd">file://</span> çš„ CORS æäº‹ã€‚</p>
        </div>
      </div>

      <div class="pillrow">
        <div class="pill"><span class="dot" id="dotOrigin"></span><span id="originText">Originï¼šæª¢æŸ¥ä¸­</span></div>
        <div class="pill"><span class="dot" id="dotReady"></span><span id="readyText">APIï¼šæœªè¨­å®š</span></div>
        <div class="pill"><span class="badge" id="modeBadge">æ¨¡å¼ï¼šâ€”</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Controls -->
      <div class="card">
        <div class="cardHeader">
          <h2>è¨­å®šé¢æ¿</h2>
          <small>å¯ä¿å­˜åˆ°ç€è¦½å™¨ï¼ˆlocalStorageï¼‰</small>
        </div>
        <div class="cardBody">
          <div class="warn" id="fileWarn">
            ä½ ç›®å‰æ˜¯ç”¨ <b>file://</b> é–‹å•Ÿï¼Œæ‰€ä»¥ <b>ç›¸å°è·¯å¾‘</b> çš„ fetch æœƒç‚¸æˆ <b>origin = null</b>ï¼ˆCORS ç›´æ¥æ“‹ï¼‰ã€‚<br>
            å»ºè­°ï¼šç”¨ VS Code Live Server æˆ– <span class="kbd">python -m http.server 5500</span> å†é–‹ <span class="kbd">http://127.0.0.1:5500</span>ã€‚
          </div>

          <div class="section">
            <div class="sectionTitle">
              <b>API è¨­å®š</b>
              <span>Key ä¸æœƒä¸Šå‚³åˆ°ä»»ä½•åœ°æ–¹ï¼ˆé™¤éä½ æŠŠå®ƒå¯«æ­»é€²æª”æ¡ˆï¼‰</span>
            </div>

            <div class="row">
              <div>
                <label>API Base URLï¼ˆOpenAI ç›¸å®¹ï¼‰</label>
                <input class="field" id="baseUrl" placeholder="https://api.openai.com/v1" />
                <div class="hint">ä¾‹ï¼šOpenAI / ä½ è‡ªå·±çš„ä»£ç† / ä»»ä½• OpenAI compatible æœå‹™ã€‚å»ºè­°çµå°¾ä¸è¦åŠ æ–œç·šã€‚</div>
              </div>

              <div>
                <label>è«‹æ±‚æ¨¡å¼</label>
                <select class="field" id="apiMode">
                  <option value="responses">/responsesï¼ˆè¼ƒæ–°æ ¼å¼ï¼‰</option>
                  <option value="chat">/chat/completionsï¼ˆå‚³çµ±æ ¼å¼ï¼‰</option>
                </select>
                <div class="hint">å¦‚æœä½ å¾Œç«¯åªæ”¯æ´å…¶ä¸­ä¸€ç¨®ï¼Œåˆ‡æ›åˆ°å¯ç”¨çš„å°±è¡Œã€‚</div>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Model</label>
                <input class="field" id="model" list="modelHints" placeholder="ä¾‹å¦‚ï¼šgpt-4o-mini / gpt-4.1-mini / ä½ å¾Œç«¯çš„æ¨¡å‹å" />
                <datalist id="modelHints">
                  <option value="gpt-4o-mini"></option>
                  <option value="gpt-4.1-mini"></option>
                  <option value="gpt-4.1"></option>
                  <option value="gpt-4o"></option>
                </datalist>
              </div>

              <div>
                <label>API Key</label>
                <div class="inline">
                  <input class="field" id="apiKey" type="password" placeholder="è²¼ä¸Šä½ çš„ keyï¼ˆä¸æœƒè‡ªå‹•é€å‡ºï¼ŒæŒ‰ç”Ÿæˆæ‰ç”¨ï¼‰" style="flex:1" />
                  <button class="btn btnSmall btnGhost" id="toggleKey" type="button">é¡¯ç¤º</button>
                </div>
                <div class="hint">âš ï¸ ä¸è¦æŠŠ key ç›´æ¥å¯«é€²æª”æ¡ˆå¾Œå†ä¸Ÿ GitHub Pagesã€‚</div>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>ä¿å­˜è¨­å®šåˆ°æœ¬æ©Ÿ</label>
                <div class="inline">
                  <input id="saveLocal" type="checkbox" />
                  <span class="hint" style="margin:0">å‹¾é¸å¾ŒæœƒæŠŠ Base URL / æ¨¡å¼ / model / key ä¿å­˜åˆ° localStorageï¼ˆåŒä¸€å°è£ç½®æ‰æœ‰æ•ˆï¼‰ã€‚</span>
                </div>
              </div>
              <div>
                <label>Debug</label>
                <div class="inline" style="gap:10px; flex-wrap:wrap">
                  <button class="btn btnSmall" id="togglePrompt" type="button">é¡¯ç¤º Prompt</button>
                  <button class="btn btnSmall" id="toggleRaw" type="button">é¡¯ç¤º Raw JSON</button>
                  <button class="btn btnSmall btnDanger" id="clearLocal" type="button">æ¸…é™¤æœ¬æ©Ÿä¿å­˜</button>
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <b>å°èªªè¼¸å…¥</b>
              <span>å¯é¸å¯è‡ªè¨‚ï¼Œè¶Šå…·é«”è¶Šç©©</span>
            </div>

            <div class="row">
              <div>
                <label>ä¸»é¡Œ / ä¸€å¥è©±æ¢—æ¦‚ï¼ˆå¿…å¡«ï¼‰</label>
                <textarea class="field" id="topic" placeholder="ä¾‹ï¼šä¸€å€‹ç¤¾ç•œå·¥ç¨‹å¸«æ„å¤–æ”¶åˆ°æœªä¾†è‡ªå·±å¯„ä¾†çš„ Git commitï¼Œæç¤ºä»–ä»Šæ™šåˆ¥åŠ ç­â€¦â€¦"></textarea>
              </div>
              <div>
                <label>äººè¨­ / ä¸»è§’è¨­å®šï¼ˆå¯é¸æˆ–è‡ªè¨‚ï¼‰</label>
                <select class="field" id="personaPreset"></select>
                <div class="hint">é¸ä¸€å€‹å¿«é€Ÿå¥—ç”¨ï¼Œæˆ–åœ¨ä¸‹æ–¹è‡ªè¨‚ã€‚</div>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>è‡ªè¨‚äººè¨­ï¼ˆæœƒè¦†è“‹é è¨­ï¼‰</label>
                <textarea class="field" id="personaCustom" placeholder="ä¾‹ï¼šä¸»è§’ 29 æ­²ï¼Œè³‡æ·±è»Ÿé«”å·¥ç¨‹å¸«ï¼Œå¤–å†·å…§ç†±ï¼Œè¨å­ç„¡æ•ˆæœƒè­°ä½†å¾ˆåœ¨æ„åŒäº‹â€¦"></textarea>
              </div>
              <div>
                <label>ä¸–ç•Œè§€ / å ´æ™¯ï¼ˆå¯é¸ï¼‰</label>
                <textarea class="field" id="setting" placeholder="ä¾‹ï¼šè¿‘æœªä¾†å°åŒ—ï¼ŒAI åŠ©ç†æ™®åŠï¼Œå…¬å¸å°å…¥ã€è‡ªå‹•ç¸¾æ•ˆè©•åˆ†ã€ç³»çµ±â€¦"></textarea>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>é¡å‹ï¼ˆGenreï¼‰</label>
                <select class="field" id="genre"></select>
              </div>
              <div>
                <label>æ–‡é¢¨ï¼ˆStyle / Toneï¼‰</label>
                <select class="field" id="tone"></select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>è¦–è§’</label>
                <select class="field" id="pov">
                  <option value="ç¬¬ä¸€äººç¨±">ç¬¬ä¸€äººç¨±</option>
                  <option value="ç¬¬ä¸‰äººç¨±ï¼ˆè²¼è¿‘ä¸»è§’ï¼‰" selected>ç¬¬ä¸‰äººç¨±ï¼ˆè²¼è¿‘ä¸»è§’ï¼‰</option>
                  <option value="ç¬¬ä¸‰äººç¨±ï¼ˆå…¨çŸ¥ï¼‰">ç¬¬ä¸‰äººç¨±ï¼ˆå…¨çŸ¥ï¼‰</option>
                </select>
              </div>
              <div>
                <label>é•·åº¦ç›®æ¨™</label>
                <select class="field" id="length">
                  <option value="æ¥µçŸ­ç¯‡ï¼ˆ600ï½900å­—ï¼‰">æ¥µçŸ­ç¯‡ï¼ˆ600ï½900å­—ï¼‰</option>
                  <option value="çŸ­ç¯‡ï¼ˆ1200ï½2000å­—ï¼‰" selected>çŸ­ç¯‡ï¼ˆ1200ï½2000å­—ï¼‰</option>
                  <option value="ä¸­çŸ­ç¯‡ï¼ˆ2500ï½3500å­—ï¼‰">ä¸­çŸ­ç¯‡ï¼ˆ2500ï½3500å­—ï¼‰</option>
                  <option value="åˆ†ç« ï¼ˆ3ç« ï¼Œæ¯ç« 800ï½1200å­—ï¼‰">åˆ†ç« ï¼ˆ3ç« ï¼Œæ¯ç« 800ï½1200å­—ï¼‰</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div>
                <label>èªè¨€</label>
                <select class="field" id="lang">
                  <option value="ç¹é«”ä¸­æ–‡" selected>ç¹é«”ä¸­æ–‡</option>
                  <option value="ç°¡é«”ä¸­æ–‡">ç°¡é«”ä¸­æ–‡</option>
                  <option value="English">English</option>
                  <option value="æ—¥æœ¬èª">æ—¥æœ¬èª</option>
                </select>
              </div>
              <div>
                <label>åˆ†ç´š / å°ºåº¦</label>
                <select class="field" id="rating">
                  <option value="æ™®éç´šï¼ˆä¸è¡€è…¥ã€ä¸éœ²éª¨ï¼‰" selected>æ™®éç´šï¼ˆä¸è¡€è…¥ã€ä¸éœ²éª¨ï¼‰</option>
                  <option value="è¼”å°ç´šï¼ˆå¯ç·Šå¼µã€å¯å¾®æš´åŠ›ï¼‰">è¼”å°ç´šï¼ˆå¯ç·Šå¼µã€å¯å¾®æš´åŠ›ï¼‰</option>
                  <option value="æˆç†Ÿå‘ï¼ˆé¿å…éœ²éª¨æå¯«ï¼‰">æˆç†Ÿå‘ï¼ˆé¿å…éœ²éª¨æå¯«ï¼‰</option>
                </select>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>æƒ…ç¯€é‡é» / è½‰æŠ˜ï¼ˆå¯é¸ï¼‰</label>
              <textarea class="field" id="beats" placeholder="ä¾‹ï¼šé–‹é ­æ”¶åˆ°æœªä¾† commit â†’ ä¸­æ®µç™¼ç¾åŒäº‹è¢«ç³»çµ±é™·å®³ â†’ åè½‰ï¼šæœªä¾†è‡ªå·±å…¶å¯¦æ˜¯â€¦"></textarea>
            </div>

            <div class="divider"></div>

            <label>å¿…é ˆåŒ…å«ï¼ˆTagï¼‰</label>
            <div class="inline" style="gap:10px; flex-wrap:wrap">
              <input class="field" id="mustInput" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enterï¼ˆä¾‹ï¼šé›¨å¤œ / ä¾¿åˆ©å•†åº— / åè½‰ï¼‰" style="flex:1" />
              <button class="btn btnSmall" id="addMust" type="button">åŠ å…¥</button>
            </div>
            <div class="chips" id="mustChips" aria-label="must include chips"></div>

            <div style="height:10px"></div>

            <label>é¿å…å‡ºç¾ï¼ˆTagï¼‰</label>
            <div class="inline" style="gap:10px; flex-wrap:wrap">
              <input class="field" id="avoidInput" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enterï¼ˆä¾‹ï¼šçˆ›ä¿—å¤±æ†¶æ¢— / éåº¦æ—ç™½ï¼‰" style="flex:1" />
              <button class="btn btnSmall" id="addAvoid" type="button">åŠ å…¥</button>
            </div>
            <div class="chips" id="avoidChips" aria-label="avoid chips"></div>
          </div>

          <div class="section">
            <div class="sectionTitle">
              <b>ç”Ÿæˆåƒæ•¸ï¼ˆå¯ä¸æ”¹ï¼‰</b>
              <span>è¶Šé«˜è¶Šç™¼æ•£ï¼Œè¶Šä½è¶Šç©©</span>
            </div>

            <div class="row">
              <div>
                <label>Temperature</label>
                <input class="field" id="temp" type="number" min="0" max="2" step="0.05" value="0.9" />
              </div>
              <div>
                <label>Max output tokens</label>
                <input class="field" id="maxTokens" type="number" min="128" max="8192" step="64" value="1200" />
              </div>
            </div>

            <div class="btns">
              <button class="btn btnPrimary" id="btnGen" type="button">ğŸš€ ç”Ÿæˆå°èªª</button>
              <button class="btn btnDanger" id="btnStop" type="button" disabled>â›” ä¸­æ­¢</button>
              <button class="btn" id="btnClearOut" type="button">ğŸ§¹ æ¸…ç©ºè¼¸å‡º</button>
              <button class="btn" id="btnCopy" type="button">ğŸ“‹ è¤‡è£½</button>
              <button class="btn" id="btnDownload" type="button">â¬‡ï¸ ä¸‹è¼‰ TXT</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Output -->
      <div class="card outputWrap">
        <div class="outTop">
          <div class="statusLine">
            <span class="badge" id="runBadge">ç‹€æ…‹ï¼šå¾…å‘½</span>
            <span>æ¨¡å‹ï¼š<strong id="modelEcho">â€”</strong></span>
            <span>è¼¸å‡ºï¼š<strong id="charCount">0</strong> å­—å…ƒ</span>
          </div>
          <div class="inline" style="gap:8px; flex-wrap:wrap;">
            <span class="badge" id="endpointEcho">Endpointï¼šâ€”</span>
          </div>
        </div>

        <div class="outBody">
          <div class="okTip" id="okTip"></div>
          <div class="warn" id="errBox"></div>
          <div id="output" class="out">åœ¨å·¦é‚Šå¡«å¥½ã€Œä¸»é¡Œ / æ¢—æ¦‚ã€å¾ŒæŒ‰ã€Œç”Ÿæˆå°èªªã€ã€‚</div>

          <div class="log" id="promptBox"></div>
          <div class="log" id="rawBox"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(()=> {
  const $ = (id)=>document.getElementById(id);

  // --- state ---
  let mustTags = [];
  let avoidTags = [];
  let aborter = null;
  let showKey = false;
  let showPrompt = false;
  let showRaw = false;

  const personaPresets = [
    { name: "ï¼ˆä¸æŒ‡å®šï¼è®“ AI è‡ªç”±ç™¼æ®ï¼‰", text: "" },
    { name: "ç¤¾ç•œå·¥ç¨‹å¸«ï¼ˆå˜´ç¡¬å¿ƒè»Ÿï¼‰", text: "ä¸»è§’æ˜¯è³‡æ·±å·¥ç¨‹å¸«ï¼Œå¤–å†·å…§ç†±ã€åæ§½åŠŸåŠ›å¼·ï¼Œæ“…é•·è§£æ±ºè¤‡é›œå•é¡Œï¼Œä½†å…¶å¯¦å¾ˆåœ¨æ„åŒä¼´ï¼›èªªè©±ä¹¾è„†ã€å¸¶ä¸€é»é»‘è‰²å¹½é»˜ã€‚" },
    { name: "å†·é¢åˆ‘è­¦ï¼ˆç›´è¦ºæ´¾ï¼‰", text: "ä¸»è§’æ˜¯å†·é¢åˆ‘è­¦ï¼Œæ²‰é»˜å¯¡è¨€ã€æ´å¯ŸåŠ›å¼·ï¼Œç›´è¦ºæ•éŠ³ï¼›å°æ­£ç¾©æœ‰è‡ªå·±å›ºåŸ·çš„æ¨™æº–ã€‚" },
    { name: "æº«æŸ”ç³»è€å¸«ï¼ˆæ²»ç™’ï¼‰", text: "ä¸»è§’æ˜¯æº«æŸ”çš„è€å¸«ï¼Œæ“…é•·è§€å¯Ÿäººå¿ƒï¼›é‡äº‹å…ˆå®‰æ’«å†å¼•å°ï¼Œèªæ°£æº«æš–ä½†ä¸çŸ¯æƒ…ã€‚" },
    { name: "å†’éšªå‹çµäººï¼ˆç¡¬æ´¾ï¼‰", text: "ä¸»è§’æ˜¯ç¡¬æ´¾å†’éšªè€…ï¼çµäººï¼Œè¡Œå‹•æœæ–·ã€é‡è¦–å¥‘ç´„ï¼›åœ¨å±æ©Ÿä¸­ä¿æŒå†·éœï¼Œåå¯«å¯¦é¢¨æ ¼ã€‚" },
    { name: "å¤©æ‰ä½†ç¤¾äº¤è‹¦æ‰‹ï¼ˆè¼•å–œåŠ‡ï¼‰", text: "ä¸»è§’æ™ºå•†å¾ˆé«˜ä½†ç¤¾äº¤è‹¦æ‰‹ï¼Œå¸¸ç”¨éåº¦ç†æ€§è§£é‡‹ç”Ÿæ´»ï¼›åœ¨å°·å°¬å ´é¢ä¸è‡ªè¦ºè£½é€ ç¬‘é»ã€‚" },
  ];

  const genreOptions = [
    "ç¾ä»£éƒ½å¸‚","è·å ´","å¥‡å¹»","ç§‘å¹»","æ‡¸ç–‘æ¨ç†","é©šæ‚š","æ„›æƒ…","å†’éšª","ç™‚ç™’æ—¥å¸¸","é»‘è‰²å¹½é»˜","é’æ˜¥æ ¡åœ’","æœ«æ—¥","è‡ªè¨‚â€¦"
  ];

  const toneOptions = [
    "è¼•é¬†å¹½é»˜","æº«æš–æ²»ç™’","ç·Šå¼µåˆºæ¿€","é»‘æš—å¯«å¯¦","æµªæ¼«ç”œ","è‹¦ä¸­å¸¶ç”œ","å†·å†½å…‹åˆ¶","ç†±è¡€ç‡ƒ","è‡ªè¨‚â€¦"
  ];

  // --- init UI ---
  function initSelects(){
    // persona
    const sel = $("personaPreset");
    sel.innerHTML = personaPresets.map((p,i)=>`<option value="${i}">${p.name}</option>`).join("");
    sel.value = "1";

    // genre
    const g = $("genre");
    g.innerHTML = genreOptions.map(x=>`<option value="${x}">${x}</option>`).join("");
    g.value = "è·å ´";

    // tone
    const t = $("tone");
    t.innerHTML = toneOptions.map(x=>`<option value="${x}">${x}</option>`).join("");
    t.value = "è¼•é¬†å¹½é»˜";
  }

  // --- local storage ---
  const LSKEY = "novelGen.v1";
  function loadLocal(){
    try{
      const raw = localStorage.getItem(LSKEY);
      if(!raw) return;
      const s = JSON.parse(raw);
      if(s.baseUrl) $("baseUrl").value = s.baseUrl;
      if(s.apiMode) $("apiMode").value = s.apiMode;
      if(s.model) $("model").value = s.model;
      if(s.apiKey) $("apiKey").value = s.apiKey;
      if(Array.isArray(s.mustTags)) mustTags = s.mustTags;
      if(Array.isArray(s.avoidTags)) avoidTags = s.avoidTags;
      $("saveLocal").checked = !!s.saveLocal;
      renderChips();
    }catch(e){}
  }
  function saveLocal(){
    if(!$("saveLocal").checked) return;
    const s = {
      baseUrl: $("baseUrl").value.trim(),
      apiMode: $("apiMode").value,
      model: $("model").value.trim(),
      apiKey: $("apiKey").value,
      mustTags, avoidTags,
      saveLocal: $("saveLocal").checked
    };
    try{ localStorage.setItem(LSKEY, JSON.stringify(s)); }catch(e){}
  }
  function clearLocal(){
    localStorage.removeItem(LSKEY);
  }

  // --- chip helpers ---
  function addTag(kind, v){
    v = (v||"").trim();
    if(!v) return;
    const list = kind==="must" ? mustTags : avoidTags;
    if(list.includes(v)) return;
    list.push(v);
    renderChips();
    saveLocal();
  }
  function removeTag(kind, v){
    const list = kind==="must" ? mustTags : avoidTags;
    const idx = list.indexOf(v);
    if(idx>=0) list.splice(idx,1);
    renderChips();
    saveLocal();
  }
  function renderChips(){
    const mustBox = $("mustChips");
    const avoidBox = $("avoidChips");
    mustBox.innerHTML = mustTags.length
      ? mustTags.map(x=>`<span class="chip">${escapeHtml(x)} <button data-kind="must" data-tag="${escapeHtmlAttr(x)}" title="ç§»é™¤">Ã—</button></span>`).join("")
      : `<span class="hint">ï¼ˆå°šç„¡ï¼‰</span>`;
    avoidBox.innerHTML = avoidTags.length
      ? avoidTags.map(x=>`<span class="chip">${escapeHtml(x)} <button data-kind="avoid" data-tag="${escapeHtmlAttr(x)}" title="ç§»é™¤">Ã—</button></span>`).join("")
      : `<span class="hint">ï¼ˆå°šç„¡ï¼‰</span>`;
  }

  // --- origin / readiness ---
  function updateOrigin(){
    const isFile = location.protocol === "file:";
    const dot = $("dotOrigin");
    const txt = $("originText");
    if(isFile){
      dot.classList.add("bad");
      txt.textContent = "Originï¼šfile://ï¼ˆå®¹æ˜“ CORSï¼‰";
      $("fileWarn").classList.add("show");
    }else{
      dot.classList.add("ok");
      txt.textContent = "Originï¼š" + location.origin;
      $("fileWarn").classList.remove("show");
    }
  }
  function updateReady(){
    const baseUrl = $("baseUrl").value.trim();
    const key = $("apiKey").value.trim();
    const model = $("model").value.trim();
    const mode = $("apiMode").value;

    $("modeBadge").textContent = "æ¨¡å¼ï¼š" + (mode==="responses" ? "responses" : "chat");
    $("modelEcho").textContent = model || "â€”";

    const dot = $("dotReady");
    const txt = $("readyText");
    dot.classList.remove("ok","bad");
    if(baseUrl && key && model){
      dot.classList.add("ok");
      txt.textContent = "APIï¼šå·²è¨­å®š";
    }else{
      dot.classList.add("bad");
      txt.textContent = "APIï¼šæœªè¨­å®šå®Œæ•´";
    }

    const endpoint = (mode==="responses") ? (baseUrl.replace(/\/$/,"") + "/responses") : (baseUrl.replace(/\/$/,"") + "/chat/completions");
    $("endpointEcho").textContent = "Endpointï¼š" + (baseUrl ? endpoint : "â€”");
  }

  // --- prompt builder ---
  function buildPrompt(){
    const topic = $("topic").value.trim();
    const personaCustom = $("personaCustom").value.trim();
    const personaText = personaCustom || personaPresets[Number($("personaPreset").value||0)]?.text || "";
    const setting = $("setting").value.trim();
    const genre = $("genre").value;
    const tone = $("tone").value;
    const pov = $("pov").value;
    const length = $("length").value;
    const lang = $("lang").value;
    const rating = $("rating").value;
    const beats = $("beats").value.trim();

    const finalGenre = (genre==="è‡ªè¨‚â€¦" ? "ï¼ˆæœªæŒ‡å®š / è‡ªç”±ç™¼æ®ï¼‰" : genre);
    const finalTone = (tone==="è‡ªè¨‚â€¦" ? "ï¼ˆæœªæŒ‡å®š / è‡ªç”±ç™¼æ®ï¼‰" : tone);

    const must = mustTags.length ? mustTags.join("ã€") : "ï¼ˆç„¡ï¼‰";
    const avoid = avoidTags.length ? avoidTags.join("ã€") : "ï¼ˆç„¡ï¼‰";

    const system = [
      "ä½ æ˜¯ä¸€ä½æ“…é•·æ•˜äº‹ç¯€å¥ã€ç•«é¢æ„Ÿã€äººç‰©å°ç™½çš„å°èªªä½œå®¶ã€‚",
      "è«‹é¿å…é‡è¤‡å¥å‹èˆ‡é‡è¤‡è³‡è¨Šï¼›æ¯å€‹æ®µè½è¦æ¨é€²æƒ…ç¯€æˆ–æ·±åŒ–è§’è‰²ã€‚",
      "ä»¥å…·é«”å‹•ä½œã€å ´æ™¯ç´°ç¯€ã€å°ç™½å‘ˆç¾ï¼Œä¸è¦é•·ç¯‡æ¦‚å¿µæ€§èªªæ•™ã€‚",
      "æ–‡ç­†è‡ªç„¶ã€æœ‰å±¤æ¬¡ï¼Œä¸¦ä¿æŒè®€è€…å¯è®€æ€§ï¼ˆä¸è¦éåº¦è¯éº—å †ç Œï¼‰ã€‚",
      "éµå®ˆä½¿ç”¨è€…æŒ‡å®šçš„åˆ†ç´š/å°ºåº¦é™åˆ¶ã€‚"
    ].join("\n");

    const user = [
      `ã€è¼¸å‡ºèªè¨€ã€‘${lang}`,
      `ã€é¡å‹ã€‘${finalGenre}`,
      `ã€æ–‡é¢¨ã€‘${finalTone}`,
      `ã€æ•˜äº‹è¦–è§’ã€‘${pov}`,
      `ã€é•·åº¦ã€‘${length}`,
      `ã€åˆ†ç´š/å°ºåº¦ã€‘${rating}`,
      "",
      `ã€ä¸»é¡Œ/æ¢—æ¦‚ã€‘\n${topic}`,
      "",
      personaText ? `ã€äººè¨­ã€‘\n${personaText}\n` : "",
      setting ? `ã€ä¸–ç•Œè§€/å ´æ™¯ã€‘\n${setting}\n` : "",
      beats ? `ã€æƒ…ç¯€é‡é»/è½‰æŠ˜ã€‘\n${beats}\n` : "",
      `ã€å¿…é ˆåŒ…å«ã€‘${must}`,
      `ã€é¿å…å‡ºç¾ã€‘${avoid}`,
      "",
      "ã€æ ¼å¼è¦æ±‚ã€‘",
      "1) ç›´æ¥è¼¸å‡ºå°èªªæ­£æ–‡ï¼ˆä¸è¦åˆ—å‡ºåˆ†ææ­¥é©Ÿï¼‰ã€‚",
      "2) è«‹ç”¨è‡ªç„¶åˆ†æ®µï¼›è‹¥ç‚ºåˆ†ç« ï¼Œæ¨™ç¤ºç¬¬ 1 ç«  / ç¬¬ 2 ç«  / ç¬¬ 3 ç« ã€‚",
      "3) è®“çµå°¾æœ‰é¤˜éŸ»æˆ–å°åè½‰ï¼ˆè‹¥é¡Œæé©åˆï¼‰ã€‚"
    ].filter(Boolean).join("\n");

    return { system, user };
  }

  // --- request builders (openai-compatible) ---
  function makeRequestBody(mode, model, temp, maxTokens, prompt){
    if(mode === "responses"){
      // Try OpenAI Responses-like schema (best-effort compatible)
      return {
        model,
        input: [
          { role: "system", content: [{ type: "text", text: prompt.system }] },
          { role: "user", content: [{ type: "text", text: prompt.user }] }
        ],
        temperature: temp,
        max_output_tokens: maxTokens
      };
    }
    // chat/completions
    return {
      model,
      messages: [
        { role: "system", content: prompt.system },
        { role: "user", content: prompt.user }
      ],
      temperature: temp,
      max_tokens: maxTokens
    };
  }

  function extractText(mode, data){
    // Robust extraction for different compatible backends
    try{
      // responses style
      if(typeof data.output_text === "string" && data.output_text.trim()) return data.output_text;
      if(Array.isArray(data.output)){
        let acc = "";
        for(const item of data.output){
          const c = item?.content;
          if(Array.isArray(c)){
            for(const part of c){
              if(part?.type === "output_text" && typeof part.text === "string") acc += part.text;
              if(part?.type === "text" && typeof part.text === "string") acc += part.text;
            }
          }
        }
        if(acc.trim()) return acc;
      }
      // chat style
      const c0 = data?.choices?.[0]?.message?.content;
      if(typeof c0 === "string" && c0.trim()) return c0;
      // some providers: choices[0].text
      const t0 = data?.choices?.[0]?.text;
      if(typeof t0 === "string" && t0.trim()) return t0;
    }catch(e){}
    return "";
  }

  // --- output helpers ---
  function setStatus(kind, msg){
    const badge = $("runBadge");
    badge.textContent = "ç‹€æ…‹ï¼š" + msg;
    if(kind==="run"){
      badge.style.borderColor = "rgba(110,231,255,.35)";
      badge.style.background = "rgba(110,231,255,.08)";
      badge.style.color = "rgba(232,255,255,.92)";
    }else if(kind==="ok"){
      badge.style.borderColor = "rgba(103,232,165,.28)";
      badge.style.background = "rgba(103,232,165,.08)";
      badge.style.color = "rgba(232,255,244,.92)";
    }else if(kind==="err"){
      badge.style.borderColor = "rgba(255,107,107,.30)";
      badge.style.background = "rgba(255,107,107,.10)";
      badge.style.color = "#ffd4d4";
    }else{
      badge.style.borderColor = "var(--line)";
      badge.style.background = "rgba(255,255,255,.03)";
      badge.style.color = "var(--muted)";
    }
  }
  function showError(text){
    $("errBox").textContent = text;
    $("errBox").classList.add("show");
  }
  function clearError(){
    $("errBox").textContent = "";
    $("errBox").classList.remove("show");
  }
  function tipOk(text){
    $("okTip").textContent = text;
    $("okTip").classList.add("show");
  }
  function clearTip(){
    $("okTip").textContent = "";
    $("okTip").classList.remove("show");
  }

  // --- main generate ---
  async function generate(){
    clearError();
    clearTip();

    const baseUrl = $("baseUrl").value.trim().replace(/\/$/,"");
    const mode = $("apiMode").value;
    const endpoint = mode==="responses" ? (baseUrl + "/responses") : (baseUrl + "/chat/completions");
    const model = $("model").value.trim();
    const apiKey = $("apiKey").value;
    const temp = Number($("temp").value || 0.9);
    const maxTokens = Number($("maxTokens").value || 1200);

    if(!$("topic").value.trim()){
      showError("è«‹å…ˆå¡«ï¼šä¸»é¡Œ / ä¸€å¥è©±æ¢—æ¦‚ï¼ˆå¿…å¡«ï¼‰ã€‚");
      return;
    }
    if(!baseUrl || !model || !apiKey){
      showError("API æœªè¨­å®šå®Œæ•´ï¼šè«‹å¡« Base URLã€Modelã€API Keyã€‚");
      return;
    }
    if(location.protocol==="file:" && endpoint.startsWith("file:")){
      showError("ä½ ç›®å‰ç”¨ file:// é–‹å•Ÿï¼Œendpoint æœƒè®Šæˆ file://... é€™ç¨®ä¸€å®šå¤±æ•—ã€‚è«‹æ”¹ç”¨ http://localhost æ–¹å¼é–‹å•Ÿã€‚");
      return;
    }

    // prepare request
    const prompt = buildPrompt();
    const body = makeRequestBody(mode, model, temp, maxTokens, prompt);

    if(showPrompt){
      $("promptBox").textContent = "=== SYSTEM ===\n" + prompt.system + "\n\n=== USER ===\n" + prompt.user;
      $("promptBox").classList.add("show");
    }
    if(showRaw){
      $("rawBox").textContent = "=== REQUEST JSON ===\n" + JSON.stringify({ endpoint, body }, null, 2);
      $("rawBox").classList.add("show");
    }

    saveLocal();
    updateReady();

    // run
    $("btnGen").disabled = true;
    $("btnStop").disabled = false;
    setStatus("run", "ç”Ÿæˆä¸­â€¦");
    $("output").textContent = "ç”Ÿæˆä¸­â€¦ï¼ˆå¦‚æœå¡ä½ï¼Œå¤šåŠæ˜¯ CORS æˆ– endpoint æ¨¡å¼ä¸å°ï¼Œè©¦è‘—åˆ‡æ› responses/chatï¼‰";
    $("charCount").textContent = "0";

    aborter = new AbortController();
    const startedAt = Date.now();

    try{
      const res = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + apiKey
        },
        body: JSON.stringify(body),
        signal: aborter.signal
      });

      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); }catch(e){}

      if(!res.ok){
        const maybeMsg = data?.error?.message || data?.message || text || ("HTTP " + res.status);
        throw new Error("è«‹æ±‚å¤±æ•—ï¼š" + res.status + "\n" + maybeMsg);
      }

      const outText = extractText(mode, data);
      if(!outText.trim()){
        // if response schema differs, still show raw
        $("output").textContent = "æœ‰æ‹¿åˆ°å›æ‡‰ï¼Œä½†æŠ“ä¸åˆ°æ–‡å­—æ¬„ä½ï¼ˆå¯èƒ½å¾Œç«¯å›å‚³æ ¼å¼ä¸åŒï¼‰ã€‚\n\nå·²åœ¨ Raw JSON é¡¯ç¤º responseï¼Œè«‹æŠŠå®ƒè²¼çµ¦æˆ‘æˆ‘å¹«ä½ å°é½Šæ¬„ä½ã€‚";
        setStatus("err", "æ ¼å¼ä¸ç¬¦");
        if(!showRaw){
          showRaw = true;
          $("rawBox").classList.add("show");
        }
        $("rawBox").textContent = "=== RESPONSE RAW ===\n" + (data ? JSON.stringify(data, null, 2) : text);
        return;
      }

      $("output").textContent = outText.trim();
      $("charCount").textContent = String(outText.length);

      const ms = Date.now() - startedAt;
      setStatus("ok", "å®Œæˆ");
      tipOk("å®Œæˆ âœ… ç”¨æ™‚ " + Math.round(ms/100)/10 + " ç§’ã€‚æƒ³è¦æ›´åƒæŸç¨®é¢¨æ ¼ï¼šæŠŠã€Œæ–‡é¢¨ã€æ”¹æˆè‡ªè¨‚ä¸¦å¯«å¾—æ›´å…·é«”ã€‚");

      if(showRaw){
        $("rawBox").textContent = "=== RESPONSE JSON ===\n" + JSON.stringify(data, null, 2);
      }
    }catch(err){
      if(err?.name === "AbortError"){
        setStatus("err", "å·²ä¸­æ­¢");
        showError("å·²ä¸­æ­¢è«‹æ±‚ã€‚");
      }else{
        setStatus("err", "å¤±æ•—");
        const msg = String(err?.message || err || "Unknown error");
        showError(msg + "\n\nå¸¸è¦‹åŸå› ï¼š\n- CORSï¼šå‰ç«¯èˆ‡ API ç¶²åŸŸä¸åŒä½†å¾Œç«¯æ²’é–‹ Access-Control-Allow-Origin\n- Endpoint/æ¨¡å¼ä¸å°ï¼šåˆ‡æ› responses â†” chat\n- Base URL å¤šæ‰“ä¸€å±¤ /v1 æˆ–å°‘äº† /v1\n- Model åç¨±èˆ‡ä½ å¾Œç«¯ä¸ä¸€è‡´");
      }
    }finally{
      $("btnGen").disabled = false;
      $("btnStop").disabled = true;
      aborter = null;
    }
  }

  // --- utilities ---
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }
  function escapeHtmlAttr(s){
    return escapeHtml(s).replace(/"/g, "&quot;");
  }

  // --- events ---
  $("toggleKey").addEventListener("click", ()=>{
    showKey = !showKey;
    $("apiKey").type = showKey ? "text" : "password";
    $("toggleKey").textContent = showKey ? "éš±è—" : "é¡¯ç¤º";
  });

  $("togglePrompt").addEventListener("click", ()=>{
    showPrompt = !showPrompt;
    $("promptBox").classList.toggle("show", showPrompt);
    $("togglePrompt").textContent = showPrompt ? "éš±è— Prompt" : "é¡¯ç¤º Prompt";
    if(showPrompt){
      const p = buildPrompt();
      $("promptBox").textContent = "=== SYSTEM ===\n" + p.system + "\n\n=== USER ===\n" + p.user;
    }
  });

  $("toggleRaw").addEventListener("click", ()=>{
    showRaw = !showRaw;
    $("rawBox").classList.toggle("show", showRaw);
    $("toggleRaw").textContent = showRaw ? "éš±è— Raw JSON" : "é¡¯ç¤º Raw JSON";
    if(showRaw){
      $("rawBox").textContent = "ï¼ˆå°‡åœ¨é€å‡ºå¾Œé¡¯ç¤º request/responseï¼‰";
    }
  });

  $("clearLocal").addEventListener("click", ()=>{
    clearLocal();
    tipOk("å·²æ¸…é™¤æœ¬æ©Ÿä¿å­˜ã€‚");
  });

  $("saveLocal").addEventListener("change", ()=>{
    if(!$("saveLocal").checked){
      tipOk("å·²å–æ¶ˆä¿å­˜ï¼ˆä½†ç¾æœ‰ localStorage ä¸æœƒè‡ªå‹•åˆªé™¤ï¼Œå¯æŒ‰ã€æ¸…é™¤æœ¬æ©Ÿä¿å­˜ã€ï¼‰ã€‚");
      return;
    }
    saveLocal();
    tipOk("å·²å•Ÿç”¨ä¿å­˜åˆ°æœ¬æ©Ÿã€‚");
  });

  ["baseUrl","apiMode","model","apiKey"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ updateReady(); if($("saveLocal").checked) saveLocal(); });
    $(id).addEventListener("change", ()=>{ updateReady(); if($("saveLocal").checked) saveLocal(); });
  });

  $("personaPreset").addEventListener("change", ()=>{
    // just a UX tip: do not force overwrite custom
    if($("personaCustom").value.trim()){
      tipOk("ä½ å·²å¡«è‡ªè¨‚äººè¨­ï¼šç”Ÿæˆæ™‚æœƒä»¥ã€Œè‡ªè¨‚ã€ç‚ºä¸»ï¼ˆä¸å—é è¨­å½±éŸ¿ï¼‰ã€‚");
    }
  });

  $("addMust").addEventListener("click", ()=>{ addTag("must", $("mustInput").value); $("mustInput").value=""; $("mustInput").focus(); });
  $("addAvoid").addEventListener("click", ()=>{ addTag("avoid", $("avoidInput").value); $("avoidInput").value=""; $("avoidInput").focus(); });

  $("mustInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); $("addMust").click(); }});
  $("avoidInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); $("addAvoid").click(); }});

  document.addEventListener("click", (e)=>{
    const btn = e.target?.closest?.("button[data-kind][data-tag]");
    if(!btn) return;
    removeTag(btn.dataset.kind, btn.dataset.tag);
  });

  $("btnGen").addEventListener("click", generate);
  $("btnStop").addEventListener("click", ()=>{ if(aborter) aborter.abort(); });

  $("btnClearOut").addEventListener("click", ()=>{
    $("output").textContent = "å·²æ¸…ç©ºã€‚";
    $("charCount").textContent = "0";
    clearError(); clearTip();
  });

  $("btnCopy").addEventListener("click", async ()=>{
    try{
      const text = $("output").textContent || "";
      await navigator.clipboard.writeText(text);
      tipOk("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…");
    }catch(e){
      showError("è¤‡è£½å¤±æ•—ï¼ˆå¯èƒ½ç€è¦½å™¨ä¸å…è¨±ï¼‰ã€‚ä½ å¯ä»¥æ‰‹å‹•å…¨é¸è¤‡è£½ã€‚");
    }
  });

  $("btnDownload").addEventListener("click", ()=>{
    const text = $("output").textContent || "";
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "novel.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    tipOk("å·²ä¸‹è¼‰ TXT âœ…");
  });

  // --- start ---
  initSelects();
  loadLocal();

  // defaults if empty
  if(!$("baseUrl").value.trim()) $("baseUrl").value = "https://api.openai.com/v1";
  if(!$("model").value.trim()) $("model").value = "gpt-4o-mini";
  if(typeof $("saveLocal").checked !== "boolean") $("saveLocal").checked = true;
  if($("saveLocal").checked === false){
    // keep as user choice
  }else{
    $("saveLocal").checked = true;
  }

  // fill persona preset select label
  // injecting options already done; no need.
  renderChips();
  updateOrigin();
  updateReady();
})();
</script>
</body>
</html>
