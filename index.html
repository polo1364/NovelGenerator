<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>小說生成器</title>
    <style>
      :root {
        --primary: #8b6f47;
        --primary-hover: #6b5535;
        --secondary: #a0826d;
        --secondary-hover: #8a6d57;
        --accent: #d4af37;
        --background: #f5f1ed;
        --card-bg: #fefdfb;
        --section-bg: #faf8f5;
        --input-bg: #fdfcfa;
        --text-primary: #2c2416;
        --text-secondary: #5a4f47;
        --border-color: #e8dfd5;
        --success: #6b9e7f;
        --warning: #c89a6b;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Georgia', 'Noto Serif TC', serif;
        background: linear-gradient(135deg, #f5f1ed 0%, #ede8e2 100%);
        color: var(--text-primary);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 30px 20px;
      }

      .container {
        max-width: 1000px;
        width: 100%;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 30px;
        border-bottom: 3px solid var(--accent);
      }

      h1 {
        font-size: 2.8rem;
        color: var(--primary);
        font-weight: 700;
        letter-spacing: 2px;
        margin-bottom: 12px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
      }

      .subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
        font-style: italic;
        line-height: 1.6;
        max-width: 600px;
        margin: 0 auto;
      }

      .card {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(139, 111, 71, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
        padding: 40px;
        border: 1px solid var(--border-color);
      }

      .section {
        background: var(--section-bg);
        border-radius: 10px;
        padding: 28px;
        margin-bottom: 28px;
        border-left: 4px solid var(--accent);
        transition: all 0.3s ease;
      }

      .section:hover {
        box-shadow: 0 4px 16px rgba(139, 111, 71, 0.06);
        transform: translateX(2px);
      }

      .section-title {
        font-weight: 700;
        font-size: 1.3rem;
        color: var(--primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title::before {
        content: '✦';
        color: var(--accent);
        font-size: 1.2rem;
      }

      .input-group {
        margin-bottom: 18px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary);
        font-size: 0.95rem;
        letter-spacing: 0.5px;
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .label-row label {
        font-weight: 600;
        color: var(--primary);
      }

      .label-row .button-group {
        display: flex;
        gap: 8px;
      }

      .label-row button {
        background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-hover) 100%);
        color: #fff;
        padding: 8px 16px;
        font-size: 0.85rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(139, 111, 71, 0.2);
      }

      .label-row button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 111, 71, 0.3);
      }

      .label-row button:active {
        transform: translateY(0);
      }

      /* API 金鑰輸入與顯示隱藏控制 */
      .api-key-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .api-key-container input {
        flex: 1;
      }

      .api-key-container button.api-toggle {
        background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-hover) 100%);
        color: #fff;
        padding: 10px 16px;
        font-size: 0.85rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(139, 111, 71, 0.2);
      }

      .api-key-container button.api-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 111, 71, 0.3);
      }

      /* 主要人物動態行 */
      .character-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 14px;
        align-items: center;
        background: var(--card-bg);
        padding: 14px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .character-row:hover {
        box-shadow: 0 2px 8px rgba(139, 111, 71, 0.1);
      }

      .character-row .char-index {
        flex: 0 0 auto;
        font-weight: 700;
        color: var(--accent);
        display: flex;
        align-items: center;
        font-size: 0.95rem;
        background: rgba(212, 175, 55, 0.1);
        padding: 4px 10px;
        border-radius: 4px;
      }

      .character-row input {
        flex: 1 1 160px;
        min-width: 120px;
      }

      .character-row button {
        background: linear-gradient(135deg, #c89a6b 0%, #b8845d 100%);
        color: #fff;
        padding: 8px 14px;
        font-size: 0.85rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(200, 154, 107, 0.2);
      }

      .character-row button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(200, 154, 107, 0.3);
      }

      /* 章節按鈕容器與按鈕樣式 */
      .chapter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
      }

      .chapter-buttons button {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: #fff;
        padding: 10px 18px;
        font-size: 0.9rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(139, 111, 71, 0.2);
      }

      .chapter-buttons button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 111, 71, 0.3);
      }

      .chapter-buttons button.active {
        background: linear-gradient(135deg, var(--accent) 0%, #c49a2f 100%);
        color: var(--primary);
      }

      input[type="text"],
      input[type="number"],
      input[type="password"],
      select,
      textarea {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--input-bg);
        font-size: 0.95rem;
        font-family: inherit;
        box-sizing: border-box;
        transition: all 0.3s ease;
        color: var(--text-primary);
      }

      input[type="text"]::placeholder,
      input[type="number"]::placeholder,
      input[type="password"]::placeholder,
      textarea::placeholder {
        color: var(--text-secondary);
        opacity: 0.6;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.15);
        background: #fffef9;
      }

      select {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238b6f47' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px;
        padding-right: 36px;
      }

      textarea {
        min-height: 110px;
        resize: vertical;
        font-family: 'Georgia', serif;
      }

      .buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        margin-top: 30px;
        justify-content: center;
      }

      button {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: #fff;
        padding: 14px 32px;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 700;
        letter-spacing: 1px;
        box-shadow: 0 4px 12px rgba(139, 111, 71, 0.25);
        text-transform: uppercase;
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(139, 111, 71, 0.35);
      }

      button:active {
        transform: translateY(-1px);
      }

      button:disabled {
        background: linear-gradient(135deg, #c9c4bc 0%, #b8b0a5 100%);
        cursor: not-allowed;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transform: none;
      }

      .status {
        margin-top: 20px;
        padding: 14px 18px;
        font-size: 0.95rem;
        color: var(--text-secondary);
        background: rgba(212, 175, 55, 0.08);
        border-radius: 8px;
        border-left: 4px solid var(--accent);
        min-height: 24px;
      }

      .output {
        margin-top: 30px;
        padding: 32px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: linear-gradient(135deg, #fffef9 0%, #fdfcfa 100%);
        font-family: 'Georgia', 'Noto Serif TC', serif;
        font-size: 1.05rem;
        line-height: 2;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: var(--text-primary);
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.02);
        min-height: 100px;
      }

      .output:empty::before {
        content: '您的故事將在此顯示...';
        color: var(--text-secondary);
        opacity: 0.5;
        font-style: italic;
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
        body {
          padding: 20px 12px;
        }

        .card {
          padding: 24px;
        }

        h1 {
          font-size: 2rem;
        }

        .section {
          padding: 20px;
        }

        .buttons {
          flex-direction: column;
        }

        button {
          width: 100%;
        }

        .character-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .character-row input {
          width: 100%;
        }

        .character-row button {
          width: 100%;
        }

        .label-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .label-row .button-group {
          width: 100%;
          margin-top: 8px;
        }

        .label-row button {
          flex: 1;
        }
      }

      /* 動畫效果 */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .section {
        animation: fadeIn 0.5s ease-out;
      }

      .output {
        animation: fadeIn 0.6s ease-out;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>✦ 小說生成器 ✦</h1>
        <p class="subtitle">
          組合主題、背景、人物與章節數，產出專屬於您的長篇故事。完成後可以直接閱讀或下載純文字檔。
        </p>
      </div>

      <div class="card">
        <!-- 基本設定 -->
        <div class="section">
          <h2 class="section-title">基本設定</h2>
          <div class="input-group">
            <label for="apiKey">Gemini API 金鑰</label>
            <div class="api-key-container">
              <input
                type="password"
                id="apiKey"
                placeholder="請輸入您的 API 金鑰"
                autocomplete="off"
              />
              <button type="button" id="toggleApiKeyVisibility" class="api-toggle">顯示</button>
            </div>
          </div>
          <div class="input-group">
            <label for="model">選擇模型</label>
            <select id="model">
              <option value="gemini-2.5-flash">gemini‑2.5‑flash</option>
              <option value="gemini-pro">gemini‑pro</option>
            </select>
          </div>
        </div>

        <!-- 故事元素 -->
        <div class="section">
          <h2 class="section-title">故事元素</h2>
          <div class="input-group">
            <label for="theme">主題</label>
            <select id="theme">
              <option value="">請選擇主題</option>
              <option value="奇幻冒險">奇幻冒險</option>
              <option value="未來科幻">未來科幻</option>
              <option value="浪漫愛情">浪漫愛情</option>
              <option value="懸疑推理">懸疑推理</option>
              <option value="歷史傳奇">歷史傳奇</option>
              <option value="青春成長">青春成長</option>
              <option value="冒險史詩">冒險史詩</option>
              <option value="玄幻修真">玄幻修真</option>
              <option value="現代都市">現代都市</option>
              <option value="魔法學院">魔法學院</option>
              <option value="恐怖驚悚">恐怖驚悚</option>
              <option value="喜劇逗趣">喜劇逗趣</option>
              <option value="現實主義">現實主義</option>
              <option value="懷舊故事">懷舊故事</option>
              <option value="神秘奇案">神秘奇案</option>
              <option value="動物寓言">動物寓言</option>
              <option value="社會批判">社會批判</option>
              <option value="魔幻現實">魔幻現實</option>
              <option value="古裝武俠">古裝武俠</option>
              <option value="時空穿越">時空穿越</option>
            </select>
          </div>
          <div class="input-group">
            <label for="setting">背景設定</label>
            <select id="setting">
              <option value="">請選擇背景</option>
              <option value="虛構的中世紀王國">虛構的中世紀王國</option>
              <option value="21世紀的臺灣都市">21世紀的臺灣都市</option>
              <option value="遙遠的太空殖民地">遙遠的太空殖民地</option>
              <option value="虛擬實境世界">虛擬實境世界</option>
              <option value="古代皇宮">古代皇宮</option>
              <option value="末日後的荒土">末日後的荒土</option>
              <option value="近未來的高科技城市">近未來的高科技城市</option>
              <option value="魔法學院">魔法學院</option>
              <option value="蒸汽龐克城市">蒸汽龐克城市</option>
              <option value="深海王國">深海王國</option>
              <option value="繁華的銀河商場">繁華的銀河商場</option>
              <option value="隱藏於雲端的城堡">隱藏於雲端的城堡</option>
              <option value="古老的山林村落">古老的山林村落</option>
              <option value="雪山上的修道院">雪山上的修道院</option>
              <option value="熱帶雨林深處">熱帶雨林深處</option>
              <option value="巨型迷宮都市">巨型迷宮都市</option>
              <option value="殖民海盜船">殖民海盜船</option>
              <option value="宇宙戰艦上">宇宙戰艦上</option>
              <option value="明朝宮廷">明朝宮廷</option>
              <option value="平行宇宙">平行宇宙</option>
            </select>
          </div>
          <div class="input-group">
            <div class="label-row">
              <label>主要人物設定</label>
              <div class="button-group">
                <button id="randomAllCharactersBtn" type="button">隨機人物</button>
                <button id="addCharacterBtn" type="button">新增人物</button>
              </div>
            </div>
            <div id="charactersContainer"></div>
          </div>
          <div class="input-group">
            <label for="style">故事風格</label>
            <select id="style">
              <option value="">請選擇風格</option>
              <option value="詩意">詩意</option>
              <option value="幽默">幽默</option>
              <option value="黑暗">黑暗</option>
              <option value="勵志">勵志</option>
              <option value="浪漫">浪漫</option>
              <option value="刺激">刺激</option>
              <option value="溫馨">溫馨</option>
              <option value="懸疑">懸疑</option>
              <option value="熱血">熱血</option>
              <option value="魔幻">魔幻</option>
              <option value="古典華麗">古典華麗</option>
              <option value="荒誕">荒誕</option>
              <option value="現實主義">現實主義</option>
              <option value="輕鬆寫意">輕鬆寫意</option>
              <option value="酷炫科技">酷炫科技</option>
              <option value="優雅浪漫">優雅浪漫</option>
              <option value="大河戲劇">大河戲劇</option>
              <option value="黑色幽默">黑色幽默</option>
              <option value="心理驚悚">心理驚悚</option>
              <option value="流行網絡">流行網絡</option>
            </select>
          </div>
          <div class="input-group">
            <label for="chapters">章節數</label>
            <input
              type="number"
              id="chapters"
              placeholder="如：10"
              min="1"
              max="50"
              step="1"
            />
          </div>
          <div class="input-group">
            <label for="length">預計總字數</label>
            <input
              type="number"
              id="length"
              placeholder="如：50000"
              min="1000"
              max="200000"
              step="1000"
            />
          </div>
        </div>

        <!-- 其他說明 -->
        <div class="section">
          <h2 class="section-title">其他說明</h2>
          <div class="input-group">
            <label for="notes">補充說明（選填）</label>
            <textarea
              id="notes"
              placeholder="如有額外情節或風格要求，可在此補充。"
            ></textarea>
          </div>
        </div>

        <!-- 控制按鈕 -->
        <div class="buttons">
          <button id="randomBtn" type="button">隨機填充</button>
          <button id="generateBtn" type="button">開始生成</button>
          <button id="downloadBtn" type="button" disabled>下載小說</button>
        </div>
        <div id="status" class="status"></div>
        <div id="result" class="output"></div>
      </div>
    </div>

    <script>
      // 取得元素
      const apiKeyInput = document.getElementById('apiKey');
      const modelSelect = document.getElementById('model');
      const themeSelect = document.getElementById('theme');
      const settingSelect = document.getElementById('setting');
      const styleSelect = document.getElementById('style');
      const chaptersInput = document.getElementById('chapters');
      const lengthInput = document.getElementById('length');
      const notesInput = document.getElementById('notes');
      const randomBtn = document.getElementById('randomBtn');
      const generateBtn = document.getElementById('generateBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const statusDiv = document.getElementById('status');
      const resultDiv = document.getElementById('result');

      // API 金鑰顯示/隱藏按鈕
      const toggleApiKeyVisibility = document.getElementById('toggleApiKeyVisibility');

      // 新增角色相關元素
      const charactersContainer = document.getElementById('charactersContainer');
      const randomAllCharactersBtn = document.getElementById('randomAllCharactersBtn');
      const addCharacterBtn = document.getElementById('addCharacterBtn');

      // 目前產出的故事文字
      let latestStory = '';

      // 儲存與讀取 API 金鑰
      const storedKey = localStorage.getItem('geminiApiKey');
      if (storedKey) {
        apiKeyInput.value = storedKey;
      }
      apiKeyInput.addEventListener('change', () => {
        const val = apiKeyInput.value.trim();
        if (val) localStorage.setItem('geminiApiKey', val);
      });

      // 載入先前生成並儲存的故事（如果有）
      const savedStory = localStorage.getItem('savedStory');
      if (savedStory) {
        latestStory = savedStory;
        resultDiv.textContent = savedStory;
        downloadBtn.disabled = false;
      }

      // 切換 API 金鑰顯示/隱藏
      if (toggleApiKeyVisibility) {
        toggleApiKeyVisibility.addEventListener('click', () => {
          const currentType = apiKeyInput.getAttribute('type');
          if (currentType === 'password') {
            apiKeyInput.setAttribute('type', 'text');
            toggleApiKeyVisibility.textContent = '隱藏';
          } else {
            apiKeyInput.setAttribute('type', 'password');
            toggleApiKeyVisibility.textContent = '顯示';
          }
        });
      }

      // 隨機資料庫
      const themes = [
        '奇幻冒險',
        '未來科幻',
        '浪漫愛情',
        '懸疑推理',
        '歷史傳奇',
        '青春成長',
        '冒險史詩',
        '玄幻修真',
        '現代都市',
        '魔法學院',
        '恐怖驚悚',
        '喜劇逗趣',
        '現實主義',
        '懷舊故事',
        '神秘奇案',
        '動物寓言',
        '社會批判',
        '魔幻現實',
        '古裝武俠',
        '時空穿越',
      ];
      const settings = [
        '虛構的中世紀王國',
        '21世紀的臺灣都市',
        '遙遠的太空殖民地',
        '虛擬實境世界',
        '古代皇宮',
        '末日後的荒土',
        '近未來的高科技城市',
        '魔法學院',
        '蒸汽龐克城市',
        '深海王國',
      ];
      const charactersSamples = [
        '一位勇敢的少年與他的神秘導師',
        '一個叛逆的黑客與一名懷有秘密的特工',
        '一位失憶的戰士與一個外星科學家',
        '一名平凡少女與她的魔法朋友',
        '一個失去家園的旅人與一隻會說話的動物',
        '一位年輕的巫師與他的忠實貓咪夥伴',
        '一名落魄騎士與他的騙子朋友',
        '一個熱血少年和沉默寡言的劍士',
        '一位外星公主與地球少年',
        '一名機器人與它的創造者',
      ];
      const stylesArr = [
        '詩意',
        '幽默',
        '黑暗',
        '勵志',
        '浪漫',
        '刺激',
        '溫馨',
        '懸疑',
        '熱血',
        '魔幻',
      ];

      // 擴充選項：額外主題、背景與風格
      // 為了保持向下相容，我們將新的類別透過 push 方式加入原本陣列
      // 主題清單已在上方擴充，不再重複加入
      settings.push(
        '繁華的銀河商場',
        '隱藏於雲端的城堡',
        '古老的山林村落',
        '雪山上的修道院',
        '熱帶雨林深處',
        '巨型迷宮都市',
        '殖民海盜船',
        '宇宙戰艦上',
        '明朝宮廷',
        '平行宇宙'
      );
      stylesArr.push(
        '古典華麗',
        '荒誕',
        '現實主義',
        '輕鬆寫意',
        '酷炫科技',
        '優雅浪漫',
        '大河戲劇',
        '黑色幽默',
        '心理驚悚',
        '流行網絡'
      );
      const chapterOpts = [5, 8, 10, 12, 15];
      const lengthOpts = [30000, 50000, 70000, 90000];

      // 角色元素資料庫
      const nameOptions = [
        '艾琳','洛恩','凱亞','米爾','席恩','薇拉','祈安','杜林','希爾維','萊雅',
        '伊凡','法蘭','格蘭','梅芙','安娜','雷格','索菲','艾略特','亞歷克','莫妮卡',
        '路西','伊芙','加百列','亞當','瑪雅','艾德','薩拉','杰登','琪拉','德瑞克',
        '凱瑟琳','馬丁','羅絲','奧利維','昆汀','哈莉','伯納德','海倫','丹尼爾','雷切爾',
        '山姆','艾薇','諾亞','艾米莉','布萊恩','艾蜜莉亞','達米安','露西亞','米蘭達','亞歷山大',
        '波琳娜','亨利','蘇菲亞','費南多','克萊兒','埃德加','歐文','莉亞','查爾斯','哈娜',
        '杰克','瑪蒂爾達','托尼','娜塔莉','達瑞斯','克里斯','艾瑪','羅伯特','凱特','格蕾絲',
        '莫里斯','普拉多','勞拉','維克多','凱莉','菲利普','瑞秋','史蒂夫','羅伊','哈德森',
        '妮可','克麗絲汀','萊昂','梅根','杜蘭','馬雅','蘭斯洛特','卡羅爾','伊麗莎白','伊薩貝拉',
        '考特尼','蔣琴','唐娜','塞德里克','布蘭妮','雷蒙','凱薩琳','阿萊克斯','加布里埃拉','西蒙'
      ];
      const personalityOptions = [
        '外冷內熱','自卑但嘴硬','樂觀又衝動','冷靜但偏執','溫柔卻不輕信任何人','堅韌而沉默',
        '幽默開朗','善良又單純','多疑且謹慎','自信而傲慢','懶散卻超凡聰明','義氣而固執',
        '急躁但心地善良','謙虛而機智','天真又好奇','冷酷無情','善於交際','孤僻沉默',
        '勇敢衝動','理性克制',
        '愛幻想','孤單','嫉妒心強','勇於挑戰','樂於助人','多愁善感','懶散','好動','機智靈活','心直口快',
        '優柔寡斷','善於隱忍','頑強','懷疑一切','思維嚴謹','黑暗內心','衝動火爆','陰晴不定','客觀理性','自律自省',
        '貪心','粗枝大葉','孤高自傲','悲天憫人','求知欲強','保守傳統','冒險精神','浪漫情懷','鐵面無私','情感豐沛',
        '不拘小節','嬉皮笑臉','深謀遠慮','勇敢無畏','友善熱情','純真孩氣','冷漠疏離','心思纖細','謙遜低調','剛愎自用',
        '風趣幽默','充滿正義感','善於操控','常常懷疑自己','樂觀開朗','感性細膩','玩世不恭','奮發向上','無厘頭','固執己見',
        '反覆無常','忍耐力強','憨厚老實','孤僻怪異','古怪多變','嫉惡如仇','天真浪漫','豪放不羈','富有創意','隨遇而安',
        '心狠手辣','重視禮節','熱愛自由','貪玩','節儉','心地善良','喜歡冒險','專注執著','真誠坦率','小心翼翼'
        ,'倔強固執','天馬行空','善解人意','易燃易爆炸','過度樂觀','莫名自信','唯我獨尊','嫉惡如仇','悲觀厭世','凡事求真'
      ];
      const goalOptions = [
        '找回失落的家族徽章','破解禁書的封印','救回被詛咒的朋友','查出學院裡的內鬼','證明自己不是怪物',
        '尋找失蹤的師父','復仇雪恥','拯救世界免於毀滅','逃離自身的命運','尋求內心的自由',
        '揭開古老遺跡的秘密','完成父母未竟的夢想','打倒暴政的君王','尋找傳說中的寶藏','守護故鄉免於侵略',
        '破解血統之謎','治癒自己的病痛','成為最強者','阻止末日降臨','改變未來的預言',
        '統治整個國度','找到通往平行世界的門','破解古老魔法的謎語','阻止邪惡教團復活','拯救族人免於滅絕',
        '與心愛之人重逢','找出真正的身世','讓世界和平','消滅所有黑暗力量','完成最後一任務',
        '揭露巨大陰謀','修復破碎的王國','找到失蹤的寶藏','治癒世界的疾病','摧毀邪惡組織',
        '報復前世的仇敵','探索未知星系','保護自然環境','發現永恆之泉','統一各族勢力',
        '尋找失傳的魔法卷軸','解放奴役的人民','阻止黑暗儀式','完成祖先的遺願','建立和平的世界',
        '揭開身世之謎','戰勝心魔','擺脫家族詛咒','實現冒險夢想','奪回失去的王位',
        '找到傳說中的武器','復活已逝的愛人','破除命運束縛','從奴役中解放族人','尋求真正的友誼',
        '建立強大的團隊','開創新秩序','揭開古墓的秘密','穿越時空拯救世界','追求藝術極致',
        '完成一場史詩之旅','阻止時空崩壞','推翻腐敗政權','尋找永恆的愛情','保護弱小',
        '拯救被遺忘的種族','阻止瘟疫蔓延','尋找新的家園','實現科學突破','救贖自己',
        '治療親人的疾病','打破命運輪迴','組織反抗軍','守護神秘寶石','阻止世界融合',
        '找回失去的能力','尋求力量的來源','證明自己的價值','成為傳說中的英雄','阻止末日機器',
        '重建家園','找到記憶碎片','守護生命之樹','維持世界平衡','拯救被囚禁的靈魂',
        '探索海底世界','阻止洪水','追尋真理','成為最偉大的巫師','開創新世界',
        '繼承神的力量','阻止瘋狂科學家','完成最後的冒險','找到宇宙的起源','救助孤兒院',
        '解開歷史謎團','平息戰爭','召喚神龍'
        ,'尋找失散多年的親人','突破自我極限','統一四海八荒','實現和平共處','追求神秘力量'
      ];
      const weaknessOptions = [
        '害怕黑暗','遇到壓力就說謊','太容易相信別人','強迫症嚴重','一旦承諾就不肯回頭',
        '畏懼深海','恐高症','容易發怒','過於固執','患有失眠','對魔法過敏','不擅長謊言',
        '心軟','容易焦慮','懼怕孤獨','怕血','記憶衰退','常自我懷疑','體力差','情緒起伏大',
        '恐水','三分鐘熱度','貪吃','愛睡覺','沒自信','容易嫉妒','怕蛇','無法拒絕他人','懼怕孤獨','受到金錢誘惑',
        '懦弱','怕寂寞','怕失敗','眼神不好','迷失自我','容易暈血','過度同情心','情緒不穩','飲食失調','缺乏耐心',
        '怕被拒絕','易感寂寞','時間管理差','容易分心','優柔寡斷','怕寵物','對聲音過敏','會暈車','不會游泳','怕蜘蛛',
        '對金錢著迷','過於誠實','不能保守秘密','健忘','反射神經差','害怕蛙','愛出風頭','情緒化','傲慢自大','懷疑一切',
        '受不起批評','追求完美','過度開朗','得失心重','過於善良','常常遲到','自控力差','容易煩惱','懷舊','過於現實',
        '怕痛','不擅交際','愛拖延','不善理財','怕換環境','低血糖','怕雷','愛哭','怕醫院','無安全感',
        '太在意他人眼光','怕火','怕蟑螂','怕雨','怕被孤立','怕未知','怕黑夜','恐懼高壓','怕失去朋友','過於衝動',
        '易怒','有強迫症','潔癖','過於挑剔','缺乏信心','害怕說謊','金錢迷惑'
        ,'過度自責','怕黑怕鬼','無法長時間專注','過於敏感','喜歡攀比'
      ];
      const secretOptions = [
        '其實能聽見魔杖的聲音','曾經施放過禁咒','血統有爭議','與反派有血緣關係','記憶被人動過手腳',
        '身上藏有古老符文','是預言中的孩子','隱藏著第二人格','真正的身份是王族','手握未來的預言',
        '擁有毀滅世界的力量','殺過無辜的人','靈魂被分裂','與神靈簽下契約','體內寄宿龍族血脈',
        '被人控制思想','持有禁書','曾是敵軍間諜','擁有可以逆天改命的能力','已經死亡又復活過',
        '身份是天界使者','出生於敵對國度','持有能控制時間的裝置','曾經是反派手下','其真正目的是復仇',
        '身體中封印著魔神','曾殺死親人','擁有不可告人的戀情','曾在另一時空活過','靈魂被惡靈附身',
        '曾經是王族成員','擁有預知能力','體內封印著神獸','曾與外星人接觸','是雙重間諜',
      ];

      // 新增角色
      function addCharacter() {
        const charIndex = charactersContainer.children.length + 1;
        const charRow = document.createElement('div');
        charRow.className = 'character-row';
        charRow.innerHTML = `
          <span class="char-index">角色 ${charIndex}</span>
          <input type="text" placeholder="輸入人物描述或名字" />
          <button type="button" class="randomCharBtn">隨機</button>
          <button type="button" class="removeCharBtn">移除</button>
        `;
        charactersContainer.appendChild(charRow);

        const randomCharBtn = charRow.querySelector('.randomCharBtn');
        randomCharBtn.addEventListener('click', () => {
          const name = nameOptions[Math.floor(Math.random() * nameOptions.length)];
          const personality = personalityOptions[Math.floor(Math.random() * personalityOptions.length)];
          const goal = goalOptions[Math.floor(Math.random() * goalOptions.length)];
          const weakness = weaknessOptions[Math.floor(Math.random() * weaknessOptions.length)];
          const secret = secretOptions[Math.floor(Math.random() * secretOptions.length)];
          const charInput = charRow.querySelector('input');
          charInput.value = `${name}（${personality}，目標：${goal}，弱點：${weakness}，秘密：${secret}）`;
        });

        const removeCharBtn = charRow.querySelector('.removeCharBtn');
        removeCharBtn.addEventListener('click', () => {
          charRow.remove();
        });
      }

      // 隨機所有角色
      function randomAllCharacters() {
        charactersContainer.innerHTML = '';
        const charCount = Math.floor(Math.random() * 3) + 2;
        for (let i = 0; i < charCount; i++) {
          addCharacter();
          const charRows = charactersContainer.querySelectorAll('.character-row');
          const lastRow = charRows[charRows.length - 1];
          const randomBtn = lastRow.querySelector('.randomCharBtn');
          randomBtn.click();
        }
      }

      // 隨機填充已有的人物
      function randomExistingCharacters() {
        const charRows = charactersContainer.querySelectorAll('.character-row');
        charRows.forEach(row => {
          const randomBtn = row.querySelector('.randomCharBtn');
          if (randomBtn) {
            randomBtn.click();
          }
        });
      }

      // 按鈕事件監聽
      addCharacterBtn.addEventListener('click', addCharacter);
      randomAllCharactersBtn.addEventListener('click', randomAllCharacters);

      // 隨機填充
      randomBtn.addEventListener('click', () => {
        themeSelect.value = themes[Math.floor(Math.random() * themes.length)];
        settingSelect.value = settings[Math.floor(Math.random() * settings.length)];
        styleSelect.value = stylesArr[Math.floor(Math.random() * stylesArr.length)];
        chaptersInput.value = chapterOpts[Math.floor(Math.random() * chapterOpts.length)];
        lengthInput.value = lengthOpts[Math.floor(Math.random() * lengthOpts.length)];
        
        // 如果已有人物，則隨機填充現有人物；否則生成新人物
        const existingChars = charactersContainer.querySelectorAll('.character-row');
        if (existingChars.length > 0) {
          randomExistingCharacters();
        } else {
          randomAllCharacters();
        }
      });

      // 開始生成
      generateBtn.addEventListener('click', async () => {
        const apiKey = apiKeyInput.value.trim();
        const model = modelSelect.value;
        const theme = themeSelect.value;
        const setting = settingSelect.value;
        const style = styleSelect.value;
        const chapters = chaptersInput.value;
        const length = lengthInput.value;
        const notes = notesInput.value;

        if (!apiKey) {
          statusDiv.textContent = '❌ 請輸入 API 金鑰';
          return;
        }
        if (!theme || !setting || !style || !chapters || !length) {
          statusDiv.textContent = '❌ 請填寫所有必填項目';
          return;
        }

        const characters = Array.from(charactersContainer.querySelectorAll('input')).map(input => input.value).filter(v => v);
        if (characters.length === 0) {
          statusDiv.textContent = '❌ 請至少添加一個人物';
          return;
        }

        generateBtn.disabled = true;
        statusDiv.textContent = '⏳ 正在生成故事，請稍候...';
        resultDiv.textContent = '';

        try {
          const prompt = `請根據以下設定生成一部${chapters}章的小說，總字數約${length}字。

主題：${theme}
背景：${setting}
風格：${style}
主要人物：${characters.join('、')}
${notes ? `補充說明：${notes}` : ''}

要求：
1. 故事要完整、連貫、引人入勝
2. 人物要有深度和發展
3. 情節要有起承轉合
4. 每章約${Math.floor(length / chapters)}字
5. 使用${style}的敘述風格

請開始創作：`;

          const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + apiKey, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: prompt
                    }
                  ]
                }
              ]
            })
          });

          if (!response.ok) {
            throw new Error('API 請求失敗');
          }

          const data = await response.json();
          if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
            latestStory = data.candidates[0].content.parts[0].text;
            resultDiv.textContent = latestStory;
            localStorage.setItem('savedStory', latestStory);
            downloadBtn.disabled = false;
            statusDiv.textContent = '✅ 故事生成完成！';
          } else {
            throw new Error('無法解析 API 回應');
          }
        } catch (error) {
          statusDiv.textContent = '❌ 生成失敗：' + error.message;
          console.error(error);
        } finally {
          generateBtn.disabled = false;
        }
      });

      // 下載小說
      downloadBtn.addEventListener('click', () => {
        if (!latestStory) {
          alert('沒有故事可下載');
          return;
        }
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(latestStory));
        element.setAttribute('download', '我的小說.txt');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      });
    </script>
  </body>
</html>
